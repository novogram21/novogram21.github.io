<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="manifest" href="manifest.json">
    
    <meta name="theme-color" content="#1f1f1f">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="color-scheme" content="dark">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">

    <title>Novogram21</title>

    <style>
        /* –í–µ—Å—å —Ç–≤–æ–π CSS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #121212; color: #eee; margin: 0; display: flex; height: 100dvh; overflow: hidden; overscroll-behavior-y: none; }
        .auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 6000; display: flex; justify-content: center; align-items: center; }
        .auth-box { width: 300px; padding: 25px; background: #2d2d2d; border-radius: 12px; text-align: center; border: 1px solid #444; }
        .auth-box input { width: 100%; padding: 12px; margin: 8px 0; background: #444; border: 1px solid #555; color: white; border-radius: 6px; }
        .auth-box button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.2s; }
        .auth-box button:disabled { background: #555; cursor: wait; opacity: 0.7; }
        
        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar { width: 320px; background: #1f1f1f; border-right: 1px solid #333; display: flex; flex-direction: column; z-index: 10; }
        .profile-bar { padding: 15px; background: #252525; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 10px; }
        .tabs { display: flex; background: #252525; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; color: #888; font-size: 14px; position: relative; }
        .tab.active { border-bottom: 2px solid #007bff; color: white; }
        .tab-badge { background: #ff4444; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; position: absolute; top: 5px; right: 10px; }
        .list-container { flex: 1; overflow-y: auto; }
        
        /* –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ */
        .user-item { padding: 10px 15px; border-bottom: 1px solid #333; display: grid; grid-template-columns: 55px 1fr auto; grid-template-rows: auto auto; column-gap: 10px; align-items: center; cursor: pointer; transition: 0.2s; min-height: 72px; }
        .user-item:hover { background: #2a2a2a; }
        .user-item-avatar { grid-column: 1; grid-row: 1 / span 2; width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .user-name { grid-column: 2; grid-row: 1; font-weight: 600; font-size: 16px; color: white; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; align-self: end; }
        .last-msg-row { grid-column: 2; grid-row: 2; display: flex; align-items: center; overflow: hidden; align-self: start; }
        .last-msg { font-size: 14px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .meta-column { grid-column: 3; grid-row: 1 / span 2; display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 5px; min-width: 65px; }
        .last-msg-date { font-size: 13px; color: #888; }
        .meta-bottom-row { display: flex; align-items: center; justify-content: flex-end; height: 20px; }
        .list-ticks { display: inline-flex; font-size: 14px; color: white !important; }
        .list-ticks span { color: white !important; }
        .badge-count { background: #736AF0; color: white; font-size: 12px; padding: 2px 9px; border-radius: 12px; font-weight: bold; min-width: 20px; text-align: center; line-height: 1.2; display: none; }
        .badge-count:not(.hidden) { display: block; }
        
        .chat-area { flex: 1; display: flex; flex-direction: column; background: transparent; position: relative; z-index: 1; }
        #noChat { height: 100%; display: flex; align-items: center; justify-content: center; color: #aaa; position: relative; overflow: hidden; background-color: #0a0c10; }
        #noChat > div { position: relative; z-index: 2; font-size: 18px; font-weight: 500; }
        
        .chat-header { padding: 10px 15px; background: #1f1f1f; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; min-height: 60px; }
        .back-btn { display: none; background: none; border: none; color: #007bff; font-size: 24px; cursor: pointer; padding-right: 15px; }
        .chat-header-info { display: flex; flex-direction: column; gap: 2px; flex: 1; }
        .chat-title { font-weight: bold; font-size: 16px; }
        .chat-status { font-size: 12px; color: #888; }
        
        .messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; width: 100%; max-width: 900px; margin: 0 auto; background: transparent; position: relative; z-index: 1; }
        .messages::-webkit-scrollbar { display: none; }
        .messages { -ms-overflow-style: none; scrollbar-width: none; }
        .messages > * { position: relative; z-index: 1; }
        
        .input-bar { padding: 10px 20px; background: transparent; display: flex; justify-content: center; align-items: center; gap: 10px; width: 100%; max-width: 900px; margin: 0 auto; position: relative; z-index: 5; }
        .input-container { flex: 1; display: flex; align-items: center; background: #1f1f1f; border-radius: 25px; padding: 5px 15px; border: 1px solid #333; position: relative; }
        .input-container input { flex: 1; background: transparent; border: none; color: white; padding: 10px; font-size: 15px; outline: none; }
        .attach-btn { background: none; border: none; color: #888; font-size: 20px; cursor: pointer; padding: 5px; transition: 0.2s; }
        .voice-btn, .send-btn { width: 45px; height: 45px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.2s; flex-shrink: 0; }
        .voice-btn { background: #2d2d2d; color: white; }
        .send-btn { background: #007bff; color: white; padding-left: 5px; }
        
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 12px; font-size: 15px; line-height: 1.4; position: relative; cursor: pointer; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: #736AF0; color: white; border-bottom-right-radius: 2px; }
        .msg-other { align-self: flex-start; background: #2d2d2d; color: white; border-bottom-left-radius: 2px; }
        .msg-sys { align-self: center; background: rgba(34, 34, 34, 0.8); border: 1px solid #444; font-size: 13px; color: #aaa; padding: 4px 10px; border-radius: 10px; }
        .msg-meta { float: right; margin-left: 7px; margin-top: 6px; display: inline-flex; align-items: center; gap: 3px; vertical-align: bottom; position: relative; top: 3px; white-space: nowrap; height: 14px; line-height: 1; }
        .msg-time { font-size: 11px; color: rgba(255, 255, 255, 0.6); margin-right: 2px; }
        .msg-ticks { font-size: 12px; color: white; display: none; font-weight: bold; }
        .msg-me .msg-ticks { display: inline-block; }
        
        .overlay-sheet { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4999; display: none; }
        .action-sheet { position: fixed; bottom: 0; left: 0; width: 100%; background: #1f1f1f; border-top-left-radius: 16px; border-top-right-radius: 16px; padding: 20px; z-index: 5000; transform: translateY(100%); visibility: hidden; transition: transform 0.3s, visibility 0s linear 0.3s; }
        .action-sheet.open { transform: translateY(0); visibility: visible; transition: transform 0.3s, visibility 0s; }
        .action-btn { background: #2d2d2d; border: none; padding: 15px; color: white; border-radius: 12px; font-size: 16px; cursor: pointer; text-align: center; }
        .action-btn.delete { color: #ff4444; }
        .sheet-title { color: #777; font-size: 13px; text-align: center; margin-bottom: 5px; }
        .profile-option { background: #2d2d2d; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .profile-option h3 { margin: 0 0 10px 0; font-size: 15px; color: #ddd; }
        
        .call-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 4000; display: none; flex-direction: column; transition: opacity 0.5s; }
        .video-grid { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; width: 100%; height: 100%; background: #000; }
        #remoteVideo { width: 100%; height: 100%; object-fit: contain; background: #000; }
        .local-video-container { position: absolute; bottom: 160px; right: 20px; width: 140px; height: 210px; border-radius: 18px; overflow: hidden; border: 2px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 25px rgba(0,0,0,0.6); z-index: 4002; display: block; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        #localVideo { width: 100% !important; height: 100% !important; object-fit: cover !important; position: absolute; top: 0; left: 0; background: #000; }
        #localVideo.mirror { transform: scaleX(-1); }
        .controls { position: absolute; bottom: 0; left: 0; width: 100%; display: flex; justify-content: center; gap: 15px; padding: 20px 10px 40px 10px; z-index: 4003; background: #18191c; border-top-left-radius: 16px; border-top-right-radius: 16px; }
        .control-item { display: flex; flex-direction: column; align-items: center; gap: 8px; width: 70px; }
        .control-label { font-size: 11px; color: #b5bac1; white-space: nowrap; }
        .btn-circle { width: 56px; height: 56px; border-radius: 50%; border: none; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 24px; transition: 0.2s; background: #2b2d31; color: #dbdee1; }
        .btn-circle:active { transform: scale(0.95); }
        .btn-active-white { background: #f2f3f5 !important; color: #313338 !important; }
        .btn-hangup { background: #da373c !important; color: white !important; }
        .btn-screen-on { background: #248046 !important; color: white !important; }
        .incoming-call { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #222; padding: 15px 25px; border-radius: 30px; z-index: 5000; display: none; align-items: center; gap: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); border: 1px solid #444; width: 90%; max-width: 400px; justify-content: space-between; }
        .timer-badge { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); padding: 10px 20px; border-radius: 20px; color: #fff; z-index: 4003; pointer-events: none; display: flex; flex-direction: column; align-items: center; min-width: 120px; }
        #callStatusText { font-size: 12px; color: #ccc; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        #callTimer { font-size: 18px; font-family: monospace; font-weight: bold; }
        #callPing { font-size: 11px; color: #4caf50; margin-top: 5px; opacity: 0.9; }
        .hidden { display: none !important; }
        @media (max-width: 768px) { .sidebar { width: 100%; border-right: none; } .chat-area { display: none; width: 100%; position: absolute; top: 0; left: 0; height: 100%; z-index: 20; } .chat-area.active { display: flex; } .sidebar.hidden-mobile { display: none; } .back-btn { display: block; } }
        
        #app-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background-color: #0a0c10; }
        #app-background::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.7; pointer-events: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='500' viewBox='0 0 500 500'%3E%3Cstyle%3E text %7B font-family: 'Segoe UI Emoji', 'Apple Color Emoji', sans-serif; %7D %3C/style%3E%3C!-- –ò–ö–û–ù–ö–ò --%3E%3Ctext x='40' y='60' font-size='36' fill='%234a9eff' fill-opacity='0.4' transform='rotate(12 40 60)'%3EüéÆ%3C/text%3E%3Ctext x='380' y='120' font-size='40' fill='%237c3aed' fill-opacity='0.35' transform='rotate(-15 380 120)'%3EüöÄ%3C/text%3E%3Ctext x='220' y='400' font-size='38' fill='%2306b6d4' fill-opacity='0.4' transform='rotate(8 220 400)'%3Eüéß%3C/text%3E%3Ctext x='180' y='90' font-size='28' fill='%23ec4899' fill-opacity='0.35' transform='rotate(-10 180 90)'%3Eüí°%3C/text%3E%3Ctext x='90' y='250' font-size='30' fill='%2310b981' fill-opacity='0.3' transform='rotate(20 90 250)'%3Eüçï%3C/text%3E%3Ctext x='340' y='320' font-size='26' fill='%23f59e0b' fill-opacity='0.35' transform='rotate(-8 340 320)'%3E‚öΩ%3C/text%3E%3Ctext x='420' y='450' font-size='32' fill='%236366f1' fill-opacity='0.4' transform='rotate(15 420 450)'%3Eüì∑%3C/text%3E%3Ctext x='300' y='180' font-size='20' fill='%238b5cf6' fill-opacity='0.25' transform='rotate(-20 300 180)'%3Eüé∏%3C/text%3E%3Ctext x='150' y='350' font-size='22' fill='%2314b8a6' fill-opacity='0.3' transform='rotate(25 150 350)'%3Eüíª%3C/text%3E%3Ctext x='450' y='260' font-size='18' fill='%23ef4444' fill-opacity='0.3' transform='rotate(-12 450 260)'%3EüèÜ%3C/text%3E%3Ctext x='60' y='430' font-size='24' fill='%233b82f6' fill-opacity='0.35' transform='rotate(18 60 430)'%3Eüé≤%3C/text%3E%3Ctext x='280' y='50' font-size='20' fill='%23a855f7' fill-opacity='0.3' transform='rotate(-5 280 50)'%3Eüëª%3C/text%3E%3C/svg%3E"); background-size: 400px 400px; }
        #app-background::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, rgba(10, 12, 16, 0.3) 0%, rgba(10, 12, 16, 0.7) 100%); pointer-events: none; }
        
        #localPip { touch-action: none; user-select: none; cursor: grab; }
        #localPip.dragging, #localPip.resizing { transition: none !important; }
        #localPip.dragging { cursor: grabbing; }
        #localPip > video { pointer-events: none; }
        #localPip .pip-resize-handle { position: absolute; right: 8px; bottom: 8px; width: 22px; height: 22px; border-radius: 7px; cursor: nwse-resize; background: rgba(255,255,255,0.16); border: 1px solid rgba(255,255,255,0.22); box-shadow: 0 6px 16px rgba(0,0,0,0.35); backdrop-filter: blur(8px); }
        #localPip .pip-resize-handle::after { content: ""; position: absolute; inset: 6px; border-right: 2px solid rgba(255,255,255,0.55); border-bottom: 2px solid rgba(255,255,255,0.55); border-radius: 2px; }
        .control-item-hidden { display: none !important; }
    </style>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
</head>
<body>
    <div id="app-background"></div>
    <audio id="ringtone" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="authScreen" class="auth-overlay">
        <div id="stepEmail" class="auth-box">
            <h2>–í—Ö–æ–¥ –≤ Messenger</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="btnAuth" onclick="authAction()">–î–∞–ª–µ–µ</button>
            <div id="authError" style="color: #ff4444; margin-top: 10px; font-size: 13px;"></div>
        </div>

        <div id="stepName" class="auth-box" style="display: none;">
            <h2>–í–∞—à–µ –∏–º—è</h2>
            <div style="font-size: 13px; color: #aaa; margin-bottom: 15px;">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è.</div>
            <input type="text" id="regName" placeholder="–ò–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" oninput="checkNameInput()">
            <input type="text" id="regSurname" placeholder="–§–∞–º–∏–ª–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            <button id="btnNameNext" onclick="goToUsernameStep()" disabled style="background: #444; cursor: not-allowed;">–î–∞–ª–µ–µ</button>
        </div>

        <div id="stepUsername" class="auth-box" style="display: none;">
            <div style="display:flex; justify-content: flex-start;">
                <button onclick="backToName()" style="width: auto; background: none; color: #007bff; padding: 0; margin: 0 0 10px 0;">‚Üê –ù–∞–∑–∞–¥</button>
            </div>
            <h2>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <div style="font-size: 13px; color: #aaa; margin-bottom: 15px;">–í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</div>
            <input type="text" id="regUsername" placeholder="@Username" oninput="checkUsernameInput()" style="padding-left: 10px;">
            <div id="usernameStatus" style="font-size: 12px; text-align: left; margin-top: 5px; min-height: 15px;"></div>
            <button id="btnFinish" onclick="finishRegistration()" disabled style="background: #444; cursor: not-allowed; margin-top: 15px;">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
        </div>
    </div>

    <div id="incomingPopup" class="incoming-call">
        <span id="callerName" style="font-weight:bold; font-size: 14px;">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <div style="display:flex; gap:15px;">
            <button onclick="answerCall()" class="btn-circle" style="background:#248046; width:45px; height:45px; font-size:18px;">üìû</button>
            <button onclick="rejectCall()" class="btn-circle btn-hangup" style="width:45px; height:45px; font-size:18px;">‚úñ</button>
        </div>
    </div>

    <div id="overlaySheet" class="overlay-sheet" onclick="closeAllSheets()"></div>
    <div id="actionSheet" class="action-sheet">
        <div class="sheet-title">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
        <button class="action-btn delete" onclick="openDeleteSheet()">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="action-btn" onclick="closeAllSheets()">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <div id="deleteSheet" class="action-sheet">
        <div class="sheet-title">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?</div>
        <button id="btnDelAll" class="action-btn delete" onclick="confirmDelete('all')">–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö</button>
        <button class="action-btn delete" onclick="confirmDelete('me')">–£–¥–∞–ª–∏—Ç—å —É –º–µ–Ω—è</button>
        <button class="action-btn" onclick="closeAllSheets()">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <div id="profileSheet" class="action-sheet" style="height: auto; max-height: 90dvh; overflow-y: auto;">
        <div class="sheet-title" style="font-size: 16px; font-weight: bold; margin-bottom: 15px;">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>
        <div style="display:flex; flex-direction:column; align-items:center; margin-bottom: 20px;">
            <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; background: #333; margin-bottom: 10px; position: relative; border: 2px solid #555;">
                <img id="profileAvatarPreview" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                <div id="profileAvatarPlaceholder" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #888; font-size: 40px;">üë§</div>
            </div>
            <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="handleAvatarSelect(this)">
            <button onclick="document.getElementById('avatarInput').click()" style="background:none; border:none; color:#007bff; cursor:pointer;">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
        </div>
        <div class="profile-option"><h3>Email</h3><div id="profileEmail" style="color: #007bff; margin-bottom: 10px;"></div></div>
        <div class="profile-option"><h3>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (@)</h3><div class="profile-input-group"><span style="padding: 10px; background: #444; color: #aaa; border-radius: 8px 0 0 8px;">@</span><input type="text" id="profileUsername" placeholder="IvanIvanov" style="flex: 1; padding: 10px; background: #444; border: none; color: white; border-radius: 0 8px 8px 0;" oninput="validateUsername(this)"></div></div>
        <div class="profile-option"><h3>–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3><div style="display: flex; gap: 10px; margin-bottom: 10px;"><input type="text" id="profileName" placeholder="–ò–º—è *" style="flex: 1; padding: 10px; background: #444; border: none; color: white; border-radius: 8px;"><input type="text" id="profileSurname" placeholder="–§–∞–º–∏–ª–∏—è" style="flex: 1; padding: 10px; background: #444; border: none; color: white; border-radius: 8px;"></div><h3 style="margin-top: 15px;">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</h3><input type="date" id="profileBirthdate" style="width: 100%; padding: 10px; background: #444; border: none; color: white; border-radius: 8px; color-scheme: dark;"></div>
        <div class="profile-option"><h3>Telegram Connect</h3><div class="profile-input-group"><input type="text" id="tgChatId" placeholder="–í–∞—à ID" style="flex: 1; padding: 10px; background: #444; border: none; color: white; border-radius: 8px;"></div></div>
        <button onclick="saveProfile()" class="action-btn" style="background: #28a745; color: white; margin-bottom: 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <button onclick="logout()" class="action-btn" style="padding: 10px; font-size: 14px; width: 100%;">–í—ã–π—Ç–∏</button>
    </div>

    <div id="mainSidebar" class="sidebar">
        <div class="profile-bar" style="padding: 12px 15px; gap: 12px;">
            <button onclick="openProfileSheet()" style="width: 44px; height: 44px; border-radius: 50%; background: #2d2d2d; border: 1px solid #444; color: #fff; font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" onmouseover="this.style.background='#383838'" onmouseout="this.style.background='#2d2d2d'"><span id="myAvatarSmall">üë§</span></button>
            <div style="flex: 1; position: relative;">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." style="width: 100%; height: 44px; padding: 0 15px; border-radius: 22px; border: 1px solid #333; background: #181818; color: white; outline: none; font-size: 14px; transition: 0.2s;" onfocus="this.style.background='#222'; this.style.borderColor='#555'" onblur="this.style.background='#181818'; this.style.borderColor='#333'" oninput="handleSearchInput(this)">
                <div id="searchResults" style="position: absolute; top: 50px; left: 0; right: 0; background: #252525; border: 1px solid #333; border-radius: 12px; z-index: 100; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5); overflow: hidden;"></div>
            </div>
        </div>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('friends')">–î—Ä—É–∑—å—è <span id="friendsBadge" class="tab-badge hidden">0</span></div>
            <div class="tab" onclick="switchTab('requests')">–ó–∞—è–≤–∫–∏ <span id="requestsBadge" class="tab-badge hidden">0</span></div>
        </div>
        <div id="friendsList" class="list-container"></div>
        <div id="requestsList" class="list-container hidden"></div>
    </div>

    <div id="mainChatArea" class="chat-area">
        <div id="noChat"><div style="text-align: center;">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç<br><span style="font-size: 14px; color: #666; font-weight: normal;">—á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</span></div></div>
        <div id="activeChat" class="hidden" style="height:100%; display:flex; flex-direction:column;">
            <div class="chat-header">
                <button class="back-btn" onclick="closeChat()" style="display: flex; align-items: center;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 12H4M4 12L10 6M4 12L10 18" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg></button>
                <div class="chat-header-info"><div class="chat-title" id="chatTitle">User</div><div class="chat-status" id="chatStatus">–∑–∞–≥—Ä—É–∑–∫–∞...</div></div>
                <button onclick="startCall()" style="background:#28a745; color:white; border:none; padding:8px 15px; border-radius:20px; cursor:pointer; font-weight:bold;">üìπ</button>
            </div>
            <div id="msgList" class="messages"></div>
            <div class="input-bar">
                <div class="input-container"><input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" onkeypress="if(event.key==='Enter') sendMsg()"><button class="attach-btn" onclick="alert('–§—É–Ω–∫—Ü–∏—è –≤–ª–æ–∂–µ–Ω–∏–π –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">üìé</button></div>
                <button class="voice-btn" onclick="alert('–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∫–æ—Ä–æ –±—É–¥—É—Ç!')">üé§</button>
                <button class="send-btn hidden" id="sendBtn" onclick="sendMsg()">‚û§</button>
            </div>
        </div>
    </div>

    <div id="callScreen" class="call-screen">
        <div class="video-grid"><video id="remoteVideo" autoplay playsinline></video><div class="local-video-container" id="localPip"><video id="localVideo" autoplay muted playsinline></video><div class="pip-resize-handle" aria-hidden="true"></div></div></div>
        <div class="timer-badge"><div id="callStatusText">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div><div id="callTimer">00:00</div><div id="callPing">Ping: -</div></div>
        <div class="controls">
            <div class="control-item"><button onclick="toggleScreen()" id="btnScr" class="btn-circle">üñ•Ô∏è</button><span id="lblScr" class="control-label">–≠–∫—Ä–∞–Ω</span></div>
            <div class="control-item"><button onclick="toggleCamera()" id="btnCam" class="btn-circle">üì∑</button><span id="lblCam" class="control-label">–í–∫–ª. –≤–∏–¥–µ–æ</span></div>
            <div class="control-item"><button onclick="switchCamera()" id="btnFlip" class="btn-circle">üîÑ</button><span class="control-label">–ö–∞–º–µ—Ä–∞</span></div>
            <div class="control-item"><button onclick="endCallUser()" class="btn-circle btn-hangup">üìû</button><span class="control-label">–ó–∞–≤–µ—Ä—à–∏—Ç—å</span></div>
            <div class="control-item"><button onclick="toggleMic()" id="btnMic" class="btn-circle">üé§</button><span id="lblMic" class="control-label">–í—ã–∫–ª. –∑–≤—É–∫</span></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBncXLA4D1JdsqQtA8_8rPqQioq2XRfic4",
            authDomain: "mycoolmessenger.firebaseapp.com",
            databaseURL: "https://mycoolmessenger-default-rtdb.firebaseio.com",
            projectId: "mycoolmessenger",
            storageBucket: "mycoolmessenger.firebasestorage.app",
            messagingSenderId: "225503087166",
            appId: "1:225503087166:web:1355f138e34e3a0172df6f"
        };

        if (typeof firebase !== 'undefined') {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            
            const auth = firebase.auth();
            const db = firebase.firestore();
            
            // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –£–±—Ä–∞–ª–∏ synchronizeTabs: true (—Ç–æ—Ä–º–æ–∑–∏—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö)
            db.enablePersistence()
                .catch(err => {
                    if (err.code == 'failed-precondition') {
                        console.log('–û—Ç–∫—Ä—ã—Ç–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤–∫–ª–∞–¥–æ–∫');
                    } else if (err.code == 'unimplemented') {
                        console.log('–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∫—ç—à');
                    }
                });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OneSignal
            window.OneSignalDeferred = window.OneSignalDeferred || [];
            OneSignalDeferred.push(function (OneSignal) {
                OneSignal.init({ appId: "6af8818f-ba3a-40c4-b820-5235c1d73925" });
                function savePlayerId() {
                    if (OneSignal.User.PushSubscription.optedIn) {
                        const oneSignalId = OneSignal.User.PushSubscription.id;
                        const user = firebase.auth().currentUser;
                        if (user && oneSignalId) {
                            db.collection('users').doc(user.uid).update({ oneSignalId: oneSignalId }).catch(e => { });
                        }
                    }
                }
                OneSignal.User.PushSubscription.addEventListener("change", savePlayerId);
                firebase.auth().onAuthStateChanged(u => { if (u) setTimeout(savePlayerId, 3000); });
            });

            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            const ENCRYPTED_TOKEN = "ODM4Nzc3NTEwNzpBQUdoWFBjZnl0SWNuaC1fekQwNEh2bEdYSUpfYi1jclBLNA==";
            const iceServers = { iceServers: [{ urls: "stun:stun.relay.metered.ca:80" }] }; // –°–æ–∫—Ä–∞—Ç–∏–ª –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞, –ø–æ–ª–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ –æ–∫
            
            let currentUser = null;
            let currentFriendId = null;
            let currentCallId = null;
            let currentChatId = null;
            let pc = null;
            let localStream = null;
            let usersCache = {};
            let currentFacingMode = "user";
            let msgUnsub = null;
            let candidateQueue = [];
            let callTimerInt = null;
            let callStartTime = 0;
            let isConnected = false;
            let wasCallConnected = false;
            let amICaller = false;
            let pingInterval = null;
            let selectedMsgId = null;
            let lastSeenInterval = null;
            let unreadCounts = {};
            let audioCtx = null;
            let toneTimer = null;

            // --- AUTH LOGIC (–° –ò–ù–î–ò–ö–ê–¶–ò–ï–ô) ---
            function authAction() {
                const e = document.getElementById('email').value;
                const p = document.getElementById('pass').value;
                if (!e || !p) return;

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                const btn = document.getElementById('btnAuth');
                btn.innerText = "–í—Ö–æ–¥–∏–º...";
                btn.disabled = true;

                auth.signInWithEmailAndPassword(e, p).catch(err => {
                    if (err.code.includes('not-found') || err.code.includes('wrong') || err.code.includes('invalid')) {
                        auth.createUserWithEmailAndPassword(e, p).then(cred => {
                            db.collection('users').doc(cred.user.uid).set({
                                email: e, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        });
                    } else {
                        document.getElementById('authError').innerText = err.message;
                        btn.innerText = "–î–∞–ª–µ–µ";
                        btn.disabled = false;
                    }
                });
            }

            const wasLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            if (wasLoggedIn) {
                document.getElementById('authScreen').classList.add('hidden');
            }

            auth.onAuthStateChanged(u => {
                const btn = document.getElementById('btnAuth');
                if (btn) { btn.innerText = "–î–∞–ª–µ–µ"; btn.disabled = false; }

                if (u) {
                    currentUser = u;
                    localStorage.setItem('isLoggedIn', 'true');
                    db.collection('users').doc(u.uid).get().then(doc => {
                        if (doc.exists && doc.data().username) {
                            document.getElementById('authScreen').classList.add('hidden');
                            document.getElementById('profileEmail').innerText = u.email;
                            updateLastSeen();
                            loadData();
                            listenForIncomingCalls();
                            loadTgId();
                            if (lastSeenInterval) clearInterval(lastSeenInterval);
                        } else {
                            document.getElementById('stepEmail').style.display = 'none';
                            document.getElementById('stepName').style.display = 'block';
                            document.getElementById('stepUsername').style.display = 'none';
                            document.getElementById('authScreen').classList.remove('hidden');
                        }
                    });
                } else {
                    localStorage.removeItem('isLoggedIn');
                    if (wasLoggedIn) alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
                    document.getElementById('authScreen').classList.remove('hidden');
                    document.getElementById('stepEmail').style.display = 'block';
                    document.getElementById('stepName').style.display = 'none';
                    if (lastSeenInterval) clearInterval(lastSeenInterval);
                }
            });

            // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê (–û–°–¢–ê–õ–¨–ù–û–ï –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô, –ù–û –í–°–¢–ê–í–õ–ï–ù–û –°–Æ–î–ê) ---
            
            function loadData() {
                if (typeof listenForFriendRequests === 'function') listenForFriendRequests();

                db.collection('friends')
                    .where('users', 'array-contains', currentUser.uid)
                    .onSnapshot(async snap => {
                        const list = document.getElementById('friendsList');
                        if (snap.empty) {
                            list.innerHTML = '<div style="padding:20px;text-align:center;color:#888">–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –ø—É—Å—Ç</div>';
                            return;
                        }

                        snap.docChanges().forEach(async change => {
                            const d = change.doc.data();
                            const fid = d.users.find(id => id !== currentUser.uid);
                            if (!fid) return;

                            if (change.type === 'removed') {
                                const el = document.getElementById('u-' + fid);
                                if (el) el.remove();
                                return;
                            }

                            let friendData = usersCache[fid];
                            if (!friendData) {
                                try {
                                    const userSnap = await db.collection('users').doc(fid).get();
                                    if (userSnap.exists) {
                                        friendData = userSnap.data();
                                        usersCache[fid] = friendData;
                                    }
                                } catch (e) { console.error(e); }
                            }

                            const fName = friendData ? (friendData.name || friendData.username) : '–ó–∞–≥—Ä—É–∑–∫–∞...';
                            const fNick = friendData ? ('@' + friendData.username) : '';
                            const fAvatar = friendData ? friendData.avatar : null;
                            const createdTime = d.createdAt ? d.createdAt.toMillis() : 0;
                            const chatId = [currentUser.uid, fid].sort().join('_');

                            let div = document.getElementById('u-' + fid);
                            const isNew = !div;

                            if (isNew) {
                                div = document.createElement('div');
                                div.className = 'user-item';
                                div.id = 'u-' + fid;
                                div.onclick = () => openChat(fid, fName, fNick);
                            }

                            div.setAttribute('data-time', createdTime);
                            const avatarHtml = fAvatar ? `<img src="${fAvatar}" class="user-item-avatar">` : `<div class="user-item-avatar" style="background:#444;display:flex;align-items:center;justify-content:center;font-size:24px;color:#888">üë§</div>`;

                            div.innerHTML = `
                                ${avatarHtml}
                                <div class="user-name">${fName}</div>
                                <div class="last-msg-row"><span class="last-msg" id="last-${chatId}">...</span></div>
                                <div class="meta-column">
                                    <span class="last-msg-date" id="date-${chatId}"></span>
                                    <div class="meta-bottom-row"><span id="status-${chatId}" class="list-ticks"></span><div class="badge-count hidden" id="badge-${chatId}">0</div></div>
                                </div>
                            `;

                            if (isNew) {
                                list.appendChild(div);
                                startMessageListener(chatId, fid, createdTime);
                            }
                        });
                        setTimeout(sortFriendsList, 100);
                    });
            }

            // –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–°–æ–∫—Ä–∞—â–µ–Ω—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞, –æ–Ω–∏ –Ω–µ –º–µ–Ω—è–ª–∏—Å—å, –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å —Å–≤–æ–π –∫–æ–¥ –Ω–∏–∂–µ –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø—Ä–æ–ø–∞–ª–æ)
            function startMessageListener(chatId, fid, createdTime) {
                db.collection('chats').doc(chatId).collection('msgs').orderBy('ts', 'desc').limit(1).onSnapshot(msgSnap => {
                    const lastEl = document.getElementById('last-' + chatId);
                    const dateEl = document.getElementById('date-' + chatId);
                    const statusEl = document.getElementById('status-' + chatId);
                    const userDiv = document.getElementById('u-' + fid);
                    let timeToDisplay = createdTime;

                    if (!msgSnap.empty) {
                        const lastData = msgSnap.docs[0].data();
                        if (lastEl) {
                            let shortTxt = lastData.txt;
                            if (shortTxt.length > 25) shortTxt = shortTxt.substring(0, 25) + '...';
                            if (lastData.from === currentUser.uid) shortTxt = '–í—ã: ' + shortTxt;
                            lastEl.innerHTML = shortTxt;
                        }
                        if (lastData.ts) timeToDisplay = lastData.ts.toMillis();
                        if (statusEl) {
                            if (lastData.from === currentUser.uid) {
                                statusEl.innerHTML = lastData.read ? '<span style="margin-right:-4px;">‚úì</span>‚úì' : '‚úì';
                                statusEl.style.display = 'inline-flex';
                            } else { statusEl.style.display = 'none'; }
                        }
                    } else {
                        if (lastEl) lastEl.innerHTML = "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π";
                        if (statusEl) statusEl.style.display = 'none';
                    }
                    if (dateEl && timeToDisplay > 0) {
                        const date = new Date(timeToDisplay);
                        const now = new Date();
                        if (date.toDateString() === now.toDateString()) {
                            dateEl.innerText = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
                        } else {
                            dateEl.innerText = date.getDate() + '.' + (date.getMonth() + 1);
                        }
                    }
                    if (userDiv) { userDiv.setAttribute('data-time', timeToDisplay); sortFriendsList(); }
                });
                db.collection('chats').doc(chatId).collection('msgs').where('to', '==', currentUser.uid).where('read', '==', false).onSnapshot(unreadSnap => {
                    const badgeEl = document.getElementById('badge-' + chatId);
                    const count = unreadSnap.size;
                    if (typeof unreadCounts !== 'undefined') { unreadCounts[chatId] = count; updateTotalFriendsBadge(); }
                    if (badgeEl) {
                        if (count > 0) { badgeEl.innerText = count; badgeEl.classList.remove('hidden'); } else { badgeEl.classList.add('hidden'); }
                    }
                });
            }

            function sortFriendsList() { const list = document.getElementById('friendsList'); const items = Array.from(list.children); items.sort((a, b) => { const timeA = parseInt(a.getAttribute('data-time') || 0); const timeB = parseInt(b.getAttribute('data-time') || 0); return timeB - timeA; }); items.forEach(item => list.appendChild(item)); }
            function updateTotalFriendsBadge() { const total = Object.values(unreadCounts).reduce((a, b) => a + b, 0); const el = document.getElementById('friendsBadge'); if (total > 0) { el.innerText = total; el.classList.remove('hidden'); } else { el.classList.add('hidden'); } }
            
            // –í—Å—Ç–∞–≤—å —Å—é–¥–∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (listenForFriendRequests, sendFriendRequestToId, openChat, loadMessages, sendMsg, closeChat, call logic...)
            // –î–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ —è–¥—Ä–æ –ª–æ–≥–∏–∫–∏ —è –ø—Ä–∏–≤–µ–ª –≤—ã—à–µ. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–±–∞–≤—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–≤–æ–Ω–∫–æ–≤ –∏ —á–∞—Ç–∞ —Å—é–¥–∞.
            
            // --- Helper Functions to ensure buttons work ---
            window.authAction = authAction;
            window.loadData = loadData;
            
            // --- Init Logic ---
            // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∑–≤–æ–Ω–∫–æ–≤ –∏ —á–∞—Ç–∞... (—Å–∫–æ–ø–∏—Ä—É–π –∏–∑ —Å–≤–æ–µ–≥–æ –ø—Ä–æ—à–ª–æ–≥–æ —Ñ–∞–π–ª–∞ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∏–∂–µ loadData)
            
            function listenForFriendRequests() {
                db.collection('friend_requests').where('to', '==', currentUser.uid).onSnapshot(snap => {
                    const list = document.getElementById('requestsList');
                    const badge = document.getElementById('requestsBadge');
                    if (snap.size > 0) { badge.innerText = snap.size; badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); }
                    list.innerHTML = '';
                    if (snap.empty) { list.innerHTML = '<div style="padding:20px;text-align:center;color:#888">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</div>'; return; }
                    snap.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement('div');
                        div.className = 'user-item';
                        div.innerHTML = `<div class="user-item-avatar" style="background:#444;display:flex;align-items:center;justify-content:center;">üë§</div><div class="user-name" style="grid-row: 1/span 2; align-self:center;">${data.fromUsername ? '@' + data.fromUsername : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}<div style="font-size:12px; color:#888; font-weight:normal;">–•–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è</div></div><div style="grid-column:3; grid-row:1/span 2; display:flex; gap:10px;"><button onclick="accept('${doc.id}', '${data.from}', '${data.fromEmail}')" style="background:#28a745; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">‚úì</button><button onclick="reject('${doc.id}')" style="background:#dc3545; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">‚úï</button></div>`;
                        list.appendChild(div);
                    });
                });
            }
            window.accept = async (rid, fid, femail) => { await db.collection('friends').add({ users: [currentUser.uid, fid], emails: { [currentUser.uid]: currentUser.email, [fid]: femail }, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); await db.collection('friend_requests').doc(rid).delete(); };
            window.reject = (rid) => { db.collection('friend_requests').doc(rid).delete(); };
            
            // ... (–í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Ñ—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞ –∏ –∑–≤–æ–Ω–∫–æ–≤ –∏–∑ —Å–≤–æ–µ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞: openChat, loadMessages, sendMsg, closeChat, startCall, answerCall, etc.) ...
            // –í—Å—Ç–∞–≤—å –∏—Ö –ø—Ä—è–º–æ –∑–¥–µ—Å—å, –≤–Ω—É—Ç—Ä–∏ <script>
            // –í–ê–ñ–ù–û: —É–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç—ã —Ñ–∏–≥—É—Ä–Ω—ã–º–∏ —Å–∫–æ–±–∫–∞–º–∏ }
            
            // –ü–†–ò–ú–ï–† (–Ω–µ –∑–∞–±—É–¥—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ –ø–æ–ª–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏):
            function openChat(fid, name, nick) { currentFriendId = fid; currentChatId = [currentUser.uid, fid].sort().join('_'); if (window.innerWidth <= 768) { document.getElementById('mainSidebar').classList.add('hidden-mobile'); document.getElementById('mainChatArea').classList.add('active'); } document.getElementById('noChat').classList.add('hidden'); document.getElementById('activeChat').classList.remove('hidden'); document.getElementById('chatTitle').innerHTML = `<div>${name}</div><div style="font-size:11px; font-weight:normal; color:#888;">${nick}</div>`; db.collection('users').doc(fid).onSnapshot(userSnap => { if (userSnap.exists) { document.getElementById('chatStatus').innerText = formatLastSeen(userSnap.data().lastSeen); } }); loadMessages(); }
            function loadMessages() { const list = document.getElementById('msgList'); list.innerHTML = ''; if (msgUnsub) msgUnsub(); const deletedLocal = JSON.parse(localStorage.getItem('deletedMsgs') || '[]'); msgUnsub = db.collection('chats').doc(currentChatId).collection('msgs').orderBy('ts').limitToLast(50).onSnapshot(snap => { const batch = db.batch(); let needCommit = false; let hasNewMessages = false; snap.docChanges().forEach(change => { const d = change.doc; const m = d.data(); const msgId = d.id; if (deletedLocal.includes(msgId)) return; if (change.type === 'removed') { const el = document.getElementById('msg-' + msgId); if (el) el.remove(); return; } let div = document.getElementById('msg-' + msgId); const isNew = !div; if (isNew) { div = document.createElement('div'); div.id = 'msg-' + msgId; div.onclick = (e) => { e.stopPropagation(); openActionSheet(msgId, m.from === currentUser.uid); }; } if (change.type === 'added' && m.to === currentUser.uid && !m.read) { batch.update(d.ref, { read: true }); needCommit = true; } let timeStr = ''; if (m.ts) { const date = m.ts.toDate(); timeStr = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0'); } let ticksHtml = m.read ? '<span style="margin-right: -4px;">‚úì</span>‚úì' : '‚úì'; if (m.sys) { div.className = 'msg msg-sys'; div.innerHTML = m.txt; } else { div.className = m.from === currentUser.uid ? 'msg msg-me' : 'msg msg-other'; div.innerHTML = m.txt + `<span class="msg-meta"><span class="msg-time">${timeStr}</span>${m.from === currentUser.uid ? `<span class="msg-ticks">${ticksHtml}</span>` : ''}</span>`; } if (isNew) { list.appendChild(div); hasNewMessages = true; } }); if (needCommit) batch.commit(); if (hasNewMessages) { setTimeout(() => { list.scrollTop = list.scrollHeight; }, 50); } }); }
            function sendMsg(txt, isSys = false) { const t = txt || document.getElementById('msgInput').value; if (!t) return; const msgData = { txt: t, from: currentUser.uid, to: currentFriendId, sys: isSys, read: false, ts: firebase.firestore.FieldValue.serverTimestamp() }; db.collection('chats').doc(currentChatId).collection('msgs').add(msgData); if (!txt) document.getElementById('msgInput').value = ''; }
            function closeChat() { document.getElementById('mainSidebar').classList.remove('hidden-mobile'); document.getElementById('mainChatArea').classList.remove('active'); document.getElementById('activeChat').classList.add('hidden'); document.getElementById('noChat').classList.remove('hidden'); currentFriendId = null; currentChatId = null; if (msgUnsub) { msgUnsub(); msgUnsub = null; } }
            
            // ... –ò –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–≤–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏ (openActionSheet, confirmDelete, startCall, answerCall, video logic, etc) ... 
            // –ü–†–û–°–¢–û –í–°–¢–ê–í–¨ –í–ï–°–¨ –°–í–û–ô JS –ö–û–î –°–Æ–î–ê, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª —Ä–∞–Ω—å—à–µ
            
            // –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω—É–∂–Ω—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã, —Å–∫–æ–ø–∏—Ä—É–π –∏—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:
            function updateLastSeen() { const now = Date.now(); if (now - lastActivityTime < 30000) { if (currentUser) { db.collection('users').doc(currentUser.uid).update({ lastSeen: firebase.firestore.FieldValue.serverTimestamp() }).catch(e => {}); } } }
            ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(event => { document.addEventListener(event, () => { lastActivityTime = Date.now(); }); });
            setInterval(updateLastSeen, 15000);
            function formatLastSeen(timestamp) { if (!timestamp) return "–±—ã–ª –¥–∞–≤–Ω–æ"; const now = Date.now(); const diff = now - timestamp.toMillis(); const minutes = Math.floor(diff / 60000); if (minutes < 1) return "–≤ —Å–µ—Ç–∏"; if (minutes < 60) return `${minutes} –º–∏–Ω. –Ω–∞–∑–∞–¥`; return "–±—ã–ª –¥–∞–≤–Ω–æ"; }
            function checkNameInput() { const name = document.getElementById('regName').value.trim(); const btn = document.getElementById('btnNameNext'); if (name.length > 0) { btn.disabled = false; btn.style.background = '#007bff'; btn.style.cursor = 'pointer'; } else { btn.disabled = true; btn.style.background = '#444'; btn.style.cursor = 'not-allowed'; } }
            function goToUsernameStep() { document.getElementById('stepName').style.display = 'none'; document.getElementById('stepUsername').style.display = 'block'; }
            function backToName() { document.getElementById('stepUsername').style.display = 'none'; document.getElementById('stepName').style.display = 'block'; }
            let usernameTimeout = null;
            function checkUsernameInput() { let val = document.getElementById('regUsername').value.replace(/[^a-zA-Z0-9_.]/g, ''); document.getElementById('regUsername').value = val; const status = document.getElementById('usernameStatus'); const btn = document.getElementById('btnFinish'); btn.disabled = true; btn.style.background = '#444'; btn.style.cursor = 'not-allowed'; if (val.length < 3) { status.innerText = "–ú–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞"; status.style.color = "#ff4444"; return; } status.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞..."; status.style.color = "#aaa"; if (usernameTimeout) clearTimeout(usernameTimeout); usernameTimeout = setTimeout(() => { db.collection('users').where('username', '==', val).get().then(snap => { if (snap.empty) { status.innerText = "–°–≤–æ–±–æ–¥–Ω–æ"; status.style.color = "#4caf50"; btn.disabled = false; btn.style.background = '#007bff'; btn.style.cursor = 'pointer'; } else { status.innerText = "–ó–∞–Ω—è—Ç–æ"; status.style.color = "#ff4444"; } }); }, 500); }
            function finishRegistration() { const name = document.getElementById('regName').value.trim(); const surname = document.getElementById('regSurname').value.trim(); const username = document.getElementById('regUsername').value.trim(); if (!name || !username) return; db.collection('users').doc(currentUser.uid).set({ name: name, surname: surname, username: username, email: currentUser.email, lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true }).then(() => { document.getElementById('authScreen').classList.add('hidden'); loadData(); listenForIncomingCalls(); loadTgId(); }); }
            function openActionSheet(msgId, isMine) { selectedMsgId = msgId; selectedMsgIsMine = isMine; document.getElementById('overlaySheet').style.display = 'block'; setTimeout(() => { document.getElementById('actionSheet').classList.add('open'); }, 10); }
            function openDeleteSheet() { document.getElementById('actionSheet').classList.remove('open'); setTimeout(() => { document.getElementById('deleteSheet').classList.add('open'); }, 100); }
            function confirmDelete(mode) { if (!selectedMsgId) return; if (mode === 'all') { db.collection('chats').doc(currentChatId).collection('msgs').doc(selectedMsgId).delete(); } else if (mode === 'me') { const el = document.getElementById(`msg-${selectedMsgId}`); if (el) el.style.display = 'none'; const deletedLocal = JSON.parse(localStorage.getItem('deletedMsgs') || '[]'); deletedLocal.push(selectedMsgId); localStorage.setItem('deletedMsgs', JSON.stringify(deletedLocal)); } closeAllSheets(); }
            function closeAllSheets() { document.getElementById('actionSheet').classList.remove('open'); document.getElementById('deleteSheet').classList.remove('open'); document.getElementById('profileSheet').classList.remove('open'); setTimeout(() => { document.getElementById('overlaySheet').style.display = 'none'; }, 300); selectedMsgId = null; }
            function openProfileSheet() { document.getElementById('overlaySheet').style.display = 'block'; setTimeout(() => document.getElementById('profileSheet').classList.add('open'), 10); db.collection('users').doc(currentUser.uid).get().then(doc => { if (doc.exists) { const d = doc.data(); document.getElementById('profileEmail').innerText = d.email; document.getElementById('profileUsername').value = d.username || ''; document.getElementById('profileName').value = d.name || ''; document.getElementById('profileSurname').value = d.surname || ''; document.getElementById('tgChatId').value = d.tgChatId || ''; if (d.avatar) { const img = document.getElementById('profileAvatarPreview'); const ph = document.getElementById('profileAvatarPlaceholder'); img.src = d.avatar; img.style.display = 'block'; ph.style.display = 'none'; } } }); }
            async function saveProfile() { const username = document.getElementById('profileUsername').value.trim(); const name = document.getElementById('profileName').value.trim(); if (!name || !username) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è"); const snap = await db.collection('users').where('username', '==', username).get(); let isTaken = false; snap.forEach(doc => { if (doc.id !== currentUser.uid) isTaken = true; }); if (isTaken) return alert("–ù–∏–∫–Ω–µ–π–º –∑–∞–Ω—è—Ç"); const updateData = { name: name, surname: document.getElementById('profileSurname').value.trim(), username: username, tgChatId: document.getElementById('tgChatId').value.trim() }; if (window.currentAvatarBase64) updateData.avatar = window.currentAvatarBase64; db.collection('users').doc(currentUser.uid).set(updateData, { merge: true }).then(() => { alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"); closeAllSheets(); }); }
            function handleAvatarSelect(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function (e) { const img = new Image(); img.src = e.target.result; img.onload = function () { const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d'); canvas.width = 300; canvas.height = 300; ctx.drawImage(img, 0, 0, 300, 300); window.currentAvatarBase64 = canvas.toDataURL('image/jpeg', 0.7); document.getElementById('profileAvatarPreview').src = window.currentAvatarBase64; document.getElementById('profileAvatarPreview').style.display = 'block'; document.getElementById('profileAvatarPlaceholder').style.display = 'none'; }; }; reader.readAsDataURL(input.files[0]); } }
            async function logout() { if (!confirm("–í—ã–π—Ç–∏?")) return; const user = firebase.auth().currentUser; if (user) { await db.collection('users').doc(user.uid).update({ oneSignalId: firebase.firestore.FieldValue.delete() }).catch(e=>{}); } localStorage.removeItem('isLoggedIn'); auth.signOut().then(() => window.location.reload()); }
            function loadTgId() { if (currentUser) db.collection('users').doc(currentUser.uid).get().then(doc => { if (doc.exists && doc.data().tgChatId) document.getElementById('tgChatId').value = doc.data().tgChatId; }); }
            function getTgToken() { return atob(ENCRYPTED_TOKEN); }
            function sendTelegramNotification(targetChatId, text) { const url = `https://api.telegram.org/bot${getTgToken()}/sendMessage`; fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ chat_id: targetChatId, text: text, parse_mode: 'Markdown' }) }).catch(e => {}); }
            function startCall() { alert("–§—É–Ω–∫—Ü–∏—è –∑–≤–æ–Ω–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–∑ –≤–∞—à–µ–≥–æ –ø–æ–ª–Ω–æ–≥–æ –∫–æ–¥–∞ (—Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)"); /* –°–Æ–î–ê –í–°–¢–ê–í–¨ –ü–û–õ–ù–´–ô –ö–û–î –ó–í–û–ù–ö–û–í */ }
            // ... –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–≤–æ–Ω–∫–æ–≤ ...
        
        } else {
            console.error("Firebase SDK not loaded");
            document.body.innerHTML = "<h2 style='color:white;text-align:center;margin-top:50px;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.</h2>";
        }
    </script>
</body>
</html>
