<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f1f1f" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <meta name="color-scheme" content="dark">
    <meta name="theme-color" content="#1f1f1f">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Novogram</title>
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <style>
        * {
            box-sizing: border-box;
        }

        /* --- –ó–ê–ü–†–ï–¢ –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø –ò –í–´–î–ï–õ–ï–ù–ò–Ø --- */
        body {
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+/Edge */
            user-select: none; /* Standard */
        }



            /* --- –≠–§–§–ï–ö–¢ –î–û–õ–ì–û–ì–û –ù–ê–ñ–ê–¢–ò–Ø (iOS –°–¢–ò–õ–¨) --- */

            /* –ü–ª–∞–≤–Ω–æ —Ä–∞–∑–º—ã–≤–∞–µ–º –∏ –∑–∞—Ç–µ–º–Ω—è–µ–º –≤—Å—ë –≤–æ–∫—Ä—É–≥ */
            body.chat-blur-active .chat-header,
            body.chat-blur-active .input-bar,
            body.chat-blur-active .floating-date,
            body.chat-blur-active .chat-date-separator {
                filter: blur(4px) brightness(0.7);
                pointer-events: none;
                transition: all 0.3s ease;
            }

            /* –†–∞–∑–º—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –ö–†–û–ú–ï –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ */
            body.chat-blur-active .msg:not(.msg-highlighted) {
                filter: blur(4px) brightness(0.7);
                pointer-events: none;
            }

        /* –°–∞–º–æ —Å–æ–æ–±—â–µ–Ω–∏–µ */
        .msg {
            transition: transform 0.2s ease, filter 0.3s ease, brightness 0.3s ease;
            -webkit-touch-callout: none; /* –û—Ç–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ –º–µ–Ω—é –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è iOS */
            -webkit-user-select: none;
            user-select: none;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç "–≤—ã–¥–∞–≤–ª–∏–≤–∞–Ω–∏—è" –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .msg-highlighted {
            transform: scale(1.03) !important;
            box-shadow: 0 10px 35px rgba(0,0,0,0.6);
            z-index: 1000; /* –ü–æ–¥–Ω–∏–º–∞–µ–º –Ω–∞–¥ –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ */
        }

        /* –†–∞–∑—Ä–µ—à–∞–µ–º –≤—ã–¥–µ–ª—è—Ç—å —Ç–µ–∫—Å—Ç —Ç–æ–ª—å–∫–æ –≤ –∏–Ω–ø—É—Ç–∞—Ö –∏ —Ç–µ–∫—Å—Ç–∞—Ä–µ—è—Ö */
        input, textarea {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #121212;
            color: #eee;
            margin: 0;
            display: flex;
            /* --- –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ó–î–ï–°–¨ --- */
            position: fixed; /* –§–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0; /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –¥–æ –Ω–∏–∑–∞. –ö–æ–≥–¥–∞ –∫–ª–∞–≤–∞ –≤—ã–π–¥–µ—Ç, bottom –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è */
            height: 100dvh; /* –£–±–∏—Ä–∞–µ–º 100dvh */
            width: 100%;
            /* ----------------------- */

            overflow: hidden;
            overscroll-behavior-y: none;
        }

        /* =========================================
   –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–û–ì–û –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø 
   ========================================= */
        .is-app .chat-date-separator,
        .is-app .floating-date {
            /* –û—Ç–∫–ª—é—á–∞–µ–º —Ç—è–∂–µ–ª–æ–µ —Ä–∞–∑–º—ã—Ç–∏–µ –≤ WebView, –æ–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç —Ç–æ—Ä–º–æ–∑–∞ –Ω–∞ Android */
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            /* –î–µ–ª–∞–µ–º —Ñ–æ–Ω —á—É—Ç—å –±–æ–ª–µ–µ –ø–ª–æ—Ç–Ω—ã–º, —á—Ç–æ–±—ã –∫–æ–º–ø–µ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –±–ª—é—Ä–∞ */
            background: rgba(40, 40, 40, 0.95) !important;
        }

        .is-app .messages {
            /* –í–∫–ª—é—á–∞–µ–º –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ */
            -webkit-overflow-scrolling: touch;
            will-change: scroll-position;
        }


        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212;
            z-index: 6000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .auth-box {
            width: 300px;
            padding: 25px;
            background: #2d2d2d;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #444;
        }

            .auth-box input {
                width: 100%;
                padding: 12px;
                margin: 8px 0;
                background: #444;
                border: 1px solid #555;
                color: white;
                border-radius: 6px;
            }

            .auth-box button {
                width: 100%;
                padding: 12px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                margin-top: 10px;
            }




        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar {
            width: 320px;
            background: #1f1f1f;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .profile-bar {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #252525; /* –ò–ª–∏ –≤–∞—à —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ */
        }


        /* –ö–Ω–æ–ø–∫–∞ –≤ —Å–∞–π–¥–±–∞—Ä–µ */
        #profileBtn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #2d2d2d;
            border: 1px solid #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden; /* –≠—Ç–æ –æ–±—Ä–µ–∂–µ—Ç –≤—Å—ë, —á—Ç–æ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –∫—Ä—É–≥–∞ */
            padding: 0; /* –£–±–∏—Ä–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã –∫–Ω–æ–ø–∫–∏ */
        }


        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏ */
        #myAvatarSmall {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }


            /* –°–∞–º–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∞ */
            #myAvatarSmall img {
                width: 100%;
                height: 100%;
                object-fit: cover; /* –ß—Ç–æ–±—ã —Ñ–æ—Ç–æ –Ω–µ —Å–ø–ª—é—â–∏–≤–∞–ª–æ—Å—å, –∞ –∑–∞–ø–æ–ª–Ω—è–ª–æ –∫—Ä—É–≥ */
                display: block;
            }


        #searchInput {
            width: 100%;
            height: 44px;
            padding: 0 15px;
            border-radius: 22px; /* –í–æ—Ç —ç—Ç–æ –¥–µ–ª–∞–µ—Ç –µ–≥–æ –∫—Ä—É–≥–ª—ã–º */
            border: 1px solid #333;
            background: #181818;
            color: white;
            font-size: 14px;
            outline: none;
            transition: 0.2s;
        }

            #searchInput:focus {
                border-color: #007bff; /* –°–∏–Ω—è—è –æ–±–≤–æ–¥–∫–∞ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
            }

        .tabs {
            display: flex;
            background: #252525;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #888;
            font-size: 14px;
            position: relative;
        }

            .tab.active {
                border-bottom: 2px solid #007bff;
                color: white;
            }

        .tab-badge {
            background: #ff4444;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            position: absolute;
            top: 5px;
            right: 10px;
            /* –ü–ª–∞–≤–Ω–æ—Å—Ç—å */
            display: block !important;
            opacity: 1;
            transform: scale(1);
            transition: opacity 0.2s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

            .tab-badge.hidden {
                display: block !important;
                opacity: 0 !important;
                transform: scale(0) !important;
            }

        .list-container {
            flex: 1;
            overflow-y: auto;
        }




        /* –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ (–ù–û–í–´–ô –î–ò–ó–ê–ô–ù) */

        /* –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ */
        .user-item {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            display: grid;
            grid-template-columns: 55px 1fr auto; /* –ê–≤–∞—Ç–∞—Ä | –ò–º—è+–¢–µ–∫—Å—Ç | –ú–µ—Ç–∞ (–≤—Ä–µ–º—è, –≥–∞–ª–æ—á–∫–∏, —Å—á–µ—Ç—á–∏–∫) */
            grid-template-rows: auto auto;
            column-gap: 10px;
            align-items: center;
            cursor: pointer;
            transition: 0.2s;
            min-height: 72px;
        }

            .user-item:hover {
                background: #2a2a2a;
            }

        .user-item-avatar {
            grid-column: 1;
            grid-row: 1 / span 2;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            grid-column: 2;
            grid-row: 1;
            font-weight: 600;
            font-size: 16px;
            color: white;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            align-self: end;
        }

        .last-msg-row {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            align-items: center;
            overflow: hidden;
            align-self: start;
        }

        .last-msg {
            font-size: 14px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }




        /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –í—Ä–µ–º—è (—Å–≤–µ—Ä—Ö—É) –∏ –ì–∞–ª–æ—á–∫–∏/–°—á–µ—Ç—á–∏–∫ (—Å–Ω–∏–∑—É) */
        .meta-column {
            grid-column: 3;
            grid-row: 1 / span 2;
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* –í—Å–µ –ø—Ä–∏–∂–∞—Ç–æ –≤–ø—Ä–∞–≤–æ */
            justify-content: center;
            gap: 5px;
            min-width: 65px;
        }

        .last-msg-date {
            font-size: 13px;
            color: #888;
        }




        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ (–ì–∞–ª–æ—á–∫–∏ –ò–õ–ò –°—á–µ—Ç—á–∏–∫) */
        .meta-bottom-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            height: 20px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
        }




        /* –ì–∞–ª–æ—á–∫–∏ - —Ç–µ–ø–µ—Ä—å –±–µ–ª—ã–µ –∏ –≤ –ø—Ä–∞–≤–æ–º —É–≥–ª—É */
        .list-ticks {
            display: inline-flex;
            font-size: 14px; /* –ß—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ */
            color: white !important; /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –±–µ–ª—ã–µ */
        }

            .list-ticks span {
                color: white !important;
            }

        .badge-count {
            background: #736AF0;
            color: white;
            font-size: 12px;
            padding: 2px 9px;
            border-radius: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            line-height: 1.2;
            /* –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ */
            display: block !important;
            opacity: 1;
            transform: scale(1);
            transform-origin: center;
            transition: opacity 0.2s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), max-width 0.2s ease, min-width 0.2s ease, padding 0.2s ease, margin 0.2s ease;
            max-width: 40px;
            overflow: hidden;
            white-space: nowrap;
        }

            /* –°–æ—Å—Ç–æ—è–Ω–∏–µ, –∫–æ–≥–¥–∞ —Å–∫—Ä–∏–ø—Ç –ø—Ä—è—á–µ—Ç —Å—á–µ—Ç—á–∏–∫ (–ø—Ä–æ—á–∏—Ç–∞–Ω–æ) */
            .badge-count.hidden {
                display: block !important; /* –ë–ª–æ–∫–∏—Ä—É–µ–º —Ä–µ–∑–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ */
                opacity: 0 !important;
                transform: scale(0) !important; /* –°—Ö–ª–æ–ø—ã–≤–∞–µ–º –≤ —Ç–æ—á–∫—É */
                max-width: 0 !important;
                min-width: 0 !important;
                padding-left: 0 !important;
                padding-right: 0 !important;
                margin-left: 0 !important; /* –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø */
                border: none !important;
            }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
            position: relative;
            z-index: 1;
        }




        /* –§–æ–Ω —Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç" */
        #noChat {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            position: relative;
            overflow: hidden;
        }

        #noChat {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            position: relative;
            overflow: hidden;
            background-color: #0a0c10;
        }

            #noChat > div {
                position: relative;
                z-index: 2;
                font-size: 18px;
                font-weight: 500;
            }

        @keyframes scrollPattern {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-10%, -10%);
            }
        }

        .chat-header {
            padding: 8px 15px; /* –ö–∞–∫ –≤ –¢–ì */
            background: #212121; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ —à–∞–ø–∫–∏ –¢–ì */
            border-bottom: 1px solid #101010;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 56px;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            overflow: hidden;
            cursor: pointer;
        }

        .chat-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            overflow: hidden;
        }



        .back-btn {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            margin-left: -5px;
            border-radius: 50%;
            transition: background 0.2s;
        }

            .back-btn:active {
                background: rgba(255,255,255,0.1);
            }

        .chat-header-info {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 2px;
            overflow: hidden;
        }

        .chat-title {
            font-weight: 600;
            font-size: 15px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-status {
            font-size: 13px;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-icon-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

            .header-icon-btn:hover {
                background: rgba(255, 255, 255, 0.08);
            }

            .header-icon-btn:active {
                background: rgba(255, 255, 255, 0.15);
            }

        /* --- –°–í–ê–ô–ü –í–õ–ï–í–û –î–õ–Ø –û–¢–í–ï–¢–ê (TELEGRAM STYLE) --- */
        .messages {
            overflow-x: hidden !important; /* –í–∞–∂–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–≤–∞–π–ø–µ –Ω–µ –ø–æ—è–≤–ª—è–ª—Å—è –ø–æ–ª–∑—É–Ω–æ–∫ */
        }

        .msg-deleting {
            opacity: 0 !important;
            transform: scale(0.8) !important;
            /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é, —á—Ç–æ–±—ã —Å—Ö–ª–æ–ø—ã–≤–∞–ª–∞—Å—å –≤—ã—Å–æ—Ç–∞ –∏ –æ—Ç—Å—Ç—É–ø—ã */
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
        }

        .msg {
            transition: transform 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        

            .msg.swiping {
                transition: none !important; /* –û—Ç–∫–ª—é—á–∞–µ–º –ø–ª–∞–≤–Ω–æ—Å—Ç—å, –ø–æ–∫–∞ –ø–∞–ª–µ—Ü –¥–≤–∏–≥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ */
            }

        .swipe-reply-icon {
            position: absolute;
            right: -45px; /* –ü—Ä—è—á–µ–º –∑–∞ –ø—Ä–∞–≤—ã–º –∫—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è */
            top: 50%;
            margin-top: -15px; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º */
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transform: scale(0.5);
            opacity: 0;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s, background 0.2s;
            z-index: -1;
        }

            .swipe-reply-icon.active {
                transform: scale(1);
                opacity: 1;
                background: #736AF0; /* –û–∫—Ä–∞—à–∏–≤–∞–µ–º –≤ —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Ü–≤–µ—Ç –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ */
            }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            background: transparent;
            position: relative;
            z-index: 1;
            min-height: 0;
            transition: opacity 0.15s ease-out; /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ */
        }

            .messages.visible {
                opacity: 1;
            }

            .messages::before {
                content: "";
                margin-top: auto;
            }




            /* –í–∞–∂–Ω–æ! –°–æ–æ–±—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –í–´–®–ï —Ñ–æ–Ω–∞ */
            .messages > * {
                position: relative;
                z-index: 1;
            }



        /* --- –ù–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ –í–í–û–î–ê (TELEGRAM STYLE) --- */
        .input-bar {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            background: #1f1f1f; /* –¶–≤–µ—Ç –ø–∞–Ω–µ–ª–∏ */
            min-height: 56px;
            padding: 8px;
            display: flex;
            align-items: flex-end; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –Ω–∏–∑—É */
            gap: 8px;
            position: relative;
            z-index: 5;
            padding: 8px 8px calc(8px + env(safe-area-inset-bottom)) 8px;
        }

        /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–π –ø–ª–∞–≤–∞—é—â–∏–π –±–∞—Ä –¢–û–õ–¨–ö–û –¥–ª—è –≤–µ–±-–≤–µ—Ä—Å–∏–∏ (–ü–ö) */
        @media (min-width: 769px) {
            .input-bar {
                border-radius: 16px;
                margin: 0 auto 20px auto; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∏ –¥–µ–ª–∞–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É */
                width: calc(100% - 40px); /* –û—Ç—Å—Ç—É–ø—ã –ø–æ –±–æ–∫–∞–º */
            }
        }

        /* –°–µ—Ä—ã–π –±–ª–æ–∫ –≤–≤–æ–¥–∞ */
        .input-wrapper {
            flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ */
            background: #181818; /* –¶–≤–µ—Ç –ø–æ–ª—è –≤–≤–æ–¥–∞ */
            border-radius: 20px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
            display: flex;
            align-items: center;
            min-height: 42px;
            padding: 0 12px;
            transition: border-color 0.2s;
            border: 1px solid transparent;
        }

            .input-wrapper:focus-within {
                border-color: rgba(255, 255, 255, 0.15); /* –í–º–µ—Å—Ç–æ —Å–∏–Ω–µ–≥–æ ‚Äî –ª–µ–≥–∫–∞—è —Å–≤–µ—Ç–ª–∞—è –æ–±–≤–æ–¥–∫–∞ */
                background: #1c1c1c; /* –ü–æ–ª–µ —á—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ—Ç –ø—Ä–∏ –≤–≤–æ–¥–µ */
            }

            /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ */
            .input-wrapper textarea {
                flex: 1;
                background: transparent;
                border: none;
                color: white;
                font-size: 16px;
                padding: 10px 0;
                line-height: 20px;
                height: 40px; /* –°—Ç—Ä–æ–≥–æ 1 —Å—Ç—Ä–æ–∫–∞ (20px —Ç–µ–∫—Å—Ç + 20px –æ—Ç—Å—Ç—É–ø—ã) */
                min-height: 40px;
                max-height: 100px;
                outline: none;
                resize: none;
                font-family: inherit;
                overflow-y: hidden; /* –í–ê–ñ–ù–û: –£–±–∏–≤–∞–µ—Ç —Ñ–∞–Ω—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä, –¥–µ–ª–∞—é—â–∏–π 2 —Å—Ç—Ä–æ–∫–∏ */
                scrollbar-width: none;
                box-sizing: border-box;
                display: block;
                -webkit-user-select: text !important;
                user-select: text !important;
            }

                .input-wrapper textarea::-webkit-scrollbar {
                    display: none;
                }

        /* –ö–Ω–æ–ø–∫–∏ –∏–∫–æ–Ω–∫–∏ (–°–∫—Ä–µ–ø–∫–∞ –∏ –°–º–∞–π–ª) */
        .tg-icon-btn-input {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: none;
            border: none;
            color: #888;
            transition: 0.2s;
            padding: 0;
            flex-shrink: 0; /* –ß—Ç–æ–±—ã –Ω–µ —Å–∂–∏–º–∞–ª–∏—Å—å */
        }

            .tg-icon-btn-input:hover {
                color: #aaa;
            }

            .tg-icon-btn-input svg {
                width: 24px;
                height: 24px;
                fill: currentColor;
            }

        /* –ö—Ä—É–≥–ª–∞—è –∫–Ω–æ–ø–∫–∞ —Å–ø—Ä–∞–≤–∞ (–ú–∏–∫—Ä–æ—Ñ–æ–Ω / –°–∞–º–æ–ª–µ—Ç–∏–∫) */
        .main-action-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* –í–ê–ñ–ù–û: –ó–∞–ø—Ä–µ—â–∞–µ—Ç –∫–Ω–æ–ø–∫–µ —Å–ø–ª—é—â–∏–≤–∞—Ç—å—Å—è! */
            transition: transform 0.2s, background 0.2s;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (—Å–µ—Ä—ã–π —Ñ–æ–Ω) */
        .btn-mic {
            background: #2d2d2d;
            color: #fff;
        }

            .btn-mic:active {
                transform: scale(0.95);
            }

        /* –°—Ç–∏–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (—Å–∏–Ω–∏–π —Ñ–æ–Ω) */
        .btn-send {
            background: #007bff;
            color: white;
        }

            .btn-send:active {
                transform: scale(0.95);
            }

        .hidden {
            display: none !important;
        }








        .voice-btn {
            background: #2d2d2d; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ */
            color: white;
        }

            .voice-btn:hover {
                background: #333;
            }

        .send-btn {
            background: #007bff; /* –°–∏–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ */
            color: white;
            padding-left: 5px; /* –í–∏–∑—É–∞–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–µ–ª–æ—á–∫—É */
        }

            .send-btn:hover {
                background: #0056b3;
            }






        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è */
        .msg {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
            cursor: pointer;
            word-wrap: break-word; /* –ß—Ç–æ–±—ã –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª–∏—Å—å */
        }




        /* –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–ø—Ä–∞–≤–∞) - —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ */
        .msg-me {
            align-self: flex-end;
            background: #736AF0; /* –ö—Ä–∞—Å–∏–≤—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ */
            color: white;
            border-bottom-right-radius: 2px;
        }




        /* –ß—É–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–ª–µ–≤–∞) - —Å–µ—Ä—ã–µ */
        .msg-other {
            align-self: flex-start;
            background: #2d2d2d; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π */
            color: white;
            border-bottom-left-radius: 2px;
        }




        /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–∞—Ç—ã –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ) */
        .msg-sys {
            align-self: center;
            background: rgba(34, 34, 34, 0.6);
            font-size: 12px;
            color: #ccc;
            padding: 4px 12px;
            border-radius: 12px;
            margin: 8px 0;
            backdrop-filter: blur(5px);
        }

        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ó–í–û–ù–ö–û–í –í –ß–ê–¢–ï (TELEGRAM STYLE) --- */
        .chat-call-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 4px 10px 4px 4px;
            min-width: 170px;
        }

        .call-icon-wrapper {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
        }

        .msg-me .call-icon-wrapper {
            background: rgba(255, 255, 255, 0.2);
        }

        .call-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .call-title {
            font-weight: 600;
            font-size: 15px;
            color: white;
            line-height: 1.1;
        }

        .call-time {
            font-size: 13px;
            display: flex;
            align-items: center;
            line-height: 1;
        }



        /* –ë–ª–æ–∫ –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–≤—Ä–µ–º—è + –≥–∞–ª–æ—á–∫–∏) */

        /* –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤—Ä–µ–º—è + –≥–∞–ª–æ—á–∫–∏) */

        /* –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤—Ä–µ–º—è + –≥–∞–ª–æ—á–∫–∏) */
        .msg-meta {
            float: right;
            margin-left: 7px;
            margin-top: 6px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            vertical-align: bottom;
            position: relative;
            top: 3px;
            white-space: nowrap; /* –í–∞–∂–Ω–æ: –∑–∞–ø—Ä–µ—â–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–∞-–±–ª–æ–∫–∞ */
            height: 14px;
            line-height: 1;
        }

        .msg-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-right: 2px;
        }

        .msg-ticks {
            font-size: 12px;
            color: white; /* –í—Å–µ–≥–¥–∞ –±–µ–ª—ã–µ */
            display: none;
            font-weight: bold;
        }

        .msg-me .msg-ticks {
            display: inline-block;
        }




        /* –ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –≥–∞–ª–æ—á–∫–∏ (—Ç–µ–ø–µ—Ä—å –æ–Ω–∏ —Ç–æ–∂–µ –±–µ–ª—ã–µ, —Ü–≤–µ—Ç –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è) */
        .tick-read {
            color: white;
        }




        /* –®—Ç–æ—Ä–∫–∏ */
        .overlay-sheet {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 4999;
            display: none;
        }

        .search-section-title {
            padding: 8px 15px;
            font-size: 12px;
            font-weight: bold;
            color: #007bff;
            background: #2a2a2a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-sheet {
            /* –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ */
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1f1f1f;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 20px;
            z-index: 5000;
            transform: translateY(100%);
            /* –î–û–ë–ê–í–õ–Ø–ï–ú –≠–¢–û: —Å–∫—Ä—ã–≤–∞–µ–º –æ—Ç —Ç–∞–±–∞/—Ñ–æ–∫—É—Å–∞, –∫–æ–≥–¥–∞ –∑–∞–∫—Ä—ã—Ç–æ */
            visibility: hidden;
            transition: transform 0.3s, visibility 0s linear 0.3s;
        }

            .action-sheet.open {
                transform: translateY(0);
                /* –î–û–ë–ê–í–õ–Ø–ï–ú –≠–¢–û: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ */
                visibility: visible;
                transition: transform 0.3s, visibility 0s;
            }

        .action-btn {
            background: #2d2d2d;
            border: none;
            padding: 15px;
            color: white;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
        }

            .action-btn:active {
                background: #333;
            }

            .action-btn.delete {
                color: #ff4444;
            }

        .sheet-title {
            color: #777;
            font-size: 13px;
            text-align: center;
            margin-bottom: 5px;
        }




        /* –ü—Ä–æ—Ñ–∏–ª—å –®—Ç–æ—Ä–∫–∞ */
        .profile-option {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

            .profile-option h3 {
                margin: 0 0 10px 0;
                font-size: 15px;
                color: #ddd;
            }

        .profile-input-group {
            display: flex;
            gap: 10px;
        }




        /* –ó–≤–æ–Ω–∫–∏ */
        .call-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 4000;
            display: none;
            flex-direction: column;
            transition: opacity 0.5s;
        }

        .video-grid {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .local-video-container {
            position: absolute;
            bottom: 160px;
            right: 20px;
            /* –£–í–ï–õ–ò–ß–ï–ù–ù–´–ï –†–ê–ó–ú–ï–†–´ */
            width: 140px; /* –ë—ã–ª–æ 100px */
            height: 210px; /* –ë—ã–ª–æ 150px (–ø—Ä–æ–ø–æ—Ä—Ü–∏—è 2:3 —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞) */
            /* –ö–†–ê–°–ò–í–û–ï –°–ö–†–£–ì–õ–ï–ù–ò–ï */
            border-radius: 18px; /* –°–∏–ª—å–Ω–µ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–æ (–±—ã–ª–æ 10px) */
            overflow: hidden;
            /* –£–¢–û–ù–ß–ï–ù–ù–ê–Ø –†–ê–ú–ö–ê */
            border: 2px solid rgba(255, 255, 255, 0.2); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –±–µ–ª–∞—è —Ä–∞–º–∫–∞ –≤—ã–≥–ª—è–¥–∏—Ç —Å—Ç–∏–ª—å–Ω–µ–µ */
            /* –¢–ï–ù–¨ –î–õ–Ø –û–ë–™–ï–ú–ê */
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
            z-index: 4002;
            display: block;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è */
        }

        #localVideo {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important; /* <--- –£–±–∏—Ä–∞–µ—Ç —á–µ—Ä–Ω—ã–µ –ø–æ–ª–æ—Å—ã, –æ–±—Ä–µ–∑–∞—è –ª–∏—à–Ω–µ–µ */
            position: absolute; /* <--- –§–∏–∫—Å–∏—Ä—É–µ—Ç –≤–∏–¥–µ–æ –≤ —É–≥–ª—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            top: 0;
            left: 0;
            background: #000;
        }

            #localVideo.mirror {
                transform: scaleX(-1);
            }

        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px 10px 40px 10px;
            z-index: 4003;
            background: #18191c;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 70px;
        }

        .control-label {
            font-size: 11px;
            color: #b5bac1;
            white-space: nowrap;
        }

        .btn-circle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            transition: 0.2s;
            background: #2b2d31;
            color: #dbdee1;
        }

            .btn-circle:active {
                transform: scale(0.95);
            }

        .btn-active-white {
            background: #f2f3f5 !important;
            color: #313338 !important;
        }

        .btn-hangup {
            background: #da373c !important;
            color: white !important;
        }

        .btn-screen-on {
            background: #248046 !important;
            color: white !important;
        }

        .incoming-call {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            padding: 15px 25px;
            border-radius: 30px;
            z-index: 5000;
            display: none;
            align-items: center;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            border: 1px solid #444;
            width: 90%;
            max-width: 400px;
            justify-content: space-between;
        }

        .timer-badge {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 20px;
            color: #fff;
            z-index: 4003;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }

        #callStatusText {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #callTimer {
            font-size: 18px;
            font-family: monospace;
            font-weight: bold;
        }

        #callPing {
            font-size: 11px;
            color: #4caf50;
            margin-top: 5px;
            opacity: 0.9;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                border-right: none;
                transition: transform 0.35s ease;
            }

                /* –°–∞–π–¥–±–∞—Ä –ø–ª–∞–≤–Ω–æ –æ—Ç—ä–µ–∑–∂–∞–µ—Ç –≤–ª–µ–≤–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ */
                .sidebar.hidden-mobile {
                    transform: translateX(-30%);
                    pointer-events: none;
                }

            .chat-area {
                display: flex !important;
                width: 100%;
                position: fixed;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 100; /* –ü–æ–¥–Ω–∏–º–∞–µ–º –≤—ã—à–µ —Å–∞–π–¥–±–∞—Ä–∞ */
                /* --- –°–ê–ú–û–ï –ì–õ–ê–í–ù–û–ï: –î–ï–õ–ê–ï–ú –§–û–ù 100% –ù–ï–ü–†–û–ó–†–ê–ß–ù–´–ú --- */
                background-color: #0a0c10 !important;
                transform: translateX(100%);
                visibility: hidden;
                transition: transform 0.35s cubic-bezier(0.25, 1, 0.5, 1), visibility 0.35s;
            }

                /* –ö–æ–ø–∏—Ä—É–µ–º –≤–∞—à–∏ –∫—Ä–∞—Å–∏–≤—ã–µ —ç–º–æ–¥–∑–∏-–æ–±–æ–∏ –ø—Ä—è–º–æ –Ω–∞ –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω —á–∞—Ç–∞ */
                .chat-area::before {
                    content: "";
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    opacity: 0.7;
                    pointer-events: none;
                    z-index: -1;
                    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='500' viewBox='0 0 500 500'%3E%3Cstyle%3E text %7B font-family: 'Segoe UI Emoji', 'Apple Color Emoji', sans-serif; %7D %3C/style%3E%3C!-- –ò–ö–û–ù–ö–ò --%3E%3Ctext x='40' y='60' font-size='36' fill='%234a9eff' fill-opacity='0.4' transform='rotate(12 40 60)'%3EüéÆ%3C/text%3E%3Ctext x='380' y='120' font-size='40' fill='%237c3aed' fill-opacity='0.35' transform='rotate(-15 380 120)'%3EüöÄ%3C/text%3E%3Ctext x='220' y='400' font-size='38' fill='%2306b6d4' fill-opacity='0.4' transform='rotate(8 220 400)'%3Eüéß%3C/text%3E%3Ctext x='180' y='90' font-size='28' fill='%23ec4899' fill-opacity='0.35' transform='rotate(-10 180 90)'%3Eüí°%3C/text%3E%3Ctext x='90' y='250' font-size='30' fill='%2310b981' fill-opacity='0.3' transform='rotate(20 90 250)'%3Eüçï%3C/text%3E%3Ctext x='340' y='320' font-size='26' fill='%23f59e0b' fill-opacity='0.35' transform='rotate(-8 340 320)'%3E‚öΩ%3C/text%3E%3Ctext x='420' y='450' font-size='32' fill='%236366f1' fill-opacity='0.4' transform='rotate(15 420 450)'%3Eüì∑%3C/text%3E%3Ctext x='300' y='180' font-size='20' fill='%238b5cf6' fill-opacity='0.25' transform='rotate(-20 300 180)'%3Eüé∏%3C/text%3E%3Ctext x='150' y='350' font-size='22' fill='%2314b8a6' fill-opacity='0.3' transform='rotate(25 150 350)'%3Eüíª%3C/text%3E%3Ctext x='450' y='260' font-size='18' fill='%23ef4444' fill-opacity='0.3' transform='rotate(-12 450 260)'%3EüèÜ%3C/text%3E%3Ctext x='60' y='430' font-size='24' fill='%233b82f6' fill-opacity='0.35' transform='rotate(18 60 430)'%3Eüé≤%3C/text%3E%3Ctext x='280' y='50' font-size='20' fill='%23a855f7' fill-opacity='0.3' transform='rotate(-5 280 50)'%3Eüëª%3C/text%3E%3C/svg%3E");
                    background-size: 400px 400px;
                }

                /* –õ–µ–≥–∫–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç —á–∏—Ç–∞–ª—Å—è –ª—É—á—à–µ */
                .chat-area::after {
                    content: "";
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: radial-gradient(circle at 50% 50%, rgba(10, 12, 16, 0.3) 0%, rgba(10, 12, 16, 0.7) 100%);
                    pointer-events: none;
                    z-index: -1;
                }

                .chat-area.active {
                    transform: translateX(0);
                    visibility: visible;
                }

            .back-btn {
                display: block;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞ –Ω–∞ –ü–ö */
        @keyframes chatContentSlide {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .chat-slide-animate {
            animation: chatContentSlide 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        /* --- –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ –í–ù–ï –º–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å–∞ (–¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–∞ –ü–ö) --- */
        @keyframes chatContentSlide {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .chat-slide-animate {
            animation: chatContentSlide 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }




        /* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ (—Å—Ç–∏–ª—å Telegram) */
        #searchResults {
            /* –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ "–ø–æ–≤–µ—Ä—Ö" */
            position: relative;
            top: 0;
            left: 0;
            right: 0;
            background: transparent; /* –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω, —á—Ç–æ–±—ã –±—ã–ª –æ–±—â–∏–π */
            border: none;
            border-radius: 0;
            box-shadow: none;
            /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –Ω–∞ –≤—Å—é –≤—ã—Å–æ—Ç—É */
            flex: 1;
            overflow-y: auto;
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            flex-direction: column;
            z-index: 10;
        }

            #searchResults.active {
                display: flex;
            }







        /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ –≤ –ø–æ–∏—Å–∫–µ */
        .search-section-title {
            padding: 10px 15px;
            font-size: 13px;
            font-weight: bold;
            color: #007bff;
            background: rgba(0, 123, 255, 0.05);
            text-transform: uppercase;
        }




        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥–æ–≥–æ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ */
        .search-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            gap: 12px;
            cursor: pointer;
            border-bottom: 1px solid #2a2a2a;
        }

            .search-item:hover {
                background: #2a2a2a;
            }

            .search-item img, .search-avatar-placeholder {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                object-fit: cover;
            }

        .search-info {
            flex: 1;
            overflow: hidden;
        }

        .search-name {
            font-weight: bold;
            color: white;
            font-size: 15px;
        }

        .search-sub {
            font-size: 13px;
            color: #888;
        }

        .search-action {
            color: #007bff;
            font-size: 20px;
            padding-right: 5px;
        }




        /* 1. –û–±—â–∏–π —Ñ–æ–Ω –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        #app-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* –õ–µ–∂–∏—Ç –ø–æ–¥ –≤—Å–µ–º */
            background-color: #0a0c10;
        }

            #app-background::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                opacity: 0.7;
                pointer-events: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='500' viewBox='0 0 500 500'%3E%3Cstyle%3E text %7B font-family: 'Segoe UI Emoji', 'Apple Color Emoji', sans-serif; %7D %3C/style%3E%3C!-- –ò–ö–û–ù–ö–ò --%3E%3Ctext x='40' y='60' font-size='36' fill='%234a9eff' fill-opacity='0.4' transform='rotate(12 40 60)'%3EüéÆ%3C/text%3E%3Ctext x='380' y='120' font-size='40' fill='%237c3aed' fill-opacity='0.35' transform='rotate(-15 380 120)'%3EüöÄ%3C/text%3E%3Ctext x='220' y='400' font-size='38' fill='%2306b6d4' fill-opacity='0.4' transform='rotate(8 220 400)'%3Eüéß%3C/text%3E%3Ctext x='180' y='90' font-size='28' fill='%23ec4899' fill-opacity='0.35' transform='rotate(-10 180 90)'%3Eüí°%3C/text%3E%3Ctext x='90' y='250' font-size='30' fill='%2310b981' fill-opacity='0.3' transform='rotate(20 90 250)'%3Eüçï%3C/text%3E%3Ctext x='340' y='320' font-size='26' fill='%23f59e0b' fill-opacity='0.35' transform='rotate(-8 340 320)'%3E‚öΩ%3C/text%3E%3Ctext x='420' y='450' font-size='32' fill='%236366f1' fill-opacity='0.4' transform='rotate(15 420 450)'%3Eüì∑%3C/text%3E%3Ctext x='300' y='180' font-size='20' fill='%238b5cf6' fill-opacity='0.25' transform='rotate(-20 300 180)'%3Eüé∏%3C/text%3E%3Ctext x='150' y='350' font-size='22' fill='%2314b8a6' fill-opacity='0.3' transform='rotate(25 150 350)'%3Eüíª%3C/text%3E%3Ctext x='450' y='260' font-size='18' fill='%23ef4444' fill-opacity='0.3' transform='rotate(-12 450 260)'%3EüèÜ%3C/text%3E%3Ctext x='60' y='430' font-size='24' fill='%233b82f6' fill-opacity='0.35' transform='rotate(18 60 430)'%3Eüé≤%3C/text%3E%3Ctext x='280' y='50' font-size='20' fill='%23a855f7' fill-opacity='0.3' transform='rotate(-5 280 50)'%3Eüëª%3C/text%3E%3C/svg%3E");
                background-size: 400px 400px;
            }

            #app-background::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: radial-gradient(circle at 50% 50%, rgba(10, 12, 16, 0.3) 0%, rgba(10, 12, 16, 0.7) 100%);
                pointer-events: none;
            }




        /* 2. –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω—ã —É –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –±–ª–æ–∫–æ–≤, —á—Ç–æ–±—ã –ø—Ä–æ—Å–≤–µ—á–∏–≤–∞–ª –æ–±—â–∏–π —Ñ–æ–Ω */
        body {
            background: transparent; /* –ë—ã–ª–æ 121212 */
        }

        .chat-area {
            background: transparent; /* –ë—ã–ª–æ 0d1117 */
        }

        #noChat {
            background: transparent; /* –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω –æ—Ç—Å—é–¥–∞ */
            /* –£–±–∏—Ä–∞–µ–º –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç—ã ::before –∏ ::after —É #noChat, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –æ–±—â–∏–π —Ñ–æ–Ω */
        }







        /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è Chrome, Safari –∏ Opera */
        .messages::-webkit-scrollbar {
            display: none;
        }






        /* PIP drag/resize */
        #localPip {
            /* –≤–∞–∂–Ω–æ: –±—É–¥–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ left/top –≤–Ω—É—Ç—Ä–∏ .video-grid (–æ–Ω–∞ position: relative) */
            touch-action: none;
            user-select: none;
            cursor: grab;
        }

            #localPip.dragging,
            #localPip.resizing {
                transition: none !important; /* —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ "—Ä–µ–∑–∏–Ω—ã" –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
            }

            #localPip.dragging {
                cursor: grabbing;
            }




            /* —á—Ç–æ–±—ã drag —Ä–∞–±–æ—Ç–∞–ª –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–∞–ø–∞–µ—à—å –ø–æ —Å–∞–º–æ–º—É –≤–∏–¥–µ–æ */
            #localPip > video {
                pointer-events: none;
            }




            /* –†—É—á–∫–∞ —Ä–µ—Å–∞–π–∑–∞ */
            #localPip .pip-resize-handle {
                position: absolute;
                right: 8px;
                bottom: 8px;
                width: 22px;
                height: 22px;
                border-radius: 7px;
                cursor: nwse-resize;
                background: rgba(255,255,255,0.16);
                border: 1px solid rgba(255,255,255,0.22);
                box-shadow: 0 6px 16px rgba(0,0,0,0.35);
                backdrop-filter: blur(8px);
            }




                /* –Ω–µ–±–æ–ª—å—à–æ–π ‚Äú–±–ª–∏–∫‚Äù, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ UI-—ç–ª–µ–º–µ–Ω—Ç */
                #localPip .pip-resize-handle::after {
                    content: "";
                    position: absolute;
                    inset: 6px;
                    border-right: 2px solid rgba(255,255,255,0.55);
                    border-bottom: 2px solid rgba(255,255,255,0.55);
                    border-radius: 2px;
                    transform: rotate(0deg);
                }




        /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–æ–∫ */
        .control-item-hidden {
            display: none !important;
        }




        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤ —á–∞—Ç–µ */
        .chat-media-img {
            max-width: 240px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É */
            max-height: 300px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É */
            border-radius: 12px;
            cursor: pointer;
            display: block;
            margin-bottom: 2px;
            object-fit: cover;
            background: #222; /* –§–æ–Ω –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è */
        }




        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤ */
        .chat-file-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.08); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ */
            border-radius: 10px;
            text-decoration: none;
            max-width: 260px;
            transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }

            .chat-file-card:hover {
                background: rgba(255, 255, 255, 0.12);
            }

        .file-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .file-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .file-name {
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .file-action {
            color: #8faebf;
            font-size: 11px;
            margin-top: 2px;
        }




        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –≥–∞–ª–æ—á–µ–∫ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
        .msg-meta {
            display: inline-block;
            vertical-align: bottom;
            margin-left: 5px;
        }




        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ö–ê–†–¢–ò–ù–û–ö –í –ß–ê–¢–ï --- */
        .chat-media-img {
            /* –î–µ–ª–∞–µ–º –∏—Ö –∫—Ä—É–ø–Ω–µ–µ */
            width: 100%;
            max-width: 320px; /* –ë—ã–ª–æ 240, —Å—Ç–∞–ª–æ —à–∏—Ä–µ */
            height: auto; /* –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –∏—Å–∫–∞–∂–∞–ª–æ—Å—å */
            max-height: 400px;
            border-radius: 12px;
            cursor: zoom-in; /* –ö—É—Ä—Å–æ—Ä –ª—É–ø—ã */
            display: block;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* –¢–µ–Ω—å –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
            transition: transform 0.2s;
        }

            .chat-media-img:active {
                transform: scale(0.98); /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è */
            }

        .media-container {
            overflow: hidden;
            border-radius: 12px;
            background: transparent; /* –£–±–∏—Ä–∞–µ–º —á–µ—Ä–Ω—ã–π —Ñ–æ–Ω */
            display: inline-block;
        }




        /* --- –°–¢–ò–õ–ò –î–õ–Ø –í–°–ü–õ–´–í–ê–Æ–©–ï–ì–û –û–ö–ù–ê (LIGHTBOX) --- */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9); /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            z-index: 9999; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px); /* –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ */
        }

            .image-viewer.active {
                display: flex;
                opacity: 1;
            }

            .image-viewer img {
                max-width: 95%;
                max-height: 95%;
                border-radius: 8px;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
                transform: scale(0.9);
                transition: transform 0.3s;
            }

            .image-viewer.active img {
                transform: scale(1);
            }

        .close-viewer-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
        }


        /* --- –ü–õ–ê–í–ê–Æ–©–ê–Ø –ö–ù–û–ü–ö–ê "–í–ù–ò–ó" --- */
        .scroll-bottom-btn {
            position: absolute;
            bottom: 95px; /* –ù–û–í–û–ï: –ü–æ–¥–Ω—è–ª–∏ –µ—â–µ —á—É—Ç—å –≤—ã—à–µ –Ω–∞–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ */
            /* –û—Ç—Å—Ç—É–ø 8px (–∫–∞–∫ —É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞) –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ, –Ω–∞ –ü–ö –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è –ø–æ —á–∞—Ç—É */
            right: max(8px, calc(50% - 442px));
            width: 48px; /* –ù–û–í–û–ï: –†–∞–∑–º–µ—Ä —Ç–æ—á–Ω–æ –∫–∞–∫ —É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–±—ã–ª–æ 44) */
            height: 48px; /* –ù–û–í–û–ï: –†–∞–∑–º–µ—Ä —Ç–æ—á–Ω–æ –∫–∞–∫ —É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–±—ã–ª–æ 44) */
            background: #212121;
            border-radius: 50%;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            z-index: 100;
            opacity: 0;
            transform: scale(0.5) translateY(20px);
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

            .scroll-bottom-btn.visible {
                opacity: 1;
                transform: scale(1) translateY(0);
                pointer-events: auto;
            }

            .scroll-bottom-btn:hover {
                background: #2a2a2a;
            }

            .scroll-bottom-btn:active {
                transform: scale(0.9) !important;
            }

            .scroll-bottom-btn svg {
                fill: #aaa;
                width: 26px;
                height: 26px;
            }



        /* –ö—Ä—É—Ç–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
        .upload-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }




        /* --- –°—Ç–∏–ª–∏ –ø—Ä–æ—Ñ–∏–ª—è –∫–∞–∫ –≤ Telegram --- */

        /* –§–æ–Ω —à–∞–ø–∫–∏ (–∑–µ–ª–µ–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω) */
        .tg-header-bg {
            background: #5a9e57;
            /* –ò–ó–ú–ï–ù–ï–ù–û: —É—á–∏—Ç—ã–≤–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∑–æ–Ω—É —Å–≤–µ—Ä—Ö—É (—á–µ–ª–∫—É) */
            padding: calc(10px + env(safe-area-inset-top)) 15px 20px 15px;
            color: white;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .tg-header-top {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .tg-icon-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        .tg-profile-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }




        /* –ê–≤–∞—Ç–∞—Ä–∫–∞ */
        .tg-avatar-large {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: #333;
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: #aaa;
            border: 2px solid white; /* –ë–µ–ª–∞—è –æ–±–≤–æ–¥–∫–∞ –∫–∞–∫ –≤ –¥–∏–∑–∞–π–Ω–µ */
        }

            .tg-avatar-large img {
                width: 100%;
                height: 100%;
                border-radius: 50%;
                object-fit: cover;
            }

        .tg-avatar-edit-icon {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: #4a8e4a;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #5a9e57;
        }


        /* --- –ü–û–ò–°–ö –í–ù–£–¢–†–ò –ß–ê–¢–ê (–¢–ï–õ–ï–ì–†–ê–ú –°–¢–ò–õ–¨) --- */
        .chat-search-bar {
            background: #212121; /* –¶–≤–µ—Ç —à–∞–ø–∫–∏ */
            display: flex;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 57px;
            z-index: 20;
            padding: 0 5px 0 15px; /* –ß—É—Ç—å —É–º–µ–Ω—å—à–∏–ª–∏ –ø—Ä–∞–≤—ã–π –æ—Ç—Å—Ç—É–ø */
        }

            .chat-search-bar.hidden {
                display: none !important;
            }

        .search-glass-icon {
            margin-right: 10px;
            flex-shrink: 0;
        }

        #chatSearchInput {
            flex: 1;
            min-width: 0; /* –í–ê–ñ–ù–û: –†–∞–∑—Ä–µ—à–∞–µ—Ç –∏–Ω–ø—É—Ç—É —Å–∂–∏–º–∞—Ç—å—Å—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞—Ö */
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            outline: none;
            padding: 0;
            height: 100%;
        }

            #chatSearchInput::placeholder {
                color: #888;
            }


        .chat-search-count {
            color: #aaa;
            font-size: 14px;
            margin: 0 5px;
            white-space: nowrap;
            flex-shrink: 0; /* –ù–µ –¥–∞–µ–º —Å—á–µ—Ç—á–∏–∫—É —Å–∂–∏–º–∞—Ç—å—Å—è */
        }

        .chat-search-actions {
            display: flex;
            align-items: center;
            gap: 0px; /* –£–±—Ä–∞–ª–∏ –ª–∏—à–Ω–∏–µ –¥—ã—Ä–∫–∏ –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
            flex-shrink: 0; /* –í–ê–ñ–ù–û: –ù–µ –¥–∞–µ–º –±–ª–æ–∫—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–ª–µ—Ç–∞—Ç—å –∑–∞ —ç–∫—Ä–∞–Ω */
        }

        .chat-search-btn {
            background: none;
            border: none;
            cursor: pointer;
            width: 36px; /* –ß—É—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            padding: 0;
            flex-shrink: 0;
        }

            .chat-search-btn:hover {
                background: rgba(255,255,255,0.08);
            }

            .chat-search-btn:active {
                background: rgba(255,255,255,0.15);
            }

            .chat-search-btn svg {
                transition: fill 0.2s;
            }

            .chat-search-btn:hover svg {
                fill: #fff;
            }

        .search-divider {
            width: 1px;
            height: 24px;
            background: #333;
            margin: 0 5px;
        }

        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ */
        .highlight {
            background-color: rgba(255, 235, 59, 0.3);
            color: inherit;
            border-radius: 3px;
        }

            .highlight.active-match {
                background-color: #ff9800;
                color: #fff;
            }


        /* –í—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –ø–æ–∏—Å–∫–∞ –ø–æ —á–∞—Ç—É */
        .chat-search-dropdown {
            position: absolute;
            top: 65px; /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –≤–Ω–∏–∑ –æ—Ç —à–∞–ø–∫–∏ */
            right: 15px; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é –Ω–∞ –ü–ö */
            width: 360px; /* –ê–∫–∫—É—Ä–∞—Ç–Ω–∞—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
            max-height: 50vh; /* –ú–∞–∫—Å–∏–º—É–º –ø–æ–ª–æ–≤–∏–Ω–∞ —ç–∫—Ä–∞–Ω–∞ –≤ –≤—ã—Å–æ—Ç—É */
            background: #212121;
            border: 1px solid #333; /* –¢–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ */
            border-radius: 12px; /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –∫—Ä–∞—è */
            box-shadow: 0 8px 25px rgba(0,0,0,0.6); /* –ö—Ä–∞—Å–∏–≤–∞—è –æ–±—ä–µ–º–Ω–∞—è —Ç–µ–Ω—å */
            z-index: 100; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ü–µ–Ω—Ç—Ä—É —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏ –ø–æ –∫—Ä–∞—è–º) */
        @media (max-width: 768px) {
            .chat-search-dropdown {
                left: 10px;
                right: 10px;
                width: auto;
                max-height: 60vh; /* –ß—É—Ç—å –±–æ–ª—å—à–µ –≤—ã—Å–æ—Ç—ã –Ω–∞ –º–æ–±–∏–ª–∫–µ */
            }
        }

        .chat-search-dropdown.hidden {
            display: none !important;
        }

        .search-msg-item {
            display: flex;
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.1s;
            border-bottom: 1px solid rgba(255,255,255,0.05); /* –ï–ª–µ –∑–∞–º–µ—Ç–Ω–∞—è –ª–∏–Ω–∏—è –º–µ–∂–¥—É –ø—É–Ω–∫—Ç–∞–º–∏ */
        }

            .search-msg-item:last-child {
                border-bottom: none; /* –£–±–∏—Ä–∞–µ–º –ª–∏–Ω–∏—é —É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
            }

            .search-msg-item:hover {
                background: #2a2a2a;
            }

            .search-msg-item.active {
                background: #2f2f2f; /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ */
            }

        .search-msg-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            margin-right: 12px;
            flex-shrink: 0;
            object-fit: cover;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .search-msg-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .search-msg-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 2px;
        }

        .search-msg-name {
            font-weight: 600;
            font-size: 14px;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-msg-time {
            font-size: 12px;
            color: #888;
            flex-shrink: 0;
            margin-left: 10px;
        }

        .search-msg-text {
            font-size: 13px;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* –ò–º—è –∏ —Å—Ç–∞—Ç—É—Å */
        .tg-profile-name-block {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tg-name-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            font-weight: 600;
            width: 100%;
            outline: none;
            padding: 0;
        }

            .tg-name-input::placeholder {
                color: rgba(255,255,255,0.6);
            }

        .tg-profile-status {
            color: rgba(255,255,255,0.8);
            font-size: 13px;
            margin-top: 4px;
        }


        /* --- –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤ (Telegram style) --- */
        .tg-spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
            width: 100%;
        }

        .tg-spinner {
            width: 36px;
            height: 36px;
            border: 3px solid rgba(115, 106, 240, 0.2); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
            border-top-color: #736AF0; /* –Ø—Ä–∫–∏–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
            border-radius: 50%;
            animation: tg-spin 0.8s linear infinite;
        }

        @keyframes tg-spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* –°–ø–∏—Å–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
        .tg-settings-list {
            background: #17212b; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω —Å–ø–∏—Å–∫–∞ */
            padding-top: 10px;
        }

        .tg-section-title {
            color: #7394ae; /* –ì–æ–ª—É–±–æ–π —Ü–≤–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ */
            font-size: 13px;
            font-weight: bold;
            padding: 15px 20px 5px 20px;
            text-transform: uppercase;
        }

        .tg-item {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            cursor: pointer;
            transition: 0.2s;
        }

            .tg-item:hover {
                background: #202b36;
            }

        .tg-item-icon {
            font-size: 22px;
            width: 40px;
            text-align: center;
            margin-right: 15px;
            color: #8faebf;
        }

        .tg-item-content {
            flex: 1;
            border-bottom: 1px solid #0e1621; /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
            padding-bottom: 10px;
            padding-top: 5px;
        }

        .tg-item:last-child .tg-item-content {
            border-bottom: none;
        }

        .tg-input-clean {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            width: 100%;
            outline: none;
            padding: 0;
            margin-bottom: 3px;
        }

        .tg-item-label {
            color: #7f91a4;
            font-size: 12px;
        }

        .tg-item-value {
            color: white;
            font-size: 16px;
            margin-bottom: 3px;
        }

        .tg-divider {
            height: 10px;
            background: #0e1621; /* –¢–µ–º–Ω–∞—è –ø–æ–ª–æ—Å–∞ –º–µ–∂–¥—É —Å–µ–∫—Ü–∏—è–º–∏ */
            margin: 5px 0;
        }



        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .full-screen-sheet {
            top: 0;
            height: 100% !important;
            background: #181818 !important;
            display: flex;
            flex-direction: column;
            z-index: 6000;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* –î–û–ë–ê–í–õ–ï–ù–û: —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ action-sheet */
            padding: 0 !important;
            border-radius: 0 !important;
        }

            .full-screen-sheet.open {
                transform: translateY(0);
            }

        .edit-content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }



        /* –ê–≤–∞—Ç–∞—Ä —Å–µ–∫—Ü–∏—è */
        .edit-avatar-section {
            display: flex;
            justify-content: center;
            padding: 30px 0;
            background: #181818;
        }

        .edit-avatar-wrapper {
            width: 100px;
            height: 100px;
            position: relative;
            cursor: pointer;
        }



        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ó–í–û–ù–ö–û–í –í –ß–ê–¢–ï --- */
        .chat-call-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 4px 6px 4px 0;
            cursor: pointer;
            min-width: 170px;
        }

        .call-icon-wrapper {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .msg-me .call-icon-wrapper {
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-call-card:active .call-icon-wrapper {
            background: rgba(255, 255, 255, 0.3);
        }

        .call-info {
            display: flex;
            flex-direction: column;
        }

        .call-title {
            font-weight: 600;
            font-size: 15px;
            color: white;
        }

        .call-time {
            font-size: 13px;
            margin-top: 2px;
        }

        /* --- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å (Toggle Switch) --- */
        .tg-switch {
            position: relative;
            display: inline-block;
            width: 42px;
            height: 24px;
        }

            .tg-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555; /* –°–µ—Ä—ã–π –≤—ã–∫–ª */
            transition: .4s;
            border-radius: 24px;
        }

            .slider:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
            }

        input:checked + .slider {
            background-color: #8774e1; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –≤–∫–ª */
        }

            input:checked + .slider:before {
                transform: translateX(18px);
            }

        .edit-avatar-wrapper img, .avatar-placeholder-large {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .avatar-placeholder-large {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: white;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }



        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ (Material Design —Å—Ç–∏–ª—å) */
        .edit-form-group {
            padding: 10px 20px;
        }

        .tg-input-field {
            position: relative;
            margin-bottom: 24px;
            background: transparent;
            border: 1px solid #444; /* –†–∞–º–∫–∞ */
            border-radius: 12px;
            padding: 0;
        }

            .tg-input-field input, .tg-input-field textarea {
                width: 100%;
                background: transparent;
                border: none;
                color: white;
                font-size: 16px;
                padding: 14px 12px;
                outline: none;
                border-radius: 12px;
            }

            .tg-input-field textarea {
                resize: none;
                min-height: 50px;
            }



            /* –ü–ª–∞–≤–∞—é—â–∏–π –ª–µ–π–±–ª */
            .tg-input-field label {
                position: absolute;
                left: 12px;
                top: 14px;
                color: #888;
                font-size: 16px;
                pointer-events: none;
                transition: 0.2s ease all;
                background: #181818;
                padding: 0 4px;
            }



            /* –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–æ–∫—É—Å–∞ –∏–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ */
            .tg-input-field input:focus ~ label,
            .tg-input-field input:not(:placeholder-shown) ~ label,
            .tg-input-field textarea:focus ~ label,
            .tg-input-field textarea:not(:placeholder-shown) ~ label {
                top: -10px;
                font-size: 12px;
                color: #8774e1;
            }

            .tg-input-field input:focus, .tg-input-field textarea:focus {
                border-color: #8774e1; /* –¶–≤–µ—Ç –∞–∫—Ü–µ–Ω—Ç–∞ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ */
            }


        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ —è–∑—ã–∫–æ–≤ */
        .lang-option {
            padding: 12px 15px;
            background: #333;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            color: white;
            transition: background 0.2s;
            display: flex;
            align-items: center;
        }

            .lang-option:hover {
                background: #444;
            }

            .lang-option:active {
                background: #555;
            }

        .char-counter {
            position: absolute;
            bottom: -20px;
            right: 5px;
            font-size: 12px;
            color: #888;
        }

        .field-hint {
            font-size: 13px;
            color: #888;
            margin-top: -15px;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .edit-separator {
            height: 12px;
            background: #0f0f0f;
            border-top: 1px solid #222;
            border-bottom: 1px solid #222;
            margin-bottom: 15px;
        }

        .section-header {
            color: #8774e1;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 15px;
            text-transform: uppercase;
        }




        /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading-overlay img {
            filter: brightness(0.5) blur(2px);
            transition: 0.3s;
        }




        /* –≠—Ñ—Ñ–µ–∫—Ç –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ */
        .click-to-copy {
            cursor: pointer;
            position: relative;
        }

            .click-to-copy:active {
                background-color: #202b36;
            }




        /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7); /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            z-index: 20000; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            animation: fadeIn 0.2s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }



        /* –°–∞–º–æ –æ–∫–Ω–æ */
        .delete-modal {
            background: #252525;
            width: 90%;
            max-width: 320px;
            border-radius: 16px;
            padding: 22px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            transform: scale(0.9);
            animation: scaleUp 0.2s forwards;
        }

        @keyframes scaleUp {
            to {
                transform: scale(1);
            }
        }

        .delete-modal h3 {
            margin: 0;
            font-size: 18px;
            color: white;
            font-weight: 600;
        }

        .delete-modal p {
            margin: 0;
            font-size: 15px;
            color: #ccc;
            line-height: 1.4;
        }



        /* –ß–µ–∫–±–æ–∫—Å */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

            .checkbox-container input[type="checkbox"] {
                appearance: none;
                width: 20px;
                height: 20px;
                border: 2px solid #888;
                border-radius: 6px;
                background: transparent;
                cursor: pointer;
                position: relative;
                transition: 0.2s;
            }

                .checkbox-container input[type="checkbox"]:checked {
                    background: #8774e1; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç –∫–∞–∫ –≤ TG */
                    border-color: #8774e1;
                }

                    .checkbox-container input[type="checkbox"]:checked::after {
                        content: '‚úì';
                        position: absolute;
                        color: white;
                        font-size: 14px;
                        left: 3px;
                        top: -1px;
                        font-weight: bold;
                    }

            .checkbox-container label {
                font-size: 15px;
                color: white;
                cursor: pointer;
                user-select: none;
            }



        /* –ö–Ω–æ–ø–∫–∏ */
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 10px;
        }

            .modal-buttons button {
                background: none;
                border: none;
                font-size: 15px;
                font-weight: bold;
                cursor: pointer;
                padding: 5px 10px;
                border-radius: 6px;
                transition: 0.2s;
            }

        .btn-cancel {
            color: #8774e1; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π */
        }

            .btn-cancel:hover {
                background: rgba(135, 116, 225, 0.1);
            }

        .btn-confirm {
            color: #ff595a; /* –ö—Ä–∞—Å–Ω—ã–π */
        }

            .btn-confirm:hover {
                background: rgba(255, 89, 90, 0.1);
            }



        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (—Å–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        .context-menu {
            position: fixed;
            z-index: 10000;
            width: 220px;
            background: transparent;
            display: none; /* –°–∫—Ä—ã—Ç–æ */
            flex-direction: column;
            gap: 8px;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.2s, transform 0.2s;
        }

            .context-menu.active {
                display: flex;
                opacity: 1;
                transform: scale(1);
            }



        /* –ë–∞—Ä —Ä–µ–∞–∫—Ü–∏–π —Å–≤–µ—Ä—Ö—É */
        .reactions-bar {
            background: #252525;
            padding: 8px;
            border-radius: 14px;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

            .reactions-bar span {
                font-size: 20px;
                cursor: pointer;
                transition: transform 0.2s;
            }

                .reactions-bar span:hover {
                    transform: scale(1.2);
                }



        /* –û—Å–Ω–æ–≤–Ω–æ–π —Å–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
        .context-list {
            background: #252525; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ –º–µ–Ω—é –∫–∞–∫ –≤ TG */
            border-radius: 14px;
            padding: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
        }

        .context-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.1s;
        }

            .context-item:hover {
                background: #333; /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
            }

        .context-icon {
            margin-right: 12px;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }



        /* –ö—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */
        .context-item.delete {
            color: #ff595a;
        }

            .context-item.delete .context-icon {
                filter: grayscale(0) !important; /* –ß—Ç–æ–±—ã –∏–∫–æ–Ω–∫–∞ –Ω–µ –±—ã–ª–∞ —Å–µ—Ä–æ–π */
            }

        .context-divider {
            height: 1px;
            background: #383838;
            margin: 4px 10px;
        }



        /* –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (Toast) */
        #toast-notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 7000;
            pointer-events: none;
        }

            #toast-notification.show {
                opacity: 1;
            }

        .tg-bio-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 16px;
            width: 100%;
            outline: none;
            resize: none;
            font-family: inherit;
            padding: 0;
            margin-bottom: 3px;
            min-height: 24px;
        }

            .tg-bio-input::placeholder {
                color: rgba(255, 255, 255, 0.4);
            }




        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–µ–Ω—é (–∫–∞–∫ –≤ Telegram) */
        .action-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            background: #252525;
            transition: background 0.2s;
        }

            .action-item:hover {
                background: #2f2f2f;
            }

        .action-icon {
            font-size: 20px;
            margin-right: 15px;
            width: 24px;
            text-align: center;
        }

        .action-text {
            font-size: 16px;
            color: white;
        }



        /* –ü–∞–Ω–µ–ª—å –æ—Ç–≤–µ—Ç–∞ –Ω–∞–¥ –≤–≤–æ–¥–æ–º */
        .reply-bar {
            width: 100%;
            background: #1f1f1f;
            border-top: 1px solid #333;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            border-left: 3px solid #736AF0;
            /* –ù–û–í–û–ï: –ü–ª–∞–≤–Ω—ã–π –≤—ã–µ–∑–¥ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.2, 0.85, 0.3, 1);
            z-index: -1; /* –ü–∞–Ω–µ–ª—å –ø—Ä—è—á–µ—Ç—Å—è –ü–û–î –æ—Å–Ω–æ–≤–Ω—ã–º –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ */
        }

            .reply-bar.editing {
                border-left: 3px solid #007bff;
            }

            /* –ù–û–í–û–ï: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∫—Ä—ã—Ç–∏–µ, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∞ –∞–Ω–∏–º–∞—Ü–∏—è –≤—ã–µ–∑–¥–∞ */
            .reply-bar.hidden {
                display: flex !important;
                opacity: 0;
                transform: translateY(100%); /* –ü—Ä—è—á–µ–º –µ—ë –≤–Ω–∏–∑ –Ω–∞ –≤—Å—é –≤—ã—Å–æ—Ç—É */
                pointer-events: none; /* –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è */
            }

        .reply-content {
            flex: 1;
            margin-left: 10px;
            overflow: hidden;
        }

        .reply-title {
            color: #736AF0;
            font-size: 13px;
            font-weight: bold;
        }

        .reply-text {
            color: #ccc;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-close {
            background: none;
            border: none;
            color: #888;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }



        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ü–∏—Ç–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .msg-reply-quote {
            border-left: 2px solid white;
            padding-left: 8px;
            margin-bottom: 4px;
            cursor: pointer;
        }

        .msg-reply-name {
            font-size: 11px;
            color: rgba(255,255,255,0.7);
            font-weight: bold;
        }

        .msg-reply-text {
            font-size: 12px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .birth-modal {
            background: #252525;
            width: 92%;
            max-width: 360px;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }


        /* --- –≠–§–§–ï–ö–¢ –î–û–õ–ì–û–ì–û –ù–ê–ñ–ê–¢–ò–Ø (iOS –°–¢–ò–õ–¨) --- */
        #chatBlurOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 2000; /* –ü–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç —à–∞–ø–∫—É –∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ */
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

            #chatBlurOverlay.active {
                opacity: 1;
            }

        .msg-highlighted {
            z-index: 2001 !important; /* –ü–æ–¥–Ω–∏–º–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–≤–µ—Ä—Ö –±–ª—é—Ä–∞ */
            position: relative;
            transform: scale(1.02); /* –≠—Ñ—Ñ–µ–∫—Ç "–≤—ã–¥–∞–≤–ª–∏–≤–∞–Ω–∏—è" –∫–∞–∫ –Ω–∞ iPhone */
            box-shadow: 0 15px 35px rgba(0,0,0,0.6);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
        }
        .birth-pickers {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

            .birth-pickers select {
                width: 100%;
                background: #1f1f1f;
                border: 1px solid #444;
                color: white;
                padding: 12px 10px;
                border-radius: 12px;
                outline: none;
            }



        /* –ê–Ω–∏–º–∞—Ü–∏—è —Ç–æ—á–µ–∫ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ø–µ—á–∞—Ç–∞–µ—Ç" */
        @keyframes blink {
            0% {
                opacity: .2;
            }

            20% {
                opacity: 1;
            }

            100% {
                opacity: .2;
            }
        }

        .typing-dots span {
            animation-name: blink;
            animation-duration: 1.4s;
            animation-iteration-count: infinite;
            animation-fill-mode: both;
        }

            .typing-dots span:nth-child(2) {
                animation-delay: .2s;
            }

            .typing-dots span:nth-child(3) {
                animation-delay: .4s;
            }

        .typing-text {
            color: #736AF0 !important; /* –§–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—á–∞—Ç–∞–µ—Ç */
            font-weight: bold;
        }


        /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–∞—Ç—ã –≤–Ω—É—Ç—Ä–∏ —á–∞—Ç–∞ */
        .chat-date-separator {
            align-self: center;
            background: rgba(0, 0, 0, 0.35);
            color: white;
            font-size: 13px;
            padding: 4px 12px;
            border-radius: 12px;
            margin: 10px 0;
            font-weight: 500;
            z-index: 2;
            backdrop-filter: blur(4px);
            user-select: none;
            cursor: pointer; /* –î–û–ë–ê–í–õ–ï–ù–û */
            transition: background 0.2s; /* –î–û–ë–ê–í–õ–ï–ù–û */
        }

            .chat-date-separator:active {
                background: rgba(0, 0, 0, 0.6);
            }

        /* –ü–ª–∞–≤–∞—é—â–∞—è –¥–∞—Ç–∞ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ */
        .floating-date {
            position: absolute;
            top: 66px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.45);
            color: white;
            font-size: 13px;
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 500;
            z-index: 50;
            backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: auto; /* –í–ê–ñ–ù–û: –∏–∑–º–µ–Ω–µ–Ω–æ —Å none –Ω–∞ auto, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª –∫–ª–∏–∫! */
            cursor: pointer;
        }

            .floating-date:active {
                background: rgba(0, 0, 0, 0.7);
            }

            .floating-date.visible {
                opacity: 1;
            }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ */
        .translated-block {
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
            color: #4a9eff; /* –ì–æ–ª—É–±–æ–π —Ü–≤–µ—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ */
            font-style: italic;
            display: block;
            animation: fadeIn 0.5s;
            /* --- –ù–û–í–û–ï: –ü–µ—Ä–µ–≤–æ–¥ –ë–û–õ–¨–®–ò–ú–ò –ë–£–ö–í–ê–ú–ò --- */
            text-transform: uppercase;
            font-weight: bold; /* –ñ–∏—Ä–Ω—ã–π, —á—Ç–æ–±—ã –ª—É—á—à–µ —á–∏—Ç–∞–ª–æ—Å—å */
        }


        /* --- –ù–û–í–û–ï: –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏ --- */
        .msg-text {
            text-transform: lowercase;
            white-space: pre-wrap; /* –ó–∞—Å—Ç–∞–≤–ª—è–µ—Ç –±—Ä–∞—É–∑–µ—Ä –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –∞–±–∑–∞—Ü—ã (Enter) */
            word-break: break-word;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
</head>
<body>
    <div id="app-background"></div>
    <audio id="ringtone" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <!-- AUTH & REGISTRATION -->
    <div id="authScreen" class="auth-overlay">
        <!-- –®–ê–ì 1: –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div id="stepEmail" class="auth-box">
            <h2>–í—Ö–æ–¥ –≤ Messenger</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="authAction()">–î–∞–ª–µ–µ</button>
            <div id="authError" style="color: #ff4444; margin-top: 10px; font-size: 13px;"></div>
        </div>
        <!-- –®–ê–ì 2: –ò–º—è –∏ –§–∞–º–∏–ª–∏—è -->
        <div id="stepName" class="auth-box" style="display: none;">
            <h2>–í–∞—à–µ –∏–º—è</h2>
            <div style="font-size: 13px; color: #aaa; margin-bottom: 15px;">
                –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ).
            </div>
            <input type="text" id="regName" placeholder="–ò–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" oninput="checkNameInput()">
            <input type="text" id="regSurname" placeholder="–§–∞–º–∏–ª–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
            <button id="btnNameNext" onclick="goToUsernameStep()" disabled style="background: #444; cursor: not-allowed;">–î–∞–ª–µ–µ</button>
        </div>
        <!-- –®–ê–ì 3: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div id="stepUsername" class="auth-box" style="display: none;">
            <div style="display:flex; justify-content: flex-start;">
                <button onclick="backToName()" style="width: auto; background: none; color: #007bff; padding: 0; margin: 0 0 10px 0;">‚Üê –ù–∞–∑–∞–¥</button>
            </div>
            <h2>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <div style="font-size: 13px; color: #aaa; margin-bottom: 15px;">
                –í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –õ—é–¥–∏ —Å–º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –≤–∞—Å –ø–æ –Ω–µ–º—É.
            </div>
            <div style="position: relative;">
                <input type="text" id="regUsername" placeholder="@Username" oninput="checkUsernameInput()" style="padding-left: 10px;">
            </div>
            <div id="usernameStatus" style="font-size: 12px; text-align: left; margin-top: 5px; min-height: 15px;"></div>
            <button id="btnFinish" onclick="finishRegistration()" disabled style="background: #444; cursor: not-allowed; margin-top: 15px;">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
        </div>
    </div>
    <!-- INCOMING -->
    <div id="incomingPopup" class="incoming-call">
        <!-- –¢–µ–ø–µ—Ä—å –∑–¥–µ—Å—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω span, –≤ –∫–æ—Ç–æ—Ä—ã–π –º—ã –±—É–¥–µ–º –ø–∏—Å–∞—Ç—å –ø–æ—á—Ç—É -->
        <span id="callerName" style="font-weight:bold; font-size: 14px;">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <div style="display:flex; gap:15px;">
            <button onclick="answerCall()" class="btn-circle" style="background:#248046; width:45px; height:45px; font-size:18px;">üìû</button>
            <button onclick="rejectCall()" class="btn-circle btn-hangup" style="width:45px; height:45px; font-size:18px;">‚úñ</button>
        </div>
    </div>

    <div id="langModal" class="modal-overlay" style="display:none" onclick="closeLangModal()">
        <div class="delete-modal" onclick="event.stopPropagation()">
            <h3 style="margin-bottom: 10px;">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫</h3>

            <div class="lang-list-container" style="display:flex; flex-direction:column; gap:5px; max-height: 300px; overflow-y:auto;">

                <div class="lang-option" onclick="selectLanguage('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π (ru)</div>
                <div class="lang-option" onclick="selectLanguage('ar')">üá™üá¨ ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (ar)</div>
                <div class="lang-option" onclick="selectLanguage('en')">üá¨üáß English (en)</div>
                <div class="lang-option" onclick="selectLanguage('de')">üá©üá™ Deutsch (de)</div>
                <div class="lang-option" onclick="selectLanguage('fr')">üá´üá∑ Fran√ßais (fr)</div>
                <div class="lang-option" onclick="selectLanguage('es')">üá™üá∏ Espa√±ol (es)</div>
                <div class="lang-option" onclick="selectLanguage('it')">üáÆüáπ Italiano (it)</div>
                <div class="lang-option" onclick="selectLanguage('tr')">üáπüá∑ T√ºrk√ße (tr)</div>
                <div class="lang-option" onclick="selectLanguage('uk')">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ (uk)</div>
            </div>

            <div class="modal-buttons" style="margin-top:15px;">
                <button class="btn-cancel" onclick="closeLangModal()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>


    <div id="generalSettingsSheet" class="action-sheet full-screen-sheet">
        <div class="tg-header-bg">
            <div class="tg-header-top">
                <button onclick="closeGeneralSettings()" class="tg-icon-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7" /></svg>
                </button>
                <div style="flex:1; font-weight: 500; font-size: 20px; margin-left: 10px;">–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
        </div>

        <div class="edit-content-scroll" style="background: #17212b;">

            <div class="tg-section-title">–Ø–∑—ã–∫</div>
            <div class="tg-divider"></div>

            <div class="tg-section-title">–ü–µ—Ä–µ–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π</div>

            <div class="tg-item">
                <div class="tg-item-content" style="border:none;">
                    <div class="tg-item-value">–ê–≤—Ç–æ–ø–µ—Ä–µ–≤–æ–¥ –≤—Ö–æ–¥—è—â–∏—Ö</div>
                    <div class="tg-item-label">–ü–µ—Ä–µ–≤–æ–¥–∏—Ç—å —á—É–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
                </div>
                <div style="padding-left: 10px;">
                    <label class="tg-switch">
                        <input type="checkbox" id="autoTranslateToggle" onchange="toggleAutoTranslate(this)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="tg-item" onclick="changeTranslateLang()">
                <div class="tg-item-content">
                    <div class="tg-item-value">–ü–µ—Ä–µ–≤–æ–¥–∏—Ç—å –Ω–∞</div>
                    <div class="tg-item-label" id="currentLangLabel">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div style="color: #6c7883;">‚Ä∫</div>
            </div>

            <div class="tg-divider"></div>
            <div class="field-hint" style="padding: 10px 20px;">
                –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π API MyMemory. –í–æ–∑–º–æ–∂–Ω—ã –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤.
            </div>

        </div>
    </div>


    <!-- –®–¢–ûÔøΩ –öÔøΩ? -->
    <div id="overlaySheet" class="overlay-sheet" onclick="closeAllSheets()" oncontextmenu="event.preventDefault(); closeAllSheets();"></div>
    <!-- –®—Ç–æ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div id="contextMenu" class="context-menu" oncontextmenu="event.preventDefault();">
        <div class="reactions-bar">
            <span>üî•</span><span>üëç</span><span>‚ù§Ô∏è</span><span>ü•∞</span><span>üëè</span><span>üí©</span>
        </div>

        <div class="context-list">
            <div class="context-item" onclick="handleReply()">
                <span class="context-icon">‚Ü©Ô∏è</span> –û—Ç–≤–µ—Ç–∏—Ç—å
            </div>

            <div id="ctxEdit" class="context-item" onclick="handleEdit()">
                <span class="context-icon">‚úèÔ∏è</span> –ò–∑–º–µ–Ω–∏—Ç—å
            </div>

            <div class="context-item" onclick="handleCopy()">
                <span class="context-icon">üìÑ</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
            </div>

            <div class="context-item" onclick="alert('–§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è —Å–∫–æ—Ä–æ –±—É–¥–µ—Ç!')">
                <span class="context-icon">üìå</span> –ó–∞–∫—Ä–µ–ø–∏—Ç—å
            </div>

            <div class="context-divider"></div>

            <div class="context-item delete" onclick="openDeleteSheet()">
                <span class="context-icon">üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
            </div>
        </div>
    </div>

    <div id="deleteModalOverlay" class="modal-overlay" style="display: none;" onclick="closeDeleteModal()">
        <div class="delete-modal" onclick="event.stopPropagation()">
            <h3>–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
            <p>–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?</p>

            <div class="checkbox-container" id="deleteForEveryoneBlock">
                <input type="checkbox" id="deleteForEveryone" checked>
                <label for="deleteForEveryone">–¢–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç—å –¥–ª—è <span id="deleteFriendName">User</span></label>
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeDeleteModal()">–û–¢–ú–ï–ù–ê</button>
                <button class="btn-confirm" onclick="executeDelete()">–£–î–ê–õ–ò–¢–¨</button>
            </div>
        </div>
    </div>

    <!-- –û–ö–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ü–†–û–§–ò–õ–Ø -->
    <div id="editProfileSheet" class="action-sheet full-screen-sheet">
        <div class="tg-header-bg">
            <div class="tg-header-top">
                <button onclick="closeEditProfile()" class="tg-icon-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7" /></svg>
                </button>
                <div style="flex:1; font-weight: 500; font-size: 20px; margin-left: 10px;">–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
                <button onclick="saveEditProfile()" class="tg-icon-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12" /></svg>
                </button>
            </div>
        </div>

        <div class="edit-content-scroll">
            <!-- –ê–≤–∞—Ç–∞—Ä -->
            <div class="edit-avatar-section">
                <div class="edit-avatar-wrapper" onclick="document.getElementById('editAvatarInput').click()">
                    <img id="editAvatarPreview" src="" style="display:none">
                    <div id="editAvatarPlaceholder" class="avatar-placeholder-large"></div>
                    <div class="camera-overlay">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" /><circle cx="12" cy="13" r="4" /></svg>
                    </div>
                </div>
                <input type="file" id="editAvatarInput" hidden accept="image/*" onchange="handleEditAvatarSelect(this)">
            </div>

            <!-- –ü–æ–ª—è –≤–≤–æ–¥–∞ -->
            <div class="edit-form-group">
                <div class="tg-input-field">
                    <input type="text" id="editName" placeholder=" " required>
                    <label>–ò–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                </div>

                <div class="tg-input-field">
                    <input type="text" id="editSurname" placeholder=" ">
                    <label>–§–∞–º–∏–ª–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                </div>

                <div class="tg-input-field">
                    <textarea id="editBio" placeholder=" " maxlength="70" rows="1" oninput="updateBioCounter(this)"></textarea>
                    <label>–û —Å–µ–±–µ</label>
                    <div class="char-counter" id="bioCounter">70</div>
                </div>
                <div class="field-hint">–õ—é–±—ã–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: –≤–æ–∑—Ä–∞—Å—Ç, —Ä–æ–¥ –∑–∞–Ω—è—Ç–∏–π –∏–ª–∏ –≥–æ—Ä–æ–¥.</div>
            </div>

            <div class="edit-separator"></div>

            <!-- –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è -->
            <div class="edit-form-group">
                <div class="section-label-row">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    <span style="font-weight: 500; color: #8774e1; margin-left: 10px;">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</span>
                </div>
                <div class="tg-input-field" style="margin-top:10px">
                    <input type="text" id="editBirthdateView" placeholder=" " readonly>
                    <label>–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</label>

                    <!-- –≤–∞–∂–Ω–æ: id —Ç–æ—Ç –∂–µ, —á—Ç–æ —É —Ç–µ–±—è –±—ã–ª, —á—Ç–æ–±—ã saveEditProfile() –Ω–µ –º–µ–Ω—è—Ç—å -->
                    <input type="hidden" id="editBirthdate">
                </div>
                <div class="field-hint">–í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å, –∫—Ç–æ –±—É–¥–µ—Ç –≤–∏–¥–µ—Ç—å –í–∞—à –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è, –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</div>
            </div>

            <div class="edit-separator"></div>

            <!-- –Æ–∑–µ—Ä–Ω–µ–π–º -->
            <div class="edit-form-group">
                <div class="section-header">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                <div class="tg-input-field">
                    <input type="text" id="editUsername" placeholder=" " oninput="checkUsernameAvailability(this)">
                    <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                </div>
                <div class="field-hint">
                    –í—ã –º–æ–∂–µ—Ç–µ –≤—ã–±—Ä–∞—Ç—å –ø—É–±–ª–∏—á–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –¥—Ä—É–≥–∏–µ –ª—é–¥–∏ —Å–º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –í–∞—Å –ø–æ —Ç–∞–∫–æ–º—É –∏–º–µ–Ω–∏.
                </div>
                <div id="editUsernameStatus" class="field-hint" style="color: #4caf50; display: none;">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–≤–æ–±–æ–¥–Ω–æ.</div>
            </div>

            <div style="height: 100px;"></div> <!-- –û—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É -->
        </div>
    </div>



    <!-- –®—Ç–æ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="deleteSheet" class="action-sheet">
        <div class="sheet-title">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?</div>
        <button id="btnDelAll" class="action-btn delete" onclick="confirmDelete('all')">–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö</button>
        <button class="action-btn delete" onclick="confirmDelete('me')">–£–¥–∞–ª–∏—Ç—å —É –º–µ–Ω—è</button>
        <button class="action-btn" onclick="closeAllSheets()">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <!-- –®—Ç–æ—Ä–∫–∞ –üÔøΩ –û–§ÔøΩ?–õ–Ø (–ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞) -->
    <!-- –ü–†–û–§–ò–õ–¨ -->
    <div id="profileSheet" class="action-sheet" style="padding: 0; background: #17212b; height: 100%; max-height: 100%; border-radius: 0;">

        <div class="tg-header-bg">
            <div class="tg-header-top">
                <button onclick="closeAllSheets()" class="tg-icon-btn">‚Üê</button>
                <div style="flex:1; font-weight: 500; font-size: 18px;">–ü—Ä–æ—Ñ–∏–ª—å</div>
                <button onclick="openEditProfile()" class="tg-icon-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                </button>
                <button onclick="logout()" class="tg-icon-btn" style="margin-left: 5px;">‚ãÆ</button>
            </div>

            <div class="tg-profile-info">
                <div class="tg-avatar-large" onclick="viewProfileAvatar()">
                    <img id="profileAvatarPreview" src="" style="display:none">
                    <div id="profileAvatarPlaceholder">üë§</div>
                </div>

                <div class="tg-profile-name-block">
                    <input type="text" id="profileName" class="tg-name-input" placeholder="–ò–º—è" readonly onblur="if(this.value.trim() === '') this.value = 'User'">
                    <input type="text" id="profileSurname" class="tg-name-input" placeholder="" readonly style="font-size: 16px; margin-top: 2px; font-weight: normal;">
                    <div class="tg-profile-status">–≤ —Å–µ—Ç–∏</div>
                </div>
            </div>
        </div>

        <div class="tg-settings-list" style="overflow-y: auto; height: calc(100% - 140px);">

            <div class="tg-section-title">–ê–∫–∫–∞—É–Ω—Ç</div>

            <div class="tg-item click-to-copy" onclick="copyData('profileEmail', 'Email')">
                <div class="tg-item-icon">üìû</div>
                <div class="tg-item-content">
                    <div class="tg-item-value" id="profileEmail" style="font-size: 16px; color: #fff;"></div>
                    <div class="tg-item-label">Email</div>
                </div>
            </div>

            <div class="tg-item click-to-copy" onclick="copyData('profileUsername', 'Username')">
                <div class="tg-item-icon">@</div>
                <div class="tg-item-content">
                    <div class="tg-item-value" id="profileUsername" style="font-size: 16px; color: #fff;"></div>
                    <div class="tg-item-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
                </div>
            </div>

            <div class="tg-item click-to-copy" id="birthdateBlock" onclick="copyData('displayBirthdate', '–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è')" style="display: none;">
                <div class="tg-item-icon">üéÇ</div>
                <div class="tg-item-content">
                    <div class="tg-item-value" id="displayBirthdate"></div>
                    <div class="tg-item-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</div>
                </div>
            </div>

            <div class="tg-item">
                <div class="tg-item-icon">‚ÑπÔ∏è</div>
                <div class="tg-item-content">
                    <textarea id="profileBio" class="tg-bio-input" placeholder="–ù–µ —É–∫–∞–∑–∞–Ω–æ" rows="1" readonly style="pointer-events: none;"></textarea>
                    <div class="tg-item-label">–û —Å–µ–±–µ</div>
                </div>
            </div>

            <input type="date" id="profileBirthdate" style="display: none;">

            <div class="tg-divider"></div>

            <div class="tg-item" onclick="openGeneralSettings()">
                <div class="tg-item-icon" style="color: #7f91a4;">‚öôÔ∏è</div>
                <div class="tg-item-content">
                    <div class="tg-item-value">–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                </div>
            </div>
            <div class="tg-item">
                <div class="tg-item-icon" style="color: #7f91a4;">üîî</div>
                <div class="tg-item-content">
                    <div class="tg-item-value">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                </div>
            </div>
            <div class="tg-item">
                <div class="tg-item-icon" style="color: #7f91a4;">üîí</div>
                <div class="tg-item-content">
                    <div class="tg-item-value">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</div>
                </div>
            </div>

            <div class="tg-divider"></div>

            <div class="tg-item" onclick="logout()" style="cursor: pointer;">
                <div class="tg-item-icon" style="color: #ff595a;">üö™</div>
                <div class="tg-item-content" style="border: none;">
                    <div class="tg-item-value" style="color: #ff595a;">–í—ã–π—Ç–∏</div>
                </div>
            </div>

            <div style="height: 50px;"></div>
        </div>
    </div>

    <div id="toast-notification">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>

    <div id="toast-notification">–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ</div>
    <!-- MAIN -->
    <div id="mainSidebar" class="sidebar">
        <!-- –ï–î–ò–ù–ê–Ø –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨: –ê–≤–∞—Ç–∞—Ä + –ü–æ–∏—Å–∫ -->
        <!-- –ü—Ä–æ—Ñ–∏–ª—å -->
        <div class="profile-bar" style="padding: 12px 15px; gap: 12px; position: relative;">
            <button id="searchBackBtn" onclick="closeSearch()" style="display: none; background: none; border: none; color: #007bff; font-size: 20px; cursor: pointer; flex-shrink: 0;">
                ‚Üê
            </button>

            <button id="profileBtn" onclick="openProfileSheet()">
                <span id="myAvatarSmall">üë§</span>
            </button>

            <div style="flex: 1; position: relative;">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..."
                       ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†style="width: 100%; height: 44px; padding: 0 15px; border-radius: 22px; border: 1px solid #333; background: #181818; color: white; outline: none; font-size: 14px; transition: 0.2s;"
                       ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†onfocus="openSearchUI()"
                       ¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†¬†oninput="handleSearchInput(this)">

                <div id="searchResults"></div>
            </div>
        </div>

        <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->


        <div class="tabs">
            <div class="tab active" onclick="switchTab('friends')">
                –î—Ä—É–∑—å—è <span id="friendsBadge" class="tab-badge hidden">0</span>
            </div>
            <div class="tab" onclick="switchTab('requests')">
                –ó–∞—è–≤–∫–∏ <span id="requestsBadge" class="tab-badge hidden">0</span>
            </div>
        </div>
        <div id="friendsList" class="list-container">
            <div class="tg-spinner-container"><div class="tg-spinner"></div></div>
        </div>
        <div id="requestsList" class="list-container hidden"></div>
    </div>
    <div id="mainChatArea" class="chat-area">
        <div id="noChat" style="height:100%; display:flex; align-items:center; justify-content:center; color:#555;"></div>
        <div id="activeChat" class="hidden" style="height:100%; display:flex; flex-direction:column; position: relative;">
            <div id="floatingDate" class="floating-date">–°–µ–≥–æ–¥–Ω—è</div>
            <input type="date" id="chatDatePicker" style="position: absolute; top: 66px; left: 50%; opacity: 0; pointer-events: none; z-index: -1;">

            <div class="chat-header">
                <div class="chat-header-left" onclick="alert('–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–∫–æ—Ä–æ!')">
                    <button class="back-btn" onclick="event.stopPropagation(); closeChat();">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#aaa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    </button>
                    <div class="chat-header-avatar" id="chatHeaderAvatar">üë§</div>
                    <div class="chat-header-info">
                        <div class="chat-title" id="chatTitle">User</div>
                        <div class="chat-status" id="chatStatus">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button class="header-icon-btn" onclick="toggleChatSearch()">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="#aaa"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" /></svg>
                    </button>
                    <button class="header-icon-btn" onclick="startCall()">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="#aaa"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z" /></svg>
                    </button>
                    <button class="header-icon-btn" onclick="alert('–ú–µ–Ω—é —á–∞—Ç–∞ —Å–∫–æ—Ä–æ!')">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="#aaa"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" /></svg>
                    </button>
                </div>
            </div>

            <div id="chatSearchBar" class="chat-search-bar hidden">
                <svg class="search-glass-icon" viewBox="0 0 24 24" width="20" height="20" fill="#888"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" /></svg>

                <input type="text" id="chatSearchInput" placeholder="–ü–æ–∏—Å–∫" oninput="handleChatSearchInput(this.value)" onkeydown="if(event.key === 'Enter') navigateChatSearch(1)">

                <span class="chat-search-count" id="chatSearchCount"></span>

                <div class="chat-search-actions">
                    <button class="chat-search-btn" onclick="navigateChatSearch(-1)" title="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="#aaa"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" /></svg>
                    </button>
                    <button class="chat-search-btn" onclick="navigateChatSearch(1)" title="–°–ª–µ–¥—É—é—â–µ–µ">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="#aaa"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z" /></svg>
                    </button>
                    <div class="search-divider"></div>
                    <button class="chat-search-btn" onclick="alert('–ü–æ–∏—Å–∫ –ø–æ –¥–∞—Ç–µ —Å–∫–æ—Ä–æ!')" title="–ö–∞–ª–µ–Ω–¥–∞—Ä—å">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="#aaa"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z" /></svg>
                    </button>
                    <button class="chat-search-btn" onclick="toggleChatSearch()" title="–ó–∞–∫—Ä—ã—Ç—å" style="margin-left: 5px;">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="#aaa"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" /></svg>
                    </button>
                </div>
            </div>
            <div id="chatSearchDropdown" class="chat-search-dropdown hidden"></div>
            <div id="chatViewsContainer" style="flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden;"></div>
            <div id="scrollToBottomBtn" class="scroll-bottom-btn" onclick="scrollToBottom()">
                <svg viewBox="0 0 24 24">
                    <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z" />
                </svg>
            </div>
            <div class="input-bar">

                <div id="replyBar" class="reply-bar hidden" style="position: absolute; bottom: 100%; left:0; right:0; border-top-left-radius: 12px; border-top-right-radius: 12px;">
                    <div class="reply-icon">‚Ü©Ô∏è</div>
                    <div class="reply-content">
                        <div id="replyTitle" class="reply-title">User</div>
                        <div id="replyText" class="reply-text">Text...</div>
                    </div>
                    <button class="reply-close" onclick="cancelReplyOrEdit()">‚úñ</button>
                </div>

                <div class="input-wrapper">
                    <button class="tg-icon-btn-input" onclick="alert('–°–º–∞–π–ª—ã —Å–∫–æ—Ä–æ!')">
                        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.17 8 15.33 8 13.83 8.67 13.83 9.5 14.5 11 15.33 11zm-6.66 0c.83 0 1.5-.67 1.5-1.5S9.5 8 8.67 8 7.17 8.67 7.17 9.5 7.84 11 8.67 11zM12 17.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" /></svg>
                    </button>

                    <textarea id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" spellcheck="true" wrap="soft" oninput="autoResize(this); handleTyping(); checkInputState();" onkeydown="handleChatInput(event)"></textarea>
                    <input type="file" id="fileInput" style="display: none;" onchange="uploadFile(this)">

                    <button class="tg-icon-btn-input" onclick="document.getElementById('fileInput').click()">
                        <svg viewBox="0 0 24 24" style="transform: rotate(45deg);"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z" /></svg>
                    </button>
                </div>

                <button id="voiceBtn" class="main-action-btn btn-mic" onclick="alert('–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–∫–æ—Ä–æ!')">
                    <svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white;"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" /><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" /></svg>
                </button>

                <button id="sendBtn" class="main-action-btn btn-send hidden" onclick="sendMsg()">
                    <svg viewBox="0 0 24 24" style="width:24px;height:24px;fill:white; margin-left: 2px;"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" /></svg>
                </button>

            </div>
        </div>
    </div>
    <!-- CALL UI -->
    <div id="callScreen" class="call-screen">
        <div class="video-grid">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="local-video-container" id="localPip">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="pip-resize-handle" aria-hidden="true"></div>
            </div>
        </div>
        <div class="timer-badge">
            <div id="callStatusText">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div>
            <div id="callTimer">00:00</div>
            <div id="callPing">Ping: -</div>
        </div>
        <div class="controls">
            <div class="control-item">
                <button onclick="toggleScreen()" id="btnScr" class="btn-circle">üñ•Ô∏è</button>
                <span id="lblScr" class="control-label">–≠–∫—Ä–∞–Ω</span>
            </div>
            <div class="control-item">
                <button onclick="toggleCamera()" id="btnCam" class="btn-circle">üì∑</button>
                <span id="lblCam" class="control-label">–í–∫–ª. –≤–∏–¥–µ–æ</span>
            </div>
            <div class="control-item">
                <button onclick="switchCamera()" id="btnFlip" class="btn-circle">üîÑ</button>
                <span class="control-label">–ö–∞–º–µ—Ä–∞</span>
            </div>
            <div class="control-item">
                <button onclick="endCallUser()" class="btn-circle btn-hangup">üìû</button>
                <span class="control-label">–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>
            </div>
            <div class="control-item">
                <button onclick="toggleMic()" id="btnMic" class="btn-circle">üé§</button>
                <span id="lblMic" class="control-label">–í—ã–∫–ª. –∑–≤—É–∫</span>
            </div>

            <div class="control-item" id="speakerControl" style="display: none;">
                <button onclick="toggleSpeaker()" id="btnSpeaker" class="btn-circle">üîà</button>
                <span id="lblSpeaker" class="control-label">–í —É—Ö–æ</span>
            </div>

        </div>
    </div>
    <script>

        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby4AnViDZV8N6X-Tk9XFG2LQwTUVb2TWWR3RcoCNhkRmOM5XLug9UBi1Ky-_j2sQB5u/exec";
        const TRANSLATE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwONUKG_V_R6rdKui4SfEbNQEwfWOGiwu0rMpRl669REYvFG0Qd2kHcWYGSehe5vWbr/exec";
        const APP_SECRET_KEY = "JH54jnbdfkjs297615109dxc1kDmnsg_df1jksHnh1Lhsc";


        const firebaseConfig = {
            apiKey: "AIzaSyBncXLA4D1JdsqQtA8_8rPqQioq2XRfic4",
            authDomain: "mycoolmessenger.firebaseapp.com",
            databaseURL: "https://mycoolmessenger-default-rtdb.firebaseio.com",
            projectId: "mycoolmessenger",
            storageBucket: "mycoolmessenger.firebasestorage.app",
            messagingSenderId: "225503087166",
            appId: "1:225503087166:web:1355f138e34e3a0172df6f"
        };
        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app();
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        db.enablePersistence({ synchronizeTabs: true })
            .then(() => console.log("üî• Offline Persistence enabled"))
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.log("Persistence failed: Multiple tabs open");
                } else if (err.code == 'unimplemented') {
                    console.log("Persistence failed: Not supported");
                }
            });
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—ç—à –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –∏–∑ localStorage, —á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ —Ç–µ—Ä—è–ª–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —á–∞—Ç–∞
        // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—ç—à –∏–∑ –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ---
        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ö—ç—à —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ ---
        let globalTranslationCache = JSON.parse(localStorage.getItem('novogram_translations') || '{}');

        // –§—É–Ω–∫—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—á—Ç–æ–±—ã –Ω–µ –∑–∞–±–∏—Ç—å –ø–∞–º—è—Ç—å)
        function saveTranslationToLocal(msgId, text) {
            globalTranslationCache[msgId] = text;
            // –ï—Å–ª–∏ –∑–∞–ø–∏—Å–µ–π –±–æ–ª—å—à–µ 500, —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ, —á—Ç–æ–±—ã —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ —Ç—É–ø–∏–ª
            const keys = Object.keys(globalTranslationCache);
            if (keys.length > 500) delete globalTranslationCache[keys[0]];
            localStorage.setItem('novogram_translations', JSON.stringify(globalTranslationCache));
        }

        // --- –ö–†–ò–ü–¢–û–ì–†–ê–§–ò–Ø (–ë–ï–ó–û–ü–ê–°–ù–ê–Ø) ---
        // –¢–≤–æ—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç
        const KEY_PROVIDER_URL = "https://script.google.com/macros/s/AKfycbwkRCYUHSgywECcVq4YYn6RJt4A27KLZO5l_KgB-dO7OvITMc-7VJF27u4u_mlCZOk/exec";

        let sessionKeys = {}; // –ö—ç—à –∫–ª—é—á–µ–π –≤ –ø–∞–º—è—Ç–∏

        // 1. –ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á (–∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É)
        async function fetchChatKey(chatId) {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –ø–∞–º—è—Ç–∏ (—Å–∞–º–æ–µ –±—ã—Å—Ç—Ä–æ–µ)
            if (sessionKeys[chatId]) return sessionKeys[chatId];

            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage (–±—ã—Å—Ç—Ä–æ)
            const localKey = localStorage.getItem('chatKey_' + chatId);
            if (localKey) {
                sessionKeys[chatId] = localKey;
                return localKey;
            }

            // 3. –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏–≥–¥–µ - –∏–¥–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–¥–æ–ª–≥–æ, –Ω–æ —Ç–æ–ª—å–∫–æ 1 —Ä–∞–∑)
            try {
                console.log("–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –∫–ª—é—á –¥–ª—è:", chatId);
                const response = await fetch(KEY_PROVIDER_URL, {
                    method: 'POST',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({
                        chatId: chatId,
                        userId: currentUser.uid
                    })
                });

                const textResult = await response.text();
                const data = JSON.parse(textResult);

                if (data.status === "success" && data.key) {
                    sessionKeys[chatId] = data.key;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –Ω–∞ –±—É–¥—É—â–µ–µ
                    localStorage.setItem('chatKey_' + chatId, data.key);
                    console.log("‚úÖ –ö–ª—é—á –ø–æ–ª—É—á–µ–Ω –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
                    return data.key;
                } else {
                    console.error("‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É:", data.message || "–ù–µ—Ç –∫–ª—é—á–∞");
                    return null;
                }
            } catch (e) {
                console.error("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞:", e);
                return null;
            }
        }

        // 2. –ó–∞—à–∏—Ñ—Ä–æ–≤–∞—Ç—å (–∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–ª—é—á)
        function encryptText(text, chatId) {
            const key = sessionKeys[chatId];
            if (!key || !text) return text;
            try {
                return CryptoJS.AES.encrypt(text, key).toString();
            } catch (e) { return text; }
        }

        // 3. –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å (–∏—Å–ø–æ–ª—å–∑—É—è –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–ª—é—á)
        function decryptText(cipherText, chatId) {
            const key = sessionKeys[chatId];
            if (!key || !cipherText) return cipherText;
            try {
                const bytes = CryptoJS.AES.decrypt(cipherText, key);
                const originalText = bytes.toString(CryptoJS.enc.Utf8);
                return originalText || cipherText;
            } catch (e) { return cipherText; }
        }



        // --- –®ÔøΩ?–§ÔøΩ –û–í–ê–ùÔøΩ?–ï –¢–û–ö–ï–ù–ê –¢–ï–õ–ï–ìÔøΩ –ê–ú–ê (Base64) ---
        // –¢–æ–∫–µ–Ω: 8387775107:AAGhXPcfytIcnh-_zD04HvlGXIJ_b-crPK4


        const iceServers = {
            iceServers: [
                { urls: "stun:stun.relay.metered.ca:80" },
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] },
                { urls: "turn:global.relay.metered.ca:80", username: "ae2c0c3b821722b03a252928", credential: "TVZk6SgD8cbvbQlB" },
                { urls: "turn:global.relay.metered.ca:80?transport=tcp", username: "ae2c0c3b821722b03a252928", credential: "TVZk6SgD8cbvbQlB" },
                { urls: "turn:global.relay.metered.ca:443", username: "ae2c0c3b821722b03a252928", credential: "TVZk6SgD8cbvbQlB" },
                { urls: "turns:global.relay.metered.ca:443?transport=tcp", username: "ae2c0c3b821722b03a252928", credential: "TVZk6SgD8cbvbQlB" },
                { urls: "turn:open-turn.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:open-turn.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:open-turn.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
            ],
            iceCandidatePoolSize: 10
        };
        let currentUser = null;
        let currentFriendId = null;
        let currentCallId = null;
        let currentChatId = null;
        let pc = null;
        let localStream = null;
        let usersCache = {};
        let currentFacingMode = "user";
        let msgUnsub = null;
        let candidateQueue = [];
        let callTimerInt = null;
        let callStartTime = 0;
        let isConnected = false;
        let wasCallConnected = false;
        let amICaller = false;
        let pingInterval = null;
        let selectedMsgId = null;
        let selectedMsgIsMine = false;
        let lastSeenInterval = null;
        let unreadCounts = {};
        let audioCtx = null;
        let toneTimer = null;
        let typingUnsub = null; // –°–ª—É—à–∞—Ç–µ–ª—å –≤—Ö–æ–¥—è—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
        let isTyping = false;¬† ¬†// –ú–æ–π —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
        let typingTimeout = null; // –¢–∞–π–º–µ—Ä –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞
        let lastTypingTime = 0; // –î–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ –±–∞–∑—É (throttle)
        let chatStatusUnsub = null;
        let originalUsername = ""; // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É
        let isUsernameValid = true; // –ò —ç—Ç—É
        let usernameCheckTimeout = null; // –ò —ç—Ç—É

               // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–û–ò–°–ö (–ë–ï–ó –î–£–ë–õ–ò–ö–ê–¢–û–í) ---
        let searchTimeout = null;

        async function handleSearchInput(input) {
            const resultsBox = document.getElementById('searchResults');
            const cleanQuery = input.value.trim();

            if (cleanQuery.length === 0) {
                resultsBox.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º...</div>';
                return;
            }

            resultsBox.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">üîç –ü–æ–∏—Å–∫...</div>';

            if (searchTimeout) clearTimeout(searchTimeout);

            searchTimeout = setTimeout(async () => {
                const localHits = [];
                const globalHits = [];

                const qLower = cleanQuery.toLowerCase(); // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
                const qExact = cleanQuery; // –î–ª—è Firebase (Firebase —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É!)

                // –ê. –ü–æ–∏—Å–∫ –ø–æ –ª–æ–∫–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç–∞–∫—Ç–∞–º (–¥—Ä—É–∑—å—è–º)
                Object.keys(usersCache).forEach(id => {
                    if (id === currentUser.uid) return; // –°–µ–±—è –Ω–µ –∏—â–µ–º
                    const u = usersCache[id];
                    const fullName = `${u.name || ''} ${u.surname || ''}`.toLowerCase();
                    const uName = (u.username || '').toLowerCase();
                    if (fullName.includes(qLower) || uName.includes(qLower)) {
                        localHits.push({ id, ...u });
                    }
                });

                // –ë. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –≤ Firebase
                try {
                    // –í–Ω–∏–º–∞–Ω–∏–µ: –µ—Å–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º –≤ –±–∞–∑–µ "Alex", –ø–æ–∏—Å–∫ –ø–æ "alex" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ—Ç.
                    // Firebase —Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤.
                    const snap = await db.collection('users')
                        .where('username', '>=', qExact)
                        .where('username', '<=', qExact + '\uf8ff')
                        .limit(10).get();

                    snap.forEach(doc => {
                        const userData = doc.data();
                        if (doc.id !== currentUser.uid && !localHits.find(h => h.id === doc.id)) {
                            globalHits.push({ id: doc.id, ...userData });
                        }
                    });
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞:", e);
                }

                // –í. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –±–µ–∑ innerHTML += (—á—Ç–æ–±—ã –Ω–µ —É–±–∏—Ç—å onclick)
                resultsBox.innerHTML = '';

                if (localHits.length === 0 && globalHits.length === 0) {
                    resultsBox.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    return;
                }

                if (localHits.length > 0) {
                    const title = document.createElement('div');
                    title.className = 'search-section-title';
                    title.innerText = '–í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã';
                    resultsBox.appendChild(title);
                    localHits.forEach(u => resultsBox.appendChild(renderSearchResult(u, true)));
                }

                if (globalHits.length > 0) {
                    const title = document.createElement('div');
                    title.className = 'search-section-title';
                    title.innerText = '–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫';
                    resultsBox.appendChild(title);
                    globalHits.forEach(u => resultsBox.appendChild(renderSearchResult(u, false)));
                }
            }, 400);
        }

        // –ï–î–ò–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ (—É–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ –∫–æ–ø–∏–∏ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏!)
        function renderSearchResult(user, isFriend) {
            const div = document.createElement('div');
            div.className = 'search-item';

            const fullName = `${user.name || 'User'} ${user.surname || ''}`.trim();

            // –ê–≤–∞—Ç–∞—Ä–∫–∞
            const avatarHtml = user.avatar
                ? `<img src="${user.avatar}" class="search-avatar-placeholder" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">`
                : `<div class="search-avatar-placeholder" style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#6a11cb,#2575fc);color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;">${fullName.charAt(0).toUpperCase()}</div>`;

            div.innerHTML = `
        ${avatarHtml}
        <div class="search-info" style="flex:1; overflow:hidden; margin-left: 10px;">
            <div class="search-name" style="font-weight:bold; color:white; font-size:15px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${fullName}</div>
            <div class="search-sub" style="font-size:13px; color:#888;">${user.username ? '@' + user.username : 'ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'}</div>
        </div>
        <div class="search-action" style="color:#007bff; font-size:20px;">${isFriend ? 'üí¨' : '‚ûï'}</div>
    `;

            // –°–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞ —Ç–µ–ø–µ—Ä—å –Ω–∞–¥–µ–∂–Ω–æ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –∑–∞ —É–∑–ª–æ–º
            div.onclick = () => {
                if (isFriend) {
                    openChat(user.id, fullName, user.username ? '@' + user.username : '');
                } else {
                    sendFriendRequestToId(user.id);
                }
                closeSearch();
            };

            return div;
        }

        


        async function performSearch(query) {
            const resultsBox = document.getElementById('searchResults');
            resultsBox.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">–ü–æ–∏—Å–∫...</div>';

            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ (–∫–ª–∞—Å—Å active –∏–∑ CSS)
            if (!resultsBox.classList.contains('active')) {
                openSearchUI();
            }

            const cleanQuery = query.startsWith('@') ? query.slice(1).toLowerCase() : query.toLowerCase();

            try {
                // --- –ê. –õ–û–ö–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö (–°–†–ï–î–ò –î–†–£–ó–ï–ô) ---
                // –ò—â–µ–º –≤ –∫—ç—à–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const localHits = Object.keys(usersCache || {})
                    .map(id => ({ id, ...usersCache[id] }))
                    .filter(u => {
                        const q = cleanQuery;
                        return (u.name && u.name.toLowerCase().includes(q)) ||
                            (u.username && u.username.toLowerCase().includes(q)) ||
                            (u.email && u.email.toLowerCase().includes(q));
                    });

                // --- –ë. –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–û–ò–°–ö (–ë–ê–ó–ê –î–ê–ù–ù–´–•) ---
                const globalHits = [];

                // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –¥–ª–∏–Ω–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤, –∏—â–µ–º –≤ –±–∞–∑–µ
                if (cleanQuery.length >= 2) {
                    // –ò—â–µ–º –ø–æ username
                    const snapUser = await db.collection('users')
                        .where('username', '>=', cleanQuery)
                        .where('username', '<=', cleanQuery + '\uf8ff')
                        .limit(5)
                        .get();

                    snapUser.forEach(doc => {
                        // –ò—Å–∫–ª—é—á–∞–µ–º —Å–µ–±—è –∏ —Ç–µ—Ö, –∫—Ç–æ —É–∂–µ –µ—Å—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –ø–æ–∏—Å–∫–µ
                        if (doc.id !== currentUser.uid && !localHits.find(h => h.id === doc.id)) {
                            globalHits.push({ id: doc.id, ...doc.data() });
                        }
                    });

                    // –ò—â–µ–º –ø–æ email (–µ—Å–ª–∏ –º–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
                    if (globalHits.length < 3) {
                        const snapEmail = await db.collection('users')
                            .where('email', '>=', cleanQuery)
                            .where('email', '<=', cleanQuery + '\uf8ff')
                            .limit(5)
                            .get();

                        snapEmail.forEach(doc => {
                            if (doc.id !== currentUser.uid &&
                                !localHits.find(h => h.id === doc.id) &&
                                !globalHits.find(h => h.id === doc.id)) {
                                globalHits.push({ id: doc.id, ...doc.data() });
                            }
                        });
                    }
                }

                // --- –í. –û–¢–†–ò–°–û–í–ö–ê ---
                resultsBox.innerHTML = '';

                if (localHits.length === 0 && globalHits.length === 0) {
                    resultsBox.innerHTML = '<div style="padding:20px; color:#888; text-align:center;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                    return;
                }

                if (localHits.length > 0) {
                    resultsBox.innerHTML += `<div class="search-section-title">–í–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã</div>`;
                    localHits.forEach(user => resultsBox.appendChild(renderSearchResult(user, true)));
                }

                if (globalHits.length > 0) {
                    resultsBox.innerHTML += `<div class="search-section-title">–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫</div>`;
                    globalHits.forEach(user => resultsBox.appendChild(renderSearchResult(user, false)));
                }

            } catch (e) {
                console.error(e);
                resultsBox.innerHTML = '<div style="padding:10px; color:red; text-align:center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
            }
        }
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HTML —ç–ª–µ–º–µ–Ω—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        
        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –ø–æ ID (–∞ –Ω–µ email)
        async function sendFriendRequestToId(targetUid) {
            try {
                const myUsername = await getCurrentUsername();
                await db.collection('friend_requests').add({
                    from: currentUser.uid,
                    fromEmail: currentUser.email,
                    fromUsername: myUsername || 'none',
                    to: targetUid,
                    ts: firebase.firestore.FieldValue.serverTimestamp()
                });
                alert('–ó–∞—è–≤–∫–∞ –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞—è–≤–∫–∏');
            }
        }
        async function getCurrentUsername() {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            return doc.exists ? doc.data().username : null;
        }
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
        function beep(freq, duration, vol = 0.05) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq;
            osc.type = 'sine';
            gain.gain.value = vol;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            setTimeout(() => {
                gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.04);
                osc.stop(audioCtx.currentTime + 0.05);
            }, duration);
        }
        function playConnectingTone() {
            stopAllTones();
            const loop = () => beep(425, 100, 0.05);
            loop();
            toneTimer = setInterval(loop, 1500);
        }
        function playRingingTone() {
            stopAllTones();
            const loop = () => beep(425, 1000, 0.08);
            loop();
            toneTimer = setInterval(loop, 4000);
        }
        function playEndTone() {
            stopAllTones();
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.4);
        }
        function stopAllTones() {
            if (toneTimer) { clearInterval(toneTimer); toneTimer = null; }
        }
        function formatLastSeen(timestamp) {
            if (!timestamp) return "–±—ã–ª –¥–∞–≤–Ω–æ";
            const now = Date.now();
            const diff = now - timestamp.toMillis();
            const seconds = Math.floor(diff / 1000); // –°—á–∏—Ç–∞–µ–º —Å–µ–∫—É–Ω–¥—ã
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            const months = Math.floor(days / 30);
            // === –ù–ê–°–¢–†–û–ô–ö–ê –ó–î–ï–°–¨ ===
            // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ 45 —Å–µ–∫—É–Ω–¥, —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –æ–Ω –µ—â—ë "–≤ —Å–µ—Ç–∏"
            if (seconds < 30) return "–≤ —Å–µ—Ç–∏";
            // –ï—Å–ª–∏ –æ—Ç 45 —Å–µ–∫ –¥–æ 1 –º–∏–Ω—É—Ç—ã - –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å "–±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ" –∏–ª–∏ —É–∂–µ —Å—á–∏—Ç–∞—Ç—å –º–∏–Ω—É—Ç—ã
            if (minutes < 1) return "–±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ";
            // –î–∞–ª—å—à–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ
            if (minutes < 60) return `${minutes} ${minutes === 1 ? '–º–∏–Ω—É—Ç—É' : minutes < 5 ? '–º–∏–Ω—É—Ç—ã' : '–º–∏–Ω—É—Ç'} –Ω–∞–∑–∞–¥`;
            if (hours < 24) return `${hours} ${hours === 1 ? '—á–∞—Å' : hours < 5 ? '—á–∞—Å–∞' : '—á–∞—Å–æ–≤'} –Ω–∞–∑–∞–¥`;
            if (days < 30) return `${days} ${days === 1 ? '–¥–µ–Ω—å' : days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'} –Ω–∞–∑–∞–¥`;
            return "–±—ã–ª –¥–∞–≤–Ω–æ";
        }
        let lastActivityTime = Date.now();
        let isOnline = false;
        // –°–ª–µ–¥–∏–º –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, () => {
                lastActivityTime = Date.now();
                if (!isOnline) {
                    // –ï—Å–ª–∏ –æ–Ω "–ø—Ä–æ—Å–Ω—É–ª—Å—è" - —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                    updateLastSeen();
                }
            });
        });
        function updateLastSeen() {
            const now = Date.now();
            // –ï—Å–ª–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ 30 —Å–µ–∫—É–Ω–¥ - –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—É
            if (now - lastActivityTime < 30000) {
                isOnline = true;
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(e => console.log('Err update lastSeen', e));
                }
            } else {
                isOnline = false;
                // –ú–æ–∂–Ω–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —è–≤–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–æ—Ñ–ª–∞–π–Ω" –≤ –±–∞–∑—É, –Ω–æ –ª—É—á—à–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–∞—Ç—É
            }
        }
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
        // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω -> –æ–±–Ω–æ–≤–∏—Ç –¥–∞—Ç—É –≤ –±–∞–∑–µ.
        // –ï—Å–ª–∏ –ù–ï –∞–∫—Ç–∏–≤–µ–Ω -> –Ω–µ –æ–±–Ω–æ–≤–∏—Ç, –∏ —á–µ—Ä–µ–∑ 30-60 —Å–µ–∫ –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–Ω —Å—Ç–∞–Ω–µ—Ç "–±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ"
        setInterval(updateLastSeen, 15000);
        // --- AUTH ---
        // 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function authAction() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            if (!e || !p) return;
            // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —é–∑–µ—Ä—É, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –ø–æ—à–µ–ª
            const btn = document.querySelector('#stepEmail button'); // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É
            const originalText = btn.innerText;
            btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            btn.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∂–∞–ª –¥–≤–∞–∂–¥—ã
            btn.style.opacity = "0.7";
            auth.signInWithEmailAndPassword(e, p).catch(err => {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å
                if (err.code.includes('not-found') || err.code.includes('wrong') || err.code.includes('invalid')) {
                    auth.createUserWithEmailAndPassword(e, p).then(cred => {
                        db.collection('users').doc(cred.user.uid).set({
                            email: e,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, onAuthStateChanged –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    }).catch(regErr => {
                        // –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                        document.getElementById('authError').innerText = regErr.message;
                        btn.innerText = originalText;
                        btn.disabled = false;
                        btn.style.opacity = "1";
                    });
                } else {
                    // –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞
                    document.getElementById('authError').innerText = err.message;
                    btn.innerText = originalText;
                    btn.disabled = false;
                    btn.style.opacity = "1";
                }
            });
        }
        // --- 1. –û–ü–¢–ò–ú–ò–°–¢–ò–ß–ù–´–ô –í–•–û–î (–í—Å—Ç–∞–≤–∏—Ç—å –ü–ï–†–ï–î auth.onAuthStateChanged) ---
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥–∏–ª –ª–∏ —é–∑–µ—Ä –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑
        const wasLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        if (wasLoggedIn) {
            // –°—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –æ—Ç–≤–µ—Ç–∞ –æ—Ç Google
            document.getElementById('authScreen').classList.add('hidden');
        }
        // --- 2. –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê (–í–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è) ---
        auth.onAuthStateChanged(u => {
            if (u) {
                currentUser = u;


                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('current_user_uid', u.uid);

                // –ó–ê–ü–£–°–ö–ê–ï–ú –î–ê–ù–ù–´–ï –°–†–ê–ó–£
                loadData();
                listenForIncomingCalls();

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º email –≤ –∫—ç—à –ø—Ä–æ—Ñ–∏–ª—è (—á–∞—Å—Ç–∏—á–Ω–æ)
                let currentCache = JSON.parse(localStorage.getItem('user_profile_cache') || '{}');
                currentCache.email = u.email;
                localStorage.setItem('user_profile_cache', JSON.stringify(currentCache));

                const savedToken = localStorage.getItem('fcm_token');
                if (savedToken) {
                    saveTokenToBackend(u.uid, savedToken);
                }

                loadTgId();
                setTimeout(handleHashChange, 500);

                db.collection('users').doc(u.uid).get().then(doc => {
                    if (doc.exists) {
                        const d = doc.data();

                        // !!! –í–ê–ñ–ù–û: –°–û–•–†–ê–ù–Ø–ï–ú –ü–û–õ–ù–´–ô –ü–†–û–§–ò–õ–¨ –í –ö–≠–® –î–õ–Ø –°–õ–ï–î–£–Æ–©–ï–ì–û –ó–ê–ü–£–°–ö–ê !!!
                        d.email = u.email; // –î–æ–±–∞–≤–ª—è–µ–º email –≤ –æ–±—ä–µ–∫—Ç
                        localStorage.setItem('user_profile_cache', JSON.stringify(d));
                        // -------------------------------------------------------------------

                        const myAvatarSmall = document.getElementById('myAvatarSmall');
                        if (myAvatarSmall && d.avatar) {
                            myAvatarSmall.innerHTML = `<img src="${d.avatar}" alt="avatar">`;
                        }

                        if (d.username) {
                            document.getElementById('authScreen').classList.add('hidden');
                            document.getElementById('profileEmail').innerText = u.email;
                            updateLastSeen();
                            if (lastSeenInterval) clearInterval(lastSeenInterval);
                        } else {
                            // –õ–æ–≥–∏–∫–∞ –µ—Å–ª–∏ –Ω–µ—Ç —é–∑–µ—Ä–Ω–µ–π–º–∞
                            document.getElementById('stepEmail').style.display = 'none';
                            document.getElementById('stepName').style.display = 'block';
                            document.getElementById('stepUsername').style.display = 'none';
                            document.getElementById('authScreen').classList.remove('hidden');
                        }
                    }
                });
            } else {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('current_user_uid'); // –ß–∏—Å—Ç–∏–º ID –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
                // –ù–µ —É–¥–∞–ª—è–µ–º –∫—ç—à –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é, —á—Ç–æ–±—ã –ø—Ä–∏ –ø–µ—Ä–µ–≤—Ö–æ–¥–µ –∞–≤–∞—Ç–∞—Ä–∫–∞ –º–µ–ª—å–∫–Ω—É–ª–∞ —Å—Ä–∞–∑—É,
                // –Ω–æ –ª—É—á—à–µ —É–¥–∞–ª–∏—Ç—å, –µ—Å–ª–∏ —ç—Ç–æ —á—É–∂–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω. –û—Å—Ç–∞–≤–∏–º –ø–æ–∫–∞ —Ç–∞–∫ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏.

                if (wasLoggedIn) {
                    alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
                }
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('stepEmail').style.display = 'block';
                if (lastSeenInterval) clearInterval(lastSeenInterval);
            }
        });



        function checkNameInput() {
            const name = document.getElementById('regName').value.trim();
            const btn = document.getElementById('btnNameNext');
            if (name.length > 0) {
                btn.disabled = false;
                btn.style.background = '#007bff'; // –°–∏–Ω–∏–π
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.background = '#444';
                btn.style.cursor = 'not-allowed';
            }
        }
        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É 3
        function goToUsernameStep() {
            document.getElementById('stepName').style.display = 'none';
            document.getElementById('stepUsername').style.display = 'block';
        }
        // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º—è)
        function backToName() {
            document.getElementById('stepUsername').style.display = 'none';
            document.getElementById('stepName').style.display = 'block';
        }
        // –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —é–∑–µ—Ä–Ω–µ–π–º–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        let usernameTimeout = null;
        function checkUsernameInput() {
            let val = document.getElementById('regUsername').value;
            const status = document.getElementById('usernameStatus');
            const btn = document.getElementById('btnFinish');
            // –û—á–∏—Å—Ç–∫–∞ –æ—Ç –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
            val = val.replace(/[^a-zA-Z0-9_.]/g, '');
            document.getElementById('regUsername').value = val; // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ
            // –í–∏–∑—É–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º @
            // (–í –∫–æ–¥–µ –≤—ã—à–µ input —É–∂–µ –∏–º–µ–µ—Ç placeholder, –Ω–æ –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å)
            btn.disabled = true;
            btn.style.background = '#444';
            btn.style.cursor = 'not-allowed';
            if (val.length < 3) {
                status.innerText = "–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)";
                status.style.color = "#ff4444";
                return;
            }
            status.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";
            status.style.color = "#aaa";
            // Debounce (–∂–¥–µ–º –ø–æ–∫–∞ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –ø–µ—á–∞—Ç–∞—Ç—å)
            if (usernameTimeout) clearTimeout(usernameTimeout);
            usernameTimeout = setTimeout(() => {
                // –ó–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ
                db.collection('users').where('username', '==', val).get().then(snap => {
                    if (snap.empty) {
                        status.innerText = `@${val} —Å–≤–æ–±–æ–¥–Ω–æ`;
                        status.style.color = "#4caf50"; // –ó–µ–ª–µ–Ω—ã–π
                        btn.disabled = false;
                        btn.style.background = '#007bff';
                        btn.style.cursor = 'pointer';
                    } else {
                        status.innerText = `@${val} —É–∂–µ –∑–∞–Ω—è—Ç–æ`;
                        status.style.color = "#ff4444"; // –ö—Ä–∞—Å–Ω—ã–π
                    }
                });
            }, 500); // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–≤–æ–¥–∞
        }
        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function finishRegistration() {
            const name = document.getElementById('regName').value.trim();
            const surname = document.getElementById('regSurname').value.trim();
            const username = document.getElementById('regUsername').value.trim();
            if (!name || !username) return;
            db.collection('users').doc(currentUser.uid).set({
                name: name,
                surname: surname,
                username: username,
                email: currentUser.email, // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }).then(() => {
                // –£—Å–ø–µ—Ö -> –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
                // –õ—É—á—à–µ –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É, –∫–∞–∫ –≤ onAuthStateChanged
                document.getElementById('authScreen').classList.add('hidden');
                loadData();
                listenForIncomingCalls();
                loadTgId();
                if (lastSeenInterval) clearInterval(lastSeenInterval);
                lastSeenInterval = setInterval(updateLastSeen, 30000);
            });
        }
        window.addEventListener('beforeunload', updateLastSeen);
        // --- LOGIC ---
        function switchTab(t) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            if (t === 'friends') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('friendsList').classList.remove('hidden');
                document.getElementById('requestsList').classList.add('hidden');
            }
            else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('friendsList').classList.add('hidden');
                document.getElementById('requestsList').classList.remove('hidden');
            }
        }
        // –°–ª—É—à–∞—Ç–µ–ª—å –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞—è–≤–æ–∫ –≤ –¥—Ä—É–∑—å—è
        function listenForFriendRequests() {
            db.collection('friend_requests')
                .where('to', '==', currentUser.uid)
                .onSnapshot(async snap => {
                    const list = document.getElementById('requestsList');
                    const badge = document.getElementById('requestsBadge');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞—è–≤–æ–∫
                    if (snap.size > 0) {
                        badge.innerText = snap.size;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                    // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç, –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                    list.innerHTML = '';
                    if (snap.empty) {
                        list.innerHTML = '<div style="padding:20px;text-align:center;color:#888">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</div>';
                        return;
                    }
                    snap.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement('div');
                        div.className = 'user-item'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Å—Ç–∏–ª—å, —á—Ç–æ –∏ –¥–ª—è —á–∞—Ç–æ–≤
                        // –ê–≤–∞—Ç–∞—Ä–∫–∞ (–∑–∞–≥–ª—É—à–∫–∞ –∏–ª–∏ –º–æ–∂–Ω–æ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é)
                        const avatar = '<div class="user-item-avatar" style="background:#444;display:flex;align-items:center;justify-content:center;">üë§</div>';
                        div.innerHTML = `
                                                                                                                                                                                                                                                                                                                                                                                            ${avatar}
                                                                                                                                                                                                                                                                                                                                                                                            <div class="user-name" style="grid-row: 1/span 2; align-self:center;">
                                                                                                                                                                                                                                                                                                                                                                                                ${data.fromUsername ? '@' + data.fromUsername : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                                                                                                                                                                                                                                                                                                                                                                                                <div style="font-size:12px; color:#888; font-weight:normal;">–•–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è</div>
                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                            <div style="grid-column:3; grid-row:1/span 2; display:flex; gap:10px;">
                                                                                                                                                                                                                                                                                                                                                                                                <button onclick="accept('${doc.id}', '${data.from}', '${data.fromEmail}')" style="background:#28a745; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">‚úì</button>
                                                                                                                                                                                                                                                                                                                                                                                                <button onclick="reject('${doc.id}')" style="background:#dc3545; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">‚úï</button>
                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                        `;
                        list.appendChild(div);
                    });
                });
        }
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ
        function startMessageListener(chatId, fid, createdTime) {
            db.collection('chats').doc(chatId).collection('msgs')
                .orderBy('ts', 'desc').limit(1)
                .onSnapshot(msgSnap => {
                    const lastEl = document.getElementById('last-' + chatId);
                    const dateEl = document.getElementById('date-' + chatId);
                    const statusEl = document.getElementById('status-' + chatId);
                    const userDiv = document.getElementById('u-' + fid);
                    // –í—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏–ª–∏ –≤ –¥—Ä—É–∑—å—è
                    let timeToDisplay = createdTime;
                    if (!msgSnap.empty) {
                        const lastData = msgSnap.docs[0].data();
                        // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                        // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                        if (lastEl) {
                            const type = lastData.type || 'text';
                            let displayText = '';

                            // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –¥–ª—è –ø—Ä–µ–≤—å—é
                            const decryptedPreview = decryptText(lastData.txt, chatId);

                            if (type === 'image') {
                                displayText = 'üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è';
                            } else if (type === 'file') {
                                displayText = 'üìÑ –§–∞–π–ª';
                            } else if (type === 'call') {
                                const callState = decryptedPreview.split('|')[0];
                                displayText = (callState === 'missed' || callState === 'canceled') ? 'üìû –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤' : 'üìû –ó–≤–æ–Ω–æ–∫';
                            } else {
                                displayText = decryptedPreview || '';
                                if (displayText.length > 25) displayText = displayText.substring(0, 25) + '...';
                            }

                            if (lastData.from === currentUser.uid) {
                                displayText = '–í—ã: ' + displayText;
                            }
                            lastEl.innerHTML = displayText;
                        }
                        // –í—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è
                        if (lastData.ts) timeToDisplay = lastData.ts.toMillis();
                        // –ì–∞–ª–æ—á–∫–∏ (—Å—Ç–∞—Ç—É—Å)
                        if (statusEl) {
                            if (lastData.from === currentUser.uid) {
                                let ticksHtml = lastData.read
                                    ? '<span style="margin-right:-4px;">‚úì</span>‚úì'
                                    : '‚úì';
                                statusEl.innerHTML = ticksHtml;
                                statusEl.style.display = 'inline-flex';
                            } else {
                                statusEl.style.display = 'none';
                            }
                        }
                    } else {
                        if (lastEl) lastEl.innerHTML = "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π";
                        if (statusEl) statusEl.style.display = 'none';
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É
                    if (dateEl && timeToDisplay > 0) {
                        // –ó–ê–ú–ï–ù–ò–¢–ï –°–¢–ê–†–´–ô IF/ELSE –ù–ê –≠–¢–£ –°–¢–†–û–ß–ö–£:
                        dateEl.innerText = formatTelegramDate(new Date(timeToDisplay));
                    }
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É —Å–ø–∏—Å–∫–∞
                    if (userDiv) {
                        userDiv.setAttribute('data-time', timeToDisplay);
                        sortFriendsList();
                    }
                });
            // –°–ª—É—à–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ (Badge)
            db.collection('chats').doc(chatId).collection('msgs')
                .where('to', '==', currentUser.uid)
                .where('read', '==', false)
                .onSnapshot(unreadSnap => {
                    const badgeEl = document.getElementById('badge-' + chatId);
                    const count = unreadSnap.size;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –æ–±—â–µ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞ (–µ—Å–ª–∏ –æ–Ω —É –≤–∞—Å –µ—Å—Ç—å)
                    if (typeof unreadCounts !== 'undefined') {
                        unreadCounts[chatId] = count;
                        updateTotalFriendsBadge();
                    }
                    if (badgeEl) {
                        if (count > 0) {
                            badgeEl.innerText = count;
                            badgeEl.classList.remove('hidden');
                        } else {
                            badgeEl.classList.add('hidden');
                        }
                    }
                });
        }

        // --- –õ–û–ì–ò–ö–ê –£–î–ê–õ–ï–ù–ò–Ø (–û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø) ---

        
        // 1. –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
        function openDeleteSheet() {
            // 1. –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
            const menu = document.getElementById('contextMenu');
            if (menu) {
                menu.classList.remove('active');
                setTimeout(() => { menu.style.display = 'none'; }, 200);
            }

            // 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
            const chatTitleEl = document.getElementById('chatTitle');
            let friendName = chatTitleEl ? (chatTitleEl.firstElementChild ? chatTitleEl.firstElementChild.innerText : chatTitleEl.innerText) : "—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞";

            // 3. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            const friendNameSpan = document.getElementById('deleteFriendName');
            if (friendNameSpan) friendNameSpan.innerText = friendName;

            // 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
            const modal = document.getElementById('deleteModalOverlay');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        // 2. –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ (–∫–Ω–æ–ø–∫–∞ –û—Ç–º–µ–Ω–∞)
        function closeDeleteModal() {
            const modal = document.getElementById('deleteModalOverlay');
            if (modal) modal.style.display = 'none';

            // --- –ù–û–í–û–ï: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–º–∞–µ–º —Ä–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ –∏ –≤—ã–¥–µ–ª–µ–Ω–∏–µ ---
            closeAllSheets();
        }

        // 3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è (–∫–Ω–æ–ø–∫–∞ –£–¥–∞–ª–∏—Ç—å)
        function animateMessageRemoval(el) {
            if (!el || el.classList.contains('msg-deleting')) return;

            el.classList.remove('msg-highlighted'); // –£–±–∏—Ä–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è

            // –§–∏–∫—Å–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–µ —Ä–∞–∑–º–µ—Ä—ã –≤ –ø–∏–∫—Å–µ–ª—è—Ö –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
            el.style.height = el.offsetHeight + 'px';
            el.style.overflow = 'hidden';

            // –§–æ—Ä—Å–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫—É, —á—Ç–æ–±—ã –±—Ä–∞—É–∑–µ—Ä –∑–∞–ø–æ–º–Ω–∏–ª –≤—ã—Å–æ—Ç—É
            void el.offsetHeight;

            // –ü–ª–∞–≤–Ω–æ —Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ 0
            el.classList.add('msg-deleting');
            el.style.height = '0px';
            el.style.paddingTop = '0px';
            el.style.paddingBottom = '0px';
            el.style.marginTop = '0px';
            el.style.marginBottom = '0px';
            el.style.border = 'none';

            // –ß–µ—Ä–µ–∑ 300–º—Å (–∫–æ–≥–¥–∞ –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è) –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ —Å—Ç–∏—Ä–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç
            setTimeout(() => {
                if (el && el.parentNode) {
                    el.remove();
                    updateDateSeparators(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø–ª–∞—à–∫–∏ –¥–∞—Ç
                }
            }, 300);
        }

        // 3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è (–∫–Ω–æ–ø–∫–∞ –£–¥–∞–ª–∏—Ç—å)
        function executeDelete() {
            if (!selectedMsgId) return;

            const isDeleteForEveryone = document.getElementById('deleteForEveryone').checked;
            const el = document.getElementById(`msg-${selectedMsgId}`);

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∫—Ä–∞—Å–∏–≤—É—é –∞–Ω–∏–º–∞—Ü–∏—é –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
            if (el) animateMessageRemoval(el);

            if (isDeleteForEveryone) {
                // –£–¥–∞–ª—è–µ–º –∏–∑ –±–∞–∑—ã
                db.collection('chats').doc(currentChatId).collection('msgs').doc(selectedMsgId).delete()
                    .catch(err => {
                        console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:", err);
                        showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: " + err.message);
                    });
            } else {
                // –ü—Ä—è—á–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                const deletedLocal = JSON.parse(localStorage.getItem('deletedMsgs') || '[]');
                deletedLocal.push(selectedMsgId);
                localStorage.setItem('deletedMsgs', JSON.stringify(deletedLocal));
            }

            closeDeleteModal();
        }

        function loadProfileFromCache() {
            const cachedProfile = localStorage.getItem('user_profile_cache');
            if (cachedProfile) {
                try {
                    const d = JSON.parse(cachedProfile);
                    // 1. –°—Ç–∞–≤–∏–º –∞–≤–∞—Ç–∞—Ä–∫—É
                    const myAvatarSmall = document.getElementById('myAvatarSmall');
                    if (myAvatarSmall && d.avatar) {
                        myAvatarSmall.innerHTML = `<img src="${d.avatar}" alt="avatar">`;
                    }
                    // 2. –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —à—Ç–æ—Ä–∫–µ –ø—Ä–æ—Ñ–∏–ª—è (—á—Ç–æ–±—ã —Ç–∞–º –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ)
                    const emailEl = document.getElementById('profileEmail');
                    if (emailEl && d.email) emailEl.innerText = d.email;

                    const nameInput = document.getElementById('profileName');
                    if (nameInput) nameInput.value = d.name || '';

                    const usernameDiv = document.getElementById('profileUsername');
                    if (usernameDiv) usernameDiv.innerText = d.username ? '@' + d.username : '@–Ω–µ_–∑–∞–¥–∞–Ω';

                } catch (e) {
                    console.log("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞ –ø—Ä–æ—Ñ–∏–ª—è", e);
                }
            }
        }

        // --- –ù–û–í–ê–Ø –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (–í—Å—Ç–∞–≤–∏—Ç—å –ü–ï–†–ï–î loadData) ---
        function getFriendItemHTML(fid, friendData, chatId, createdTime) {
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –±–µ—Ä–µ–º –∏–º—è –∏–∑ –∫—ç—à–∞ –∏–ª–∏ –ø–∏—à–µ–º –∑–∞–≥–ª—É—à–∫—É
            const fName = friendData ? (friendData.name || friendData.username) : (usersCache[fid]?.name || '–ó–∞–≥—Ä—É–∑–∫–∞...');
            const fNick = friendData ? ('@' + friendData.username) : '';

            // –ê–≤–∞—Ç–∞—Ä–∫–∞
            const avatarHtml = (friendData && friendData.avatar)
                ? `<img src="${friendData.avatar}" class="user-item-avatar">`
                : `<div class="user-item-avatar" style="background:#444;display:flex;align-items:center;justify-content:center;font-size:24px;color:#888">üë§</div>`;

            return `
                        ${avatarHtml}
                        <div class="user-name">${fName}</div>
                        <div class="last-msg-row">
                            <span class="last-msg" id="last-${chatId}">...</span>
                        </div>
                        <div class="meta-column">
                            <span class="last-msg-date" id="date-${chatId}"></span>
                            <div class="meta-bottom-row">
                                <span id="status-${chatId}" class="list-ticks"></span>
                                <div class="badge-count hidden" id="badge-${chatId}">0</div>
                            </div>
                        </div>
                    `;
        }

        function loadData() {
            // 1. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∫—É –∑–∞—è–≤–æ–∫
            if (typeof listenForFriendRequests === 'function') {
                listenForFriendRequests();
            }

            const list = document.getElementById('friendsList');
            if (list.innerHTML === '' || list.innerText.includes('–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –ø—É—Å—Ç')) {
                list.innerHTML = '<div class="tg-spinner-container"><div class="tg-spinner"></div></div>';
            }

            const localFriends = localStorage.getItem('novogram_cached_friends');
            if (localFriends) {
                const parsed = JSON.parse(localFriends);
                const list = document.getElementById('friendsList');
                if (list.innerHTML === '' || list.innerText.includes('–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –ø—É—Å—Ç')) {
                    list.innerHTML = ''; // –û—á–∏—â–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
                    parsed.forEach(p => {
                        // –°–æ–∑–¥–∞–µ–º div –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
                        // –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –∂–¥–µ–º –ø–æ–∫–∞ Firebase –æ–±–Ω–æ–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ, –Ω–æ –ª—É—á—à–µ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å:
                        // (–î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∏–º –∫—ç—à –≤ –ø–∞–º—è—Ç—å, —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –∑–Ω–∞–ª –∏–º–µ–Ω–∞)
                        if (p.fid && p.data) usersCache[p.fid] = p.data;
                    });
                    // –¢—É—Ç –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –æ—Ç—Ä–∏—Å–æ–≤–∫—É, –Ω–æ —á—Ç–æ–±—ã –Ω–µ —É—Å–ª–æ–∂–Ω—è—Ç—å –∫–æ–¥ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º render-—Ñ—É–Ω–∫—Ü–∏–∏,
                    // Firebase Persistence –∏–∑ —à–∞–≥–∞ 1 –æ–±—ã—á–Ω–æ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –æ—Ç—Ä–∏—Å–æ–≤–∫–æ–π —Å–∞–º.
                    // –ù–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ usersCache –≤ –ø–∞–º—è—Ç—å –Ω–∞–º –æ—á–µ–Ω—å –ø–æ–º–æ–∂–µ—Ç –¥–ª—è –∏–º–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö!
                }
            }
            
            // 2. –°–ª—É—à–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û + –ü–†–ï–î–ó–ê–ì–†–£–ó–ö–ê –ö–õ–Æ–ß–ï–ô)
            db.collection('friends')
                .where('users', 'array-contains', currentUser.uid)
                .onSnapshot(async snap => {
                    const list = document.getElementById('friendsList');

                    // --- –ù–û–í–û–ï: –£–î–ê–õ–Ø–ï–ú –ö–†–£–¢–ò–õ–ö–£, –ö–ê–ö –¢–û–õ–¨–ö–û –ü–†–ò–®–õ–ò –î–ê–ù–ù–´–ï ---
                    const spinner = list.querySelector('.tg-spinner-container');
                    if (spinner) {
                        spinner.remove();
                    }
                    // ---------------------------------------------------------

                    if (snap.empty) {
                        list.innerHTML = '<div style="padding:20px;text-align:center;color:#888">–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –ø—É—Å—Ç</div>';
                        return;
                    }
                    // –ü—Ä–æ—Ö–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –ø–æ –ò–ó–ú–ï–ù–ï–ù–ò–Ø–ú
                    snap.docChanges().forEach(async change => {
                        const d = change.doc.data();
                        const fid = d.users.find(id => id !== currentUser.uid);
                        if (!fid) return;

                        // –ï—Å–ª–∏ –¥—Ä—É–≥–∞ —É–¥–∞–ª–∏–ª–∏
                        if (change.type === 'removed') {
                            const el = document.getElementById('u-' + fid);
                            if (el) el.remove();
                            return;
                        }

                        // --- üî• –í–ê–ñ–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –§–û–ù–û–í–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –ö–õ–Æ–ß–ê üî• ---
                        // –í—ã—á–∏—Å–ª—è–µ–º ID —á–∞—Ç–∞
                        const preChatId = [currentUser.uid, fid].sort().join('_');
                        // –¢–∏—Ö–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–ª—é—á. –ú—ã –Ω–µ —Å—Ç–∞–≤–∏–º await, —á—Ç–æ–±—ã –Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
                        // –°–∫—Ä–∏–ø—Ç –ø–æ–π–¥–µ—Ç –∑–∞ –∫–ª—é—á–æ–º –≤ —Ñ–æ–Ω–µ.
                        fetchChatKey(preChatId).then(k => {
                            if (k) console.log("üîë –ö–ª—é—á –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è:", fid);
                        });
                        // -----------------------------------------------------

                        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∞ (–∏–∑ –∫—ç—à–∞ –∏–ª–∏ –±–∞–∑—ã)
                        let friendData = usersCache[fid];
                        if (!friendData) {
                            try {
                                const userSnap = await db.collection('users').doc(fid).get();
                                if (userSnap.exists) {
                                    friendData = userSnap.data();
                                    usersCache[fid] = friendData;
                                }
                            } catch (e) {
                                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è", e);
                            }
                        }

                        let fName = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                        if (friendData) {
                            // –°–∫–ª–µ–∏–≤–∞–µ–º –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é. –ï—Å–ª–∏ —Ñ–∞–º–∏–ª–∏–∏ –Ω–µ—Ç, trim() —É–±–µ—Ä–µ—Ç –ª–∏—à–Ω–∏–π –ø—Ä–æ–±–µ–ª.
                            fName = `${friendData.name || ''} ${friendData.surname || ''}`.trim() || friendData.username || 'User';
                        }
                        const fNick = friendData && friendData.username ? ('@' + friendData.username) : '';
                        const fAvatar = friendData ? friendData.avatar : null;
                        const createdTime = d.createdAt ? d.createdAt.toMillis() : 0;
                        const chatId = preChatId; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π ID

                        let div = document.getElementById('u-' + fid);
                        const isNew = !div;

                        if (isNew) {
                            div = document.createElement('div');
                            div.className = 'user-item';
                            div.id = 'u-' + fid;
                            div.onclick = () => openChat(fid, fName, fNick);
                        }

                        div.setAttribute('data-time', createdTime);

                        const avatarHtml = fAvatar
                            ? `<img src="${fAvatar}" class="user-item-avatar">`
                            : `<div class="user-item-avatar" style="background:#444;display:flex;align-items:center;justify-content:center;font-size:24px;color:#888">üë§</div>`;

                        div.innerHTML = `
                                                                                    ${avatarHtml}
                                                                                    <div class="user-name">${fName}</div>
                                                                                    <div class="last-msg-row">
                                                                                        <span class="last-msg" id="last-${chatId}">...</span>
                                                                                    </div>
                                                                                    <div class="meta-column">
                                                                                        <span class="last-msg-date" id="date-${chatId}"></span>
                                                                                        <div class="meta-bottom-row">
                                                                                            <span id="status-${chatId}" class="list-ticks"></span>
                                                                                            <div class="badge-count hidden" id="badge-${chatId}">0</div>
                                                                                        </div>
                                                                                    </div>
                                                                                `;

                        if (isNew) {
                            list.appendChild(div);
                            startMessageListener(chatId, fid, createdTime);
                        }
                    });

                    setTimeout(sortFriendsList, 100);
                });
        }
        function sortFriendsList() {
            const list = document.getElementById('friendsList');
            // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã —á–∞—Ç–æ–≤ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫—Ä—É—Ç–∏–ª–∫—É –∑–∞–≥—Ä—É–∑–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ —Ç–∞–º –µ—Å—Ç—å)
            const items = Array.from(list.querySelectorAll('.user-item'));

            // 1. –ó–ê–ü–û–ú–ò–ù–ê–ï–ú —Å—Ç–∞—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–¥–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏)
            const oldPositions = new Map();
            items.forEach(item => {
                oldPositions.set(item.id, item.getBoundingClientRect().top);
            });

            // 2. –°–û–†–¢–ò–†–£–ï–ú —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            items.sort((a, b) => {
                const timeA = parseInt(a.getAttribute('data-time') || 0);
                const timeB = parseInt(b.getAttribute('data-time') || 0);
                return timeB - timeA;
            });

            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–º–µ—â–∞–µ–º –∏—Ö –≤ HTML (–≥–ª–∞–∑ —ç—Ç–æ –Ω–µ –∑–∞–º–µ—Ç–∏—Ç)
            items.forEach(item => list.appendChild(item));

            // 3. –ê–ù–ò–ú–ò–†–£–ï–ú –ø–µ—Ä–µ—Ö–æ–¥ (FLIP —Ç–µ—Ö–Ω–∏–∫–∞)
            items.forEach(item => {
                const oldTop = oldPositions.get(item.id);
                // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —É–∂–µ –±—ã–ª –≤ —Å–ø–∏—Å–∫–µ (–Ω–µ –Ω–æ–≤—ã–π)
                if (oldTop !== undefined) {
                    const newTop = item.getBoundingClientRect().top;
                    const delta = oldTop - newTop;

                    // –ï—Å–ª–∏ –ø–æ–∑–∏—Ü–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
                    if (delta !== 0) {
                        // "–¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º" —ç–ª–µ–º–µ–Ω—Ç –≤–∏–∑—É–∞–ª—å–Ω–æ –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –µ–≥–æ —Å—Ç–∞—Ä–æ–µ –º–µ—Å—Ç–æ
                        item.style.transform = `translateY(${delta}px)`;
                        item.style.transition = 'none';

                        // –ñ–¥–µ–º –æ–¥–∏–Ω –∫–∞–¥—Ä –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–≤–Ω—ã–π —Å–ø—É—Å–∫ –Ω–∞ –Ω–æ–≤–æ–µ –º–µ—Å—Ç–æ
                        requestAnimationFrame(() => {
                            requestAnimationFrame(() => {
                                item.style.transform = '';
                                // –ü–ª–∞–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è –¥–≤–∏–∂–µ–Ω–∏—è (–∫–∞–∫ –≤ iOS/Telegram)
                                item.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1)';

                                // –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∞ hover-—ç—Ñ—Ñ–µ–∫—Ç–∞–º
                                setTimeout(() => {
                                    item.style.transition = '';
                                }, 400);
                            });
                        });
                    }
                }
            });
        }
        function updateTotalFriendsBadge() {
            const total = Object.values(unreadCounts).reduce((a, b) => a + b, 0);
            const el = document.getElementById('friendsBadge');
            if (total > 0) { el.innerText = total; el.classList.remove('hidden'); }
            else { el.classList.add('hidden'); }
        }
        async function sendFriendRequest() {
            const e = document.getElementById('searchEmail').value;
            const snap = await db.collection('users').where('email', '==', e).get();
            if (snap.empty) return alert('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            await db.collection('friend_requests').add({ from: currentUser.uid, fromEmail: currentUser.email, to: snap.docs[0].id });
            alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); document.getElementById('searchEmail').value = '';
        }
        async function accept(rid, fid, femail) {
            await db.collection('friends').add({
                users: [currentUser.uid, fid],
                emails: { [currentUser.uid]: currentUser.email, [fid]: femail },
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection('friend_requests').doc(rid).delete();
        }
        function reject(rid) { db.collection('friend_requests').doc(rid).delete(); }
        function openChat(fid, name, nick) {
            // –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–µ—Ä –∑–∞–∫—Ä—ã—Ç–∏—è, –µ—Å–ª–∏ —é–∑–µ—Ä –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ –∫–ª–∏–∫–Ω—É–ª
            if (typeof closeChatTimeout !== 'undefined' && closeChatTimeout) {
                clearTimeout(closeChatTimeout);
                closeChatTimeout = null;
            }

            const newHash = "#chat/" + fid;

            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —Ç–æ—Ç –∂–µ —Å–∞–º—ã–π —á–∞—Ç, –≤ –∫–æ—Ç–æ—Ä–æ–º —É–∂–µ –Ω–∞—Ö–æ–¥–∏–º—Å—è - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
            if (window.location.hash === newHash) return;

            // --- –¢–û–¢ –°–ê–ú–´–ô –ú–ò–ö–†–û-–ü–†–´–ñ–û–ö ---
            if (window.location.hash.startsWith('#chat/')) {
                // 1. –ö–∏–¥–∞–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é (–∑–∞–ø–∏—à–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥)
                window.location.hash = '';

                // 2. –ß–µ—Ä–µ–∑ 15 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ (–≥–ª–∞–∑ –Ω–µ –∑–∞–º–µ—Ç–∏—Ç) –∫–∏–¥–∞–µ–º –≤ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥.
                // –ë—Ä–∞—É–∑–µ—Ä —Å–∞–º –≤—ã–∑–æ–≤–µ—Ç handleHashChange, –∫–æ—Ç–æ—Ä—ã–π —á–∏—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∏—Ç –∞–≤–∞—Ç–∞—Ä–∫–∏ –∏ –∫–ª—é—á–∏.
                setTimeout(() => {
                    window.location.hash = newHash;
                }, 15);
            } else {
                // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç –ø—Ä—è–º–æ –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
                window.location.hash = newHash;
            }
        }

        function scrollToMsg(id) {
            const el = document.getElementById('msg-' + id);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // –≠—Ñ—Ñ–µ–∫—Ç –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–Ω–∏—è
                el.style.transition = "background 0.5s";
                el.style.background = "#3a3a3a";
                setTimeout(() => { el.style.background = ""; }, 1500);
            } else {
                showToast("–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (–≤–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–∞—Ä–æ–µ)");
            }
        }

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –£–º–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ —Å–∫–∞—á–∫–æ–≤ ---
        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ó–ê–ì–†–£–ó–ö–ò (–¢–ï–ü–ï–†–¨ –£–î–ê–õ–Ø–ï–¢ –°–û–û–ë–©–ï–ù–ò–Ø) ---
        function loadMessages() {
            if (window.msgUnsub) {
                window.msgUnsub();
                window.msgUnsub = null;
            }

            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –¥–æ—Å—Ç–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Å–ª–æ–π —á–∞—Ç–∞
            const { list, isNew } = getOrCreateMsgList(currentChatId);

            if (isNew) {
                list.classList.add('is-loading'); // –ü–µ—Ä–≤—ã–π –∑–∞—Ö–æ–¥
                // --- –ò–°–ü–†–ê–í–õ–ï–ù–û: –ñ–µ—Å—Ç–∫–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –æ—Ç—Å—Ç—É–ø—ã —Å–ø–∏—Å–∫–∞ ---
                // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º absolute –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ transform –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞.
                list.innerHTML = '<div class="tg-spinner-container" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10;"><div class="tg-spinner"></div></div>';
            } else {
                list.scrollTop = list.scrollHeight; // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞—Ö–æ–¥ - —á–∞—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ú–ì–ù–û–í–ï–ù–ù–û
            }

            const deletedLocal = JSON.parse(localStorage.getItem('deletedMsgs') || '[]');

            window.msgUnsub = db.collection('chats').doc(currentChatId).collection('msgs')
                .orderBy('ts', 'asc')
                .onSnapshot({ includeMetadataChanges: true }, snap => {

                    // --- –ù–û–í–û–ï: –£–¥–∞–ª—è–µ–º –∫—Ä—É—Ç–∏–ª–∫—É, –∫–∞–∫ —Ç–æ–ª—å–∫–æ Firebase –ø—Ä–∏—Å–ª–∞–ª –æ—Ç–≤–µ—Ç ---
                    const spinner = list.querySelector('.tg-spinner-container');
                    if (spinner) spinner.remove();

                    const batch = db.batch();
                    let needCommit = false;
                    const isWindowActive = document.hasFocus() && document.visibilityState === 'visible';

                    // –£–¥–∞–ª–µ–Ω–∏—è
                    snap.docChanges().forEach(change => {
                        if (change.type === 'removed') {
                            const el = document.getElementById('msg-' + change.doc.id);
                            if (el) animateMessageRemoval(el); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–∞–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ!
                        }
                    });

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ (–µ—Å–ª–∏ –º—ã —É–∂–µ –≤–∏–¥–∏–º —á–∞—Ç)
                    // –í–∞–∂–Ω–æ: –µ—Å–ª–∏ —á–∞—Ç —Å–∫—Ä—ã—Ç (is-loading), —Å—á–∏—Ç–∞–µ–º —á—Ç–æ —Å–∫—Ä–æ–ª–ª –Ω–∞–º –Ω–µ –≤–∞–∂–µ–Ω, –º—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä—ã–≥–Ω–µ–º –≤–Ω–∏–∑
                    const isScrolledToBottom = list.scrollHeight - list.scrollTop <= list.clientHeight + 300;

                    let allDocs = snap.docs;

                    allDocs.sort((a, b) => {
                        const timeA = a.data().ts ? a.data().ts.toMillis() : Date.now() + 999999999;
                        const timeB = b.data().ts ? b.data().ts.toMillis() : Date.now() + 999999999;
                        return timeA - timeB;
                    });

                    allDocs.forEach(doc => {
                        const msgId = doc.id;
                        const rawData = doc.data();

                        if (deletedLocal.includes(msgId)) {
                            const el = document.getElementById('msg-' + msgId);
                            if (el) el.remove();
                            return;
                        }

                        const m = { ...rawData };
                        m.txt = decryptText(rawData.txt, currentChatId);
                        const msgType = m.type || 'text';

                        const tsMillis = m.ts ? m.ts.toMillis() : Date.now();
                        const dateStr = getChatSeparatorDate(tsMillis);

                        // –ù–û–í–û–ï: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º "–º–∞—à–∏–Ω–Ω—É—é" –¥–∞—Ç—É –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º (—Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD)
                        const dObj = new Date(tsMillis);
                        const rawDate = `${dObj.getFullYear()}-${String(dObj.getMonth() + 1).padStart(2, '0')}-${String(dObj.getDate()).padStart(2, '0')}`;

                        let div = document.getElementById('msg-' + msgId);
                        const isNew = !div;

                        if (isNew) {
                            div = document.createElement('div');
                            div.id = 'msg-' + msgId;

                            if (m.sys) div.className = 'msg msg-sys';
                            else if (m.from === currentUser.uid) div.className = 'msg msg-me';
                            else div.className = 'msg msg-other';

                            // –ù–∞ –ü–ö –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–ª–∏–∫ –ø—Ä–∞–≤–æ–π –∫–Ω–æ–ø–∫–æ–π –º—ã—à–∏
                            div.oncontextmenu = (e) => {
                                e.preventDefault(); e.stopPropagation();

                                // --- –ù–û–í–û–ï: –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∫–ª–∏–∫–µ ---
                                const menu = document.getElementById('contextMenu');
                                if (menu && menu.classList.contains('active')) {
                                    if (selectedMsgId === msgId) {
                                        closeAllSheets(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º
                                        return;
                                    }
                                }

                                openContextMenu(e, msgId, m.from === currentUser.uid);
                            };
                            // –û–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª–∏–∫ –¥–ª—è –º–æ–±–∏–ª–æ–∫ —É–¥–∞–ª–µ–Ω, —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ–ª–≥–æ–µ –∑–∞–∂–∞—Ç–∏–µ!
                            list.appendChild(div);
                        }

                        div.setAttribute('data-datestr', dateStr);
                        div.setAttribute('data-rawdate', rawDate); // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—à–∏–Ω–Ω—É—é –¥–∞—Ç—É –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è

                        // –†–µ–Ω–¥–µ—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                        const newHtml = buildMessageHTML(m, msgId, msgType);
                        if (div.innerHTML !== newHtml) div.innerHTML = newHtml;

                        if (typeof isAutoTranslate !== 'undefined' && isAutoTranslate && m.from !== currentUser.uid && msgType === 'text' && !m.sys) {
                            appendTranslation(div, m.txt, msgId);
                        }

                        if (m.to === currentUser.uid && !m.read && isWindowActive) {
                            batch.update(doc.ref, { read: true });
                            needCommit = true;
                        }
                    });

                    if (needCommit) batch.commit();

                    updateDateSeparators();
                    // <--- !!! –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –õ–û–ì–ò–ö–ê –°–ö–†–û–õ–õ–ê –ò –ü–û–Ø–í–õ–ï–ù–ò–Ø

                    // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —Å–µ–π—á–∞—Å —Å–∫—Ä—ã—Ç (–∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ü–ï–†–í–ê–Ø –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏)
                    // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —Å–µ–π—á–∞—Å —Å–∫—Ä—ã—Ç (–∑–Ω–∞—á–∏—Ç —ç—Ç–æ –ü–ï–†–í–ê–Ø –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏)
                    if (list.classList.contains('is-loading')) {
                        list.scrollTop = list.scrollHeight;

                        // –í WebView –Ω–∞–¥–µ–∂–Ω–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å setTimeout –≤–º–µ—Å—Ç–æ requestAnimationFrame
                        setTimeout(() => {
                            list.scrollTop = list.scrollHeight;
                            list.classList.remove('is-loading'); // –ß–∞—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è
                        }, 150); // –î–∞–µ–º –¥–≤–∏–∂–∫—É 150 –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥ –Ω–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    } else if (isScrolledToBottom) {
                        // --- –ù–û–í–û–ï: –ü–ª–∞–≤–Ω—ã–π –∞–≤—Ç–æ—Å–∫—Ä–æ–ª–ª, –µ—Å–ª–∏ –º—ã —É–∂–µ –±—ã–ª–∏ –≤–Ω–∏–∑—É –∏ –ø—Ä–∏—à–ª–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ ---
                        setTimeout(() => {
                            list.scrollTo({ top: list.scrollHeight + 500, behavior: 'smooth' });
                        }, 50);
                    }
                });
        }



        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—Å—Ç–∞–≤–∫–∏ HTML –ø–µ—Ä–µ–≤–æ–¥–∞ (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥)
        function injectTranslationBlock(msgDiv, text) {
            if (msgDiv.querySelector('.translated-block')) return;

            const transBlock = document.createElement('div');
            transBlock.className = 'translated-block';
            transBlock.innerText = text;

            const contentSpan = msgDiv.querySelector('.msg-text');
            if (contentSpan) contentSpan.appendChild(transBlock);
            else msgDiv.appendChild(transBlock);
        }

        // --- 3. –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–í–û–î–ê (API + CACHE + SCROLL FIX) ---
        // --- 3. –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–í–û–î–ê (–° –°–û–•–†–ê–ù–ï–ù–ò–ï–ú –í –ü–ê–ú–Ø–¢–¨) ---
        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 3: –ü–µ—Ä–µ–≤–æ–¥ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º ---
        async function appendTranslation(msgElement, text, msgId) {
            if (!isAutoTranslate) return;
            if (msgElement.querySelector('.translated-block')) return;

            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
            if (globalTranslationCache[msgId]) {
                injectTranslationBlock(msgElement, globalTranslationCache[msgId]);
                return;
            }

            const list = currentMsgList;
            // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Å–∫—Ä–æ–ª–ª–∞ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π
            const wasAtBottom = list.scrollHeight - list.scrollTop <= list.clientHeight + 400;

            // –ó–∞–ø—Ä–æ—Å –∫ API
            const translatedText = await fetchTranslation(text, targetLang);

            if (!msgElement.isConnected) return;

            if (translatedText && translatedText !== text) {
                // –°–û–•–†–ê–ù–Ø–ï–ú –í –ü–ê–ú–Ø–¢–¨
                saveTranslationToLocal(msgId, translatedText);

                // –†–∏—Å—É–µ–º
                injectTranslationBlock(msgElement, translatedText);

                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª –º—è–≥–∫–æ
                if (wasAtBottom) {
                    requestAnimationFrame(() => {
                        list.scrollTop = list.scrollHeight + 500;
                    });
                }
            }
        }

        // --- 2. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø HTML (—á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥) ---
        function buildMessageHTML(m, msgId, msgType) {
            let contentHtml = '';

            // –í—Ä–µ–º—è
            let timeStr = '';
            if (m.ts) {
                const date = m.ts.toDate();
                timeStr = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
            } else {
                const now = new Date();
                timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            }

            let ticksHtml = m.read ? '<span style="margin-right: -4px;">‚úì</span>‚úì' : '‚úì';

            // –¶–∏—Ç–∞—Ç–∞ (Reply)
            if (m.replyTo) {
                contentHtml += `
                                            <div class="msg-reply-quote" onclick="scrollToMsg('${m.replyTo.id}')">
                                                <div class="msg-reply-name">${m.replyTo.name}</div>
                                                <div class="msg-reply-text">${m.replyTo.text}</div>
                                            </div>`;
            }

            // –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
            if (m.sys) {
                contentHtml += m.txt;
            }
            else if (msgType === 'image') {
                let imgSrc = m.txt;
                if (m.txt.includes('id=')) { try { const fileId = m.txt.split('id=')[1]; imgSrc = `https://lh3.googleusercontent.com/d/${fileId}=w600`; } catch (e) { } }
                contentHtml += `<div class="media-container"><img src="${imgSrc}" class="chat-media-img" onclick="openImageViewer('${imgSrc}')" onerror="this.src='https://placehold.co/200x200?text=–û—à–∏–±–∫–∞';"></div>`;
            }
            else if (msgType === 'call') {
                const parts = m.txt.split('|');
                const callState = parts[0] || 'success';
                const durationStr = parts[1] || '';
                const isMine = (m.from === currentUser.uid);

                let titleText = '';
                let arrowHtml = '';
                let arrowColor = '#50a758'; // –ó–µ–ª–µ–Ω—ã–π

                // –õ–æ–≥–∏–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤ –∏ —Å—Ç—Ä–µ–ª–æ—á–µ–∫
                if (isMine) {
                    titleText = (callState === 'canceled' || callState === 'missed') ? '–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫' : '–ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫';
                    arrowColor = (callState === 'canceled' || callState === 'missed') ? '#ff595a' : '#50a758';
                    arrowHtml = `<svg style="color:${arrowColor}; margin-right:4px;" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>`;
                } else {
                    titleText = (callState === 'canceled' || callState === 'missed') ? '–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫' : '–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫';
                    arrowColor = (callState === 'canceled' || callState === 'missed') ? '#ff595a' : '#50a758';
                    arrowHtml = `<svg style="color:${arrowColor}; margin-right:4px;" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="17" y1="7" x2="7" y2="17"></line><polyline points="17 17 7 17 7 7"></polyline></svg>`;
                }

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                let durationDisplay = '';
                if (durationStr && durationStr !== '00:00') {
                    const dParts = durationStr.split(':');
                    if (dParts.length === 2) {
                        const mins = parseInt(dParts[0], 10);
                        const secs = parseInt(dParts[1], 10);
                        if (mins > 0) durationDisplay = ` (${mins} –º–∏–Ω ${secs} —Å–µ–∫)`;
                        else durationDisplay = ` (${secs} —Å–µ–∫)`;
                    }
                }

                // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–æ style="color: currentColor;" –∫ SVG –∏ —É–±—Ä–∞–Ω onclick –∏–∑ –≤–µ—Ä—Å—Ç–∫–∏, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
                contentHtml += `
                    <div class="chat-call-card">
                        <div class="call-icon-wrapper">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                        </div>
                        <div class="call-info">
                            <div class="call-title">${titleText}</div>
                            <div class="call-time" style="color: ${arrowColor === '#ff595a' ? '#ff595a' : '#aaa'};">${arrowHtml}${timeStr}${durationDisplay}</div>
                        </div>
                    </div>
                `;
            }
            else {
                // –¢–µ–∫—Å—Ç
                let formattedText = m.txt.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:#4a9eff;text-decoration:underline;">$1</a>');
                const safeHtml = DOMPurify.sanitize(formattedText, { ALLOWED_TAGS: ['a'], ALLOWED_ATTR: ['href', 'target', 'style'] });
                contentHtml += `<span class="msg-text">${safeHtml}</span>`;
            }

            // –ú–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ (–í—Ä–µ–º—è + –ì–∞–ª–æ—á–∫–∏) (—É–±–∏—Ä–∞–µ–º –∏—Ö –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ –∫–∞—Ä—Ç–æ—á–∫—É)
            if (!m.sys && msgType !== 'call') {
                let metaStyle = "";
                if (msgType === 'image') {
                    // –î–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ –ø–æ–≤–µ—Ä—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    metaStyle = "position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.5); padding: 2px 8px; border-radius: 12px; backdrop-filter: blur(4px); z-index: 2;";
                    // –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    contentHtml = `<div style="position: relative; display: inline-block; vertical-align: top; min-width: 200px;">${contentHtml}`;
                }

                let metaHtml = `
                                            <span class="msg-meta" style="${metaStyle}">
                                                ${m.edited ? '<span style="font-size: 11px; color: rgba(255,255,255,0.6); margin-right: 5px;">–∏–∑–º.</span>' : ''}
                                                <span class="msg-time" style="color: rgba(255,255,255,0.6); font-size: 11px;">${timeStr}</span>
                                                ${m.from === currentUser.uid ? `<span class="msg-ticks" style="color: white; font-size: 12px; margin-left: 3px;">${ticksHtml}</span>` : ''}
                                            </span>`;

                if (msgType === 'image') contentHtml += metaHtml + `</div>`;
                else contentHtml += metaHtml;
            }

            return contentHtml;
        }

        // --- 3. –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–í–û–î–ê (–û–î–ò–ù –†–ê–ó + –î–û–ú–ê–¢–´–í–ê–ù–ò–ï) ---
        async function appendTranslation(msgElement, text) {
            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥—É—Ä–∞–∫–∞
            if (!isAutoTranslate) return;
            // –ï—Å–ª–∏ –í–ù–£–¢–†–ò —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –£–ñ–ï –µ—Å—Ç—å –±–ª–æ–∫ –ø–µ—Ä–µ–≤–æ–¥–∞ - —Å—Ç–æ–ø!
            if (msgElement.querySelector('.translated-block')) return;

            const list = currentMsgList;
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —é–∑–µ—Ä –≤–Ω–∏–∑—É –ü–ï–†–ï–î —Ç–µ–º –∫–∞–∫ –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥
            const isNearBottom = list.scrollHeight - list.scrollTop - list.clientHeight <= 300;

            // 2. –ó–∞–ø—Ä–æ—Å
            const translatedText = await fetchTranslation(text, targetLang);

            // 3. –ï—â–µ –æ–¥–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π (–≤–¥—Ä—É–≥ –ø–æ–∫–∞ –≥—Ä—É–∑–∏–ª–æ—Å—å, —É–∂–µ –≤—Å—Ç–∞–≤–∏–ª–∏?)
            if (!msgElement.isConnected) return; // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–∏–ª–∏
            if (msgElement.querySelector('.translated-block')) return; // –ï—Å–ª–∏ —É–∂–µ –ø–µ—Ä–µ–≤–µ–ª–æ—Å—å

            if (translatedText && translatedText !== text) {
                const transBlock = document.createElement('div');
                transBlock.className = 'translated-block';
                transBlock.innerText = translatedText;

                const contentSpan = msgElement.querySelector('.msg-text');
                if (contentSpan) contentSpan.appendChild(transBlock);
                else msgElement.appendChild(transBlock);

                // === –§–ò–ö–° –ù–ï–î–û–ú–û–¢–ö–ò ===
                if (isNearBottom) {
                    // –ñ–¥–µ–º –º–∏–∫—Ä–æ-—Ç–∏–∫, –ø–æ–∫–∞ –±–ª–æ–∫ –æ—Ç—Ä–∏—Å—É–µ—Ç—Å—è –∏ –∑–∞–π–º–µ—Ç –≤—ã—Å–æ—Ç—É
                    requestAnimationFrame(() => {
                        // –°–∫—Ä–æ–ª–ª–∏–º —Å–∞–º —Å–ø–∏—Å–æ–∫ –≤ —Å–∞–º—ã–π –Ω–∏–∑ (—Å –∑–∞–ø–∞—Å–æ–º)
                        list.scrollTop = list.scrollHeight + 500;

                        // –ò–õ–ò –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ —Å–∞–º–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é)
                        // msgElement.scrollIntoView({ behavior: "smooth", block: "end" });
                    });
                }
            }
        }
        let closeChatTimeout = null;

        function performCloseUI() {
            closeAllSheets(); // <--- –ù–û–í–û–ï: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–µ–Ω—é, –±–ª—é—Ä –∏ —à—Ç–æ—Ä–∫–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ!
            document.getElementById('scrollToBottomBtn')?.classList.remove('visible');

            if (window.msgUnsub) {
                window.msgUnsub();
                window.msgUnsub = null;
            }

            if (closeChatTimeout) {
                clearTimeout(closeChatTimeout);
                closeChatTimeout = null;
            }

            if (window.innerWidth <= 768) {
                document.getElementById('mainChatArea').classList.remove('active');
                document.getElementById('mainSidebar').classList.remove('hidden-mobile');

                closeChatTimeout = setTimeout(() => {
                    document.getElementById('activeChat').classList.add('hidden');
                    document.getElementById('noChat').classList.remove('hidden');
                }, 350);
            } else {
                document.getElementById('mainSidebar').classList.remove('hidden-mobile');
                document.getElementById('mainChatArea').classList.remove('active');
                document.getElementById('activeChat').classList.add('hidden');
                document.getElementById('noChat').classList.remove('hidden');
            }

            if (currentChatId && currentUser) {
                db.collection('chats').doc(currentChatId).collection('typing').doc(currentUser.uid).set({
                    isTyping: false
                }).catch(() => { });
            }

            if (chatStatusUnsub) { chatStatusUnsub(); chatStatusUnsub = null; }
            if (typeof typingUnsub !== 'undefined' && typingUnsub) { typingUnsub(); typingUnsub = null; }

            currentFriendId = null;
            currentChatId = null;
        }
        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–∏–ø: 'text', 'image', 'file')
        function sendMsg(txt, isSys = false, type = 'text') {
            const inputEl = document.getElementById('msgInput');
            const t = txt || inputEl.value.trim();
            if (!t) return;

            // ========================================================
            // --- –ù–û–í–û–ï: –°–ë–†–û–° –°–¢–ê–¢–£–°–ê "–ü–ï–ß–ê–¢–ê–ï–¢" ---
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –∏ —Å—Ç–∞—Ç—É—Å –≤ –±–∞–∑–µ –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
            if (typeof typingTimeout !== 'undefined' && typingTimeout) {
                clearTimeout(typingTimeout);
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∏ –ø–∏—à–µ–º –≤ –±–∞–∑—É false
            if (typeof isTyping !== 'undefined') isTyping = false;

            if (currentChatId && currentUser) {
                db.collection('chats').doc(currentChatId).collection('typing').doc(currentUser.uid).set({
                    isTyping: false
                }).catch(() => { }); // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
            }
            // ========================================================


            // --- –õ–û–ì–ò–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ---
            if (isEditingMode && editMessageId) {
                db.collection('chats').doc(currentChatId).collection('msgs').doc(editMessageId).update({
                    txt: encryptText(t, currentChatId),
                    edited: true // –ú–µ—Ç–∫–∞, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–æ
                }).then(() => {
                    cancelReplyOrEdit();
                });
                return; // –í—ã—Ö–æ–¥–∏–º, –Ω–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ
            }

            // --- –û–ë–´–ß–ù–ê–Ø –û–¢–ü–†–ê–í–ö–ê ---
            const encryptedText = encryptText(t, currentChatId);

            const msgData = {
                txt: encryptedText, // –í –±–∞–∑—É –ª–µ—Ç–∏—Ç —à–∏—Ñ—Ä
                from: currentUser.uid,
                to: currentFriendId,
                sys: isSys,
                type: type,
                read: false,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            };

            // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (replyMessageData) {
                msgData.replyTo = {
                    id: replyMessageData.id,
                    name: replyMessageData.name,
                    text: replyMessageData.text
                };
                cancelReplyOrEdit(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
            }

            db.collection('chats').doc(currentChatId).collection('msgs').add(msgData).then(() => {
                // –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–æ—á–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—è–≤–∏–ª–æ—Å—å –≤ –±–∞–∑–µ
                if (currentMsgList) {
                    setTimeout(() => {
                        currentMsgList.scrollTo({ top: currentMsgList.scrollHeight + 500, behavior: 'smooth' });
                    }, 50);
                }
            });

            if (!txt) {
                inputEl.value = '';
                inputEl.style.height = '40px'; // –°–±—Ä–æ—Å –≤—ã—Å–æ—Ç—ã
                checkInputState(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                inputEl.focus();

                // --- –ù–û–í–û–ï: –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ ---
                if (currentMsgList) {
                    currentMsgList.scrollTo({ top: currentMsgList.scrollHeight + 500, behavior: 'smooth' });
                }
            }
            // –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (–ë–ï–ó–û–ü–ê–°–ù–û –ß–ï–†–ï–ó –°–ï–†–í–ï–†)
            if (!isSys && currentFriendId) {
                sendNotificationSecure(currentFriendId, t, type);
            }
        }
        let isEditingMode = false;
        let editMessageId = null;
        let replyMessageData = null; // { id, name, text }


        function openActionSheet(msgId, isMine) {
            selectedMsgId = msgId;
            selectedMsgIsMine = isMine;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ò–∑–º–µ–Ω–∏—Ç—å"
            const editBtn = document.getElementById('btnEditMsg');
            if (isMine) {
                editBtn.style.display = 'flex';
            } else {
                editBtn.style.display = 'none';
            }

            document.getElementById('overlaySheet').style.display = 'block';
            setTimeout(() => { document.getElementById('actionSheet').classList.add('open'); }, 10);
        }

        // --- –ö–û–ü–ò–†–û–í–ê–¢–¨ ---
        function handleCopy() {
            const msgEl = document.getElementById('msg-' + selectedMsgId);
            if (msgEl) {
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–∏—Å–∫–ª—é—á–∞—è –º–µ—Ç–∞-–∏–Ω—Ñ–æ –∏ –≤—Ä–µ–º—è)
                let text = "";
                const textSpan = msgEl.querySelector('.msg-text');
                if (textSpan) {
                    text = textSpan.innerText;
                } else {
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –±–µ–∑ span
                    text = msgEl.innerText.replace(/\n\d{2}:\d{2}.*/s, ''); // –ì—Ä—É–±–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
                }

                navigator.clipboard.writeText(text).then(() => {
                    showToast("–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω");
                });
            }
            closeAllSheets();
        }

        
        // --- –û–¢–í–ï–¢–ò–¢–¨ ---
        function handleReply() {
            const msgEl = document.getElementById('msg-' + selectedMsgId);
            if (!msgEl) return closeAllSheets();

            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
            const chatTitleEl = document.getElementById('chatTitle');
            let friendName = chatTitleEl ? (chatTitleEl.firstElementChild ? chatTitleEl.firstElementChild.innerText : chatTitleEl.innerText) : "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫";

            const name = selectedMsgIsMine ? "–í—ã" : friendName;

            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç
            let text = "–í–ª–æ–∂–µ–Ω–∏–µ";
            const textSpan = msgEl.querySelector('.msg-text');
            if (textSpan) text = textSpan.innerText;
            else if (msgEl.querySelector('.chat-media-img')) text = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è";
            else if (msgEl.querySelector('.chat-file-card')) text = "–§–∞–π–ª";

            startReplyUI(selectedMsgId, name, text);
            closeAllSheets();
        }

        // --- –ò–ó–ú–ï–ù–ò–¢–¨ ---
        function handleEdit() {
            const msgEl = document.getElementById('msg-' + selectedMsgId);
            if (!msgEl) return closeAllSheets();

            let text = "";
            const textSpan = msgEl.querySelector('.msg-text');
            if (textSpan) text = textSpan.innerText;

            // –ï—Å–ª–∏ —ç—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ–∫–∞ –Ω–µ –¥–µ–ª–∞–µ–º —Å–ª–æ–∂–Ω—ã–º
            if (!text && (msgEl.querySelector('img') || msgEl.querySelector('a'))) {
                alert("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞ –ø–æ–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ");
                return closeAllSheets();
            }

            startEditUI(selectedMsgId, text);
            closeAllSheets();
        }

        function startReplyUI(id, name, text) {
            cancelReplyOrEdit(); // –°–±—Ä–æ—Å
            replyMessageData = { id, name, text };

            const bar = document.getElementById('replyBar');
            const title = document.getElementById('replyTitle');
            const txt = document.getElementById('replyText');
            const icon = bar.querySelector('.reply-icon');

            bar.classList.remove('hidden', 'editing');
            title.innerText = name;
            txt.innerText = text;
            icon.innerText = "‚Ü©Ô∏è";

            document.getElementById('msgInput').focus();
        }

        function startEditUI(id, text) {
            cancelReplyOrEdit(); // –°–±—Ä–æ—Å
            isEditingMode = true;
            editMessageId = id;

            const bar = document.getElementById('replyBar');
            const title = document.getElementById('replyTitle');
            const txt = document.getElementById('replyText');
            const icon = bar.querySelector('.reply-icon');
            const input = document.getElementById('msgInput');

            bar.classList.remove('hidden');
            bar.classList.add('editing'); // –°–∏–Ω–∏–π —Ü–≤–µ—Ç
            title.innerText = "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
            txt.innerText = text;
            icon.innerText = "‚úèÔ∏è";

            input.value = text;
            input.focus();
        }

        function cancelReplyOrEdit() {
            isEditingMode = false;
            editMessageId = null;
            replyMessageData = null;

            const bar = document.getElementById('replyBar');
            if (bar) bar.classList.add('hidden');

            const inp = document.getElementById('msgInput');
            inp.value = '';
            inp.style.height = '40px'; // <-- –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ß–ö–£ (–°–±—Ä–æ—Å –≤—ã—Å–æ—Ç—ã)
            checkInputState(); // <-- –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –°–¢–†–û–ß–ö–£ (–í–µ—Ä–Ω—É—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω)
        }




        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ–ª—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è

        function closeAllSheets(fromPopState = false) {
            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ —Ñ–æ–Ω—É, –∞ –æ—Ç–∫—Ä—ã—Ç–æ —Å—Ä–∞–∑—É 2 –∏–ª–∏ 3 –æ–∫–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ—Ñ–∏–ª—å -> –Ω–∞—Å—Ç—Ä–æ–π–∫–∏), 
            // –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å—Ä–∞–∑—É –Ω–∞ –Ω—É–∂–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤ –Ω–∞–∑–∞–¥.
            if (fromPopState !== true && typeof sheetHistoryStack !== 'undefined' && sheetHistoryStack > 0) {
                const steps = -sheetHistoryStack;
                sheetHistoryStack = 0;
                history.go(steps);
            }

            document.getElementById('actionSheet')?.classList.remove('open');
            document.getElementById('deleteSheet')?.classList.remove('open');
            document.getElementById('profileSheet')?.classList.remove('open');
            document.getElementById('editProfileSheet')?.classList.remove('open');
            document.getElementById('generalSettingsSheet')?.classList.remove('open');

            const menu = document.getElementById('contextMenu');
            if (menu) {
                menu.classList.remove('active');
                setTimeout(() => menu.style.display = 'none', 200);
            }

            // --- –û–¢–ö–õ–Æ–ß–ê–ï–ú –†–ê–ó–ú–´–¢–ò–ï –§–û–ù–ê –ò –í–´–î–ï–õ–ï–ù–ò–ï ---
            document.body.classList.remove('chat-blur-active');
            document.querySelectorAll('.msg-highlighted').forEach(el => {
                el.classList.remove('msg-highlighted');
            });

            setTimeout(() => {
                const overlay = document.getElementById('overlaySheet');
                if (overlay) {
                    overlay.style.display = 'none';
                    overlay.style.background = 'rgba(0,0,0,0.5)'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ü–≤–µ—Ç
                }
            }, 300);

            selectedMsgId = null;
        }
        function closeAllSheets() {
            document.getElementById('actionSheet')?.classList.remove('open');
            document.getElementById('deleteSheet')?.classList.remove('open');
            document.getElementById('profileSheet')?.classList.remove('open');
            document.getElementById('editProfileSheet')?.classList.remove('open');

            const menu = document.getElementById('contextMenu');
            if (menu) {
                menu.classList.remove('active');
                setTimeout(() => menu.style.display = 'none', 200);
            }

            // --- –û–¢–ö–õ–Æ–ß–ê–ï–ú –†–ê–ó–ú–´–¢–ò–ï –§–û–ù–ê –ò –í–´–î–ï–õ–ï–ù–ò–ï ---
            document.body.classList.remove('chat-blur-active');
            document.querySelectorAll('.msg-highlighted').forEach(el => {
                el.classList.remove('msg-highlighted');
            });

            setTimeout(() => {
                const overlay = document.getElementById('overlaySheet');
                if (overlay) {
                    overlay.style.display = 'none';
                    overlay.style.background = 'rgba(0,0,0,0.5)'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –¥—Ä—É–≥–∏—Ö —à—Ç–æ—Ä–æ–∫
                }
            }, 300);

            selectedMsgId = null;
        }



        function updateCallStatus(text) { document.getElementById('callStatusText').innerText = text; }
        function startTimer() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –±—ã–ª
            if (callTimerInt) clearInterval(callTimerInt);
            // –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ –µ—â–µ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω–æ ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–µ–π—á–∞—Å
            if (!callStartTime) callStartTime = Date.now();
            const el = document.getElementById('callTimer');
            const tick = () => {
                // –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É "—Å–µ–π—á–∞—Å" –∏ "—Å—Ç–∞—Ä—Ç–æ–º"
                const diff = Math.max(0, Date.now() - callStartTime);
                const totalSeconds = Math.floor(diff / 1000);
                const mm = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const ss = String(totalSeconds % 60).padStart(2, '0');
                el.innerText = `${mm}:${ss}`;
            };
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∏–∫–∞–Ω—å–µ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            tick();
            callTimerInt = setInterval(tick, 1000);
        }
        function setupPeerConnection() {
            candidateQueue = [];
            pc = new RTCPeerConnection(iceServers);
            pc.oniceconnectionstatechange = () => {
                if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
                    pc.getStats().then(stats => {
                        stats.forEach(report => {
                            if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                                const local = stats.get(report.localCandidateId);
                                console.log(`üöÄ Connection: ${local.candidateType}`);
                            }
                        });
                    });
                }
            };
            pc.onicecandidate = e => { };
            pc.ontrack = e => {
                const remoteVid = document.getElementById('remoteVideo');
                remoteVid.muted = false;
                if (remoteVid.srcObject !== e.streams[0]) {
                    remoteVid.srcObject = e.streams[0];
                    remoteVid.play().catch(console.error);
                }
            };
            pc.onconnectionstatechange = () => {
                if (pc.connectionState === 'connected') {
                    isConnected = true; wasCallConnected = true; updateCallStatus("–í —Ä–∞–∑–≥–æ–≤–æ—Ä–µ");
                    stopAllTones(); startTimer(); startPing();
                } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                    endCall(false);
                }
            };
        }
        function startPing() {
            const el = document.getElementById('callPing');
            if (pingInterval) clearInterval(pingInterval);
            pingInterval = setInterval(async () => {
                if (!pc) return;
                const stats = await pc.getStats();
                let rtt = null;
                stats.forEach(r => {
                    if (r.type === 'candidate-pair' && r.state === 'succeeded' && r.currentRoundTripTime) { rtt = r.currentRoundTripTime; }
                });
                if (rtt) el.innerText = `Ping: ${(rtt * 1000).toFixed(0)} ms`;
            }, 2000);
        }
        async function addCandidateSafely(candidate) {
            if (!pc) return;
            if (pc.remoteDescription && pc.remoteDescription.type) { try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); } catch (e) { } }
            else { candidateQueue.push(candidate); }
        }
        async function flushCandidateQueue() {
            if (!pc) return;
            for (const cand of candidateQueue) { try { await pc.addIceCandidate(new RTCIceCandidate(cand)); } catch (e) { } }
            candidateQueue = [];
        }
        function setLocalMirror(facing) {
            const v = document.getElementById('localVideo');
            if (!v) return;
            if (facing === 'user') v.classList.add('mirror');
            else v.classList.remove('mirror');
        }
        async function getStreamForFacing(facing, withAudio) {
            const audio = !!withAudio;
            // 1) –ø—Ä–æ–±—É–µ–º —Å—Ç—Ä–æ–≥–æ –Ω—É–∂–Ω—É—é –∫–∞–º–µ—Ä—É
            try {
                return await navigator.mediaDevices.getUserMedia({
                    audio,
                    video: { facingMode: { exact: facing } }
                });
            } catch (e1) { }
            // 2) –ø—Ä–æ–±—É–µ–º "–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ"
            try {
                return await navigator.mediaDevices.getUserMedia({
                    audio,
                    video: { facingMode: { ideal: facing } }
                });
            } catch (e2) {
                // 3) fallback: —á–µ—Ä–µ–∑ enumerateDevices + deviceId
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cams = devices.filter(d => d.kind === 'videoinput');
                if (!cams.length) throw e2;
                const cam = (facing === 'environment') ? cams[cams.length - 1] : cams[0];
                return await navigator.mediaDevices.getUserMedia({
                    audio,
                    video: { deviceId: { exact: cam.deviceId } }
                });
            }
        }
        async function getMedia() {
            try {
                localStream = await getStreamForFacing(currentFacingMode, true);
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('localVideo').muted = true;
                setLocalMirror(currentFacingMode);
                // –∫–∞–∫ –±—ã–ª–æ —É —Ç–µ–±—è: –≤–∏–¥–µ–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω–æ, –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω
                localStream.getVideoTracks()[0].enabled = false;
                updateCamBtnUI(false);
                localStream.getAudioTracks()[0].enabled = true;
                updateMicBtnUI(true);
                localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            } catch (e) {
                console.error(e);
                alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä/–∫–∞–º–µ—Ä–µ");
            }
        }
        async function switchCamera() {
            if (!pc || !localStream) return;

            // 1. –ù–∞—Ö–æ–¥–∏–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤–∏–¥–µ–æ (Sender)
            const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
            if (!sender) return;

            // –ï—Å–ª–∏ –±—ã–ª —à–∞—Ä–∏–Ω–≥ —ç–∫—Ä–∞–Ω–∞ ‚Äî –≤—ã–∫–ª—é—á–∞–µ–º –µ–≥–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
            if (sender.track && sender.track.label && sender.track.label.toLowerCase().includes('screen')) {
                stopScreen(sender);
            }

            // 2. –ù–∞—Ö–æ–¥–∏–º —Å—Ç–∞—Ä—ã–π –≤–∏–¥–µ–æ-—Ç—Ä–µ–∫
            const oldVideoTrack = localStream.getVideoTracks()[0];

            // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–≤–∫–ª—é—á–µ–Ω–æ –≤–∏–¥–µ–æ –∏–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ –∫–Ω–æ–ø–∫–æ–π)
            const wasEnabled = oldVideoTrack ? oldVideoTrack.enabled : true;

            // 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â—É—é –∫–∞–º–µ—Ä—É
            const nextFacing = (currentFacingMode === 'user') ? 'environment' : 'user';

            // 4. –í–ê–ñ–ù–û: –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¢–û–õ–¨–ö–û –≤–∏–¥–µ–æ. –ê—É–¥–∏–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º!
            if (oldVideoTrack) oldVideoTrack.stop();

            // 5. –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π –≤–∏–¥–µ–æ-–ø–æ—Ç–æ–∫ (audio: false, —Ç–∞–∫ –∫–∞–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω —É –Ω–∞—Å —É–∂–µ –µ—Å—Ç—å)
            let newStream;
            try {
                newStream = await getStreamForFacing(nextFacing, false);
            } catch (e) {
                console.error(e);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É");
                return;
            }

            const newVideoTrack = newStream.getVideoTracks()[0];
            newVideoTrack.enabled = wasEnabled; // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–µ—Å–ª–∏ –±—ã–ª–æ –≤—ã–∫–ª—é—á–µ–Ω–æ)

            // 6. –ó–∞–º–µ–Ω—è–µ–º –≤–∏–¥–µ–æ-—Ç—Ä–µ–∫ –≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ (—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —É–≤–∏–¥–∏—Ç –Ω–æ–≤—É—é –∫–∞–º–µ—Ä—É)
            try {
                await sender.replaceTrack(newVideoTrack);
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–º–µ–Ω—ã —Ç—Ä–µ–∫–∞:", e);
            }

            // 7. –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫: –ë–ï–†–ï–ú –°–¢–ê–†–´–ô –ê–£–î–ò–û + –ù–û–í–û–ï –í–ò–î–ï–û
            const audioTrack = localStream.getAudioTracks()[0]; // –ñ–∏–≤–æ–π –∞—É–¥–∏–æ-—Ç—Ä–µ–∫
            localStream = new MediaStream(); // –ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –ø–æ—Ç–æ–∫–∞

            if (audioTrack) {
                localStream.addTrack(audioTrack); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∂–∏–≤–æ–π –º–∏–∫—Ä–æ—Ñ–æ–Ω
            }
            localStream.addTrack(newVideoTrack);  // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–∞–º–µ—Ä—É

            // 8. –û–±–Ω–æ–≤–ª—è–µ–º <video> —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            const videoEl = document.getElementById('localVideo');
            videoEl.srcObject = localStream;
            videoEl.muted = true; // –°–µ–±—è –º—ã –Ω–µ —Å–ª—ã—à–∏–º

            // 9. –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            currentFacingMode = nextFacing;
            setLocalMirror(currentFacingMode);
        }
        async function startCall() {
            if (currentCallId) {
                try {
                    const snap = await db.collection('calls').doc(currentCallId).get();
                    if (snap.exists) { return alert("–í—ã —É–∂–µ –≤ –∑–≤–æ–Ω–∫–µ!"); }
                    else { currentCallId = null; isConnected = false; }
                } catch (e) { currentCallId = null; }
            }
            if (isConnected) return alert("–í—ã —É–∂–µ –≤ –∑–≤–æ–Ω–∫–µ!");
            amICaller = true; wasCallConnected = false;
            document.getElementById('callTimer').innerText = "00:00";
            callStartTime = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
            if (callTimerInt) clearInterval(callTimerInt);
            const newCallId = [currentUser.uid, currentFriendId].sort().join('_');
            const callDoc = db.collection('calls').doc(newCallId);
            const snap = await callDoc.get();
            if (snap.exists && snap.data().caller !== currentUser.uid) { return alert("–õ–∏–Ω–∏—è –∑–∞–Ω—è—Ç–∞!"); }
            currentCallId = newCallId;
            document.getElementById('callScreen').style.display = 'flex';
            updateCallControlsVisibility();
            document.getElementById('callScreen').style.pointerEvents = 'auto';
            updateCallStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...");
            playConnectingTone();
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–≤–æ–Ω–∫–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º
            if (currentFriendId) {
                db.collection('users').doc(currentFriendId).get().then(doc => {
                    if (doc.exists && doc.data().tgChatId) {
                        sendTelegramNotification(doc.data().tgChatId, `üìû *–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫*\n–û—Ç: ${currentUser.email}\n–ó–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å!`);
                    }
                });
            }
            setupPeerConnection();
            pc.onicecandidate = e => { if (e.candidate) callDoc.collection('offerCandidates').add(e.candidate.toJSON()); };
            await getMedia();
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ 'to', —á—Ç–æ–±—ã —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –º–æ–≥ –Ω–∞–π—Ç–∏ —ç—Ç–æ—Ç –∑–≤–æ–Ω–æ–∫
            await callDoc.set({
                offer: { type: offer.type, sdp: offer.sdp },
                caller: currentUser.uid,
                to: currentFriendId, // <--- –í–ê–ñ–ù–û–ï –î–û–ë–ê–í–õ–ï–ù–ò–ï
                status: 'dialing'
            });
            callDoc.onSnapshot(async snap => {
                if (!snap.exists) { endCall(false, true); return; }
                const data = snap.data();
                if (data.status === 'ringing' && !isConnected) { updateCallStatus("–ó–≤–æ–Ω–æ–∫..."); playRingingTone(); }
                if (pc && !pc.currentRemoteDescription && data && data.answer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    flushCandidateQueue();
                }
            });
            callDoc.collection('answerCandidates').onSnapshot(snap => {
                snap.docChanges().forEach(change => { if (change.type === 'added') addCandidateSafely(change.doc.data()); });
            });
        }
        async function answerCall() {
            amICaller = false; wasCallConnected = false;
            document.getElementById('ringtone').pause();
            document.getElementById('callTimer').innerText = "00:00";
            callStartTime = 0;
            if (callTimerInt) clearInterval(callTimerInt);
            document.getElementById('incomingPopup').style.display = 'none';
            document.getElementById('callScreen').style.display = 'flex';
            updateCallControlsVisibility();
            document.getElementById('callScreen').style.pointerEvents = 'auto';
            updateCallStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...");
            const callDoc = db.collection('calls').doc(currentCallId);
            const data = (await callDoc.get()).data();
            setupPeerConnection();
            pc.onicecandidate = e => { if (e.candidate) callDoc.collection('answerCandidates').add(e.candidate.toJSON()); };
            await getMedia();
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            flushCandidateQueue();
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await callDoc.update({ answer: { type: answer.type, sdp: answer.sdp }, status: 'connected' });
            callDoc.onSnapshot(snap => { if (!snap.exists) endCall(false, true); });
            callDoc.collection('offerCandidates').onSnapshot(snap => {
                snap.docChanges().forEach(change => { if (change.type === 'added') addCandidateSafely(change.doc.data()); });
            });
        }
        function toggleMic() {
            if (!localStream) return;
            const track = localStream.getAudioTracks()[0]; track.enabled = !track.enabled; updateMicBtnUI(track.enabled);
        }
        function updateMicBtnUI(enabled) {
            const btn = document.getElementById('btnMic'); const lbl = document.getElementById('lblMic');
            if (enabled) { btn.classList.remove('btn-active-white'); btn.innerHTML = 'üé§'; lbl.innerText = '–í—ã–∫–ª. –∑–≤—É–∫'; }
            else { btn.classList.add('btn-active-white'); btn.innerHTML = 'üîá'; lbl.innerText = '–í–∫–ª. –∑–≤—É–∫'; }
        }
        function toggleCamera() {
            if (!localStream) return;
            const sender = pc.getSenders().find(s => s.track.kind === 'video');
            if (sender && sender.track.label.includes('screen')) stopScreen(sender);
            const track = localStream.getVideoTracks()[0]; track.enabled = !track.enabled; updateCamBtnUI(track.enabled);
        }
        function updateCamBtnUI(enabled) {
            const btn = document.getElementById('btnCam'); const lbl = document.getElementById('lblCam');
            if (enabled) { btn.classList.add('btn-active-white'); btn.innerHTML = 'üì∑'; lbl.innerText = '–í—ã–∫–ª. –≤–∏–¥–µ–æ'; }
            else { btn.classList.remove('btn-active-white'); btn.innerHTML = 'üìµ'; lbl.innerText = '–í–∫–ª. –≤–∏–¥–µ–æ'; }
        }
        async function toggleScreen() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) { alert("–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ iPhone."); return; }
            if (!localStream) return;
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const screenTrack = stream.getVideoTracks()[0];
                const sender = pc.getSenders().find(s => s.track.kind === 'video');
                if (sender) {
                    sender.replaceTrack(screenTrack);
                    document.getElementById('localVideo').srcObject = stream;
                    const btn = document.getElementById('btnScr'); const lbl = document.getElementById('lblScr');
                    btn.classList.add('btn-screen-on'); lbl.innerText = '–û—Å—Ç. —Å—Ç—Ä–∏–º';
                    screenTrack.onended = () => stopScreen(sender);
                }
            } catch (e) { console.log(e); }
        }
        function stopScreen(sender) {
            const camTrack = localStream.getVideoTracks()[0];
            sender.replaceTrack(camTrack);
            document.getElementById('localVideo').srcObject = localStream;
            const btn = document.getElementById('btnScr'); const lbl = document.getElementById('lblScr');
            btn.classList.remove('btn-screen-on'); lbl.innerText = '–≠–∫—Ä–∞–Ω';
        }
        function listenForIncomingCalls() {
            db.collection('calls').where('to', '==', currentUser.uid).onSnapshot(snap => {
                snap.docChanges().forEach(change => {
                    if (change.type === "added") {
                        if (change.doc.id.includes(currentUser.uid)) {
                            if (currentCallId) {
                                console.log("Ignored incoming call because busy");
                                return;
                            }
                            currentCallId = change.doc.id;
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É
                            const popup = document.getElementById('incomingPopup');
                            popup.style.display = 'flex';
                            document.getElementById('ringtone').play().catch(() => { });
                            db.collection('calls').doc(currentCallId).update({ status: 'ringing' }).catch(() => { });
                            const data = change.doc.data();
                            const callerId = data.caller;
                            // –°—Å—ã–ª–∫–∞ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç –∏–º–µ–Ω–∏
                            const nameEl = document.getElementById('callerName');
                            nameEl.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞..."; // –°–±—Ä–æ—Å –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
                            // --- –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ó–î–ï–°–¨: –ó–ê–ì–†–£–ó–ö–ê –ò–ú–ï–ù–ò, –§–ê–ú–ò–õ–ò–ò –ò –ê–í–ê–¢–ê–†–ö–ò ---
                            db.collection('users').doc(callerId).get().then(userDoc => {
                                if (userDoc.exists) {
                                    const u = userDoc.data();
                                    // 1. –§–æ—Ä–º–∏—Ä—É–µ–º –ò–º—è + –§–∞–º–∏–ª–∏—è
                                    // –ï—Å–ª–∏ —Ñ–∞–º–∏–ª–∏–∏ –Ω–µ—Ç, –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ –∏–º—è. trim() —É–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã.
                                    let fullName = `${u.name || ''} ${u.surname || ''}`.trim();
                                    // –ï—Å–ª–∏ –∏ –∏–º–µ–Ω–∏ –Ω–µ—Ç, –±–µ—Ä–µ–º –Ω–∏–∫–Ω–µ–π–º –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É
                                    if (!fullName) fullName = u.username ? `@${u.username}` : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";
                                    // 2. –õ–æ–≥–∏–∫–∞ –ê–≤–∞—Ç–∞—Ä–∫–∏
                                    let avatarHtml;
                                    if (u.avatar) {
                                        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ç–æ
                                        avatarHtml = `<img src="${u.avatar}" style="width:42px; height:42px; border-radius:50%; object-fit:cover; margin-right:12px;">`;
                                    } else {
                                        // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ - –¥–µ–ª–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –∫—Ä—É–∂–æ–∫ —Å –ø–µ—Ä–≤–æ–π –±—É–∫–≤–æ–π (–°—Ç–∏–ª—å Telegram)
                                        const firstLetter = fullName.charAt(0).toUpperCase();
                                        avatarHtml = `<div style="width:42px; height:42px; border-radius:50%; background: linear-gradient(135deg, #6a11cb, #2575fc); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px; margin-right:12px; border: 1px solid #444;">${firstLetter}</div>`;
                                    }
                                    // 3. –§–æ—Ä–º–∏—Ä—É–µ–º HTML "–∫–∞–∫ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–µ"
                                    // –°–≤–µ—Ä—Ö—É –∏–º—è (–±–µ–ª–æ–µ, –∂–∏—Ä–Ω–æ–µ), —Å–Ω–∏–∑—É "Telegram Audio..." (–≥–æ–ª—É–±–æ–≤–∞—Ç–æ–µ/—Å–µ—Ä–æ–µ)
                                    nameEl.innerHTML = `
                                                                                                                                                                                                                                                                        <div style="display:flex; align-items:center;">
                                                                                                                                                                                                                                                                            ${avatarHtml}
                                                                                                                                                                                                                                                                            <div style="display:flex; flex-direction:column; align-items:flex-start; justify-content:center;">
                                                                                                                                                                                                                                                                                <span style="font-size: 15px; font-weight: 600; color: white; line-height: 1.2;">${fullName}</span>
                                                                                                                                                                                                                                                                                <span style="font-size: 13px; color: #8faebf; font-weight: normal; margin-top: 2px;">Telegram Audio...</span>
                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                    `;
                                } else {
                                    nameEl.innerText = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –Ω–æ–º–µ—Ä";
                                }
                            }).catch(err => {
                                console.error(err);
                                nameEl.innerText = "–û—à–∏–±–∫–∞ ID";
                            });
                            // -------------------------------------------------------------
                        }
                    }
                    if (change.type === "removed") {
                        if (currentCallId === change.doc.id) {
                            endCall(false, true);
                        }
                    }
                });
            });
        }
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –≤—Ö–æ–¥—è—â–µ–≥–æ –≤—ã–∑–æ–≤–∞
        function rejectCall() {
            // 1. –í—ã–∫–ª—é—á–∞–µ–º –∑–≤—É–∫
            document.getElementById('ringtone').pause();
            document.getElementById('ringtone').currentTime = 0;
            // 2. –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            document.getElementById('incomingPopup').style.display = 'none';
            // 3. –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫ (ID –∑–≤–æ–Ω–∫–∞)
            if (currentCallId) {
                // –£–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –∑–≤–æ–Ω–∫–∞ –∏–∑ –±–∞–∑—ã (—ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç –∑–≤–æ–Ω–æ–∫ –∏ —É –∑–≤–æ–Ω—è—â–µ–≥–æ)
                db.collection('calls').doc(currentCallId).delete()
                    .then(() => {
                        console.log("–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω");
                    })
                    .catch(error => {
                        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏:", error);
                    });
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                currentCallId = null;
            }
        }
        function endCallUser() { endCall(true, false); }
        function endCall(isInitiator = true, isRemote = false) {
            document.getElementById('ringtone').pause();
            document.getElementById('ringtone').currentTime = 0;
            stopAllTones();
            if (amICaller) {
                if (wasCallConnected && isConnected) {
                    const time = document.getElementById('callTimer').innerText;
                    sendMsg(`success|${time}`, false, 'call');
                } else if (!wasCallConnected) {
                    if (isInitiator && !isRemote) {
                        sendMsg(`canceled|00:00`, false, 'call');
                    } else {
                        sendMsg(`missed|00:00`, false, 'call');
                        if (currentFriendId) {
                            db.collection('users').doc(currentFriendId).get().then(doc => {
                                if (doc.exists && doc.data().tgChatId) {
                                    sendTelegramNotification(doc.data().tgChatId, `‚ùå *–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫*\n–û—Ç: ${currentUser.email}`);
                                }
                            });
                        }
                    }
                }
            }
            if (pc) pc.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (callTimerInt) clearInterval(callTimerInt);
            if (pingInterval) clearInterval(pingInterval);
            const statusText = document.getElementById('callStatusText');
            statusText.innerText = "–ó–í–û–ù–û–ö –ó–ê–í–ï–†–®–ï–ù"; statusText.style.color = "#ff4444"; statusText.style.fontWeight = "bold";
            playEndTone();
            const screen = document.getElementById('callScreen'); screen.style.pointerEvents = 'none';
            document.getElementById('incomingPopup').style.display = 'none';
            if (isInitiator && currentCallId) { db.collection('calls').doc(currentCallId).delete().catch(() => { }); }
            pc = null; localStream = null; candidateQueue = []; isConnected = false; currentCallId = null; wasCallConnected = false; amICaller = false;
            callStartTime = 0;
            if (callTimerInt) clearInterval(callTimerInt);
            callTimerInt = null;
            setTimeout(() => {
                screen.style.display = 'none';
                document.getElementById('callTimer').innerText = "00:00";
                document.getElementById('callPing').innerText = "Ping: -";
                statusText.style.color = "#ccc"; statusText.style.fontWeight = "normal";
            }, 1500);
        }
        function saveTgId() {
            const id = document.getElementById('tgChatId').value.trim();
            if (!id) return alert("–í–≤–µ–¥–∏—Ç–µ ID!");
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).set({ tgChatId: id }, { merge: true }).then(() => {
                    alert("ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
                    sendTelegramNotification(id, "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!");
                });
            }
        }
        function loadTgId() {
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).get().then(doc => {
                    if (doc.exists && doc.data().tgChatId) { document.getElementById('tgChatId').value = doc.data().tgChatId; }
                });
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ü–†–û–§–ò–õ–Ø ---
        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∏–∫–Ω–µ–π–º–∞ (—Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª, —Ü–∏—Ñ—Ä—ã, _ –∏ .)
        function validateUsername(input) {
            input.value = input.value.replace(/[^a-zA-Z0-9_.]/g, '');
        }
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ
        // --- –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø –î–õ–Ø –°–°–´–õ–ö–ò –ù–ê –§–û–¢–û (–í—Å—Ç–∞–≤—å –ø–µ—Ä–µ–¥ —Ñ—É–Ω–∫—Ü–∏—è–º–∏) ---
        let newUploadedAvatarUrl = null;

        // --- 1. –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –í–´–ë–û–†–ê –ò –ó–ê–ì–†–£–ó–ö–ò –§–û–¢–û ---
        function handleAvatarSelect(input) {
            const file = input.files[0];
            if (!file) return;

            // 1. –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Å—ã
            const saveBtn = document.querySelector('#editProfileSheet .tg-header-top button:last-child');
            if (saveBtn) {
                saveBtn.style.opacity = "0.5";
                saveBtn.style.pointerEvents = "none";
                saveBtn.innerHTML = "‚è≥";
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function () {
                    // --- –ù–ê–°–¢–†–û–ô–ö–ò –ö–ê–ß–ï–°–¢–í–ê (–í—ã—Å–æ–∫–æ–µ) ---
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // –°—Ç–∞–≤–∏–º 1024px (–±—ã–ª–æ 300) - —ç—Ç–æ —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ
                    const MAX = 1024;

                    if (width > height) {
                        if (width > MAX) { height *= MAX / width; width = MAX; }
                    } else {
                        if (height > MAX) { width *= MAX / height; height = MAX; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // –ö–∞—á–µ—Å—Ç–≤–æ 0.9 (90%)
                    const highResBase64 = canvas.toDataURL('image/jpeg', 0.9);

                    // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —Å—Ä–∞–∑—É (—á—Ç–æ–±—ã —é–∑–µ—Ä –≤–∏–¥–µ–ª, —á—Ç–æ –≤—ã–±—Ä–∞–ª)
                    const preview = document.getElementById('editAvatarPreview');
                    const ph = document.getElementById('editAvatarPlaceholder');
                    preview.src = highResBase64;
                    preview.style.display = 'block';
                    ph.style.display = 'none';

                    // 3. !!! –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ù–ê –ì–£–ì–õ –î–ò–°–ö !!!
                    const rawBase64 = highResBase64.split(',')[1];

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–≤–æ—é —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∫—Ä–∏–ø—Ç (–æ–Ω–∞ —É–∂–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –∫–æ–¥–µ –≤—ã—à–µ)
                    fetch(GOOGLE_SCRIPT_URL, {
                        method: "POST",
                        redirect: "follow",
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify({
                            action: "upload",
                            secret: "JH54jnbdfkjs297615109dxc1kDmnsg_df1jksHnh1Lhsc",
                            filename: "avatar_" + Date.now() + ".jpg",
                            mimeType: "image/jpeg",
                            base64: rawBase64
                        })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.result === "success") {
                                console.log("–ê–≤–∞—Ç–∞—Ä –∑–∞–≥—Ä—É–∂–µ–Ω:", data.url);
                                newUploadedAvatarUrl = data.url; // <--- –ó–ê–ü–û–ú–ò–ù–ê–ï–ú –°–°–´–õ–ö–£ –° –î–ò–°–ö–ê
                                showToast("–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ –æ–±–ª–∞–∫–æ ‚úì");
                            } else {
                                alert("–û—à–∏–±–∫–∞ Google –î–∏—Å–∫–∞: " + data.message);
                            }
                        })
                        .catch(err => {
                            console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", err);
                            alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
                        })
                        .finally(() => {
                            // 4. –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                            if (saveBtn) {
                                saveBtn.style.opacity = "1";
                                saveBtn.style.pointerEvents = "auto";
                                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–∞–ª–æ—á–∫—É
                                saveBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12" /></svg>';
                            }
                        });
                }
            };
            reader.readAsDataURL(file);
        }

        // --- 2. –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –ü–†–û–§–ò–õ–Ø ---
        function saveEditProfile() {
            const name = document.getElementById('editName').value.trim();
            if (!name) {
                showToast('–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!');
                return;
            }

            const surname = document.getElementById('editSurname').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            const birthdate = document.getElementById('editBirthdate').value;
            const username = document.getElementById('editUsername').value.trim();

            const updateData = {
                name: name,
                surname: surname,
                bio: bio,
                birthdate: birthdate,
                username: username
            };

            // !!! –ï–°–õ–ò –ï–°–¢–¨ –°–°–´–õ–ö–ê –ù–ê –ì–£–ì–õ –î–ò–°–ö - –°–û–•–†–ê–ù–Ø–ï–ú –ï–Å !!!
            if (newUploadedAvatarUrl) {
                updateData.avatar = newUploadedAvatarUrl;
            }

            const user = firebase.auth().currentUser;
            db.collection('users').doc(user.uid).update(updateData)
                .then(() => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
                    const nameInput = document.getElementById('profileName');
                    if (nameInput) nameInput.value = name;

                    const surInput = document.getElementById('profileSurname');
                    if (surInput) {
                        if (surname) {
                            surInput.value = surname;
                            surInput.style.display = "block";
                        } else {
                            surInput.style.display = "none";
                        }
                    }

                    const bioInput = document.getElementById('profileBio');
                    if (bioInput) bioInput.value = bio;

                    const nickDiv = document.getElementById('profileUsername');
                    if (nickDiv) nickDiv.innerText = username ? username : '';

                    // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏–ª–∏ –Ω–æ–≤—É—é –∞–≤–∞—Ç–∞—Ä–∫—É - –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë –≤–µ–∑–¥–µ
                    if (newUploadedAvatarUrl) {
                        const myAvatarSmall = document.getElementById('myAvatarSmall');
                        if (myAvatarSmall) myAvatarSmall.innerHTML = `<img src="${newUploadedAvatarUrl}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;

                        const pImg = document.getElementById('profileAvatarPreview');
                        if (pImg) {
                            pImg.src = newUploadedAvatarUrl;
                            pImg.style.display = 'block';
                        }
                        const pPh = document.getElementById('profileAvatarPlaceholder');
                        if (pPh) pPh.style.display = 'none';

                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
                        newUploadedAvatarUrl = null;
                        if (typeof editAvatarBase64 !== 'undefined') editAvatarBase64 = null;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è
                    const birthDisplay = document.getElementById('displayBirthdate');
                    const birthBlock = document.getElementById('birthdateBlock');
                    if (birthdate) {
                        const parts = birthdate.split('-');
                        if (parts.length === 3 && birthDisplay) {
                            birthDisplay.innerText = `${parts[2]}.${parts[1]}.${parts[0]}`;
                            if (birthBlock) birthBlock.style.display = 'flex';
                        }
                    } else {
                        if (birthBlock) birthBlock.style.display = 'none';
                    }

                    showToast('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
                    closeEditProfile();
                })
                .catch(err => {
                    console.error(err);
                    showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message);
                });
        }
        // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        async function saveProfile() {
            const name = document.getElementById('profileName').value.trim();
            const surname = document.getElementById('profileSurname').value.trim();
            const bio = document.getElementById('profileBio').value.trim();

            if (!name) {
                showToast("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
                return;
            }

            const updateData = {
                name: name,
                surname: surname,
                bio: bio
            };

            if (currentAvatarBase64) {
                updateData.avatar = currentAvatarBase64;
            }

            db.collection('users').doc(currentUser.uid).set(updateData, { merge: true })
                .then(() => {
                    showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úì");
                    closeAllSheets();
                })
                .catch(err => {
                    console.error(err);
                    showToast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
                });
        }

        // 3. –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
        function copyData(elementId, label) {
            const el = document.getElementById(elementId);
            if (el && el.innerText && el.innerText.trim() !== '' && el.innerText !== '@–Ω–µ_–∑–∞–¥–∞–Ω') {
                const text = el.innerText;

                navigator.clipboard.writeText(text).then(() => {
                    showToast(`${label} —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω`);
                }).catch(err => {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å', err);
                });
            }
        }

        // 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.innerText = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }
        
        let sheetHistoryStack = 0; // –°—á–µ—Ç—á–∏–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –æ–∫–æ–Ω –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ–ª—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
        function openProfileSheet() {
            // --- –ù–û–í–û–ï: –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é –±—Ä–∞—É–∑–µ—Ä–∞ ---
            sheetHistoryStack++;
            history.pushState({ isSheet: true }, "", window.location.href);

            document.getElementById('overlaySheet').style.display = 'block';
            const sheet = document.getElementById('profileSheet');
            setTimeout(() => sheet.classList.add('open'), 10);

            if (!currentUser) return;

            db.collection('users').doc(currentUser.uid).get().then(doc => {
                if (doc.exists) {
                    const d = doc.data();

                    // Email (–¢–µ–∫—Å—Ç)
                    const emailEl = document.getElementById('profileEmail');
                    if (emailEl) emailEl.innerText = d.email;

                    // Username (–¢–µ–∫—Å—Ç) - –ò–°–ü–†–ê–í–õ–ï–ù–û
                    const usernameDiv = document.getElementById('profileUsername');
                    if (usernameDiv) {
                        // –ï—Å–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º –µ—Å—Ç—å –≤ –±–∞–∑–µ, —Å—Ç–∞–≤–∏–º –µ–≥–æ, –∏–Ω–∞—á–µ –∑–∞–≥–ª—É—à–∫—É
                        usernameDiv.innerText = d.username ? '@' + d.username : '@–Ω–µ_–∑–∞–¥–∞–Ω';
                    }

                    // –ò–º—è –∏ –§–∞–º–∏–ª–∏—è (Input)
                    document.getElementById('profileName').value = d.name || '';
                    document.getElementById('profileSurname').value = d.surname || '';

                    // –û —Å–µ–±–µ (Textarea)
                    const bioArea = document.getElementById('profileBio');
                    if (bioArea) {
                        bioArea.value = d.bio || '';
                        // –ê–≤—Ç–æ-–ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ –≤—ã—Å–æ—Ç—ã
                        bioArea.style.height = 'auto';
                        bioArea.style.height = bioArea.scrollHeight + 'px';
                    }

                    // –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
                    const birthInput = document.getElementById('profileBirthdate');
                    const birthDisplay = document.getElementById('displayBirthdate');
                    const birthBlock = document.getElementById('birthdateBlock');

                    if (d.birthdate) {
                        birthInput.value = d.birthdate;
                        // –ö—Ä–∞—Å–∏–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì
                        const parts = d.birthdate.split('-');
                        if (parts.length === 3) {
                            birthDisplay.innerText = `${parts[2]}.${parts[1]}.${parts[0]}`;
                        } else {
                            birthDisplay.innerText = d.birthdate;
                        }
                        birthBlock.style.display = 'flex';
                    } else {
                        birthInput.value = '';
                        birthDisplay.innerText = '';
                        birthBlock.style.display = 'none';
                    }

                    // –ê–≤–∞—Ç–∞—Ä–∫–∞
                    const img = document.getElementById('profileAvatarPreview');
                    const ph = document.getElementById('profileAvatarPlaceholder');

                    if (d.avatar) {
                        img.src = d.avatar;
                        img.style.display = 'block';
                        ph.style.display = 'none';
                    } else {
                        img.style.display = 'none';
                        ph.style.display = 'flex';
                    }
                }
            });
        }

        // --- –ï–î–ò–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö ESC ---
        document.addEventListener('keydown', function (e) {
            if (e.key === "Escape") {
                const viewer = document.getElementById('imageViewer');
                const searchRes = document.getElementById('searchResults');
                const searchInp = document.getElementById('searchInput');

                // 1. –°–ê–ú–´–ô –í–´–°–û–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢: –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç–∏–Ω–∫–∏
                if (viewer.classList.contains('active')) {
                    closeImageViewer();
                    return;
                }

                // 2. –ó–ê–ö–†–´–¢–¨ –®–¢–û–†–ö–ò –ü–†–û–§–ò–õ–Ø/–ù–ê–°–¢–†–û–ï–ö (–ü–æ –æ—á–µ—Ä–µ–¥–∏ —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑)
                if (document.getElementById('editProfileSheet')?.classList.contains('open')) {
                    closeEditProfile();
                    return;
                }
                if (document.getElementById('generalSettingsSheet')?.classList.contains('open')) {
                    closeGeneralSettings();
                    return;
                }
                if (document.getElementById('profileSheet')?.classList.contains('open')) {
                    closeAllSheets();
                    return;
                }

                // 3. –ó–ê–ö–†–´–¢–¨ –ü–û–ò–°–ö
                if (searchRes.classList.contains('active') || searchInp.value.trim() !== '' || document.activeElement === searchInp) {
                    e.preventDefault();
                    closeSearch();
                    return;
                }

                // 4. –ù–ò–ó–ö–ò–ô –ü–†–ò–û–†–ò–¢–ï–¢: –ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç
                if (currentChatId) {
                    closeChat();
                    return;
                }
            }
        });
        const msgInput = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.querySelector('.voice-btn');

        msgInput.addEventListener('input', function () {
            handleTyping();
            if (this.value.trim().length > 0) {
                sendBtn.classList.remove('hidden'); // <-- –ò–°–ü–†–ê–í–õ–ï–ù–û (–±—ã–ª–æ hidden-btn)
                sendBtn.style.display = 'flex';     // –¢–µ–ø–µ—Ä—å —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
                voiceBtn.style.display = 'none';
            } else {
                sendBtn.classList.add('hidden');    // <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
                sendBtn.style.display = 'none';
                voiceBtn.style.display = 'flex';
            }
        });


       
        
        // --- –ê–í–¢–û–ü–û–í–û–†–û–¢ –û–ö–û–®–ö–ê –°–í–û–ï–ì–û –í–ò–î–ï–û ---
        // --- PIP: drag + resize (–∫—Ä–∞—Å–∏–≤–æ –∏ –±–µ–∑ –±–∞–≥–æ–≤) ---
        const localVidEl = document.getElementById('localVideo');
        const pipEl = document.getElementById('localPip');¬† ¬† ¬† ¬† ¬† ¬† ¬† // –Ω–æ–≤—ã–π id
        const gridEl = document.querySelector('.video-grid');
        const controlsEl = document.querySelector('.controls');
        const resizeHandleEl = pipEl.querySelector('.pip-resize-handle');
        const PIP_STORAGE_KEY = 'pipState_v3';
        let pipRatio = 2 / 3;¬† ¬† ¬† // width/height, –¥–µ—Ñ–æ–ª—Ç –∫–∞–∫ —É —Ç–µ–±—è 140x210
        let pipUserSized = false;¬† // —Å—Ç–∞–Ω–µ—Ç true –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ —Ä–µ—Å–∞–π–∑–∞
        function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
        function getBounds() {
            const gridRect = gridEl.getBoundingClientRect();
            const controlsRect = controlsEl.getBoundingClientRect();
            const margin = 12;
            // bottomLimit: –Ω–µ –¥–∞—ë–º –∑–∞–ª–µ–∑–∞—Ç—å –ø–æ–¥ controls (–æ–Ω–∏ absolute –∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –Ω–∏–∑)
            const bottomLimit = Math.min(gridRect.bottom, controlsRect.top) - gridRect.top - margin;
            return {
                minLeft: margin,
                minTop: margin,
                maxLeft: gridRect.width - margin,
                maxTop: bottomLimit
            };
        }
        function readPipRect() {
            return {
                left: parseFloat(pipEl.style.left || '0'),
                top: parseFloat(pipEl.style.top || '0'),
                width: parseFloat(pipEl.style.width || pipEl.offsetWidth),
                height: parseFloat(pipEl.style.height || pipEl.offsetHeight)
            };
        }
        function applyPipRect(rect, { save = true } = {}) {
            const b = getBounds();
            const minW = 110;
            const maxW = Math.max(minW, b.maxLeft - b.minLeft);
            const width = clamp(rect.width, minW, maxW);
            // –≤—ã—Å–æ—Ç—É –¥–µ—Ä–∂–∏–º –ø–æ ratio (—á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–æ—Å—å)
            const height = Math.max(90, Math.round(width / pipRatio));
            const maxLeft = Math.max(b.minLeft, b.maxLeft - width);
            const maxTop = Math.max(b.minTop, b.maxTop - height);
            const left = clamp(rect.left, b.minLeft, maxLeft);
            const top = clamp(rect.top, b.minTop, maxTop);
            // –≤–∞–∂–Ω–æ–µ: –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ left/top, —á—Ç–æ–±—ã drag/resize –±—ã–ª–∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º–∏
            pipEl.style.left = `${Math.round(left)}px`;
            pipEl.style.top = `${Math.round(top)}px`;
            pipEl.style.right = 'auto';
            pipEl.style.bottom = 'auto';
            pipEl.style.width = `${Math.round(width)}px`;
            pipEl.style.height = `${Math.round(height)}px`;
            if (save) {
                const state = { left: Math.round(left), top: Math.round(top), width: Math.round(width), ratio: pipRatio, userSized: pipUserSized };
                localStorage.setItem(PIP_STORAGE_KEY, JSON.stringify(state));
            }
        }
        function setDefaultPip() {
            const gridRect = gridEl.getBoundingClientRect();
            const controlsRect = controlsEl.getBoundingClientRect();
            const controlsH = Math.max(0, gridRect.bottom - controlsRect.top);
            const defW = (pipRatio >= 1) ? 210 : 140;¬† ¬†// –ø–æ—Ö–æ–∂–µ –Ω–∞ —Ç–≤–æ—é —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É landscape [–ø–æ —Å–º—ã—Å–ª—É]
            const left = gridRect.width - defW - 20;
            const top = gridRect.height - controlsH - Math.round(defW / pipRatio) - 160; // —Ç–≤–æ–π bottom:160 [–ø–æ —Å–º—ã—Å–ª—É]
            pipUserSized = false;
            applyPipRect({ left, top, width: defW, height: defW / pipRatio }, { save: true });
        }
        function loadPipState() {
            try {
                const raw = localStorage.getItem(PIP_STORAGE_KEY);
                if (!raw) return false;
                const s = JSON.parse(raw);
                if (typeof s.ratio === 'number' && isFinite(s.ratio) && s.ratio > 0.1) pipRatio = s.ratio;
                pipUserSized = !!s.userSized;
                applyPipRect({ left: s.left ?? 0, top: s.top ?? 0, width: s.width ?? 140, height: 0 }, { save: false });
                return true;
            } catch (_) {
                return false;
            }
        }
        function updateRatioFromVideo() {
            if (localVidEl.videoWidth && localVidEl.videoHeight) {
                const w = localVidEl.videoWidth;
                const h = localVidEl.videoHeight;
                // –õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –≤–∏–¥–µ–æ —à–∏—Ä–æ–∫–æ–µ (–ü–ö) -> –¥–µ–ª–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (2:3)
                // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –≤—ã—Å–æ–∫–æ–µ (–¢–µ–ª–µ—Ñ–æ–Ω) -> –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                if (w > h) {
                    pipRatio = 2 / 3;
                } else {
                    pipRatio = w / h;
                }
                // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                let currentWidth = parseFloat(pipEl.style.width) || 140;
                let newHeight = currentWidth / pipRatio;
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –≥–ª—é–∫–æ–≤: –µ—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ –ø–æ–ª—É—á–∏–ª–∞—Å—å —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–π, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
                if (newHeight < 100) newHeight = currentWidth * 1.5;
                applyPipRect({ width: currentWidth, height: newHeight }, true);
            }
        }
        // 1) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏/—Ä–∞–∑–º–µ—Ä–∞
        (function initPip() {
            // –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ bottom/right (–∏–∑ CSS) –≤ left/top, —á—Ç–æ–±—ã –¥–∞–ª—å—à–µ –±—ã–ª–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ
            // –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî –æ–Ω–æ –≥–ª–∞–≤–Ω–µ–µ
            const hasState = loadPipState();
            if (!hasState) setDefaultPip();
            // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–≤—Ç–æ-–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –±–µ–∑ –¥–µ—Ä–≥–∞–Ω–∏–π
            localVidEl.addEventListener('loadedmetadata', () => {
                updateRatioFromVideo();
                // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–µ–Ω—è–ª —Ä–∞–∑–º–µ—Ä ‚Äî –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç –ø–æ–¥ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é
                if (!pipUserSized) setDefaultPip();
            });
            // –∫–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è viewport (–ø–æ–≤–æ—Ä–æ—Ç/resize –æ–∫–Ω–∞) ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–∂–∏–º–∞–µ–º –≤ –≥—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('resize', () => applyPipRect(readPipRect(), { save: true }));
        })();
        // 2) Drag
        let drag = null;
        pipEl.addEventListener('pointerdown', (e) => {
            if (e.button !== 0) return;
            if (e.target === resizeHandleEl) return; // resize –æ—Ç–¥–µ–ª—å–Ω–æ
            e.preventDefault();
            pipEl.classList.add('dragging');
            pipEl.setPointerCapture(e.pointerId);
            const r = readPipRect();
            drag = {
                id: e.pointerId,
                startX: e.clientX,
                startY: e.clientY,
                startLeft: r.left,
                startTop: r.top,
                width: r.width,
                height: r.height
            };
        });
        pipEl.addEventListener('pointermove', (e) => {
            if (!drag || drag.id !== e.pointerId) return;
            const dx = e.clientX - drag.startX;
            const dy = e.clientY - drag.startY;
            applyPipRect({
                left: drag.startLeft + dx,
                top: drag.startTop + dy,
                width: drag.width,
                height: drag.height
            }, { save: false });
        });
        pipEl.addEventListener('pointerup', (e) => {
            if (!drag || drag.id !== e.pointerId) return;
            pipEl.classList.remove('dragging');
            drag = null;
            applyPipRect(readPipRect(), { save: true });
        });
        // 3) Resize (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º aspect ratio)
        let resize = null;
        resizeHandleEl.addEventListener('pointerdown', (e) => {
            if (e.button !== 0) return;
            e.preventDefault();
            pipEl.classList.add('resizing');
            pipEl.setPointerCapture(e.pointerId);
            const r = readPipRect();
            resize = {
                id: e.pointerId,
                startX: e.clientX,
                startY: e.clientY,
                startW: r.width,
                startLeft: r.left,
                startTop: r.top
            };
        });
        pipEl.addEventListener('pointermove', (e) => {
            if (!resize || resize.id !== e.pointerId) return;
            const dx = e.clientX - resize.startX;
            const dy = e.clientY - resize.startY;
            // –±–µ—Ä—ë–º ‚Äú–Ω–∞–∏–±–æ–ª–µ–µ —Å–∏–ª—å–Ω–æ–µ‚Äù –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            const grow = Math.max(dx, dy * pipRatio);
            const newW = resize.startW + grow;
            pipUserSized = true;
            applyPipRect({
                left: resize.startLeft,
                top: resize.startTop,
                width: newW,
                height: 0
            }, { save: false });
        });
        pipEl.addEventListener('pointerup', (e) => {
            if (!resize || resize.id !== e.pointerId) return;
            pipEl.classList.remove('resizing');
            resize = null;
            applyPipRect(readPipRect(), { save: true });
        });
        // 4) –ë—ã—Å—Ç—Ä—ã–π —Å–±—Ä–æ—Å (–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ / –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø)
        pipEl.addEventListener('dblclick', () => setDefaultPip());
        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –≤–∏–¥–µ–æ
        localVidEl.addEventListener('loadedmetadata', checkLocalVideoOrientation);
        localVidEl.addEventListener('resize', checkLocalVideoOrientation);
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        function checkLocalVideoOrientation() {
            if (!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                const settings = videoTrack.getSettings();
                // –õ–æ–≥–∏–∫–∞ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥–ª—É—à–∫–∞, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª–æ
                console.log("Orientation check:", settings.width, settings.height);
            }
        }
        function updateCallControlsVisibility() {
            const isMobile = isMobileDevice();
            // –ò—â–µ–º –∫–Ω–æ–ø–∫–∏
            const btnFlip = document.getElementById('btnFlip');
            const btnScr = document.getElementById('btnScr');
            // –ò—â–µ–º –∏—Ö —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ .control-item
            const flipItem = btnFlip ? btnFlip.closest('.control-item') : null;
            const scrItem = btnScr ? btnScr.closest('.control-item') : null;
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å —Å–∫—Ä—ã—Ç–∏—è:
            // - –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ (btnScr) —Å–∫—Ä—ã—Ç–∞ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
            // - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã (btnFlip) —Å–∫—Ä—ã—Ç–æ –Ω–∞ –ü–ö
            if (scrItem) {
                if (isMobile) {
                    scrItem.classList.add('control-item-hidden');
                } else {
                    scrItem.classList.remove('control-item-hidden');
                }
            }
            if (flipItem) {
                if (isMobile) {
                    flipItem.classList.remove('control-item-hidden');
                } else {
                    flipItem.classList.add('control-item-hidden');
                }
            }
            console.log('[updateCallControls] isMobile:', isMobile, '| scrItem —Å–∫—Ä—ã—Ç–∞:', scrItem?.classList.contains('control-item-hidden'), '| flipItem —Å–∫—Ä—ã—Ç–∞:', flipItem?.classList.contains('control-item-hidden'));
        }
    </script>
    <!-- OneSignal Push Logic (–í—Å—Ç–∞–≤—å —ç—Ç–æ –≤ —Å–∞–º—ã–π –Ω–∏–∑ –ø–µ—Ä–µ–¥ </body>) -->
    <script>
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(function (OneSignal) {
            OneSignal.init({
                appId: "6af8818f-ba3a-40c4-b820-5235c1d73925", // –¢–≤–æ–π App ID
            });
            function savePlayerId() {
                if (OneSignal.User.PushSubscription.optedIn) {
                    const oneSignalId = OneSignal.User.PushSubscription.id;
                    const user = firebase.auth().currentUser;
                    if (user && oneSignalId) {
                        console.log("–°–æ—Ö—Ä–∞–Ω—è–µ–º OneSignal ID:", oneSignalId);
                        db.collection('users').doc(user.uid).update({ oneSignalId: oneSignalId }).catch(e => { });
                    }
                }
            }
            OneSignal.User.PushSubscription.addEventListener("change", savePlayerId);
            firebase.auth().onAuthStateChanged(u => { if (u) setTimeout(savePlayerId, 3000); });
        });
        // 2. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—É—à–∞ (–° –û–ë–•–û–î–û–ú –ë–õ–û–ö–ò–†–û–í–ö–ò)


        // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –í–´–•–û–î–ê ---
        async function logout() {
            if (!confirm("–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?")) return;

            const user = firebase.auth().currentUser;

            if (user) {
                try {
                    console.log("üßπ –û—á–∏—Å—Ç–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...");

                    // 1. –£–î–ê–õ–Ø–ï–ú –¢–û–ö–ï–ù–´ –ò–ó –ë–ê–ó–´ –î–ê–ù–ù–´–•
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º FieldValue.delete(), —á—Ç–æ–±—ã —Å—Ç–µ—Ä–µ—Ç—å —Å–∞–º–∏ –ø–æ–ª—è
                    await db.collection('users').doc(user.uid).update({
                        fcmToken: firebase.firestore.FieldValue.delete(),
                        oneSignalId: firebase.firestore.FieldValue.delete(),
                        // –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–≤ —Å–µ—Ç–∏"
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    console.log("‚úÖ –¢–æ–∫–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞.");
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤:", e);
                    // –î–∞–∂–µ –µ—Å–ª–∏ –æ—à–∏–±–∫–∞ (–Ω–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞), –≤—Å–µ —Ä–∞–≤–Ω–æ –≤—ã—Ö–æ–¥–∏–º –Ω–∏–∂–µ
                }
            }

            // 2. –ß–∏—Å—Ç–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –º–µ—Ç–∫–∏ –≤—Ö–æ–¥–∞
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('current_user_uid');

            // –í–ê–ñ–ù–û: –ú—ã –ù–ï —É–¥–∞–ª—è–µ–º 'fcm_token' –∏–∑ localStorage!
            // –û–Ω –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¢–ï–õ–ï–§–û–ù–£, –∞ –Ω–µ –∫ –∞–∫–∫–∞—É–Ω—Ç—É.
            // –û–Ω –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è, –∫–æ–≥–¥–∞ —Ç—ã –≤–æ–π–¥–µ—à—å –≤ –î–†–£–ì–û–ô –∞–∫–∫–∞—É–Ω—Ç.

            // 3. –†–∞–∑–ª–æ–≥–∏–Ω–∏–≤–∞–µ–º—Å—è
            auth.signOut().then(() => {
                window.location.reload();
            });
        }
        // === –†–û–£–¢–ï–† (–ù–ê–í–ò–ì–ê–¶–ò–Ø) ===
        // 1. –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥)
        window.addEventListener('hashchange', handleHashChange);
        async function handleHashChange() {
            const hash = window.location.hash;
            // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –ø—É—Å—Ç–∞—è (–º—ã –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤)
            if (!hash || hash === '#') {
                performCloseUI();
                return;
            }
            // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –≤–∏–¥–∞ #chat/USER_ID
            if (hash.startsWith('#chat/')) {
                const userId = hash.replace('#chat/', '');

                // –ï—Å–ª–∏ –º—ã —É–∂–µ –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                if (currentFriendId === userId) return;

                if (!currentUser) return;

                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≤ –∫—ç—à–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –±–∞–∑—ã
                let userData = usersCache[userId];
                if (!userData) {
                    try {
                        document.getElementById('mainChatArea').classList.add('active');
                        document.getElementById('noChat').classList.add('hidden');
                        document.getElementById('activeChat').classList.remove('hidden');
                        document.getElementById('chatTitle').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

                        const doc = await db.collection('users').doc(userId).get();
                        if (doc.exists) {
                            userData = doc.data();
                            usersCache[userId] = userData;
                        }
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞", e);
                    }
                }

                if (userData) {
                    // –°–∫–ª–µ–∏–≤–∞–µ–º –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é –¥–ª—è —à–∞–ø–∫–∏ —á–∞—Ç–∞
                    const name = `${userData.name || ''} ${userData.surname || ''}`.trim() || userData.username || 'User';

                    currentFriendId = userId;
                    currentChatId = [currentUser.uid, userId].sort().join('_');

                    // --- –í–ê–ñ–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª—é—á–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
                    fetchChatKey(currentChatId);
                    // -----------------------------------------------------------------

                    if (window.innerWidth <= 768) {
                        // –ü–ª–∞–≤–Ω–æ –ø—Ä—è—á–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
                        document.getElementById('mainSidebar').classList.add('hidden-mobile');
                        // –ü–ª–∞–≤–Ω–æ –≤—ã–¥–≤–∏–≥–∞–µ–º —á–∞—Ç
                        document.getElementById('mainChatArea').classList.add('active');
                    }

                    document.getElementById('noChat').classList.add('hidden');
                    const activeChatElement = document.getElementById('activeChat');
                    activeChatElement.classList.remove('hidden');

                    // –ö—Ä–∞—Å–∏–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –ü–ö
                    if (window.innerWidth > 768) {
                        activeChatElement.classList.remove('chat-slide-animate');
                        void activeChatElement.offsetWidth; // –°–±—Ä–æ—Å –∫—ç—à–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
                        activeChatElement.classList.add('chat-slide-animate');
                    }

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–º—è (–ù–∏–∫ –≤ –¢–ì –Ω–µ –ø–∏—à–µ—Ç—Å—è –≤ —à–∞–ø–∫–µ)
                    document.getElementById('chatTitle').innerText = name;

                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É
                    const headerAvatar = document.getElementById('chatHeaderAvatar');
                    if (userData && userData.avatar) {
                        headerAvatar.innerHTML = `<img src="${userData.avatar}" style="width:100%;height:100%;object-fit:cover;">`;
                    } else {
                        // –ó–∞–≥–ª—É—à–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ
                        headerAvatar.innerHTML = 'üë§';
                    }

                    // =======================================================
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ó–ê–ü–£–°–ö–ê–ï–ú –°–õ–£–®–ê–¢–ï–õ–¨ –°–¢–ê–¢–£–°–ê –ü–†–ò –û–ë–ù–û–í–õ–ï–ù–ò–ò
                    // =======================================================

                    // 1. –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π, –µ—Å–ª–∏ –±—ã–ª
                    if (chatStatusUnsub) chatStatusUnsub();

                    // 2. –°—Ç–∞–≤–∏–º "–∑–∞–≥—Ä—É–∑–∫–∞" –∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–µ –≤—Ä–µ–º—è —Å—Ä–∞–∑—É
                    const statusEl = document.getElementById('chatStatus');
                    if (statusEl) {
                        statusEl.innerText = userData.lastSeen ? formatLastSeen(userData.lastSeen) : '–∑–∞–≥—Ä—É–∑–∫–∞...';
                    }

                    // 3. –ó–∞–ø—É—Å–∫–∞–µ–º –∂–∏–≤–æ–µ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ
                    chatStatusUnsub = db.collection('users').doc(userId).onSnapshot(userSnap => {
                        if (userSnap.exists && currentFriendId === userId) {
                            const uData = userSnap.data();
                            usersCache[userId] = uData; // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à

                            const el = document.getElementById('chatStatus');
                            if (el) {
                                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ —Å–µ–π—á–∞—Å –ù–ï –∏–¥–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—è "–ø–µ—á–∞—Ç–∞–µ—Ç"
                                if (!el.querySelector('.typing-text')) {
                                    el.innerText = formatLastSeen(uData.lastSeen);
                                    el.style.color = "#888";
                                }
                            }
                        }
                    }, err => console.error("–û—à–∏–±–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª—è —Å—Ç–∞—Ç—É—Å–∞:", err));

                    // =======================================================

                    // =======================================================

                    loadMessages();

                    // --- –ù–û–í–û–ï: –ê–í–¢–û–§–û–ö–£–° –ü–†–ò –í–•–û–î–ï –í –ß–ê–¢ ---
                    setTimeout(() => {
                        const inp = document.getElementById('msgInput');
                        if (!inp) return;

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–±–∏–ª–∫–∞ –ª–∏ —ç—Ç–æ
                        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                        if (isMobile) {
                            // –¢–†–Æ–ö –î–õ–Ø –¢–ï–õ–ï–§–û–ù–û–í: –°—Ç–∞–≤–∏–º inputmode='none'. 
                            // –ë—Ä–∞—É–∑–µ—Ä —Å—Ç–∞–≤–∏—Ç —Ñ–æ–∫—É—Å (–∫—É—Ä—Å–æ—Ä –º–∏–≥–∞–µ—Ç), –Ω–æ –æ–≥—Ä–æ–º–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ù–ï –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç —á–∞—Ç —Å—Ä–∞–∑—É.
                            inp.setAttribute('inputmode', 'none');
                            inp.focus();

                            // –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–∞–ª—å–Ω–æ –∫–∞—Å–∞–µ—Ç—Å—è –ø–æ–ª—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
                            inp.addEventListener('pointerdown', function () {
                                inp.removeAttribute('inputmode');
                            }, { once: true });
                        } else {
                            // –ù–∞ –ü–ö –ø—Ä–æ—Å—Ç–æ –¥–∞–µ–º –æ–±—ã—á–Ω—ã–π —Ñ–æ–∫—É—Å
                            inp.removeAttribute('inputmode');
                            inp.focus();
                        }
                    }, 300); // –ñ–¥–µ–º 300–º—Å, –ø–æ–∫–∞ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞
                    // ------------------------------------------

                } else {
                    // –Æ–∑–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω
                    window.location.hash = '';
                }
            }
        }
        // --- –í—Å—Ç–∞–≤—å —ç—Ç–æ –≤ —Å–≤–æ–π —Å–∫—Ä–∏–ø—Ç ---

        // === –ù–ê–ß–ê–õ–û –í–°–¢–ê–í–ö–ò: –û–±—Ä–∞–±–æ—Ç–∫–∞ –¢–æ–∫–µ–Ω–∞ –∏–∑ C# ===

        // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Android (C#) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        window.setNativeOneSignalId = function (token) {
            console.log("üî• FCM Token –ø–æ–ª—É—á–µ–Ω –∏–∑ Android:", token);
            // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞
            localStorage.setItem('fcm_token', token);

            // 2. –ï—Å–ª–∏ –º—ã —É–∂–µ –≤–æ—à–ª–∏, —Å—Ä–∞–∑—É —à–ª–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            if (currentUser) {
                saveTokenToBackend(currentUser.uid, token);
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–æ–∫–µ–Ω–∞ –≤ –±–∞–∑—É –∏ –Ω–∞ —Å–∫—Ä–∏–ø—Ç
        function saveTokenToBackend(uid, token) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (Firestore)
            db.collection('users').doc(uid).update({
                fcmToken: token
            }).catch(err => console.log("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –≤ –ë–î:", err));

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç—É (–¥–ª—è –ø—É—à–µ–π)
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    action: 'saveToken',
                    userId: uid,
                    token: token
                })
            });
        }

        // === –ö–û–ù–ï–¶ –í–°–¢–ê–í–ö–ò ===





        async function sendNotificationSecure(friendUid, messageText, msgType = 'text', isCall = false) {
            if (!friendUid || !messageText) return;

            // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
            let senderName = "Novogram";
            if (currentUser) {
                if (usersCache[currentUser.uid] && usersCache[currentUser.uid].name) {
                    senderName = usersCache[currentUser.uid].name;
                } else if (currentUser.displayName) {
                    senderName = currentUser.displayName;
                } else {
                    senderName = currentUser.email;
                }
            }

            let displayText = messageText;
            if (msgType === 'image') displayText = 'üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è';
            if (msgType === 'file') displayText = 'üìÑ –§–∞–π–ª';
            if (isCall) displayText = 'üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...';

            try {
                // 2. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                const doc = await db.collection('users').doc(friendUid).get();
                if (!doc.exists) return;

                const userData = doc.data();

                // –ò—â–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
                const fcmToken = userData.fcmToken || null;
                const tgId = userData.tgChatId || null;
                const osId = userData.oneSignalId || null;

                if (!tgId && !osId && !fcmToken) {
                    console.log("–£ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –Ω–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.");
                    return;
                }

                // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ú–ï–¢–û–î)
                fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    redirect: "follow", // <-- –í–ê–ñ–ù–û: –°–ª–µ–¥–æ–≤–∞—Ç—å –∑–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º Google
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8" // <-- –í–ê–ñ–ù–û: text/plain —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ CORS –æ—à–∏–±–æ–∫
                    },
                    body: JSON.stringify({
                        action: "notification",
                        secret: APP_SECRET_KEY,

                        fcmToken: fcmToken,
                        tgId: tgId,
                        oneSignalId: osId,

                        title: senderName,
                        text: displayText,
                        isCall: isCall
                    })
                })
                    .then(response => response.json())
                    .then(data => console.log("–°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏:", data))
                    .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–∫—Ä–∏–ø—Ç—É:", err));

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:", e);
            }
        }


        
        // --- 1. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ "–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ" —Å–æ–æ–±—â–µ–Ω–∏—è (–ø—Ä–µ–≤—å—é) ---
        function showTempMessage(file) {
            const list = currentMsgList;
            const tempId = 'temp-' + Date.now();
            const div = document.createElement('div');
            div.id = tempId;
            div.className = 'msg msg-me'; // –°—Ä–∞–∑—É –∫–∞–∫ "—Å–≤–æ—ë"
            let contentHtml = '';
            // –ï—Å–ª–∏ —ç—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë —Å—Ä–∞–∑—É
            if (file.type.startsWith('image/')) {
                const url = URL.createObjectURL(file);
                contentHtml = `
                                                                                                                                                                                                                                            <div class="media-container loading-overlay" style="position: relative; display: inline-block;">
                                                                                                                                                                                                                                                <img src="${url}" class="chat-media-img" style="opacity: 1;">
                                                                                                                                                                                                                                                <div class="upload-spinner"></div>
                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                        `;
            }
            // –ï—Å–ª–∏ —ç—Ç–æ —Ñ–∞–π–ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
            else {
                contentHtml = `
                                                                                                                                                                                                                                            <div class="chat-file-card" style="opacity: 0.7;">
                                                                                                                                                                                                                                                <div class="file-icon">üìÑ</div>
                                                                                                                                                                                                                                                <div class="file-info">
                                                                                                                                                                                                                                                    <div class="file-name">${file.name}</div>
                                                                                                                                                                                                                                                    <div class="file-action">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                <div class="upload-spinner" style="width: 20px; height: 20px; border-width: 2px; left: auto; right: 10px; transform: translateY(-50%);"></div>
                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                        `;
            }
            div.innerHTML = contentHtml;
            list.appendChild(div);

            // --- –ù–û–í–û–ï: –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ ---
            setTimeout(() => {
                list.scrollTo({ top: list.scrollHeight + 500, behavior: 'smooth' });
            }, 50);

            return tempId; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º ID, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
        }
        
        // --- 2. –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ ---
        // !!! –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è GOOGLE_SCRIPT_URL –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤—ã—à–µ !!!
        async function uploadFile(input) {
            const file = input.files[0];
            if (!file) return;

            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 10 –ú–ë
            if (file.size > 10 * 1024 * 1024) {
                alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 10 –ú–ë.");
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            const tempMsgId = showTempMessage(file);

            const msgInput = document.getElementById('msgInput');
            const originalPlaceholder = msgInput.placeholder;
            msgInput.placeholder = "–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...";
            msgInput.disabled = true;

            try {
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Base64
                const toBase64 = f => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(f);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });

                const base64Data = await toBase64(file);

                // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ó–ê–ü–†–û–° –° –°–ï–ö–†–ï–¢–û–ú –ò ACTION
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    redirect: "follow",
                    headers: {
                        "Content-Type": "text/plain;charset=utf-8"
                    },
                    body: JSON.stringify({
                        action: "upload",¬† // <--- –í–ê–ñ–ù–û: –≥–æ–≤–æ—Ä–∏–º —Å–µ—Ä–≤–µ—Ä—É, —á—Ç–æ —ç—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∞
                        secret: "JH54jnbdfkjs297615109dxc1kDmnsg_df1jksHnh1Lhsc", // <--- –í–ê–ñ–ù–û: —Ç–≤–æ–π –∫–ª—é—á
                        filename: file.name,
                        mimeType: file.type,
                        base64: base64Data
                    })
                });

                const data = await response.json();

                // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–≤—å—é
                const tempEl = document.getElementById(tempMsgId);
                if (tempEl) tempEl.remove();

                if (data.result === "success") {
                    const type = file.type.startsWith('image/') ? 'image' : 'file';
                    sendMsg(data.url, false, type);
                } else {
                    throw new Error(data.message || "–û—à–∏–±–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞");
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
                const tempEl = document.getElementById(tempMsgId);
                if (tempEl) tempEl.remove();
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + error.message);
            } finally {
                msgInput.placeholder = originalPlaceholder;
                msgInput.disabled = false;
                input.value = '';
                msgInput.focus();
            }
        }
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
        function openImageViewer(src) {
            const viewer = document.getElementById('imageViewer');
            const img = document.getElementById('imageViewerImg');
            // –ú–µ–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–≤—ã—à–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–µ—Å–ª–∏ —ç—Ç–æ –≥—É–≥–ª –¥–∏—Å–∫)
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä =w2000 (—à–∏—Ä–∏–Ω–∞ 2000px)
            let highResSrc = src;
            if (src.includes('lh3.googleusercontent.com')) {
                highResSrc = src.split('=')[0] + '=w2000';
            }
            img.src = highResSrc;
            viewer.classList.add('active');
        }
        function closeImageViewer() {
            const viewer = document.getElementById('imageViewer');
            viewer.classList.remove('active');
            setTimeout(() => {
                document.getElementById('imageViewerImg').src = ''; // –û—á–∏—Å—Ç–∫–∞
            }, 300);
        }
        function closeChat() {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–µ—à (–Ω–∞–ø—Ä–∏–º–µ—Ä, #chat/123)
            if (window.location.hash) {
                // 2. –£–±–∏—Ä–∞–µ–º —Ö–µ—à –∏–∑ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                history.pushState("", document.title, window.location.pathname + window.location.search);
                // 3. –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Ö–µ—à–∞ –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã –æ–Ω –∑–∞–ø—É—Å—Ç–∏–ª performCloseUI()
                handleHashChange();
            } else {
                // –ï—Å–ª–∏ —Ö–µ—à–∞ –Ω–µ—Ç (—Å—Ç—Ä–∞–Ω–Ω—ã–π —Å–ª—É—á–∞–π), –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º UI
                performCloseUI();
            }
        }
        function closeSearch() {
            const resBox = document.getElementById('searchResults');
            const searchInput = document.getElementById('searchInput');
            const friendsList = document.getElementById('friendsList');
            const requestsList = document.getElementById('requestsList');
            const tabs = document.querySelector('.tabs');

            // –°–∫—Ä—ã–≤–∞–µ–º –∏ –æ—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            resBox.classList.remove('active');
            resBox.style.display = 'none';
            resBox.innerHTML = '';
            searchInput.value = '';

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–∞–±—ã
            if (tabs) tabs.classList.remove('hidden');

            // –°–º–æ—Ç—Ä–∏–º, –∫–∞–∫–∞—è –≤–∫–ª–∞–¥–∫–∞ –±—ã–ª–∞ –∞–∫—Ç–∏–≤–Ω–∞, –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω—É–∂–Ω—ã–π —Å–ø–∏—Å–æ–∫
            const activeTab = document.querySelector('.tab.active');
            if (activeTab && activeTab.innerText.includes('–ó–∞—è–≤–∫–∏')) {
                requestsList.classList.remove('hidden');
                friendsList.classList.add('hidden');
            } else {
                friendsList.classList.remove('hidden');
                requestsList.classList.add('hidden');
            }

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∞–≤–∞—Ç–∞—Ä–∫—É
            document.getElementById('profileBtn').style.display = 'flex';
            document.getElementById('searchBackBtn').style.display = 'none';
        }

    
        
        // –ò –æ–±–Ω–æ–≤–∏ openSearchUI, —á—Ç–æ–±—ã display –ø–µ—Ä–µ–∫–ª—é—á–∞–ª—Å—è
        function openSearchUI() {
            document.getElementById('profileBtn').style.display = 'none';
            document.getElementById('searchBackBtn').style.display = 'block';

            // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–∫–∏ –∏ —Ç–∞–±—ã
            document.getElementById('friendsList').classList.add('hidden');
            document.getElementById('requestsList').classList.add('hidden');
            document.querySelector('.tabs').classList.add('hidden');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            const resBox = document.getElementById('searchResults');
            resBox.style.display = 'flex';
            resBox.classList.add('active');
        }








        function openContextMenu(e, msgId, isMine, isMobile = false) {
            // --- –ù–û–í–û–ï: –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ —Å—Ç–∞—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø—Ä–∏ –ø–µ—Ä–µ–ø—Ä—ã–≥–∏–≤–∞–Ω–∏–∏ –º–µ–Ω—é) ---
            document.querySelectorAll('.msg-highlighted').forEach(el => {
                el.classList.remove('msg-highlighted');
            });

            selectedMsgId = msgId;
            selectedMsgIsMine = isMine;

            const menu = document.getElementById('contextMenu');
            const btnEdit = document.getElementById('ctxEdit');
            const msgEl = document.getElementById('msg-' + msgId);

            if (isMine) btnEdit.style.display = 'flex';
            else btnEdit.style.display = 'none';

            // --- –í–ö–õ–Æ–ß–ê–ï–ú –†–ê–ó–ú–´–¢–ò–ï –ò –í–´–î–ï–õ–Ø–ï–ú –°–û–û–ë–©–ï–ù–ò–ï ---
            document.body.classList.add('chat-blur-active');
            if (msgEl) msgEl.classList.add('msg-highlighted');

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ–≤–∏–¥–∏–º—ã–π –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Å–ª–æ–π –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ –∫–ª–∏–∫–∞ –º–∏–º–æ –º–µ–Ω—é
            const overlay = document.getElementById('overlaySheet');
            if (overlay) {
                overlay.style.background = 'transparent'; // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–Ω–æ—Ç—É, —Ç.–∫. –º—ã —É–∂–µ –∑–∞—Ç–µ–º–Ω–∏–ª–∏ —Ñ–æ–Ω CSS-–æ–º
                overlay.style.display = 'block';
            }

            menu.style.display = 'flex';

            // –î–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –¥–æ–ª—é —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å display:flex –∏ –≤—ã—á–∏—Å–ª–∏—Ç—å —Ä–∞–∑–º–µ—Ä—ã –º–µ–Ω—é
            setTimeout(() => {
                if (isMobile && msgEl) {
                    const rect = msgEl.getBoundingClientRect();
                    const menuH = menu.offsetHeight;
                    const menuW = menu.offsetWidth;

                    // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Ä–æ–≤–Ω–æ –ü–û–î —Å–æ–æ–±—â–µ–Ω–∏–µ–º. –ï—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç ‚Äî –ù–ê–î –Ω–∏–º.
                    let topPos = rect.bottom + 10;
                    if (topPos + menuH > window.innerHeight - 20) {
                        topPos = rect.top - menuH - 10;
                    }

                    // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ: –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –ª–µ–≤–æ–º—É –∏–ª–∏ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é —Å–æ–æ–±—â–µ–Ω–∏—è
                    let leftPos;
                    if (isMine) {
                        leftPos = rect.right - menuW;
                        if (leftPos < 10) leftPos = 10; // –ó–∞—â–∏—Ç–∞ –æ—Ç –≤—ã—Ö–æ–¥–∞ –∑–∞ —ç–∫—Ä–∞–Ω
                    } else {
                        leftPos = rect.left;
                        if (leftPos + menuW > window.innerWidth - 10) leftPos = window.innerWidth - menuW - 10;
                    }

                    menu.style.position = 'fixed';
                    menu.style.top = `${topPos}px`;
                    menu.style.left = `${leftPos}px`;
                    menu.style.transform = 'none';
                } else if (e) {
                    // –î–ª—è –ü–ö - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –º—ã—à–∫–∏
                    let x = e.clientX;
                    let y = e.clientY;
                    if (x + menu.offsetWidth > window.innerWidth) x -= menu.offsetWidth;
                    if (y + menu.offsetHeight > window.innerHeight) y -= menu.offsetHeight;
                    menu.style.left = `${x}px`;
                    menu.style.top = `${y}px`;
                    menu.style.transform = 'none';
                }

                menu.classList.add('active');
            }, 10);
        }





        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ (–∫–∞–∫ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ)
        document.addEventListener('scroll', () => {
            const menu = document.getElementById('contextMenu');
            if (menu.style.display === 'flex') {
                menu.classList.remove('active');
                menu.style.display = 'none';
            }
        }, true); // true –¥–ª—è –ø–µ—Ä–µ—Ö–≤–∞—Ç–∞ —Å–∫—Ä–æ–ª–ª–∞ –≤–Ω—É—Ç—Ä–∏ div'–æ–≤

        let editAvatarBase64 = null;


        function openEditProfile() {
            // --- –ù–û–í–û–ï ---
            sheetHistoryStack++;
            history.pushState({ isSheet: true }, "", window.location.href);

            const user = firebase.auth().currentUser;
            if (!user) return;

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            const sheet = document.getElementById('editProfileSheet');
            sheet.classList.add('open');

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            db.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    const d = doc.data();
                    document.getElementById('editName').value = d.name || '';
                    document.getElementById('editSurname').value = d.surname || '';
                    document.getElementById('editBio').value = d.bio || '';
                    updateBioCounter(document.getElementById('editBio'));

                    if (d.birthdate) {
                        document.getElementById('editBirthdate').value = d.birthdate;
                        syncBirthdateView();
                    } else {
                        document.getElementById('editBirthdate').value = '';
                    }

                    originalUsername = d.username || '';
                    document.getElementById('editUsername').value = originalUsername;
                    document.getElementById('editUsernameStatus').style.display = 'none';
                    isUsernameValid = true;

                    const saveBtn = document.querySelector('#editProfileSheet .tg-header-top button:last-child');
                    if (saveBtn) {
                        saveBtn.style.opacity = "1";
                        saveBtn.style.pointerEvents = "auto";
                    }

                    const img = document.getElementById('editAvatarPreview');
                    const ph = document.getElementById('editAvatarPlaceholder');

                    if (d.avatar) {
                        img.src = d.avatar;
                        img.style.display = 'block';
                        ph.style.display = 'none';
                        editAvatarBase64 = d.avatar;
                    } else {
                        img.style.display = 'none';
                        ph.style.display = 'flex';
                        const firstLetter = (d.name || 'U').charAt(0).toUpperCase();
                        ph.innerText = firstLetter;
                        editAvatarBase64 = null;
                    }
                }
            });
        }

        function closeEditProfile(fromPopState = false) {
            // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ ESC –∏–ª–∏ –∫–Ω–æ–ø–∫—É –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –¥–∞–µ–º –±—Ä–∞—É–∑–µ—Ä—É –∫–æ–º–∞–Ω–¥—É "–ù–∞–∑–∞–¥"
            if (fromPopState !== true && typeof sheetHistoryStack !== 'undefined' && sheetHistoryStack > 0) {
                history.back();
                return; // –í–ê–ñ–ù–û: –ü—Ä–µ—Ä—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é. –û–∫–Ω–æ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —Å–∞–º–æ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π popstate!
            }

            // –§–∏–∑–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ (—Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º —Å–≤–∞–π–ø–µ –∏–ª–∏ –ø–æ—Å–ª–µ history.back)
            document.getElementById('editProfileSheet').classList.remove('open');
        }

        function updateBioCounter(el) {
            const count = el.value.length;
            const remaining = 70 - count;
            document.getElementById('bioCounter').innerText = remaining;
            if (remaining < 0) {
                document.getElementById('bioCounter').style.color = 'red';
            } else {
                document.getElementById('bioCounter').style.color = '#888';
            }
        }

        function handleEditAvatarSelect(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                // –°–∂–∞—Ç–∏–µ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É —Å–∂–∞—Ç–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º)
                const img = new Image();
                img.src = e.target.result;
                img.onload = function () {
                    // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ canvas –¥–ª—è —Å–∂–∞—Ç–∏—è –¥–æ 500x500
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const MAX = 500;
                    if (width > height) {
                        if (width > MAX) { height *= MAX / width; width = MAX; }
                    } else {
                        if (height > MAX) { width *= MAX / height; height = MAX; }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    editAvatarBase64 = canvas.toDataURL('image/jpeg', 0.8);

                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    const preview = document.getElementById('editAvatarPreview');
                    const ph = document.getElementById('editAvatarPlaceholder');
                    preview.src = editAvatarBase64;
                    preview.style.display = 'block';
                    ph.style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        }

        

        // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ (–¥–æ–±–∞–≤—å—Ç–µ –≤ –Ω–∞—á–∞–ª–æ —Å–∫—Ä–∏–ø—Ç–∞, –µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç)
        // let usernameCheckTimeout = null;

        function checkUsernameAvailability(input) {
            // 1. –û—á–∏—Å—Ç–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤ (–¢–û–ß–ù–û –ö–ê–ö –ü–†–ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò)
            // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü—É, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ
            let val = input.value;
            const cleanVal = val.replace(/[^a-zA-Z0-9_]/g, '');

            if (val !== cleanVal) {
                input.value = cleanVal;
                val = cleanVal;
            }

            const statusEl = document.getElementById('editUsernameStatus');
            // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —Ö–µ–¥–µ—Ä–∞ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            const saveBtn = document.querySelector('#editProfileSheet .tg-header-top button:last-child');

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
            if (usernameCheckTimeout) clearTimeout(usernameCheckTimeout);

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–æ–π
            const setValid = (isValid) => {
                isUsernameValid = isValid;
                saveBtn.style.opacity = isValid ? "1" : "0.5";
                saveBtn.style.pointerEvents = isValid ? "auto" : "none";
            };

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã (–∫–∞–∫ –Ω–∞ –≤–∞—à–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç–µ - 5 —Å–∏–º–≤–æ–ª–æ–≤)
            if (val.length < 5) {
                statusEl.innerText = "–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ ‚Äî 5 —Å–∏–º–≤–æ–ª–æ–≤.";
                statusEl.style.color = "#ff595a"; // –ö—Ä–∞—Å–Ω—ã–π
                statusEl.style.display = "block";
                setValid(false);
                return;
            }

            // 3. –í–ê–ñ–ù–û: –ï—Å–ª–∏ —é–∑–µ—Ä–Ω–µ–π–º —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º ‚Äî –æ–Ω —Å–≤–æ–±–æ–¥–µ–Ω!
            // (–≠—Ç–æ–≥–æ –Ω–µ—Ç –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –Ω–æ —ç—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–¥–µ—Å—å)
            if (val === originalUsername) {
                statusEl.style.display = "none";
                setValid(true);
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ü—Ä–æ–≤–µ—Ä–∫–∞..."
            statusEl.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";
            statusEl.style.color = "#888";
            statusEl.style.display = "block";
            setValid(false); // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∫–∞ –∏–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∞

            // 4. –ó–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ (Debounce 500–º—Å ‚Äî –∫–∞–∫ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
            usernameCheckTimeout = setTimeout(() => {
                db.collection('users').where('username', '==', val).get().then(snap => {
                    if (snap.empty) {
                        // –°–≤–æ–±–æ–¥–Ω–æ
                        statusEl.innerText = "–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–≤–æ–±–æ–¥–Ω–æ.";
                        statusEl.style.color = "#4caf50"; // –ó–µ–ª–µ–Ω—ã–π
                        setValid(true);
                    } else {
                        // –ó–∞–Ω—è—Ç–æ
                        statusEl.innerText = "–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ.";
                        statusEl.style.color = "#ff595a"; // –ö—Ä–∞—Å–Ω—ã–π
                        setValid(false);
                    }
                });
            }, 500);
        }


        // 1. –£–º–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π (–°–µ–≥–æ–¥–Ω—è, –í—á–µ—Ä–∞, 15 —Ñ–µ–≤—Ä–∞–ª—è)
        function getChatSeparatorDate(ts) {
            if (!ts) return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
            const msgDate = new Date(ts);
            const now = new Date();

            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const target = new Date(msgDate.getFullYear(), msgDate.getMonth(), msgDate.getDate()).getTime();
            const diffDays = Math.floor((today - target) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return "–°–µ–≥–æ–¥–Ω—è";
            if (diffDays === 1) return "–í—á–µ—Ä–∞";

            const months = ["—è–Ω–≤–∞—Ä—è", "—Ñ–µ–≤—Ä–∞–ª—è", "–º–∞—Ä—Ç–∞", "–∞–ø—Ä–µ–ª—è", "–º–∞—è", "–∏—é–Ω—è", "–∏—é–ª—è", "–∞–≤–≥—É—Å—Ç–∞", "—Å–µ–Ω—Ç—è–±—Ä—è", "–æ–∫—Ç—è–±—Ä—è", "–Ω–æ—è–±—Ä—è", "–¥–µ–∫–∞–±—Ä—è"];
            let res = `${msgDate.getDate()} ${months[msgDate.getMonth()]}`;

            if (msgDate.getFullYear() !== now.getFullYear()) res += ` ${msgDate.getFullYear()} –≥.`;
            return res;
        }

        let lastClickedDateStr = null;
        let dateClickTimeout = null;

        function handleDateClick(dateStr) {
            // –ï—Å–ª–∏ –º—ã —É–∂–µ –Ω–∞–∂–∏–º–∞–ª–∏ –Ω–∞ –≠–¢–£ –ñ–ï –¥–∞—Ç—É —Ç–æ–ª—å–∫–æ —á—Ç–æ -> –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            if (lastClickedDateStr === dateStr) {
                const picker = document.getElementById('chatDatePicker');
                if (picker) {
                    try { picker.showPicker(); } catch (e) { picker.click(); }
                }
                lastClickedDateStr = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º
            } else {
                // –ü–µ—Ä–≤—ã–π –∫–ª–∏–∫ -> –ò—â–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —ç—Ç–æ–≥–æ –¥–Ω—è
                const msgs = document.querySelectorAll('.msg');
                let target = null;
                for (let i = 0; i < msgs.length; i++) {
                    if (msgs[i].getAttribute('data-datestr') === dateStr) {
                        target = msgs[i];
                        break;
                    }
                }

                if (target) {
                    // –ü—Ä—ã–≥–∞–µ–º –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
                    const scrollTarget = target.previousElementSibling && target.previousElementSibling.classList.contains('chat-date-separator')
                        ? target.previousElementSibling
                        : target;

                    scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ (–∫–∞–∫ –≤ –¢–ì)
                    const oldBg = target.style.background;
                    target.style.transition = 'background 0.5s';
                    target.style.background = 'rgba(115, 106, 240, 0.4)';
                    setTimeout(() => target.style.background = oldBg, 1000);

                    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –º—ã —Å—é–¥–∞ —É–∂–µ –ø—Ä—ã–≥–Ω—É–ª–∏
                    lastClickedDateStr = dateStr;
                    // –ï—Å–ª–∏ —é–∑–µ—Ä –Ω–µ –∫–ª–∏–∫–Ω—É–ª –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –≤ —Ç–µ—á–µ–Ω–∏–µ 3 —Å–µ–∫, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
                    if (dateClickTimeout) clearTimeout(dateClickTimeout);
                    dateClickTimeout = setTimeout(() => { lastClickedDateStr = null; }, 3000);
                }
            }
        }

        function handleCalendarChange(e) {
            const selectedDate = e.target.value; // —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD
            if (!selectedDate) return;

            const msgs = Array.from(document.querySelectorAll('.msg'));
            let targetMsg = null;

            // –ò—â–µ–º –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –¥–∞—Ç–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ >= –≤—ã–±—Ä–∞–Ω–Ω–æ–π
            for (let i = 0; i < msgs.length; i++) {
                const msgDate = msgs[i].getAttribute('data-rawdate');
                if (msgDate && msgDate >= selectedDate) {
                    targetMsg = msgs[i];
                    break;
                }
            }

            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ (–≤—ã–±—Ä–∞–ª–∏ –±—É–¥—É—â–µ–µ), –±–µ—Ä–µ–º —Å–∞–º–æ–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
            if (!targetMsg && msgs.length > 0) {
                targetMsg = msgs[msgs.length - 1];
            }

            if (targetMsg) {
                // –ü—Ä—ã–≥–∞–µ–º –∫ —Å–æ–æ–±—â–µ–Ω–∏—é (–≤ —Å–∞–º—ã–π –≤–µ—Ä—Ö)
                targetMsg.scrollIntoView({ behavior: 'smooth', block: 'start' });
                const oldBg = targetMsg.style.background;
                targetMsg.style.transition = 'background 0.5s';
                targetMsg.style.background = 'rgba(115, 106, 240, 0.4)';
                setTimeout(() => targetMsg.style.background = oldBg, 1000);
            } else {
                showToast("–í —á–∞—Ç–µ –µ—â–µ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π");
            }
        }

        // 2. –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Ä–∞—Å—Å—Ç–∞–≤–ª—è–µ—Ç –ø–ª–∞—à–∫–∏-—Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        function updateDateSeparators() {
            const list = currentMsgList;
            const oldSeparators = list.querySelectorAll('.chat-date-separator');
            oldSeparators.forEach(el => el.remove());

            const msgs = list.querySelectorAll('.msg');
            let lastDateStr = null;

            msgs.forEach(msg => {
                const dateStr = msg.getAttribute('data-datestr');
                if (!dateStr) return;

                if (dateStr !== lastDateStr) {
                    const sep = document.createElement('div');
                    sep.className = 'chat-date-separator';
                    sep.innerText = dateStr;
                    // –í–ï–®–ê–ï–ú –ö–õ–ò–ö –ù–ê –†–ê–ó–î–ï–õ–ò–¢–ï–õ–¨:
                    sep.onclick = () => handleDateClick(dateStr);
                    list.insertBefore(sep, msg);
                    lastDateStr = dateStr;
                }
            });
        }

        
        // 3. –õ–æ–≥–∏–∫–∞ –ø–ª–∞–≤–∞—é—â–µ–π –¥–∞—Ç—ã (–°–∫—Ä–æ–ª–ª —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ handleChatScroll)
        document.addEventListener('DOMContentLoaded', () => {
            const floatingDate = document.getElementById('floatingDate');
            const chatDatePicker = document.getElementById('chatDatePicker');

            if (floatingDate) {
                floatingDate.onclick = () => handleDateClick(floatingDate.innerText);
            }

            if (chatDatePicker) {
                chatDatePicker.addEventListener('change', handleCalendarChange);
            }
        });

        function pad2(n) { return String(n).padStart(2, '0'); }
        function daysInMonth(y, m1to12) { return new Date(y, m1to12, 0).getDate(); }

        function setSelectValue(sel, val) {
            sel.value = String(val);
        }

        function fillSelect(sel, from, to, fmt = v => v) {
            sel.innerHTML = '';
            for (let v = from; v <= to; v++) {
                const opt = document.createElement('option');
                opt.value = String(v);
                opt.textContent = fmt(v);
                sel.appendChild(opt);
            }
        }

        function syncBirthdateView() {
            const hidden = document.getElementById('editBirthdate');
            const view = document.getElementById('editBirthdateView');
            if (!hidden || !view) return;

            if (!hidden.value) {
                view.value = '';
                return;
            }
            const [y, m, d] = hidden.value.split('-');
            view.value = `${pad2(d)}.${pad2(m)}.${y}`;
        }

        function openBirthModal() {
            const modal = document.getElementById('birthModal');
            const hidden = document.getElementById('editBirthdate');

            const daySel = document.getElementById('bdDay');
            const monthSel = document.getElementById('bdMonth');
            const yearSel = document.getElementById('bdYear');

            const now = new Date();
            let y = now.getFullYear(), m = now.getMonth() + 1, d = now.getDate();

            if (hidden && hidden.value) {
                const parts = hidden.value.split('-');
                if (parts.length === 3) {
                    y = parseInt(parts[0], 10);
                    m = parseInt(parts[1], 10);
                    d = parseInt(parts[2], 10);
                }
            }

            const minYear = 1900;
            const maxYear = 2011;

            if (y > maxYear) y = maxYear;

            fillSelect(yearSel, minYear, maxYear);
            fillSelect(monthSel, 1, 12, v => pad2(v));

            setSelectValue(yearSel, y);
            setSelectValue(monthSel, m);

            function refreshDays() {
                const yy = parseInt(yearSel.value, 10);
                const mm = parseInt(monthSel.value, 10);
                const maxD = daysInMonth(yy, mm);
                const curD = Math.min(parseInt(daySel.value || d, 10), maxD);

                fillSelect(daySel, 1, maxD, v => pad2(v));
                setSelectValue(daySel, curD);
            }

            yearSel.onchange = refreshDays;
            monthSel.onchange = refreshDays;

            refreshDays();
            modal.style.display = 'flex';
        }

        function closeBirthModal() {
            const modal = document.getElementById('birthModal');
            if (modal) modal.style.display = 'none';
        }

        function applyBirthdate() {
            const daySel = document.getElementById('bdDay');
            const monthSel = document.getElementById('bdMonth');
            const yearSel = document.getElementById('bdYear');

            const y = yearSel.value;
            const m = pad2(monthSel.value);
            const d = pad2(daySel.value);

            document.getElementById('editBirthdate').value = `${y}-${m}-${d}`;
            syncBirthdateView();
            closeBirthModal();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const view = document.getElementById('editBirthdateView');
            if (view) {
                view.addEventListener('click', openBirthModal);
            }
            syncBirthdateView();
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è
        function viewProfileAvatar() {
            const img = document.getElementById('profileAvatarPreview');
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
            if (img && img.style.display !== 'none' && img.src) {
                openImageViewer(img.src);
            }
        }

        function openGeneralSettings() {
            // --- –ù–û–í–û–ï ---
            sheetHistoryStack++;
            history.pushState({ isSheet: true }, "", window.location.href);

            const sheet = document.getElementById('generalSettingsSheet');
            sheet.style.display = 'flex';
            setTimeout(() => {
                sheet.classList.add('open');
            }, 10);
        }

        function closeGeneralSettings(fromPopState = false) {
            if (fromPopState !== true && typeof sheetHistoryStack !== 'undefined' && sheetHistoryStack > 0) {
                history.back();
                return;
            }

            const sheet = document.getElementById('generalSettingsSheet');
            sheet.classList.remove('open');
        }



        fetch(KEY_PROVIDER_URL, { method: 'GET', mode: 'no-cors' }).catch(() => { });
        // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ ---
        window.addEventListener('click', function (e) {
            const menu = document.getElementById('contextMenu');
            // –ï—Å–ª–∏ –º–µ–Ω—é –æ—Ç–∫—Ä—ã—Ç–æ (display: flex) –ò –∫–ª–∏–∫ –±—ã–ª –ù–ï –≤–Ω—É—Ç—Ä–∏ –º–µ–Ω—é
            if (menu && menu.style.display === 'flex' && !menu.contains(e.target)) {
                menu.classList.remove('active');
                menu.style.display = 'none';
            }
        });

        // --- –õ–û–ì–ò–ö–ê –ü–†–û–ß–¢–ï–ù–ò–Ø –ü–†–ò –í–û–ó–í–†–ê–©–ï–ù–ò–ò –ù–ê –í–ö–õ–ê–î–ö–£ ---

        function markCurrentChatRead() {
            // –ï—Å–ª–∏ —á–∞—Ç –Ω–µ –æ—Ç–∫—Ä—ã—Ç –∏–ª–∏ –æ–∫–Ω–æ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ - –≤—ã—Ö–æ–¥–∏–º
            if (!currentChatId || !currentUser) return;
            if (!document.hasFocus() || document.visibilityState !== 'visible') return;

            // –ò—â–µ–º –≤—Å–µ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ, –∞–¥—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–µ –º–Ω–µ
            db.collection('chats').doc(currentChatId).collection('msgs')
                .where('to', '==', currentUser.uid)
                .where('read', '==', false)
                .get()
                .then(snap => {
                    if (snap.empty) return;

                    const batch = db.batch();
                    snap.docs.forEach(doc => {
                        batch.update(doc.ref, { read: true });
                    });

                    batch.commit().then(() => {
                        console.log('–°–æ–æ–±—â–µ–Ω–∏—è –ø–æ–º–µ—á–µ–Ω—ã –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏');
                    });
                })
                .catch(err => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º:", err));
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ñ–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –æ–∫–Ω–µ
        window.addEventListener('focus', markCurrentChatRead);

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É, –∫–æ–≥–¥–∞ –≤–∫–ª–∞–¥–∫–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –≤–∏–¥–∏–º–æ–π
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                markCurrentChatRead();
            }
        });

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±—É—é —á–∞—Å—Ç—å –æ–∫–Ω–∞ (–Ω–∞ —Å–ª—É—á–∞–π –≥–ª—é–∫–æ–≤ —Ñ–æ–∫—É—Å–∞)
        window.addEventListener('click', () => {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –Ω–µ —Å–ø–∞–º–∏—Ç—å –∑–∞–ø—Ä–æ—Å–∞–º–∏
            if (currentChatId) markCurrentChatRead();
        });

        function handleTyping() {
            if (!currentChatId || !currentUser) return;

            const now = Date.now();

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞—é" —Ä–∞–∑ –≤ 2 —Å–µ–∫—É–Ω–¥—ã
            if (!isTyping || (now - lastTypingTime > 2000)) {
                isTyping = true;
                lastTypingTime = now;

                console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é —Å—Ç–∞—Ç—É—Å: –ø–µ—á–∞—Ç–∞—é..."); // <-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏

                db.collection('chats').doc(currentChatId).collection('typing').doc(currentUser.uid).set({
                    isTyping: true,
                    ts: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(err => console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:", err));
            }

            // –°–±—Ä–æ—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã —Ç–∏—à–∏–Ω—ã
            if (typingTimeout) clearTimeout(typingTimeout);

            typingTimeout = setTimeout(() => {
                isTyping = false;
                console.log("üì§ –°—Ç–∞—Ç—É—Å —Å–±—Ä–æ—à–µ–Ω (–Ω–µ –ø–µ—á–∞—Ç–∞—é)"); // <-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏

                db.collection('chats').doc(currentChatId).collection('typing').doc(currentUser.uid).set({
                    isTyping: false
                });
            }, 3000);
        }




        // --- –õ–û–ì–ò–ö–ê –ü–ï–†–ï–í–û–î–ê ---

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ø–∞–º—è—Ç–∏
        let isAutoTranslate = localStorage.getItem('isAutoTranslate') === 'true';
        let targetLang = localStorage.getItem('targetLang') || 'ru';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        function initSettingsUI() {
            const toggle = document.getElementById('autoTranslateToggle');
            if (toggle) toggle.checked = isAutoTranslate;

            // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É —è–∑—ã–∫–∞ —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏–∑ localStorage
            const label = document.getElementById('currentLangLabel');
            if (label) {
                label.innerText = `–ö–æ–¥ —è–∑—ã–∫–∞: ${targetLang}`;
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç—É–º–±–ª–µ—Ä–∞
        function toggleAutoTranslate(el) {
            isAutoTranslate = el.checked;
            localStorage.setItem('isAutoTranslate', isAutoTranslate);
            showToast(isAutoTranslate ? "–ê–≤—Ç–æ–ø–µ—Ä–µ–≤–æ–¥ –≤–∫–ª—é—á–µ–Ω" : "–ê–≤—Ç–æ–ø–µ—Ä–µ–≤–æ–¥ –≤—ã–∫–ª—é—á–µ–Ω");
        }

        // –°–º–µ–Ω–∞ —è–∑—ã–∫–∞ (–ø—Ä–æ—Å—Ç–æ–π prompt)
        // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –Ø–ó–´–ö–ê ---

        // 1. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ –≤–º–µ—Å—Ç–æ prompt
        function changeTranslateLang() {
            const modal = document.getElementById('langModal');
            if (modal) {
                modal.style.display = 'flex';
            } else {
                console.error("Modale window #langModal not found!");
            }
        }

        // 2. –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –æ–∫–Ω–æ
        function closeLangModal() {
            document.getElementById('langModal').style.display = 'none';
        }

        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±–æ—Ä
        // 3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—ã–±–æ—Ä
        function selectLanguage(code) {
            const langs = {
                'ar': 'Egyptian', // –î–æ–±–∞–≤–ª–µ–Ω–æ
                'ru': '–†—É—Å—Å–∫–∏–π',
                'en': 'English',
                'de': 'Deutsch',
                'fr': 'Fran√ßais',
                'es': 'Espa√±ol',
                'it': 'Italiano',
                'tr': 'T√ºrk√ße',
                'uk': '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞'
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å –∏ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            targetLang = code;
            localStorage.setItem('targetLang', targetLang);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
            updateLangLabel();

            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showToast(`–Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${langs[code] || code}`);

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
            closeLangModal();
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
        function updateLangLabel() {
            const el = document.getElementById('currentLangLabel');
            if (el) {
                const langNames = {
                    'ar': 'Egyptian', // –î–æ–±–∞–≤–ª–µ–Ω–æ
                    'ru': '–†—É—Å—Å–∫–∏–π',
                    'en': 'English',
                    'de': 'Deutsch',
                    'es': 'Espa√±ol',
                    'fr': 'Fran√ßais',
                    'it': 'Italiano',
                    'tr': 'T√ºrk√ße',
                    'uk': '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞'
                };
                const name = langNames[targetLang] || targetLang.toUpperCase();
                el.innerText = `${name} (${targetLang})`;
            }
        }

        // ==========================================
        // –õ–û–ì–ò–ö–ê –ü–û–ò–°–ö–ê –ü–û –ß–ê–¢–£ (–¢–ï–õ–ï–ì–†–ê–ú –°–¢–ò–õ–¨)
        // ==========================================
        let chatSearchMatches = [];
        let chatSearchCurrentIndex = -1;
        let chatSearchDebounce;

        function toggleChatSearch() {
            const bar = document.getElementById('chatSearchBar');
            const dropdown = document.getElementById('chatSearchDropdown');
            const inp = document.getElementById('chatSearchInput');

            if (bar.classList.contains('hidden')) {
                bar.classList.remove('hidden');
                inp.focus();
            } else {
                bar.classList.add('hidden');
                dropdown.classList.add('hidden');
                inp.value = '';
                clearChatSearch();
            }
        }

        function handleChatSearchInput(query) {
            clearTimeout(chatSearchDebounce);
            chatSearchDebounce = setTimeout(() => {
                performChatSearch(query);
            }, 300); // –ò—â–µ–º —á–µ—Ä–µ–∑ 0.3 —Å–µ–∫ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–≤–æ–¥–∞
        }

        function clearChatSearch() {
            chatSearchMatches = [];
            chatSearchCurrentIndex = -1;
            document.getElementById('chatSearchCount').innerText = "";
            document.getElementById('chatSearchDropdown').innerHTML = "";
        }

        function performChatSearch(query) {
            clearChatSearch();
            const dropdown = document.getElementById('chatSearchDropdown');
            if (!query.trim()) { dropdown.classList.add('hidden'); return; }

            const lowerQuery = query.toLowerCase();
            const msgs = currentMsgList.querySelectorAll('.msg');

            // –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const myData = JSON.parse(localStorage.getItem('user_profile_cache') || '{}');
            const myAvatar = myData.avatar || '';
            const friendData = usersCache[currentFriendId] || {};
            const friendFullName = `${friendData.name || 'User'} ${friendData.surname || ''}`.trim();
            const friendAvatar = friendData.avatar || '';

            msgs.forEach(msgBlock => {
                const textSpan = msgBlock.querySelector('.msg-text');
                if (!textSpan) return;

                const text = textSpan.innerText;
                if (text.toLowerCase().includes(lowerQuery)) {
                    const isMine = msgBlock.classList.contains('msg-me');

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ Firebase –∏–ª–∏ DOM
                    // –í —á–∞—Ç–µ –º—ã —Ö—Ä–∞–Ω–∏–º –≤—Ä–µ–º—è –≤ –±–ª–æ–∫–µ .msg-time
                    const timeEl = msgBlock.querySelector('.msg-time');

                    chatSearchMatches.push({
                        id: msgBlock.id,
                        text: text,
                        isMine: isMine,
                        name: isMine ? "–í—ã" : friendFullName, // <--- –ó–î–ï–°–¨ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û "–í–´"
                        avatar: isMine ? myAvatar : friendAvatar,
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–¥–ª—è –ø–æ–∏—Å–∫–∞ –±–µ—Ä–µ–º –¥–∞—Ç—É —Å–æ–æ–±—â–µ–Ω–∏—è)
                        time: timeEl ? timeEl.innerText : '',
                        element: msgBlock
                    });
                }
            });

            dropdown.innerHTML = '';
            if (chatSearchMatches.length === 0) {
                dropdown.innerHTML = '<div style="padding:20px; text-align:center; color:#888; font-size:14px;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            } else {
                chatSearchMatches.forEach((res, index) => {
                    const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const regex = new RegExp(`(${escapedQuery})`, 'gi');
                    const highlightedText = res.text.replace(regex, '<span class="highlight active-match">$1</span>');

                    // –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–æ–∫ (—Ñ–æ—Ç–æ –∏–ª–∏ —Ü–≤–µ—Ç–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞)
                    let avatarHtml;
                    if (res.avatar) {
                        avatarHtml = `<img src="${res.avatar}" class="search-msg-avatar" style="object-fit:cover;">`;
                    } else {
                        const firstLetter = res.name.charAt(0).toUpperCase();
                        avatarHtml = `<div class="search-msg-avatar" style="background: linear-gradient(135deg, #6a11cb, #2575fc); color: white; font-weight: bold;">${firstLetter}</div>`;
                    }

                    const div = document.createElement('div');
                    div.className = 'search-msg-item';
                    div.id = 'search-item-' + index;
                    div.innerHTML = `
                        ${avatarHtml}
                        <div class="search-msg-content">
                            <div class="search-msg-header">
                                <span class="search-msg-name">${res.name}</span>
                                <span class="search-msg-time">${res.time}</span>
                            </div>
                            <div class="search-msg-text">${highlightedText}</div>
                        </div>
                    `;

                    div.onclick = () => {
                        chatSearchCurrentIndex = index;
                        jumpToMessageAndCloseDropdown();
                    };

                    dropdown.appendChild(div);
                });
            }

            dropdown.classList.remove('hidden');

            if (chatSearchMatches.length > 0) {
                chatSearchCurrentIndex = chatSearchMatches.length - 1;
                updateSearchUI();
            }
        }

        function navigateChatSearch(direction) {
            if (chatSearchMatches.length === 0) return;

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏
            chatSearchCurrentIndex += direction;

            // –ó–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ
            if (chatSearchCurrentIndex < 0) chatSearchCurrentIndex = chatSearchMatches.length - 1;
            if (chatSearchCurrentIndex >= chatSearchMatches.length) chatSearchCurrentIndex = 0;

            updateSearchUI();

            // –°–∫—Ä–æ–ª–ª–∏–º —Å–∞–º–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ
            const targetMsg = chatSearchMatches[chatSearchCurrentIndex].element;
            targetMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
            glowMessage(targetMsg);
        }

        function updateSearchUI() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—á–µ—Ç—á–∏–∫–∞ (–≤ –¢–ì –∏–¥–µ—Ç –æ–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç: 1 –∏–∑ 10 - —ç—Ç–æ —Å–∞–º–æ–µ —Å–≤–µ–∂–µ–µ)
            const displayIndex = chatSearchMatches.length - chatSearchCurrentIndex;
            document.getElementById('chatSearchCount').innerText = `${displayIndex} –∏–∑ ${chatSearchMatches.length}`;

            // –í—ã–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ
            document.querySelectorAll('.search-msg-item').forEach(el => el.classList.remove('active'));
            const activeItem = document.getElementById('search-item-' + chatSearchCurrentIndex);
            if (activeItem) {
                activeItem.classList.add('active');
                activeItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function jumpToMessageAndCloseDropdown() {
            const targetMsg = chatSearchMatches[chatSearchCurrentIndex].element;

            // –°–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —à–∞–ø–∫—É –æ—Ç–∫—Ä—ã—Ç–æ–π
            document.getElementById('chatSearchDropdown').classList.add('hidden');

            // –°–∫—Ä–æ–ª–ª–∏–º –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
            targetMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
            updateSearchUI(); // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫

            glowMessage(targetMsg);
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å–ø—ã—à–∫–∏ (–ø–æ–¥—Å–≤–µ—Ç–∫–∏) —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ –Ω–µ–º—É
        function glowMessage(element) {
            element.style.transition = 'background 0.5s ease';
            const originalBg = element.style.background || element.style.backgroundColor;
            // –î–µ–ª–∞–µ–º –≤—Å–ø—ã—à–∫—É —Å–∏–Ω–µ–π, –∫–∞–∫ –≤ –¢–ì, –∏–ª–∏ —Å–µ—Ä–æ–π
            element.style.backgroundColor = 'rgba(115, 106, 240, 0.4)';
            setTimeout(() => {
                element.style.backgroundColor = originalBg;
            }, 1000);
        }

        function updateLangLabel() {
            const el = document.getElementById('currentLangLabel');
            if (el) {
                const langNames = { 'ru': '–†—É—Å—Å–∫–∏–π', 'en': 'English', 'de': 'Deutsch', 'es': 'Espa√±ol' };
                const name = langNames[targetLang] || targetLang.toUpperCase();
                el.innerText = `${name} (${targetLang})`;
            }
        }



        // –í—ã–∑–æ–≤ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–¥–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –≤—ã–∑–æ–≤ –≤ openGeneralSettings)
        const originalOpenSettings = openGeneralSettings;
        openGeneralSettings = function () {
            originalOpenSettings();
            initSettingsUI();
        };

        // --- API –ü–ï–†–ï–í–û–î–ê ---
        // --- API –ü–ï–†–ï–í–û–î–ê ---
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø GOOGLE SCRIPTS ---


        // --- –õ–û–ì–ò–ö–ê –ü–ï–†–ï–í–û–î–ê –ß–ï–†–ï–ó GOOGLE SCRIPT ---

        async function fetchTranslation(text, toLang) {
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Ç–≤–æ–π –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
                const response = await fetch(TRANSLATE_SCRIPT_URL, {
                    method: "POST",
                    mode: "cors", // Google Script –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç cors –ø—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
                    body: JSON.stringify({
                        action: "translate",
                        text: text,
                        toLang: toLang
                    })
                });

                const data = await response.json();

                if (data.status === "success" && data.translatedText) {
                    const result = data.translatedText;

                    // –ï—Å–ª–∏ Google –≤–µ—Ä–Ω—É–ª —Ç–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç (—è–∑—ã–∫–∏ —Å–æ–≤–ø–∞–ª–∏), –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ –ø–µ—Ä–µ–≤–æ–¥–∞
                    if (result.trim().toLowerCase() === text.trim().toLowerCase()) {
                        return null;
                    }

                    return result;
                } else {
                    console.error("–û—à–∏–±–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:", data.message);
                    return null;
                }
            } catch (e) {
                console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:", e);
                return null;
            }
        }

        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞—É–¥–∏–æ-–≤—ã—Ö–æ–¥–∞
        async function setAudioOutput(toEarpiece) {
            console.log("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∑–≤—É–∫–∞. –í —É—Ö–æ:", toEarpiece);

            // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞: –ú—ã –≤ MAUI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏?
            if (window.DotNet) {
                // –ï—Å–ª–∏ —Ç—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª Bridge, –≤—ã–∑—ã–≤–∞–µ–º C# –º–µ—Ç–æ–¥
                // –ï—Å–ª–∏ –Ω–µ—Ç, Android —Å–∞–º —á–∞—Å—Ç–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤ Mode_In_Communication –ø—Ä–∏ WebRTC
                console.log("–ü–æ–ø—ã—Ç–∫–∞ –≤—ã–∑–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å MAUI");
            }

            // 2. –õ–æ–≥–∏–∫–∞ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ (–∏ WebView)
            const remoteVid = document.getElementById('remoteVideo');
            if (remoteVid && remoteVid.setSinkId) {
                // –í —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö –º–æ–∂–Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ,
                // –Ω–æ –Ω–∞ –º–æ–±–∏–ª–∫–∞—Ö —ç—Ç–æ —á–∞—â–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–æ–π.
            }

            showToast(toEarpiece ? "–ó–≤—É–∫: –î–∏–Ω–∞–º–∏–∫ —É—Ö–∞" : "–ó–≤—É–∫: –ì—Ä–æ–º–∫–∞—è —Å–≤—è–∑—å");
        }

        let isEarpiece = false;

        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–µ–¥—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∑–≤–æ–Ω–∫–∞
        function updateSpeakerButtonVisibility() {
            // –í MAUI Blazor Hybrid –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω –æ–±—ä–µ–∫—Ç window.chrome.webview –∏–ª–∏ DotNet
            const isApp = window.chrome && window.chrome.webview;
            const speakerBtn = document.getElementById('speakerControl');
            if (isApp && speakerBtn) {
                speakerBtn.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
            }
        }

        // 2. –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
        function toggleSpeaker() {
            isEarpiece = !isEarpiece;
            const btn = document.getElementById('btnSpeaker');
            const lbl = document.getElementById('lblSpeaker');

            if (isEarpiece) {
                btn.innerHTML = 'üëÇ';
                lbl.innerText = '–ì—Ä–æ–º–∫–∞—è';
                btn.classList.add('btn-active-white');
            } else {
                btn.innerHTML = 'üîà';
                lbl.innerText = '–í —É—Ö–æ';
                btn.classList.remove('btn-active-white');
            }

            // –í–´–ó–û–í C# –ö–û–î–ê (MAUI)
            if (window.chrome && window.chrome.webview) {
                // –ü–µ—Ä–µ–¥–∞–µ–º –∫–æ–º–∞–Ω–¥—É –≤ MainActivity.cs
                window.chrome.webview.postMessage(JSON.stringify({
                    action: "setAudioMode",
                    earpiece: isEarpiece
                }));
            }
        }

        // 3. –í—ã–∑–æ–≤–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –∫–Ω–æ–ø–æ–∫ –≤ –º–æ–º–µ–Ω—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è —ç–∫—Ä–∞–Ω–∞ –∑–≤–æ–Ω–∫–∞
        // –î–æ–±–∞–≤—å —ç—Ç–æ –≤–Ω—É—Ç—Ä—å —Ñ—É–Ω–∫—Ü–∏–∏ startCall() –∏ answerCall()
        // updateSpeakerButtonVisibility();


        // ... (—Ç–≤–æ–π –∫–æ–¥ updateCallControlsVisibility –∏ OneSignal) ...

        // --- –ú–ì–ù–û–í–ï–ù–ù–´–ô –ó–ê–ü–£–°–ö ---
        // –ï—Å–ª–∏ –º—ã –ø–æ–º–Ω–∏–º, —á—Ç–æ —é–∑–µ—Ä –±—ã–ª –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—Ä–∞–∑—É
        // --- –ú–ì–ù–û–í–ï–ù–ù–´–ô –ó–ê–ü–£–°–ö ---
        if (localStorage.getItem('isLoggedIn') === 'true' && localStorage.getItem('current_user_uid')) {
            console.log("üöÄ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç –∏–∑ –∫—ç—à–∞");

            document.getElementById('authScreen').classList.add('hidden');
            loadProfileFromCache();

            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–∞–µ–º —Å–∫—Ä–∏–ø—Ç—É ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –î–û –æ—Ç–≤–µ—Ç–∞ –æ—Ç Firebase ---
            if (!currentUser) {
                currentUser = {
                    uid: localStorage.getItem('current_user_uid')
                };
            }

            // –¢–µ–ø–µ—Ä—å loadData() –Ω–µ —É–ø–∞–¥–µ—Ç —Å –æ—à–∏–±–∫–æ–π –∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞—á–Ω—É—Ç –≥—Ä—É–∑–∏—Ç—å—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
            loadData();
        }

        // –ê–≤—Ç–æ-—É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –ø–æ–ª—è –≤–≤–æ–¥–∞
        function autoResize(textarea) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç—Ä–æ–≥–æ –¥–æ 1 —Å—Ç—Ä–æ–∫–∏, –∞ –Ω–µ –¥–æ 'auto', —á—Ç–æ–±—ã WebView –Ω–µ —Ç—É–ø–∏–ª
            textarea.style.height = '40px';

            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –±–æ–ª—å—à–µ, —á–µ–º –Ω–∞ 1 —Å—Ç—Ä–æ–∫—É, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É (–¥–æ 100px)
            const newHeight = Math.min(textarea.scrollHeight, 100);
            textarea.style.height = newHeight + 'px';
        }

        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –ú–∏–∫—Ä–æ—Ñ–æ–Ω / –°–∞–º–æ–ª–µ—Ç–∏–∫
        function checkInputState() {
            const val = document.getElementById('msgInput').value.trim();
            const voiceBtn = document.getElementById('voiceBtn');
            const sendBtn = document.getElementById('sendBtn');

            if (val.length > 0) {
                voiceBtn.classList.add('hidden');
                sendBtn.classList.remove('hidden');
            } else {
                voiceBtn.classList.remove('hidden');
                sendBtn.classList.add('hidden');
            }
        }

        // –£–º–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã (–∫–∞–∫ –≤ Telegram)
        function formatTelegramDate(date) {
            if (!date) return "";
            const now = new Date();
            const msgDate = new Date(date);

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–∞—Ç
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const target = new Date(msgDate.getFullYear(), msgDate.getMonth(), msgDate.getDate()).getTime();
            const diffDays = Math.floor((today - target) / (1000 * 60 * 60 * 24));

            // –°–µ–≥–æ–¥–Ω—è -> 14:30
            if (diffDays === 0) {
                return msgDate.getHours().toString().padStart(2, '0') + ':' + msgDate.getMinutes().toString().padStart(2, '0');
            }
            // –í—á–µ—Ä–∞ -> –≤—á–µ—Ä–∞
            if (diffDays === 1) return "–≤—á–µ—Ä–∞";
            // –ü–æ–∑–∞–≤—á–µ—Ä–∞ -> –ø–æ–∑–∞–≤—á–µ—Ä–∞
            if (diffDays === 2) return "–ø–æ–∑–∞–≤—á–µ—Ä–∞";
            // –í –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–µ–¥–µ–ª–∏ -> –ü–ù, –í–¢...
            if (diffDays < 7) {
                const weekDays = ["–í–°", "–ü–ù", "–í–¢", "–°–†", "–ß–¢", "–ü–¢", "–°–ë"];
                return weekDays[msgDate.getDay()];
            }
            // –í —ç—Ç–æ–º –≥–æ–¥—É -> 11.02
            if (msgDate.getFullYear() === now.getFullYear()) {
                return msgDate.getDate().toString().padStart(2, '0') + '.' + (msgDate.getMonth() + 1).toString().padStart(2, '0');
            }
            // –ü—Ä–æ—à–ª—ã–µ –≥–æ–¥–∞ -> 11.12.25
            return msgDate.getDate().toString().padStart(2, '0') + '.' +
                (msgDate.getMonth() + 1).toString().padStart(2, '0') + '.' +
                msgDate.getFullYear().toString().slice(-2);
        }


        let currentMsgList = null;

        function getOrCreateMsgList(chatId) {
            const container = document.getElementById('chatViewsContainer');

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ —á–∞—Ç—ã
            const allLists = container.querySelectorAll('.messages');
            allLists.forEach(el => el.style.display = 'none');

            // –ò—â–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
            let list = document.getElementById('msgList_' + chatId);
            let isNew = false;

            if (!list) {
                // –ï—Å–ª–∏ –∑–∞—à–ª–∏ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ - —Å–æ–∑–¥–∞–µ–º —Å–ª–æ–π
                list = document.createElement('div');
                list.id = 'msgList_' + chatId;
                list.className = 'messages';
                list.addEventListener('scroll', handleChatScroll); // –í–µ—à–∞–µ–º —Å–∫—Ä–æ–ª–ª

                // –°–õ–£–®–ê–¢–ï–õ–ò –î–õ–Ø –°–í–ê–ô–ü–ê
                list.addEventListener('touchstart', handleChatTouchStart, { passive: true });
                list.addEventListener('touchmove', handleChatTouchMove, { passive: false });
                list.addEventListener('touchend', handleChatTouchEnd);
                list.addEventListener('touchcancel', handleChatTouchEnd);
                if (!container.dataset.eventsAdded) {
                    container.addEventListener('contextmenu', handleDesktopSideRightClick);
                    container.addEventListener('dblclick', handleDesktopSideDoubleClick);
                    container.dataset.eventsAdded = 'true';
                }
                // --------------------------------------------------------

                container.appendChild(list);
                isNew = true;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π
            list.style.display = 'flex';
            currentMsgList = list;

            return { list, isNew };
        }

        // ==========================================
        // –õ–û–ì–ò–ö–ê –°–í–ê–ô–ü–ê –ò –î–û–õ–ì–û–ì–û –ù–ê–ñ–ê–¢–ò–Ø (iOS STYLE)
        // ==========================================
        let swipeTarget = null;
        let swipeStartX = 0;
        let swipeStartY = 0;
        let swipeCurrentX = 0;
        let isSwipeHorizontal = false;
        let isSwipeVertical = false;
        let swipeHapticTriggered = false;
        let longPressTimer = null; // –¢–∞–π–º–µ—Ä –¥–ª—è –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è

        function handleChatTouchStart(e) {
            if (window.innerWidth > 768) return;

            const touch = e.touches[0];
            swipeStartX = touch.clientX;
            swipeStartY = touch.clientY;

            const msgEl = e.target.closest('.msg');
            if (!msgEl) return;

            swipeTarget = msgEl;
            swipeCurrentX = 0;
            isSwipeHorizontal = false;
            isSwipeVertical = false;
            swipeHapticTriggered = false;

            // --- –ó–ê–ü–£–°–ö –¢–ê–ô–ú–ï–†–ê –î–û–õ–ì–û–ì–û –ù–ê–ñ–ê–¢–ò–Ø (400–º—Å) ---
            if (longPressTimer) clearTimeout(longPressTimer);
            longPressTimer = setTimeout(() => {
                // –ï—Å–ª–∏ –ø–∞–ª–µ—Ü –Ω–µ —Å–¥–≤–∏–Ω—É–ª—Å—è, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –º–µ–Ω—é
                if (!isSwipeHorizontal && !isSwipeVertical && swipeTarget) {
                    if (navigator.vibrate) navigator.vibrate(40); // –õ–µ–≥–∫–∞—è –≤–∏–±—Ä–∞—Ü–∏—è –∫–∞–∫ –Ω–∞ iPhone

                    const msgId = swipeTarget.id.replace('msg-', '');
                    const isMine = swipeTarget.classList.contains('msg-me');

                    openContextMenu(null, msgId, isMine, true);
                    swipeTarget = null; // –û—Ç–º–µ–Ω—è–µ–º —Å–≤–∞–π–ø
                }
            }, 400);

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –æ—Ç–≤–µ—Ç–∞ —Å–∑–∞–¥–∏, –µ—Å–ª–∏ –µ—ë –µ—â–µ –Ω–µ—Ç (–¥–ª—è —Å–≤–∞–π–ø–∞)
            let icon = swipeTarget.querySelector('.swipe-reply-icon');
            if (!icon) {
                icon = document.createElement('div');
                icon.className = 'swipe-reply-icon';
                icon.innerHTML = '‚Ü©Ô∏è';
                swipeTarget.appendChild(icon);
            }
        }

        function handleChatTouchMove(e) {
            if (!swipeTarget) return;
            const touch = e.touches[0];
            const deltaX = touch.clientX - swipeStartX;
            const deltaY = touch.clientY - swipeStartY;

            // –ï—Å–ª–∏ –ø–∞–ª–µ—Ü —Å–¥–≤–∏–Ω—É–ª—Å—è (—Å–∫—Ä–æ–ª–ª –∏–ª–∏ —Å–≤–∞–π–ø) - –æ—Ç–º–µ–Ω—è–µ–º –¥–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ!
            if (Math.abs(deltaX) > 8 || Math.abs(deltaY) > 8) {
                if (longPressTimer) clearTimeout(longPressTimer);
            }

            if (!isSwipeHorizontal && !isSwipeVertical) {
                if (Math.abs(deltaY) > Math.abs(deltaX)) {
                    isSwipeVertical = true;
                } else if (deltaX < -5) {
                    isSwipeHorizontal = true;
                } else {
                    swipeTarget = null;
                    return;
                }
            }

            if (isSwipeVertical) {
                swipeTarget = null;
                return;
            }

            if (isSwipeHorizontal) {
                if (e.cancelable) e.preventDefault();

                swipeCurrentX = Math.max(deltaX, -65);
                swipeTarget.classList.add('swiping');
                swipeTarget.style.transform = `translateX(${swipeCurrentX}px)`;

                const icon = swipeTarget.querySelector('.swipe-reply-icon');
                if (icon) {
                    if (swipeCurrentX <= -50) {
                        icon.classList.add('active');
                        if (!swipeHapticTriggered) {
                            if (navigator.vibrate) navigator.vibrate(30);
                            swipeHapticTriggered = true;
                        }
                    } else {
                        icon.classList.remove('active');
                        swipeHapticTriggered = false;
                    }
                }
            }
        }

        function handleChatTouchEnd(e) {
            // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–∏ –ø–∞–ª—å—Ü–∞ (—á—Ç–æ–±—ã –æ–±—ã—á–Ω—ã–π –∫–ª–∏–∫ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–ª)
            if (longPressTimer) clearTimeout(longPressTimer);

            if (!swipeTarget) return;

            const icon = swipeTarget.querySelector('.swipe-reply-icon');

            if (swipeCurrentX <= -50) {
                triggerSwipeReply(swipeTarget);
            }

            swipeTarget.classList.remove('swiping');
            swipeTarget.style.transform = '';
            if (icon) icon.classList.remove('active');

            swipeTarget = null;
            isSwipeHorizontal = false;
            isSwipeVertical = false;
        }

        function triggerSwipeReply(msgEl) {
            const msgId = msgEl.id.replace('msg-', '');
            const isMine = msgEl.classList.contains('msg-me');
            let text = "–í–ª–æ–∂–µ–Ω–∏–µ";
            const textSpan = msgEl.querySelector('.msg-text');
            if (textSpan) text = textSpan.innerText;
            else if (msgEl.querySelector('.chat-media-img')) text = "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è";
            else if (msgEl.querySelector('.chat-file-card')) text = "–§–∞–π–ª";

            const chatTitleEl = document.getElementById('chatTitle');
            let friendName = chatTitleEl ? (chatTitleEl.firstElementChild ? chatTitleEl.firstElementChild.innerText : chatTitleEl.innerText) : "–°–æ–±–µ—Å–µ–¥–Ω–∏–∫";

            const name = isMine ? "–í—ã" : friendName;
            startReplyUI(msgId, name, text);
        }

        // ==========================================
        // –õ–û–ì–ò–ö–ê –ö–õ–ò–ö–û–í –†–Ø–î–û–ú –° –°–û–û–ë–©–ï–ù–ò–ï–ú (–ü–ö)
        // ==========================================

        // –£–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –≤—ã—á–∏—Å–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–∞—Ö–æ–¥—è—â–µ–µ—Å—è –Ω–∞ —Ç–æ–π –∂–µ –≤—ã—Å–æ—Ç–µ, —á—Ç–æ –∏ –º—ã—à–∫–∞
        function getMsgByYCoordinate(y) {
            if (!currentMsgList) return null;
            // –ò—â–µ–º –≤—Å–µ –ø—É–∑—ã—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–π, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –ø–ª–∞—à–∫–∏ –¥–∞—Ç –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const msgs = currentMsgList.querySelectorAll('.msg:not(.msg-sys)');
            for (let i = 0; i < msgs.length; i++) {
                const rect = msgs[i].getBoundingClientRect();
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –º—ã—à–∫–∞ –ø–æ –≤—ã—Å–æ—Ç–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ —ç—Ç–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å –∑–∞–∑–æ—Ä–æ–º 6px)
                if (y >= rect.top - 6 && y <= rect.bottom + 6) {
                    return msgs[i];
                }
            }
            return null;
        }

        // –ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ (–í—ã–∑–æ–≤ –º–µ–Ω—é)
        function handleDesktopSideRightClick(e) {
            if (window.innerWidth <= 768) return;
            if (e.target.closest('.msg')) return;

            const msgEl = getMsgByYCoordinate(e.clientY);
            if (msgEl) {
                e.preventDefault();
                const msgId = msgEl.id.replace('msg-', '');
                const isMine = msgEl.classList.contains('msg-me');

                // --- –ù–û–í–û–ï: –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∫–ª–∏–∫–µ ---
                const menu = document.getElementById('contextMenu');
                if (menu && menu.classList.contains('active')) {
                    if (selectedMsgId === msgId) {
                        closeAllSheets(); // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ —Ç–æ–º—É –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—é - –∑–∞–∫—Ä—ã–≤–∞–µ–º
                        return;
                    }
                }

                openContextMenu(e, msgId, isMine);
            }
        }

        
        // –î–í–û–ô–ù–û–ô –ª–µ–≤—ã–π –∫–ª–∏–∫ (–ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç: —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–æ —Ñ–æ–Ω—É, –∏ –ø–æ —Å–∞–º–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é)
        function handleDesktopSideDoubleClick(e) {
            if (window.innerWidth <= 768) return;

            // –ò—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ: –ª–∏–±–æ –º—ã –∫–ª–∏–∫–Ω—É–ª–∏ –ø—Ä—è–º–æ –ø–æ –Ω–µ–º—É, –ª–∏–±–æ –ø–æ —Ñ–æ–Ω—É —Ä—è–¥–æ–º
            const msgEl = e.target.closest('.msg') || getMsgByYCoordinate(e.clientY);

            if (msgEl) {
                e.preventDefault();

                // –û—á–∏—â–∞–µ–º —Å–∏–Ω–µ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞, –∫–æ—Ç–æ—Ä–æ–µ –±—Ä–∞—É–∑–µ—Ä –¥–µ–ª–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º –∫–ª–∏–∫–µ
                if (window.getSelection) {
                    window.getSelection().removeAllRanges();
                }

                triggerSwipeReply(msgEl);
            }
        }



        let scrollDateTimeout = null;
        let scrollThrottleTimer = null; // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –µ—Å—Ç—å

        function handleChatScroll(e) {
            const list = e.target;

            // --- –ù–û–í–û–ï: –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ "–í–Ω–∏–∑" ---
            const scrollBtn = document.getElementById('scrollToBottomBtn');
            if (scrollBtn) {
                // –ï—Å–ª–∏ –º—ã –ø–æ–¥–Ω—è–ª–∏—Å—å –≤—ã—à–µ —á–µ–º –Ω–∞ 200px –æ—Ç –∫–æ–Ω—Ü–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                if (list.scrollHeight - list.scrollTop - list.clientHeight > 200) {
                    scrollBtn.classList.add('visible');
                } else {
                    scrollBtn.classList.remove('visible');
                }
            }
            // -----------------------------------

            const floatingDate = document.getElementById('floatingDate');
            if (!floatingDate) return;

            clearTimeout(scrollDateTimeout);
            scrollDateTimeout = setTimeout(() => {
                floatingDate.classList.remove('visible');
            }, 1000);

            if (scrollThrottleTimer) return;

            scrollThrottleTimer = setTimeout(() => {
                const listRect = list.getBoundingClientRect();
                const topEl = document.elementFromPoint(listRect.left + listRect.width / 2, listRect.top + 30);

                if (topEl) {
                    const target = topEl.closest('.msg, .chat-date-separator');
                    if (target) {
                        const dateStr = target.getAttribute('data-datestr') || target.innerText;
                        if (dateStr && floatingDate.innerText !== dateStr) {
                            floatingDate.innerText = dateStr;
                        }
                        floatingDate.classList.add('visible');
                    }
                }
                scrollThrottleTimer = null;
            }, 100);
        }


        function scrollToBottom() {
            if (currentMsgList) {
                // –ú—è–≥–∫–æ —Å–∫—Ä–æ–ª–ª–∏–º —Å –∑–∞–ø–∞—Å–æ–º –≤ —Å–∞–º—ã–π –Ω–∏–∑
                currentMsgList.scrollTo({
                    top: currentMsgList.scrollHeight + 1000,
                    behavior: 'smooth'
                });
            }
        }

        // --- –£–ú–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –í–í–û–î–ê (–° –†–ê–ó–î–ï–õ–ï–ù–ò–ï–ú –ü–ö / –¢–ï–õ–ï–§–û–ù) ---
        function handleChatInput(e) {
            if (e.key === 'Enter') {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∏–¥–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                if (isMobile) {
                    // –ù–ê –¢–ï–õ–ï–§–û–ù–ï: –ü—Ä–æ—Å—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ–º —Å–∏—Å—Ç–µ–º–µ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏. 
                    // –ù–∏—á–µ–≥–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ.
                    return;
                } else {
                    // –ù–ê –ü–ö:
                    if (e.shiftKey || e.ctrlKey) {
                        // –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç Shift+Enter –∏–ª–∏ Ctrl+Enter -> –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
                        return;
                    } else {
                        // –û–±—ã—á–Ω—ã–π Enter –±–µ–∑ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ -> –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
                        e.preventDefault(); // –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
                        sendMsg();

                        // –°–±—Ä–æ—Å –≤—ã—Å–æ—Ç—ã –ø–æ–ª—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                        const inp = document.getElementById('msgInput');
                        inp.style.height = '40px';
                        checkInputState();
                    }
                }
            }
        }
        // –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (–∫—Ä–æ–º–µ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞)
        document.addEventListener('copy', function (e) {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                // showToast("–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ"); 
            }
        });

        // –ó–∞–ø—Ä–µ—â–∞–µ–º –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ Ctrl+C / Cmd+C (–∫—Ä–æ–º–µ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞)
        document.addEventListener('keydown', function (e) {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C')) {
                if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                }
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, —á—Ç–æ –º—ã –≤–Ω—É—Ç—Ä–∏ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (WebView)
        document.addEventListener("DOMContentLoaded", () => {
            // window.chrome.webview - —ç—Ç–æ –¥–ª—è MAUI Blazor, 'wv' - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –º–µ—Ç–∫–∞ Android WebView
            const isApp = (window.chrome && window.chrome.webview) || navigator.userAgent.includes('wv');

            if (isApp) {
                document.body.classList.add('is-app');
                console.log("üì± –í–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (WebView –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)");
            }
        });

        // --- –°–õ–£–®–ê–¢–ï–õ–¨ –°–ò–°–¢–ï–ú–ù–û–ô –ö–ù–û–ü–ö–ò "–ù–ê–ó–ê–î" (–ò –°–í–ê–ô–ü–ê –ù–ê –¢–ï–õ–ï–§–û–ù–ï) ---
        window.addEventListener('popstate', (e) => {
            if (typeof sheetHistoryStack !== 'undefined' && sheetHistoryStack > 0) {
                sheetHistoryStack--;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∞—è —à—Ç–æ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ —Å–µ–π—á–∞—Å —Å–≤–µ—Ä—Ö—É, –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –∏–º–µ–Ω–Ω–æ –µ—ë
                if (document.getElementById('editProfileSheet')?.classList.contains('open')) {
                    closeEditProfile(true);
                } else if (document.getElementById('generalSettingsSheet')?.classList.contains('open')) {
                    closeGeneralSettings(true);
                } else if (document.getElementById('profileSheet')?.classList.contains('open')) {
                    closeAllSheets(true);
                }
            }
        });


    </script>

    <div id="birthModal" class="modal-overlay" style="display:none" onclick="closeBirthModal()">
        <div class="birth-modal" onclick="event.stopPropagation()">
            <h3 style="margin:0; font-size:18px; color:white; font-weight:600;">–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è</h3>

            <div class="birth-pickers">
                <select id="bdDay"></select>
                <select id="bdMonth"></select>
                <select id="bdYear"></select>
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeBirthModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn-confirm" style="color:#8774e1" onclick="applyBirthdate()">–ì–æ—Ç–æ–≤–æ</button>
            </div>
        </div>
    </div>


    <div id="imageViewer" class="image-viewer" onclick="closeImageViewer()">
        <span class="close-viewer-btn">&times;</span>
        <img id="imageViewerImg" src="" onclick="event.stopPropagation()">
    </div>
</body>
</html>
