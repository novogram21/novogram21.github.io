<!DOCTYPE html>
<html lang="ru">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f1f1f" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="color-scheme" content="dark">
    <meta name="theme-color" content="#1f1f1f">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>Novogram</title>
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #121212;
            color: #eee;
            margin: 0;
            display: flex;
            height: 100dvh;
            overflow: hidden;
            overscroll-behavior-y: none;
        }


        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212;
            z-index: 6000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .auth-box {
            width: 300px;
            padding: 25px;
            background: #2d2d2d;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #444;
        }

            .auth-box input {
                width: 100%;
                padding: 12px;
                margin: 8px 0;
                background: #444;
                border: 1px solid #555;
                color: white;
                border-radius: 6px;
            }

            .auth-box button {
                width: 100%;
                padding: 12px;
                background: #007bff;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                margin-top: 10px;
            }


        /* –°–∞–π–¥–±–∞—Ä */
        .sidebar {
            width: 320px;
            background: #1f1f1f;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .profile-bar {
            padding: 15px;
            background: #252525;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tabs {
            display: flex;
            background: #252525;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #888;
            font-size: 14px;
            position: relative;
        }

            .tab.active {
                border-bottom: 2px solid #007bff;
                color: white;
            }

        .tab-badge {
            background: #ff4444;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            position: absolute;
            top: 5px;
            right: 10px;
        }

        .list-container {
            flex: 1;
            overflow-y: auto;
        }


        /* –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ (–ù–û–í–´–ô –î–ò–ó–ê–ô–ù) */

        /* –≠–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ */
        .user-item {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            display: grid;
            grid-template-columns: 55px 1fr auto; /* –ê–≤–∞—Ç–∞—Ä | –ò–º—è+–¢–µ–∫—Å—Ç | –ú–µ—Ç–∞ (–≤—Ä–µ–º—è, –≥–∞–ª–æ—á–∫–∏, —Å—á–µ—Ç—á–∏–∫) */
            grid-template-rows: auto auto;
            column-gap: 10px;
            align-items: center;
            cursor: pointer;
            transition: 0.2s;
            min-height: 72px;
        }

            .user-item:hover {
                background: #2a2a2a;
            }

        .user-item-avatar {
            grid-column: 1;
            grid-row: 1 / span 2;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-name {
            grid-column: 2;
            grid-row: 1;
            font-weight: 600;
            font-size: 16px;
            color: white;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            align-self: end;
        }

        .last-msg-row {
            grid-column: 2;
            grid-row: 2;
            display: flex;
            align-items: center;
            overflow: hidden;
            align-self: start;
        }

        .last-msg {
            font-size: 14px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }


        /* –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –í—Ä–µ–º—è (—Å–≤–µ—Ä—Ö—É) –∏ –ì–∞–ª–æ—á–∫–∏/–°—á–µ—Ç—á–∏–∫ (—Å–Ω–∏–∑—É) */
        .meta-column {
            grid-column: 3;
            grid-row: 1 / span 2;
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* –í—Å–µ –ø—Ä–∏–∂–∞—Ç–æ –≤–ø—Ä–∞–≤–æ */
            justify-content: center;
            gap: 5px;
            min-width: 65px;
        }

        .last-msg-date {
            font-size: 13px;
            color: #888;
        }


        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –Ω–∏–∂–Ω–µ–π —á–∞—Å—Ç–∏ –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–∏ (–ì–∞–ª–æ—á–∫–∏ –ò–õ–ò –°—á–µ—Ç—á–∏–∫) */
        .meta-bottom-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            height: 20px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
        }


        /* –ì–∞–ª–æ—á–∫–∏ - —Ç–µ–ø–µ—Ä—å –±–µ–ª—ã–µ –∏ –≤ –ø—Ä–∞–≤–æ–º —É–≥–ª—É */
        .list-ticks {
            display: inline-flex;
            font-size: 14px; /* –ß—É—Ç—å –∫—Ä—É–ø–Ω–µ–µ */
            color: white !important; /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –±–µ–ª—ã–µ */
        }

            .list-ticks span {
                color: white !important;
            }

        .badge-count {
            background: #736AF0;
            color: white;
            font-size: 12px;
            padding: 2px 9px;
            border-radius: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            line-height: 1.2;
            display: none;
        }

            .badge-count:not(.hidden) {
                display: block;
            }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
            position: relative;
            z-index: 1;
        }




        /* –§–æ–Ω —Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç" */
        .noChat {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            position: relative;
            overflow: hidden;
            background-color: #0a0c10;
        }

        #noChat {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            position: relative;
            overflow: hidden;
            background-color: transparent; /* –£–±—Ä–∞–ª —Ñ–æ–Ω */
        }

            #noChat > div {
                position: relative;
                z-index: 2;
                font-size: 18px;
                font-weight: 500;
            }


        @keyframes scrollPattern {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-10%, -10%);
            }
        }


        .chat-header {
            padding: 10px 15px;
            background: #1f1f1f;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 60px;
        }

        .back-btn {
            display: none;
            background: none;
            border: none;
            color: #007bff;
            font-size: 24px;
            cursor: pointer;
            padding-right: 15px;
        }

        .chat-header-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
        }

        .chat-title {
            font-weight: bold;
            font-size: 16px;
        }

        .chat-status {
            font-size: 12px;
            color: #888;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* –î–æ–±–∞–≤–ª—è–µ–º —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
            width: 100%;
            max-width: 900px; /* –®–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ –∫–∞–∫ –≤ Telegram */
            margin: 0 auto; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–∞–º—É –∫–æ–ª–æ–Ω–∫—É */

            background: transparent; /* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ñ–æ–Ω –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */
            /* –£–±–∏—Ä–∞–µ–º position: relative, –µ—Å–ª–∏ –æ–Ω –º–µ—à–∞–µ—Ç —Ñ–æ–Ω—É, –Ω–æ –æ–±—ã—á–Ω–æ –Ω–µ –º–µ—à–∞–µ—Ç */
            position: relative;
            z-index: 1;
        }



            /* –í–∞–∂–Ω–æ! –°–æ–æ–±—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –í–´–®–ï —Ñ–æ–Ω–∞ */
            .messages > * {
                position: relative;
                z-index: 1;
            }



        .input-bar {
            padding: 10px 20px;
            background: transparent; /* –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å —Ñ–æ–Ω */
            display: flex;
            justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
            align-items: center;
            gap: 10px;
            width: 100%;
            max-width: 900px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É, —á—Ç–æ–±—ã –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –±—ã–ª–æ –Ω–µ —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–æ */
            margin: 0 auto; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–∞–º –±–ª–æ–∫ */
            position: relative;
            z-index: 5;
        }

        .input-container {
            flex: 1;
            display: flex;
            align-items: center;
            background: #1f1f1f; /* –§–æ–Ω —Å–∞–º–æ–≥–æ –ø–æ–ª—è –≤–≤–æ–¥–∞ */
            border-radius: 25px; /* –°–∏–ª—å–Ω–æ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
            padding: 5px 15px;
            border: 1px solid #333;
            position: relative;
        }

            .input-container input {
                flex: 1;
                background: transparent;
                border: none;
                color: white;
                padding: 10px;
                font-size: 15px;
                outline: none;
            }


        /* –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä–µ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª—è */
        .attach-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: 0.2s;
        }

            .attach-btn:hover {
                color: #ccc;
            }


        /* –ö—Ä—É–≥–ª–∞—è –∫–Ω–æ–ø–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞/–æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–ø—Ä–∞–≤–∞ */
        .voice-btn, .send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: 0.2s;
            flex-shrink: 0;
        }

        .voice-btn {
            background: #2d2d2d; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ */
            color: white;
        }

            .voice-btn:hover {
                background: #333;
            }

        .send-btn {
            background: #007bff; /* –°–∏–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ */
            color: white;
            padding-left: 5px; /* –í–∏–∑—É–∞–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å—Ç—Ä–µ–ª–æ—á–∫—É */
        }

            .send-btn:hover {
                background: #0056b3;
            }




        .input-bar input {
            flex: 1;
            padding: 12px;
            border-radius: 20px;
            border: 1px solid #444;
            background: #2d2d2d;
            color: white;
        }


        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è */
        .msg {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
            cursor: pointer;
            word-wrap: break-word; /* –ß—Ç–æ–±—ã –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –ø–µ—Ä–µ–Ω–æ—Å–∏–ª–∏—Å—å */
        }


        /* –°–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–ø—Ä–∞–≤–∞) - —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–µ */
        .msg-me {
            align-self: flex-end;
            background: #736AF0; /* –ö—Ä–∞—Å–∏–≤—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π —Ü–≤–µ—Ç –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ */
            color: white;
            border-bottom-right-radius: 2px;
        }


        /* –ß—É–∂–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–ª–µ–≤–∞) - —Å–µ—Ä—ã–µ */
        .msg-other {
            align-self: flex-start;
            background: #2d2d2d; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π */
            color: white;
            border-bottom-left-radius: 2px;
        }


        /* –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ø–æ —Ü–µ–Ω—Ç—Ä—É) */
        .msg-sys {
            align-self: center;
            background: rgba(34, 34, 34, 0.8);
            border: 1px solid #444;
            font-size: 13px;
            color: #aaa;
            padding: 4px 10px;
            border-radius: 10px;
        }


        /* –ë–ª–æ–∫ –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–≤—Ä–µ–º—è + –≥–∞–ª–æ—á–∫–∏) */

        /* –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤—Ä–µ–º—è + –≥–∞–ª–æ—á–∫–∏) */

        /* –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–≤—Ä–µ–º—è + –≥–∞–ª–æ—á–∫–∏) */
        .msg-meta {
            float: right;
            margin-left: 7px;
            margin-top: 6px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            vertical-align: bottom;
            position: relative;
            top: 3px;
            white-space: nowrap; /* –í–∞–∂–Ω–æ: –∑–∞–ø—Ä–µ—â–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–∞-–±–ª–æ–∫–∞ */
            height: 14px;
            line-height: 1;
        }

        .msg-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-right: 2px;
        }

        .msg-ticks {
            font-size: 12px;
            color: white; /* –í—Å–µ–≥–¥–∞ –±–µ–ª—ã–µ */
            display: none;
            font-weight: bold;
        }

        .msg-me .msg-ticks {
            display: inline-block;
        }



        /* –ü—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ –≥–∞–ª–æ—á–∫–∏ (—Ç–µ–ø–µ—Ä—å –æ–Ω–∏ —Ç–æ–∂–µ –±–µ–ª—ã–µ, —Ü–≤–µ—Ç –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è) */
        .tick-read {
            color: white;
        }




        /* –®—Ç–æ—Ä–∫–∏ */
        .overlay-sheet {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 4999;
            display: none;
        }



        .action-sheet {
            /* –û—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ */
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #1f1f1f;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 20px;
            z-index: 5000;
            transform: translateY(100%);
            /* –î–û–ë–ê–í–õ–Ø–ï–ú –≠–¢–û: —Å–∫—Ä—ã–≤–∞–µ–º –æ—Ç —Ç–∞–±–∞/—Ñ–æ–∫—É—Å–∞, –∫–æ–≥–¥–∞ –∑–∞–∫—Ä—ã—Ç–æ */
            visibility: hidden;
            transition: transform 0.3s, visibility 0s linear 0.3s;
        }

            .action-sheet.open {
                transform: translateY(0);
                /* –î–û–ë–ê–í–õ–Ø–ï–ú –≠–¢–û: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ */
                visibility: visible;
                transition: transform 0.3s, visibility 0s;
            }


        .action-btn {
            background: #2d2d2d;
            border: none;
            padding: 15px;
            color: white;
            border-radius: 12px;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
        }

            .action-btn:active {
                background: #333;
            }

            .action-btn.delete {
                color: #ff4444;
            }

        .sheet-title {
            color: #777;
            font-size: 13px;
            text-align: center;
            margin-bottom: 5px;
        }


        /* –ü—Ä–æ—Ñ–∏–ª—å –®—Ç–æ—Ä–∫–∞ */
        .profile-option {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }

            .profile-option h3 {
                margin: 0 0 10px 0;
                font-size: 15px;
                color: #ddd;
            }

        .profile-input-group {
            display: flex;
            gap: 10px;
        }


        /* –ó–≤–æ–Ω–∫–∏ */
        .call-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 4000;
            display: none;
            flex-direction: column;
            transition: opacity 0.5s;
        }

        .video-grid {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }

        .local-video-container {
            position: absolute;
            bottom: 160px;
            right: 20px;
            /* –£–í–ï–õ–ò–ß–ï–ù–ù–´–ï –†–ê–ó–ú–ï–†–´ */
            width: 140px; /* –ë—ã–ª–æ 100px */
            height: 210px; /* –ë—ã–ª–æ 150px (–ø—Ä–æ–ø–æ—Ä—Ü–∏—è 2:3 —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞) */
            /* –ö–†–ê–°–ò–í–û–ï –°–ö–†–£–ì–õ–ï–ù–ò–ï */
            border-radius: 18px; /* –°–∏–ª—å–Ω–µ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–æ (–±—ã–ª–æ 10px) */

            overflow: hidden;
            /* –£–¢–û–ù–ß–ï–ù–ù–ê–Ø –†–ê–ú–ö–ê */
            border: 2px solid rgba(255, 255, 255, 0.2); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –±–µ–ª–∞—è —Ä–∞–º–∫–∞ –≤—ã–≥–ª—è–¥–∏—Ç —Å—Ç–∏–ª—å–Ω–µ–µ */
            /* –¢–ï–ù–¨ –î–õ–Ø –û–ë–™–ï–ú–ê */
            box-shadow: 0 8px 25px rgba(0,0,0,0.6);
            z-index: 4002;
            display: block;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è */
        }


        #localVideo {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important; /* <--- –£–±–∏—Ä–∞–µ—Ç —á–µ—Ä–Ω—ã–µ –ø–æ–ª–æ—Å—ã, –æ–±—Ä–µ–∑–∞—è –ª–∏—à–Ω–µ–µ */
            position: absolute; /* <--- –§–∏–∫—Å–∏—Ä—É–µ—Ç –≤–∏–¥–µ–æ –≤ —É–≥–ª—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            top: 0;
            left: 0;
            background: #000;
        }

            #localVideo.mirror {
                transform: scaleX(-1);
            }


        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px 10px 40px 10px;
            z-index: 4003;
            background: #18191c;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 70px;
        }

        .control-label {
            font-size: 11px;
            color: #b5bac1;
            white-space: nowrap;
        }

        .btn-circle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            transition: 0.2s;
            background: #2b2d31;
            color: #dbdee1;
        }

            .btn-circle:active {
                transform: scale(0.95);
            }

        .btn-active-white {
            background: #f2f3f5 !important;
            color: #313338 !important;
        }

        .btn-hangup {
            background: #da373c !important;
            color: white !important;
        }

        .btn-screen-on {
            background: #248046 !important;
            color: white !important;
        }

        .incoming-call {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #222;
            padding: 15px 25px;
            border-radius: 30px;
            z-index: 5000;
            display: none;
            align-items: center;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            border: 1px solid #444;
            width: 90%;
            max-width: 400px;
            justify-content: space-between;
        }

        .timer-badge {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 20px;
            color: #fff;
            z-index: 4003;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }

        #callStatusText {
            font-size: 12px;
            color: #ccc;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #callTimer {
            font-size: 18px;
            font-family: monospace;
            font-weight: bold;
        }

        #callPing {
            font-size: 11px;
            color: #4caf50;
            margin-top: 5px;
            opacity: 0.9;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                border-right: none;
            }

            .chat-area {
                display: none;
                width: 100%;
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                z-index: 20;
            }

                .chat-area.active {
                    display: flex;
                }

            .sidebar.hidden-mobile {
                display: none;
            }

            .back-btn {
                display: block;
            }
        }


        /* 1. –û–±—â–∏–π —Ñ–æ–Ω –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        #app-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* –õ–µ–∂–∏—Ç –ø–æ–¥ –≤—Å–µ–º */
            background-color: #0a0c10;
        }

            #app-background::before {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                opacity: 0.7;
                pointer-events: none;
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='500' height='500' viewBox='0 0 500 500'%3E%3Cstyle%3E text %7B font-family: 'Segoe UI Emoji', 'Apple Color Emoji', sans-serif; %7D %3C/style%3E%3C!-- –ò–ö–û–ù–ö–ò --%3E%3Ctext x='40' y='60' font-size='36' fill='%234a9eff' fill-opacity='0.4' transform='rotate(12 40 60)'%3EüéÆ%3C/text%3E%3Ctext x='380' y='120' font-size='40' fill='%237c3aed' fill-opacity='0.35' transform='rotate(-15 380 120)'%3EüöÄ%3C/text%3E%3Ctext x='220' y='400' font-size='38' fill='%2306b6d4' fill-opacity='0.4' transform='rotate(8 220 400)'%3Eüéß%3C/text%3E%3Ctext x='180' y='90' font-size='28' fill='%23ec4899' fill-opacity='0.35' transform='rotate(-10 180 90)'%3Eüí°%3C/text%3E%3Ctext x='90' y='250' font-size='30' fill='%2310b981' fill-opacity='0.3' transform='rotate(20 90 250)'%3Eüçï%3C/text%3E%3Ctext x='340' y='320' font-size='26' fill='%23f59e0b' fill-opacity='0.35' transform='rotate(-8 340 320)'%3E‚öΩ%3C/text%3E%3Ctext x='420' y='450' font-size='32' fill='%236366f1' fill-opacity='0.4' transform='rotate(15 420 450)'%3Eüì∑%3C/text%3E%3Ctext x='300' y='180' font-size='20' fill='%238b5cf6' fill-opacity='0.25' transform='rotate(-20 300 180)'%3Eüé∏%3C/text%3E%3Ctext x='150' y='350' font-size='22' fill='%2314b8a6' fill-opacity='0.3' transform='rotate(25 150 350)'%3Eüíª%3C/text%3E%3Ctext x='450' y='260' font-size='18' fill='%23ef4444' fill-opacity='0.3' transform='rotate(-12 450 260)'%3EüèÜ%3C/text%3E%3Ctext x='60' y='430' font-size='24' fill='%233b82f6' fill-opacity='0.35' transform='rotate(18 60 430)'%3Eüé≤%3C/text%3E%3Ctext x='280' y='50' font-size='20' fill='%23a855f7' fill-opacity='0.3' transform='rotate(-5 280 50)'%3Eüëª%3C/text%3E%3C/svg%3E");
                background-size: 400px 400px;
            }

            #app-background::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: radial-gradient(circle at 50% 50%, rgba(10, 12, 16, 0.3) 0%, rgba(10, 12, 16, 0.7) 100%);
                pointer-events: none;
            }


        /* 2. –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω—ã —É –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –±–ª–æ–∫–æ–≤, —á—Ç–æ–±—ã –ø—Ä–æ—Å–≤–µ—á–∏–≤–∞–ª –æ–±—â–∏–π —Ñ–æ–Ω */
        body {
            background: transparent; /* –ë—ã–ª–æ 121212 */
        }

        .chat-area {
            background: transparent; /* –ë—ã–ª–æ 0d1117 */
        }

        #noChat {
            background: transparent; /* –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω –æ—Ç—Å—é–¥–∞ */
            /* –£–±–∏—Ä–∞–µ–º –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç—ã ::before –∏ ::after —É #noChat, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –æ–±—â–∏–π —Ñ–æ–Ω */
        }


        /* –ï—Å–ª–∏ —É –≤–∞—Å –æ—Å—Ç–∞–ª–∏—Å—å —Å—Ç–∏–ª–∏ –¥–ª—è #noChat::before –∏ #noChat::after - –£–î–ê–õ–ò–¢–ï –ò–• */
        .messages {
            background: transparent; /* –£–±–∏—Ä–∞–µ–º —Ñ–æ–Ω */
            /* –£–±–∏—Ä–∞–µ–º –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç—ã ::before –∏ ::after —É .messages */
        }


            /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è Chrome, Safari –∏ Opera */
            .messages::-webkit-scrollbar {
                display: none;
            }


        /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è IE, Edge –∏ Firefox */
        .messages {
            -ms-overflow-style: none; /* IE –∏ Edge */
            scrollbar-width: none; /* Firefox */
        }


        /* PIP drag/resize */
        #localPip {
            /* –≤–∞–∂–Ω–æ: –±—É–¥–µ—Ç –¥–≤–∏–≥–∞—Ç—å—Å—è –ø–æ left/top –≤–Ω—É—Ç—Ä–∏ .video-grid (–æ–Ω–∞ position: relative) */
            touch-action: none;
            user-select: none;
            cursor: grab;
        }

            #localPip.dragging,
            #localPip.resizing {
                transition: none !important; /* —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ "—Ä–µ–∑–∏–Ω—ã" –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ */
            }

            #localPip.dragging {
                cursor: grabbing;
            }


            /* —á—Ç–æ–±—ã drag —Ä–∞–±–æ—Ç–∞–ª –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–∞–ø–∞–µ—à—å –ø–æ —Å–∞–º–æ–º—É –≤–∏–¥–µ–æ */
            #localPip > video {
                pointer-events: none;
            }


            /* –†—É—á–∫–∞ —Ä–µ—Å–∞–π–∑–∞ */
            #localPip .pip-resize-handle {
                position: absolute;
                right: 8px;
                bottom: 8px;
                width: 22px;
                height: 22px;
                border-radius: 7px;
                cursor: nwse-resize;
                background: rgba(255,255,255,0.16);
                border: 1px solid rgba(255,255,255,0.22);
                box-shadow: 0 6px 16px rgba(0,0,0,0.35);
                backdrop-filter: blur(8px);
            }


                /* –Ω–µ–±–æ–ª—å—à–æ–π ‚Äú–±–ª–∏–∫‚Äù, —á—Ç–æ–±—ã –≤—ã–≥–ª—è–¥–µ–ª–æ –∫–∞–∫ UI-—ç–ª–µ–º–µ–Ω—Ç */
                #localPip .pip-resize-handle::after {
                    content: "";
                    position: absolute;
                    inset: 6px;
                    border-right: 2px solid rgba(255,255,255,0.55);
                    border-bottom: 2px solid rgba(255,255,255,0.55);
                    border-radius: 2px;
                    transform: rotate(0deg);
                }


        /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–æ–∫ */
        .control-item-hidden {
            display: none !important;
        }



        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤ —á–∞—Ç–µ */
        .chat-media-img {
            max-width: 240px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É */
            max-height: 300px; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É */
            border-radius: 12px;
            cursor: pointer;
            display: block;
            margin-bottom: 2px;
            object-fit: cover;
            background: #222; /* –§–æ–Ω –ø–æ–∫–∞ –≥—Ä—É–∑–∏—Ç—Å—è */
        }


        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤ */
        .chat-file-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.08); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –ø–æ–¥–ª–æ–∂–∫–∞ */
            border-radius: 10px;
            text-decoration: none;
            max-width: 260px;
            transition: 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }

            .chat-file-card:hover {
                background: rgba(255, 255, 255, 0.12);
            }

        .file-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .file-info {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .file-name {
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .file-action {
            color: #8faebf;
            font-size: 11px;
            margin-top: 2px;
        }


        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –≥–∞–ª–æ—á–µ–∫ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) */
        .msg-meta {
            display: inline-block;
            vertical-align: bottom;
            margin-left: 5px;
        }


        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ö–ê–†–¢–ò–ù–û–ö –í –ß–ê–¢–ï --- */
        .chat-media-img {
            /* –î–µ–ª–∞–µ–º –∏—Ö –∫—Ä—É–ø–Ω–µ–µ */
            width: 100%;
            max-width: 320px; /* –ë—ã–ª–æ 240, —Å—Ç–∞–ª–æ —à–∏—Ä–µ */
            height: auto; /* –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –∏—Å–∫–∞–∂–∞–ª–æ—Å—å */
            max-height: 400px;
            border-radius: 12px;
            cursor: zoom-in; /* –ö—É—Ä—Å–æ—Ä –ª—É–ø—ã */
            display: block;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); /* –¢–µ–Ω—å –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
            transition: transform 0.2s;
        }

            .chat-media-img:active {
                transform: scale(0.98); /* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è */
            }

        .media-container iframe {
            display: block;
            background: #000;
        }

        /* --- –ù–û–í–´–ô –°–¢–ò–õ–¨ –î–õ–Ø –í–ò–î–ï–û --- */
        .chat-media-video {
            width: 100%;
            max-width: 320px;
            max-height: 400px;
            border-radius: 12px;
            display: block;
            background: #000;
            outline: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* --- –°–¢–ò–õ–ò –î–õ–Ø –í–°–ü–õ–´–í–ê–Æ–©–ï–ì–û –û–ö–ù–ê (LIGHTBOX) --- */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9); /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            z-index: 9999; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
            backdrop-filter: blur(5px); /* –†–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ */
        }

            .image-viewer.active {
                display: flex;
                opacity: 1;
            }

            .image-viewer img {
                max-width: 95%;
                max-height: 95%;
                border-radius: 8px;
                box-shadow: 0 0 20px rgba(0,0,0,0.5);
                transform: scale(0.9);
                transition: transform 0.3s;
            }

            .image-viewer.active img {
                transform: scale(1);
            }

        .close-viewer-btn {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
        }


        /* –ö—Ä—É—Ç–∏–ª–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
        .upload-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        @keyframes spin {
            to {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }


        /* –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loading-overlay img {
            filter: brightness(0.5) blur(2px);
            transition: 0.3s;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>



    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function (OneSignal) {
            await OneSignal.init({
                appId: "6af8818f-ba3a-40c4-b820-5235c1d73925",
            });
        });
    </script>


</head>
<body>
    <div id="app-background"></div>
    <audio id="ringtone" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="authScreen" class="auth-overlay">

        <div id="stepEmail" class="auth-box">
            <h2>–í—Ö–æ–¥ –≤ Messenger</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="authAction()">–î–∞–ª–µ–µ</button>
            <div id="authError" style="color: #ff4444; margin-top: 10px; font-size: 13px;"></div>
        </div>

        <div id="stepName" class="auth-box" style="display: none;">
            <h2>–í–∞—à–µ –∏–º—è</h2>
            <div style="font-size: 13px; color: #aaa; margin-bottom: 15px;">
                –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ).
            </div>

            <input type="text" id="regName" placeholder="–ò–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" oninput="checkNameInput()">
            <input type="text" id="regSurname" placeholder="–§–∞–º–∏–ª–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">

            <button id="btnNameNext" onclick="goToUsernameStep()" disabled style="background: #444; cursor: not-allowed;">–î–∞–ª–µ–µ</button>
        </div>

        <div id="stepUsername" class="auth-box" style="display: none;">
            <div style="display:flex; justify-content: flex-start;">
                <button onclick="backToName()" style="width: auto; background: none; color: #007bff; padding: 0; margin: 0 0 10px 0;">‚Üê –ù–∞–∑–∞–¥</button>
            </div>
            <h2>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <div style="font-size: 13px; color: #aaa; margin-bottom: 15px;">
                –í—ã–±–µ—Ä–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –õ—é–¥–∏ —Å–º–æ–≥—É—Ç –Ω–∞–π—Ç–∏ –≤–∞—Å –ø–æ –Ω–µ–º—É.
            </div>

            <div style="position: relative;">
                <input type="text" id="regUsername" placeholder="@Username" oninput="checkUsernameInput()" style="padding-left: 10px;">
            </div>

            <div id="usernameStatus" style="font-size: 12px; text-align: left; margin-top: 5px; min-height: 15px;"></div>

            <button id="btnFinish" onclick="finishRegistration()" disabled style="background: #444; cursor: not-allowed; margin-top: 15px;">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
        </div>

    </div>


    <div id="incomingPopup" class="incoming-call">
        <span id="callerName" style="font-weight:bold; font-size: 14px;">–ó–∞–≥—Ä—É–∑–∫–∞...</span>

        <div style="display:flex; gap:15px;">
            <button onclick="answerCall()" class="btn-circle" style="background:#248046; width:45px; height:45px; font-size:18px;">üìû</button>
            <button onclick="rejectCall()" class="btn-circle btn-hangup" style="width:45px; height:45px; font-size:18px;">‚úñ</button>
        </div>
    </div>

    <div id="overlaySheet" class="overlay-sheet" onclick="closeAllSheets()"></div>

    <div id="actionSheet" class="action-sheet">
        <div class="sheet-title">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
        <button class="action-btn delete" onclick="openDeleteSheet()">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="action-btn" onclick="closeAllSheets()">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="deleteSheet" class="action-sheet">
        <div class="sheet-title">–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?</div>
        <button id="btnDelAll" class="action-btn delete" onclick="confirmDelete('all')">–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö</button>
        <button class="action-btn delete" onclick="confirmDelete('me')">–£–¥–∞–ª–∏—Ç—å —É –º–µ–Ω—è</button>
        <button class="action-btn" onclick="closeAllSheets()">–û—Ç–º–µ–Ω–∞</button>
    </div>

    <div id="profileSheet" class="action-sheet" style="height: auto; max-height: 90dvh; overflow-y: auto;">
        <div class="sheet-title" style="font-size: 16px; font-weight: bold; margin-bottom: 15px;">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</div>

        <div style="display:flex; flex-direction:column; align-items:center; margin-bottom: 20px;">
            <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; background: #333; margin-bottom: 10px; position: relative; border: 2px solid #555;">
                <img id="profileAvatarPreview" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                <div id="profileAvatarPlaceholder" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #888; font-size: 40px;">üë§</div>
            </div>

            <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="handleAvatarSelect(this)">
            <button onclick="document.getElementById('avatarInput').click()" style="background:none; border:none; color:#007bff; cursor:pointer;">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
        </div>


        <div class="profile-option">
            <h3>Email</h3>
            <div id="profileEmail" style="color: #007bff; margin-bottom: 10px;"></div>
        </div>

        <div class="profile-option">
            <h3>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (@)</h3>
            <div class="profile-input-group">
                <span style="padding: 10px; background: #444; color: #aaa; border-radius: 8px 0 0 8px;">@</span>
                <input type="text" id="profileUsername" placeholder="IvanIvanov" style="flex: 1; padding: 10px; background: #444; border: none; color: white; border-radius: 0 8px 8px 0;" oninput="validateUsername(this)">
            </div>
            <div style="font-size: 11px; color: #666; margin-top: 5px;">a-z, 0-9, _ –∏ .</div>
        </div>

        <div class="profile-option">
            <h3>–õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="profileName" placeholder="–ò–º—è *" style="flex: 1; padding: 10px; background: #444; border: none; color: white; border-radius: 8px;">
                <input type="text" id="profileSurname" placeholder="–§–∞–º–∏–ª–∏—è" style="flex: 1; padding: 10px; background: #444; border: none; color: white; border-radius: 8px;">
            </div>

            <h3 style="margin-top: 15px;">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</h3>
            <input type="date" id="profileBirthdate" style="width: 100%; padding: 10px; background: #444; border: none; color: white; border-radius: 8px; color-scheme: dark;">
        </div>

        <div class="profile-option">
            <h3>Telegram Connect</h3>
            <div class="profile-input-group">
                <input type="text" id="tgChatId" placeholder="–í–∞—à ID" style="flex: 1; padding: 10px; background: #444; border: none; color: white; border-radius: 8px;">
            </div>
        </div>

        <button onclick="saveProfile()" class="action-btn" style="background: #28a745; color: white; margin-bottom: 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>

        <button onclick="logout()" class="action-btn" style="padding: 10px; font-size: 14px; width: 100%;">–í—ã–π—Ç–∏</button>
    </div>


    <div id="mainSidebar" class="sidebar">
        <div class="profile-bar" style="padding: 12px 15px; gap: 12px;">

            <button onclick="openProfileSheet()" style="

        width: 44px;

        height: 44px;

        border-radius: 50%;

        background: #2d2d2d;

        border: 1px solid #444;

        color: #fff;

        font-size: 22px;

        cursor: pointer;

        display: flex;

        align-items: center;

        justify-content: center;

        flex-shrink: 0;

        transition: 0.2s;

    " onmouseover="this.style.background='#383838'" onmouseout="this.style.background='#2d2d2d'">

                <span id="myAvatarSmall">üë§</span>

            </button>

            <div style="flex: 1; position: relative;">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..."
                       style="
                   width: 100%;
                   height: 44px;
                   padding: 0 15px;
                   border-radius: 22px; /* –ü–æ–ª–Ω–æ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ */
                   border: 1px solid #333;
                   background: #181818;
                   color: white;
                   outline: none;
                   font-size: 14px;
                   transition: 0.2s;
               "
                       onfocus="this.style.background='#222'; this.style.borderColor='#555'"
                       onblur="this.style.background='#181818'; this.style.borderColor='#333'"
                       oninput="handleSearchInput(this)">

                <div id="searchResults" style="

            position: absolute;

            top: 50px;

            left: 0;

            right: 0;

            background: #252525;

            border: 1px solid #333;

            border-radius: 12px;

            z-index: 100;

            display: none;

            box-shadow: 0 5px 20px rgba(0,0,0,0.5);

            overflow: hidden;

        ">

                </div>

            </div>

        </div>



        <div id="searchResults" style="position: absolute; top: 45px; left: 10px; right: 10px; background: #2d2d2d; border: 1px solid #444; border-radius: 6px; z-index: 100; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('friends')">
                –î—Ä—É–∑—å—è <span id="friendsBadge" class="tab-badge hidden">0</span>
            </div>
            <div class="tab" onclick="switchTab('requests')">
                –ó–∞—è–≤–∫–∏ <span id="requestsBadge" class="tab-badge hidden">0</span>
            </div>
        </div>
        <div id="friendsList" class="list-container"></div>
        <div id="requestsList" class="list-container hidden"></div>
    </div>

    <div id="mainChatArea" class="chat-area">
        <div id="noChat" style="height:100%; display:flex; align-items:center; justify-content:center; color:#555;"></div>
        <div id="activeChat" class="hidden" style="height:100%; display:flex; flex-direction:column;">
            <div class="chat-header">
                <button class="back-btn" onclick="closeChat()" style="background: none; border: none; cursor: pointer; padding: 0 15px 0 0; display: flex; align-items: center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 12H4M4 12L10 6M4 12L10 18" stroke="#007bff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </button>
                <div class="chat-header-info">
                    <div class="chat-title" id="chatTitle">User</div>
                    <div class="chat-status" id="chatStatus">–∑–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="startCall()" style="background:#28a745; color:white; border:none; padding:8px 15px; border-radius:20px; cursor:pointer; font-weight:bold;">üìπ –ó–≤–æ–Ω–æ–∫</button>
                </div>
            </div>

            <div id="msgList" class="messages"></div>
            <div class="input-bar">
                <div class="input-container">
                    <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" onkeypress="if(event.key==='Enter') sendMsg()">

                    <input type="file" id="fileInput" style="display: none;" onchange="uploadFile(this)">

                    <button class="attach-btn" onclick="document.getElementById('fileInput').click()">üìé</button>
                </div>

                <button class="voice-btn" onclick="alert('–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–∫–æ—Ä–æ –±—É–¥—É—Ç!')">üé§</button>
                <button class="send-btn hidden" id="sendBtn" onclick="sendMsg()">‚û§</button>
            </div>
        </div>
    </div>

    <div id="callScreen" class="call-screen">
        <div class="video-grid">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="local-video-container" id="localPip">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="pip-resize-handle" aria-hidden="true"></div>
            </div>
        </div>
        <div class="timer-badge">
            <div id="callStatusText">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...</div>
            <div id="callTimer">00:00</div>
            <div id="callPing">Ping: -</div>
        </div>
        <div class="controls">
            <div class="control-item">
                <button onclick="toggleScreen()" id="btnScr" class="btn-circle">üñ•Ô∏è</button>
                <span id="lblScr" class="control-label">–≠–∫—Ä–∞–Ω</span>
            </div>

            <div class="control-item">
                <button onclick="toggleCamera()" id="btnCam" class="btn-circle">üì∑</button>
                <span id="lblCam" class="control-label">–í–∫–ª. –≤–∏–¥–µ–æ</span>
            </div>

            <div class="control-item">
                <button onclick="switchCamera()" id="btnFlip" class="btn-circle">üîÑ</button>
                <span class="control-label">–ö–∞–º–µ—Ä–∞</span>
            </div>

            <div class="control-item">
                <button onclick="endCallUser()" class="btn-circle btn-hangup">üìû</button>
                <span class="control-label">–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>
            </div>

            <div class="control-item">
                <button onclick="toggleMic()" id="btnMic" class="btn-circle">üé§</button>
                <span id="lblMic" class="control-label">–í—ã–∫–ª. –∑–≤—É–∫</span>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBncXLA4D1JdsqQtA8_8rPqQioq2XRfic4",
            authDomain: "mycoolmessenger.firebaseapp.com",
            databaseURL: "https://mycoolmessenger-default-rtdb.firebaseio.com",
            projectId: "mycoolmessenger",
            storageBucket: "mycoolmessenger.firebasestorage.app",
            messagingSenderId: "225503087166",
            appId: "1:225503087166:web:1355f138e34e3a0172df6f"
        };


        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app();
        }
        const auth = firebase.auth();
        const db = firebase.firestore();



        // --- –®–ò–§ –û–í–ê–ù –ò–ï –¢–û–ö–ï–ù–ê –¢–ï–õ–ï–ì –ê–ú–ê (Base64) ---
        // –¢–æ–∫–µ–Ω: 8387775107:AAGhXPcfytIcnh-_zD04HvlGXIJ_b-crPK4
        const ENCRYPTED_TOKEN = "ODM4Nzc3NTEwNzpBQUdoWFBjZnl0SWNuaC1fekQwNEh2bEdYSUpfYi1jclBLNA==";

        function getTgToken() {
            //  –∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            return atob(ENCRYPTED_TOKEN);
        }

        const iceServers = {
            iceServers: [
                { urls: "stun:stun.relay.metered.ca:80" },
                { urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'] },
                { urls: "turn:global.relay.metered.ca:80", username: "ae2c0c3b821722b03a252928", credential: "TVZk6SgD8cbvbQlB" },
                { urls: "turn:global.relay.metered.ca:80?transport=tcp", username: "ae2c0c3b821722b03a252928", credential: "TVZk6SgD8cbvbQlB" },
                { urls: "turn:global.relay.metered.ca:443", username: "ae2c0c3b821722b03a252928", credential: "TVZk6SgD8cbvbQlB" },
                { urls: "turns:global.relay.metered.ca:443?transport=tcp", username: "ae2c0c3b821722b03a252928", credential: "TVZk6SgD8cbvbQlB" },
                { urls: "turn:open-turn.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:open-turn.metered.ca:443", username: "openrelayproject", credential: "openrelayproject" },
                { urls: "turn:open-turn.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
            ],
            iceCandidatePoolSize: 10
        };

        let currentUser = null;
        let currentFriendId = null;
        let currentCallId = null;
        let currentChatId = null;
        let pc = null;
        let localStream = null;
        let usersCache = {};
        let currentFacingMode = "user";
        let msgUnsub = null;
        let candidateQueue = [];
        let callTimerInt = null;
        let callStartTime = 0;
        let isConnected = false;
        let wasCallConnected = false;
        let amICaller = false;
        let pingInterval = null;
        let selectedMsgId = null;
        let selectedMsgIsMine = false;
        let lastSeenInterval = null;
        let unreadCounts = {};
        let audioCtx = null;
        let toneTimer = null;

        // --- –ù–û–í–´–ô –ü–û–ò–°–ö ---
        let searchTimeout = null;

        function handleSearchInput(input) {
            const val = input.value.trim();
            const resultsBox = document.getElementById('searchResults');

            // –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º
            if (val.length < 3) {
                resultsBox.style.display = 'none';
                return;
            }

            if (searchTimeout) clearTimeout(searchTimeout);

            searchTimeout = setTimeout(() => {
                performSearch(val);
            }, 500); // –ò—â–µ–º —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–≤–æ–¥–∞
        }

        async function performSearch(query) {
            const resultsBox = document.getElementById('searchResults');
            resultsBox.innerHTML = '<div style="padding:10px; color:#888; text-align:center;">–ü–æ–∏—Å–∫...</div>';
            resultsBox.style.display = 'block';

            // –£–±–∏—Ä–∞–µ–º @ –µ—Å–ª–∏ –µ—Å—Ç—å
            const cleanQuery = query.startsWith('@') ? query.slice(1) : query;

            try {
                const hits = [];

                // 1. –ò—â–µ–º –ø–æ username
                const snapUser = await db.collection('users')
                    .where('username', '>=', cleanQuery)
                    .where('username', '<=', cleanQuery + '\uf8ff')
                    .limit(3)
                    .get();

                snapUser.forEach(doc => {
                    if (doc.id !== currentUser.uid) hits.push({ id: doc.id, ...doc.data() });
                });

                // 2. –ï—Å–ª–∏ –º–∞–ª–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∏—â–µ–º –ø–æ email
                if (hits.length < 3) {
                    const snapEmail = await db.collection('users')
                        .where('email', '>=', query)
                        .where('email', '<=', query + '\uf8ff')
                        .limit(3)
                        .get();

                    snapEmail.forEach(doc => {
                        if (doc.id !== currentUser.uid && !hits.find(h => h.id === doc.id)) {
                            hits.push({ id: doc.id, ...doc.data() });
                        }
                    });
                }

                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–º–∞–∫—Å–∏–º—É–º 3)
                const finalHits = hits.slice(0, 3);

                if (finalHits.length === 0) {
                    resultsBox.innerHTML = '<div style="padding:10px; color:#888; text-align:center;">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                } else {
                    resultsBox.innerHTML = '';
                    finalHits.forEach(user => {
                        const div = document.createElement('div');
                        div.style.padding = '10px';
                        div.style.borderBottom = '1px solid #333';
                        div.style.cursor = 'pointer';
                        div.style.display = 'flex';
                        div.style.alignItems = 'center';
                        div.style.gap = '10px';

                        // –ê–≤–∞—Ç–∞—Ä–∫–∞ –∏–ª–∏ –∑–∞–≥–ª—É—à–∫–∞
                        const avatarSrc = user.avatar ? `<img src="${user.avatar}" style="width:30px;height:30px;border-radius:50%;object-fit:cover;">` : `<div style="width:30px;height:30px;border-radius:50%;background:#444;display:flex;align-items:center;justify-content:center;">üë§</div>`;

                        // –ù–∏–∫–Ω–µ–π–º (–∏–ª–∏ none)
                        const displayNick = user.username ? `@${user.username}` : 'none';

                        div.innerHTML = `
                                                                                                                                                                                                                                                                ${avatarSrc}
                                                                                                                                                                                                                                                                <div>
                                                                                                                                                                                                                                                                    <div style="font-weight:bold; font-size:14px;">${user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                                                                                                                                                                                                                                                                    <div style="font-size:12px; color:#888;">${displayNick}</div>
                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                            `;

                        div.onclick = () => {
                            sendFriendRequestToId(user.id); // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                            resultsBox.style.display = 'none';
                            document.getElementById('searchInput').value = '';
                        };

                        resultsBox.appendChild(div);
                    });
                }

            } catch (e) {
                console.error(e);
                resultsBox.innerHTML = '<div style="padding:10px; color:red; text-align:center;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
            }
        }

        // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –ø–æ ID (–∞ –Ω–µ email)
        async function sendFriendRequestToId(targetUid) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥—Ä—É–∑—å—è –ª–∏ —É–∂–µ
            // –≠—Ç–æ —Å–ª–æ–∂–Ω–µ–µ –≤ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º–µ, –Ω–æ –ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏–º –∑–∞—è–≤–∫—É
            try {
                await db.collection('friend_requests').add({
                    from: currentUser.uid,
                    fromEmail: currentUser.email, // –û—Å—Ç–∞–≤–ª—è–µ–º email –∫–∞–∫ —Ç–µ—Ö. –ø–æ–ª–µ
                    fromUsername: (await getCurrentUsername()) || 'none', // –î–æ–±–∞–≤–ª—è–µ–º username
                    to: targetUid
                });
                alert('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
            } catch (e) {
                alert('–û—à–∏–±–∫–∞: ' + e.message);
            }
        }

        async function getCurrentUsername() {
            const doc = await db.collection('users').doc(currentUser.uid).get();
            return doc.exists ? doc.data().username : null;
        }


        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function beep(freq, duration, vol = 0.05) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq;
            osc.type = 'sine';
            gain.gain.value = vol;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            setTimeout(() => {
                gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.04);
                osc.stop(audioCtx.currentTime + 0.05);
            }, duration);
        }

        function playConnectingTone() {
            stopAllTones();
            const loop = () => beep(425, 100, 0.05);
            loop();
            toneTimer = setInterval(loop, 1500);
        }

        function playRingingTone() {
            stopAllTones();
            const loop = () => beep(425, 1000, 0.08);
            loop();
            toneTimer = setInterval(loop, 4000);
        }

        function playEndTone() {
            stopAllTones();
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.4);
        }

        function stopAllTones() {
            if (toneTimer) { clearInterval(toneTimer); toneTimer = null; }
        }

        function formatLastSeen(timestamp) {
            if (!timestamp) return "–±—ã–ª –¥–∞–≤–Ω–æ";
            const now = Date.now();
            const diff = now - timestamp.toMillis();

            const seconds = Math.floor(diff / 1000); // –°—á–∏—Ç–∞–µ–º —Å–µ–∫—É–Ω–¥—ã
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            const months = Math.floor(days / 30);

            // === –ù–ê–°–¢–†–û–ô–ö–ê –ó–î–ï–°–¨ ===
            // –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ 45 —Å–µ–∫—É–Ω–¥, —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –æ–Ω –µ—â—ë "–≤ —Å–µ—Ç–∏"
            if (seconds < 30) return "–≤ —Å–µ—Ç–∏";

            // –ï—Å–ª–∏ –æ—Ç 45 —Å–µ–∫ –¥–æ 1 –º–∏–Ω—É—Ç—ã - –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å "–±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ" –∏–ª–∏ —É–∂–µ —Å—á–∏—Ç–∞—Ç—å –º–∏–Ω—É—Ç—ã
            if (minutes < 1) return "–±—ã–ª —Ç–æ–ª—å–∫–æ —á—Ç–æ";

            // –î–∞–ª—å—à–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ
            if (minutes < 60) return `${minutes} ${minutes === 1 ? '–º–∏–Ω—É—Ç—É' : minutes < 5 ? '–º–∏–Ω—É—Ç—ã' : '–º–∏–Ω—É—Ç'} –Ω–∞–∑–∞–¥`;
            if (hours < 24) return `${hours} ${hours === 1 ? '—á–∞—Å' : hours < 5 ? '—á–∞—Å–∞' : '—á–∞—Å–æ–≤'} –Ω–∞–∑–∞–¥`;
            if (days < 30) return `${days} ${days === 1 ? '–¥–µ–Ω—å' : days < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'} –Ω–∞–∑–∞–¥`;
            return "–±—ã–ª –¥–∞–≤–Ω–æ";
        }


        let lastActivityTime = Date.now();
        let isOnline = false;

        // –°–ª–µ–¥–∏–º –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, () => {
                lastActivityTime = Date.now();
                if (!isOnline) {
                    // –ï—Å–ª–∏ –æ–Ω "–ø—Ä–æ—Å–Ω—É–ª—Å—è" - —Å—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
                    updateLastSeen();
                }
            });
        });

        function updateLastSeen() {
            const now = Date.now();
            // –ï—Å–ª–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ 30 —Å–µ–∫—É–Ω–¥ - –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–∑—É
            if (now - lastActivityTime < 30000) {
                isOnline = true;
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(e => console.log('Err update lastSeen', e));
                }
            } else {
                isOnline = false;
                // –ú–æ–∂–Ω–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —è–≤–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å "–æ—Ñ–ª–∞–π–Ω" –≤ –±–∞–∑—É, –Ω–æ –ª—É—á—à–µ –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–∞—Ç—É
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
        // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω -> –æ–±–Ω–æ–≤–∏—Ç –¥–∞—Ç—É –≤ –±–∞–∑–µ.
        // –ï—Å–ª–∏ –ù–ï –∞–∫—Ç–∏–≤–µ–Ω -> –Ω–µ –æ–±–Ω–æ–≤–∏—Ç, –∏ —á–µ—Ä–µ–∑ 30-60 —Å–µ–∫ –¥–ª—è –¥—Ä—É–≥–∏—Ö –æ–Ω —Å—Ç–∞–Ω–µ—Ç "–±—ã–ª –Ω–µ–¥–∞–≤–Ω–æ"
        setInterval(updateLastSeen, 15000);


        // --- AUTH ---
        // 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function authAction() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            if (!e || !p) return;

            // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —é–∑–µ—Ä—É, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –ø–æ—à–µ–ª
            const btn = document.querySelector('#stepEmail button'); // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É
            const originalText = btn.innerText;
            btn.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            btn.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∂–∞–ª –¥–≤–∞–∂–¥—ã
            btn.style.opacity = "0.7";

            auth.signInWithEmailAndPassword(e, p).catch(err => {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å
                if (err.code.includes('not-found') || err.code.includes('wrong') || err.code.includes('invalid')) {
                    auth.createUserWithEmailAndPassword(e, p).then(cred => {
                        db.collection('users').doc(cred.user.uid).set({
                            email: e,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, onAuthStateChanged –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    }).catch(regErr => {
                        // –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                        document.getElementById('authError').innerText = regErr.message;
                        btn.innerText = originalText;
                        btn.disabled = false;
                        btn.style.opacity = "1";
                    });
                } else {
                    // –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞
                    document.getElementById('authError').innerText = err.message;
                    btn.innerText = originalText;
                    btn.disabled = false;
                    btn.style.opacity = "1";
                }
            });
        }


        // --- 1. –û–ü–¢–ò–ú–ò–°–¢–ò–ß–ù–´–ô –í–•–û–î (–í—Å—Ç–∞–≤–∏—Ç—å –ü–ï–†–ï–î auth.onAuthStateChanged) ---
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Ö–æ–¥–∏–ª –ª–∏ —é–∑–µ—Ä –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑
        const wasLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

        if (wasLoggedIn) {
            // –°—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞, –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –æ—Ç–≤–µ—Ç–∞ –æ—Ç Google
            document.getElementById('authScreen').classList.add('hidden');
        }

        // --- 2. –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê (–í–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ —Å–ª—É—à–∞—Ç–µ–ª—è) ---
        auth.onAuthStateChanged(u => {
            if (u) {
                currentUser = u;
                // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω —Å–µ—Ä–≤–µ—Ä–æ–º -> —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –±—É–¥—É—â–µ–µ
                localStorage.setItem('isLoggedIn', 'true');

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –ª–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                db.collection('users').doc(u.uid).get().then(doc => {
                    if (doc.exists && doc.data().username) {
                        // –í—Å–µ –æ–∫, –ø—É—Å–∫–∞–µ–º –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ
                        document.getElementById('authScreen').classList.add('hidden');
                        document.getElementById('profileEmail').innerText = u.email;
                        updateLastSeen();

                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç—ã —Ç–æ–ª—å–∫–æ —Å–µ–π—á–∞—Å (—Ç–∞–∫ –∫–∞–∫ –Ω—É–∂–µ–Ω currentUser)
                        loadData();
                        listenForIncomingCalls();
                        loadTgId();
                        setTimeout(handleHashChange, 500);

                        if (lastSeenInterval) clearInterval(lastSeenInterval);

                    } else {
                        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ -> –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —ç–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                        document.getElementById('stepEmail').style.display = 'none';
                        document.getElementById('stepName').style.display = 'block';
                        document.getElementById('stepUsername').style.display = 'none';
                        document.getElementById('authScreen').classList.remove('hidden');
                    }
                });
            } else {
                // –°–µ—Ä–≤–µ—Ä —Å–∫–∞–∑–∞–ª: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–æ—à–µ–ª" –∏–ª–∏ "–¢–æ–∫–µ–Ω –ø—Ä–æ—Ç—É—Ö"
                localStorage.removeItem('isLoggedIn'); // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É

                // –ï—Å–ª–∏ –º—ã "–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ" –ø—É—Å—Ç–∏–ª–∏ —é–∑–µ—Ä–∞, –∞ —Å–µ—Ä–≤–µ—Ä –æ—Ç–∫–∞–∑–∞–ª -> –≤—ã–≥–æ–Ω—è–µ–º
                if (wasLoggedIn) {
                    alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.");
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞)
                document.getElementById('authScreen').classList.remove('hidden');
                document.getElementById('stepEmail').style.display = 'block';
                document.getElementById('stepName').style.display = 'none';
                document.getElementById('stepUsername').style.display = 'none';
                if (lastSeenInterval) clearInterval(lastSeenInterval);
            }
        });



        function checkNameInput() {
            const name = document.getElementById('regName').value.trim();
            const btn = document.getElementById('btnNameNext');

            if (name.length > 0) {
                btn.disabled = false;
                btn.style.background = '#007bff'; // –°–∏–Ω–∏–π
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.background = '#444';
                btn.style.cursor = 'not-allowed';
            }
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É 3
        function goToUsernameStep() {
            document.getElementById('stepName').style.display = 'none';
            document.getElementById('stepUsername').style.display = 'block';
        }

        // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º—è)
        function backToName() {
            document.getElementById('stepUsername').style.display = 'none';
            document.getElementById('stepName').style.display = 'block';
        }

        // –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —é–∑–µ—Ä–Ω–µ–π–º–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        let usernameTimeout = null;

        function checkUsernameInput() {
            let val = document.getElementById('regUsername').value;
            const status = document.getElementById('usernameStatus');
            const btn = document.getElementById('btnFinish');

            // –û—á–∏—Å—Ç–∫–∞ –æ—Ç –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
            val = val.replace(/[^a-zA-Z0-9_.]/g, '');
            document.getElementById('regUsername').value = val; // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ

            // –í–∏–∑—É–∞–ª—å–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º @
            // (–í –∫–æ–¥–µ –≤—ã—à–µ input —É–∂–µ –∏–º–µ–µ—Ç placeholder, –Ω–æ –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å)

            btn.disabled = true;
            btn.style.background = '#444';
            btn.style.cursor = 'not-allowed';

            if (val.length < 3) {
                status.innerText = "–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ (–º–∏–Ω. 3 —Å–∏–º–≤–æ–ª–∞)";
                status.style.color = "#ff4444";
                return;
            }

            status.innerText = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";
            status.style.color = "#aaa";

            // Debounce (–∂–¥–µ–º –ø–æ–∫–∞ –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –ø–µ—á–∞—Ç–∞—Ç—å)
            if (usernameTimeout) clearTimeout(usernameTimeout);

            usernameTimeout = setTimeout(() => {
                // –ó–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ
                db.collection('users').where('username', '==', val).get().then(snap => {
                    if (snap.empty) {
                        status.innerText = `@${val} —Å–≤–æ–±–æ–¥–Ω–æ`;
                        status.style.color = "#4caf50"; // –ó–µ–ª–µ–Ω—ã–π

                        btn.disabled = false;
                        btn.style.background = '#007bff';
                        btn.style.cursor = 'pointer';
                    } else {
                        status.innerText = `@${val} —É–∂–µ –∑–∞–Ω—è—Ç–æ`;
                        status.style.color = "#ff4444"; // –ö—Ä–∞—Å–Ω—ã–π
                    }
                });
            }, 500); // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ 0.5 —Å–µ–∫ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–≤–æ–¥–∞
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function finishRegistration() {
            const name = document.getElementById('regName').value.trim();
            const surname = document.getElementById('regSurname').value.trim();
            const username = document.getElementById('regUsername').value.trim();

            if (!name || !username) return;

            db.collection('users').doc(currentUser.uid).set({
                name: name,
                surname: surname,
                username: username,
                email: currentUser.email, // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }).then(() => {
                // –£—Å–ø–µ—Ö -> –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
                // –õ—É—á—à–µ –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É, –∫–∞–∫ –≤ onAuthStateChanged
                document.getElementById('authScreen').classList.add('hidden');
                loadData();
                listenForIncomingCalls();
                loadTgId();
                if (lastSeenInterval) clearInterval(lastSeenInterval);
                lastSeenInterval = setInterval(updateLastSeen, 30000);
            });
        }

        window.addEventListener('beforeunload', updateLastSeen);

        // --- LOGIC ---
        function switchTab(t) {
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            if (t === 'friends') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('friendsList').classList.remove('hidden');
                document.getElementById('requestsList').classList.add('hidden');
            }
            else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('friendsList').classList.add('hidden');
                document.getElementById('requestsList').classList.remove('hidden');
            }
        }

        // –°–ª—É—à–∞—Ç–µ–ª—å –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞—è–≤–æ–∫ –≤ –¥—Ä—É–∑—å—è
        function listenForFriendRequests() {
            db.collection('friend_requests')
                .where('to', '==', currentUser.uid)
                .onSnapshot(async snap => {
                    const list = document.getElementById('requestsList');
                    const badge = document.getElementById('requestsBadge');

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞—è–≤–æ–∫
                    if (snap.size > 0) {
                        badge.innerText = snap.size;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }

                    // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç, –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                    list.innerHTML = '';
                    if (snap.empty) {
                        list.innerHTML = '<div style="padding:20px;text-align:center;color:#888">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</div>';
                        return;
                    }

                    snap.forEach(doc => {
                        const data = doc.data();
                        const div = document.createElement('div');
                        div.className = 'user-item'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Å—Ç–∏–ª—å, —á—Ç–æ –∏ –¥–ª—è —á–∞—Ç–æ–≤

                        // –ê–≤–∞—Ç–∞—Ä–∫–∞ (–∑–∞–≥–ª—É—à–∫–∞ –∏–ª–∏ –º–æ–∂–Ω–æ –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∞–ª—å–Ω—É—é)
                        const avatar = '<div class="user-item-avatar" style="background:#444;display:flex;align-items:center;justify-content:center;">üë§</div>';

                        div.innerHTML = `
                                                                                                                                                                                                                                                                        ${avatar}
                                                                                                                                                                                                                                                                        <div class="user-name" style="grid-row: 1/span 2; align-self:center;">
                                                                                                                                                                                                                                                                            ${data.fromUsername ? '@' + data.fromUsername : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}
                                                                                                                                                                                                                                                                            <div style="font-size:12px; color:#888; font-weight:normal;">–•–æ—á–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Å –≤ –¥—Ä—É–∑—å—è</div>
                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                        <div style="grid-column:3; grid-row:1/span 2; display:flex; gap:10px;">
                                                                                                                                                                                                                                                                            <button onclick="accept('${doc.id}', '${data.from}', '${data.fromEmail}')" style="background:#28a745; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">‚úì</button>
                                                                                                                                                                                                                                                                            <button onclick="reject('${doc.id}')" style="background:#dc3545; border:none; color:white; padding:5px 10px; border-radius:5px; cursor:pointer;">‚úï</button>
                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                    `;
                        list.appendChild(div);
                    });
                });
        }


        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ
        function startMessageListener(chatId, fid, createdTime) {
            db.collection('chats').doc(chatId).collection('msgs')
                .orderBy('ts', 'desc').limit(1)
                .onSnapshot(msgSnap => {
                    const lastEl = document.getElementById('last-' + chatId);
                    const dateEl = document.getElementById('date-' + chatId);
                    const statusEl = document.getElementById('status-' + chatId);
                    const userDiv = document.getElementById('u-' + fid);

                    // –í—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –∫–æ–≥–¥–∞ –¥–æ–±–∞–≤–∏–ª–∏ –≤ –¥—Ä—É–∑—å—è
                    let timeToDisplay = createdTime;

                    if (!msgSnap.empty) {
                        const lastData = msgSnap.docs[0].data();

                        // –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
                        if (lastEl) {
                            let shortTxt = lastData.txt;
                            if (shortTxt.length > 25) shortTxt = shortTxt.substring(0, 25) + '...';
                            if (lastData.from === currentUser.uid) shortTxt = '–í—ã: ' + shortTxt;
                            lastEl.innerHTML = shortTxt;
                        }

                        // –í—Ä–µ–º—è —Å–æ–æ–±—â–µ–Ω–∏—è
                        if (lastData.ts) timeToDisplay = lastData.ts.toMillis();

                        // –ì–∞–ª–æ—á–∫–∏ (—Å—Ç–∞—Ç—É—Å)
                        if (statusEl) {
                            if (lastData.from === currentUser.uid) {
                                let ticksHtml = lastData.read
                                    ? '<span style="margin-right:-4px;">‚úì</span>‚úì'
                                    : '‚úì';
                                statusEl.innerHTML = ticksHtml;
                                statusEl.style.display = 'inline-flex';
                            } else {
                                statusEl.style.display = 'none';
                            }
                        }
                    } else {
                        if (lastEl) lastEl.innerHTML = "–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π";
                        if (statusEl) statusEl.style.display = 'none';
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É
                    if (dateEl && timeToDisplay > 0) {
                        const date = new Date(timeToDisplay);
                        const now = new Date();
                        // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –¥–∞—Ç—ã: —á–∞—Å—ã:–º–∏–Ω—É—Ç—ã –∏–ª–∏ –¥–µ–Ω—å
                        if (date.toDateString() === now.toDateString()) {
                            dateEl.innerText = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
                        } else {
                            dateEl.innerText = date.getDate() + '.' + (date.getMonth() + 1);
                        }
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É —Å–ø–∏—Å–∫–∞
                    if (userDiv) {
                        userDiv.setAttribute('data-time', timeToDisplay);
                        sortFriendsList();
                    }
                });

            // –°–ª—É—à–∞–µ–º –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ (Badge)
            db.collection('chats').doc(chatId).collection('msgs')
                .where('to', '==', currentUser.uid)
                .where('read', '==', false)
                .onSnapshot(unreadSnap => {
                    const badgeEl = document.getElementById('badge-' + chatId);
                    const count = unreadSnap.size;

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è –æ–±—â–µ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞ (–µ—Å–ª–∏ –æ–Ω —É –≤–∞—Å –µ—Å—Ç—å)
                    if (typeof unreadCounts !== 'undefined') {
                        unreadCounts[chatId] = count;
                        updateTotalFriendsBadge();
                    }

                    if (badgeEl) {
                        if (count > 0) {
                            badgeEl.innerText = count;
                            badgeEl.classList.remove('hidden');
                        } else {
                            badgeEl.classList.add('hidden');
                        }
                    }
                });
        }


        function loadData() {
            // 1. –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Å–ª—É—à–∫—É –∑–∞—è–≤–æ–∫
            if (typeof listenForFriendRequests === 'function') {
                listenForFriendRequests();
            }

            // 2. –°–ª—É—à–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û)
            db.collection('friends')
                .where('users', 'array-contains', currentUser.uid)
                .onSnapshot(async snap => {
                    const list = document.getElementById('friendsList');

                    if (snap.empty) {
                        list.innerHTML = '<div style="padding:20px;text-align:center;color:#888">–°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –ø—É—Å—Ç</div>';
                        return;
                    }

                    // –ü—Ä–æ—Ö–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –ø–æ –ò–ó–ú–ï–ù–ï–ù–ò–Ø–ú, –∞ –Ω–µ –ø–æ –≤—Å–µ–º—É —Å–ø–∏—Å–∫—É
                    snap.docChanges().forEach(async change => {
                        const d = change.doc.data();
                        const docId = change.doc.id;
                        const fid = d.users.find(id => id !== currentUser.uid);
                        if (!fid) return;

                        // –ï—Å–ª–∏ –¥—Ä—É–≥–∞ —É–¥–∞–ª–∏–ª–∏
                        if (change.type === 'removed') {
                            const el = document.getElementById('u-' + fid);
                            if (el) el.remove();
                            return;
                        }

                        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥—Ä—É–≥–∞ (–∏–∑ –∫—ç—à–∞ –∏–ª–∏ –±–∞–∑—ã)
                        let friendData = usersCache[fid];

                        if (!friendData) {
                            // –ï—Å–ª–∏ –Ω–µ—Ç –≤ –∫—ç—à–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º (–æ–¥–∏–Ω —Ä–∞–∑!)
                            try {
                                const userSnap = await db.collection('users').doc(fid).get();
                                if (userSnap.exists) {
                                    friendData = userSnap.data();
                                    usersCache[fid] = friendData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                                }
                            } catch (e) {
                                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è", e);
                            }
                        }

                        // –î–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å
                        const fName = friendData ? (friendData.name || friendData.username) : '–ó–∞–≥—Ä—É–∑–∫–∞...';
                        const fNick = friendData ? ('@' + friendData.username) : '';
                        const fAvatar = friendData ? friendData.avatar : null;
                        const createdTime = d.createdAt ? d.createdAt.toMillis() : 0;
                        const chatId = [currentUser.uid, fid].sort().join('_');

                        // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç
                        let div = document.getElementById('u-' + fid);
                        const isNew = !div;

                        if (isNew) {
                            div = document.createElement('div');
                            div.className = 'user-item';
                            div.id = 'u-' + fid;
                            div.onclick = () => openChat(fid, fName, fNick);
                        }

                        div.setAttribute('data-time', createdTime);

                        const avatarHtml = fAvatar
                            ? `<img src="${fAvatar}" class="user-item-avatar">`
                            : `<div class="user-item-avatar" style="background:#444;display:flex;align-items:center;justify-content:center;font-size:24px;color:#888">üë§</div>`;

                        // –í—Å—Ç–∞–≤–ª—è–µ–º HTML (–û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ: id –¥–ª—è last-msg –∏ badge –æ—Å—Ç–∞–ª–∏—Å—å —Ç–µ –∂–µ)
                        div.innerHTML = `
                                                                                                                                                                                                                                                                            ${avatarHtml}
                                                                                                                                                                                                                                                                            <div class="user-name">${fName}</div>
                                                                                                                                                                                                                                                                            <div class="last-msg-row">
                                                                                                                                                                                                                                                                                <span class="last-msg" id="last-${chatId}">...</span>
                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                            <div class="meta-column">
                                                                                                                                                                                                                                                                                <span class="last-msg-date" id="date-${chatId}"></span>
                                                                                                                                                                                                                                                                                <div class="meta-bottom-row">
                                                                                                                                                                                                                                                                                    <span id="status-${chatId}" class="list-ticks"></span>
                                                                                                                                                                                                                                                                                    <div class="badge-count hidden" id="badge-${chatId}">0</div>
                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                        `;

                        if (isNew) {
                            list.appendChild(div);
                            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π –¢–û–õ–¨–ö–û –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                            startMessageListener(chatId, fid, createdTime);
                        }
                    });

                    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (–Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã —ç–ª–µ–º–µ–Ω—Ç—ã —É—Å–ø–µ–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å—Å—è)
                    setTimeout(sortFriendsList, 100);
                });
        }








        function sortFriendsList() {
            const list = document.getElementById('friendsList');
            const items = Array.from(list.children);
            items.sort((a, b) => {
                const timeA = parseInt(a.getAttribute('data-time') || 0);
                const timeB = parseInt(b.getAttribute('data-time') || 0);
                return timeB - timeA;
            });
            items.forEach(item => list.appendChild(item));
        }

        function updateTotalFriendsBadge() {
            const total = Object.values(unreadCounts).reduce((a, b) => a + b, 0);
            const el = document.getElementById('friendsBadge');
            if (total > 0) { el.innerText = total; el.classList.remove('hidden'); }
            else { el.classList.add('hidden'); }
        }

        async function sendFriendRequest() {
            const e = document.getElementById('searchEmail').value;
            const snap = await db.collection('users').where('email', '==', e).get();
            if (snap.empty) return alert('–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            await db.collection('friend_requests').add({ from: currentUser.uid, fromEmail: currentUser.email, to: snap.docs[0].id });
            alert('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); document.getElementById('searchEmail').value = '';
        }

        async function accept(rid, fid, femail) {
            await db.collection('friends').add({
                users: [currentUser.uid, fid],
                emails: { [currentUser.uid]: currentUser.email, [fid]: femail },
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection('friend_requests').doc(rid).delete();
        }
        function reject(rid) { db.collection('friend_requests').doc(rid).delete(); }

        function openChat(fid, name, nick) {
            // === –ù–û–í–û–ï: –ú–µ–Ω—è–µ–º URL ===
            window.location.hash = "chat/" + fid;
            // ==========================

            currentFriendId = fid;
            currentChatId = [currentUser.uid, fid].sort().join('_');

            // UI –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è (–º–æ–±–∏–ª—å–Ω—ã–π/–¥–µ—Å–∫—Ç–æ–ø)
            if (window.innerWidth <= 768) {
                document.getElementById('mainSidebar').classList.add('hidden-mobile');
                document.getElementById('mainChatArea').classList.add('active');
            }
            document.getElementById('noChat').classList.add('hidden');
            document.getElementById('activeChat').classList.remove('hidden');

            // –ó–ê–ì–û–õ–û–í–û–ö –ß–ê–¢–ê
            document.getElementById('chatTitle').innerHTML = `
                                                                                                                                                                                                                                                <div>${name}</div>
                                                                                                                                                                                                                                                <div style="font-size:11px; font-weight:normal; color:#888;">${nick}</div>
                                                                                                                                                                                                                                            `;

            // –°—Ç–∞—Ç—É—Å "–±—ã–ª –≤ —Å–µ—Ç–∏"
            db.collection('users').doc(fid).onSnapshot(userSnap => {
                if (userSnap.exists) {
                    const userData = userSnap.data();
                    const statusEl = document.getElementById('chatStatus');
                    if (statusEl) statusEl.innerText = formatLastSeen(userData.lastSeen);
                }
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            loadMessages();
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (!isMobile) {
                setTimeout(() => {
                    const inp = document.getElementById('msgInput');
                    if (inp) inp.focus();
                }, 100);
            }
        }

        function loadMessages() {
            const list = document.getElementById('msgList');
            list.innerHTML = '';

            if (msgUnsub) msgUnsub();

            const deletedLocal = JSON.parse(localStorage.getItem('deletedMsgs') || '[]');

            msgUnsub = db.collection('chats').doc(currentChatId).collection('msgs')
                .orderBy('ts')
                .limitToLast(50)
                .onSnapshot(snap => {
                    const batch = db.batch();
                    let needCommit = false;
                    let hasNewMessages = false;

                    snap.docChanges().forEach(change => {
                        const d = change.doc;
                        const m = d.data();
                        const msgId = d.id;

                        if (deletedLocal.includes(msgId)) return;

                        if (change.type === 'removed') {
                            const el = document.getElementById('msg-' + msgId);
                            if (el) el.remove();
                            return;
                        }

                        let div = document.getElementById('msg-' + msgId);
                        const isNew = !div;

                        if (isNew) {
                            div = document.createElement('div');
                            div.id = 'msg-' + msgId;
                            div.onclick = (e) => {
                                if (e.target.tagName !== 'A' && e.target.tagName !== 'IMG' && e.target.tagName !== 'VIDEO') {
                                    e.stopPropagation();
                                    openActionSheet(msgId, m.from === currentUser.uid);
                                }
                            };
                        }

                        // 3. –û—Ç–º–µ—Ç–∫–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º
                        if (change.type === 'added' && m.to === currentUser.uid && !m.read) {
                            batch.update(d.ref, { read: true });
                            needCommit = true;
                        }

                        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø HTML ---
                        let timeStr = '';
                        if (m.ts) {
                            const date = m.ts.toDate();
                            timeStr = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');
                        }

                        let ticksHtml = m.read ? '<span style="margin-right: -4px;">‚úì</span>‚úì' : '‚úì';

                        // –ö–ª–∞—Å—Å—ã
                        if (m.sys) {
                            div.className = 'msg msg-sys';
                        } else if (m.from === currentUser.uid) {
                            div.className = 'msg msg-me';
                        } else {
                            div.className = 'msg msg-other';
                        }

                        // === –ö–û–ù–¢–ï–ù–¢ ===
                        let contentHtml = '';
                        const msgType = m.type || 'text';

                        if (m.sys) {
                            contentHtml = m.txt;
                        }
                        else if (msgType === 'image') {
                            // === –ö–ê–†–¢–ò–ù–ö–ê (–í–´–°–û–ö–û–ï –ö–ê–ß–ï–°–¢–í–û) ===
                            let imgSrc = m.txt;

                            // –ü–∞—Ä—Å–∏–º ID –∏ –¥–µ–ª–∞–µ–º High-Res —Å—Å—ã–ª–∫—É (lh3.../d/ID=w1000)
                            if (m.txt.includes('drive.google.com') && m.txt.includes('id=')) {
                                try {
                                    const fileId = m.txt.split('id=')[1];
                                    // =w600 - –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è —á–∞—Ç–∞ (–±—ã—Å—Ç—Ä–æ –≥—Ä—É–∑–∏—Ç, —á–µ—Ç–∫–æ –≤—ã–≥–ª—è–¥–∏—Ç)
                                    // –ü—Ä–∏ –∫–ª–∏–∫–µ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è
                                    imgSrc = `https://lh3.googleusercontent.com/d/${fileId}=w600`;
                                } catch (e) { }
                            }

                            // –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ onclick="openImageViewer(...)"
                            contentHtml = `
                                                                                                                                                                                                                                                                <div class="media-container">
                                                                                                                                                                                                                                                                    <img src="${imgSrc}"
                                                                                                                                                                                                                                                                         class="chat-media-img"
                                                                                                                                                                                                                                                                         onclick="openImageViewer('${imgSrc}')"
                                                                                                                                                                                                                                                                         referrerpolicy="no-referrer"
                                                                                                                                                                                                                                                                         onload="this.parentElement.style.background='transparent'"
                                                                                                                                                                                                                                                                         onerror="this.src='https://placehold.co/200x200?text=Error';">
                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                            `;
                        }
                        else if (msgType === 'video') {
                            // === –í–ò–î–ï–û (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –î–õ–Ø GOOGLE DRIVE) ===
                            // –ì—É–≥–ª –Ω–µ –¥–∞–µ—Ç —Å—Ç—Ä–∏–º–∏—Ç—å –≤–∏–¥–µ–æ –Ω–∞–ø—Ä—è–º—É—é –≤ —Ç–µ–≥ <video> –∏–∑-–∑–∞ CORS.
                            // –†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å iframe —Å —Ä–µ–∂–∏–º–æ–º /preview.

                            let fileId = null;

                            // 1. –ü—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å ID —Ñ–∞–π–ª–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Å—Å—ã–ª–æ–∫
                            if (m.txt.includes('id=')) {
                                try { fileId = m.txt.split('id=')[1].split('&')[0]; } catch (e) { }
                            }
                            else if (m.txt.includes('/file/d/')) {
                                try { fileId = m.txt.split('/file/d/')[1].split('/')[0]; } catch (e) { }
                            }

                            if (fileId) {
                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º iframe —Å /preview - —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–±
                                const embedUrl = `https://drive.google.com/file/d/${fileId}/preview`;

                                contentHtml = `
                                    <div class="media-container" style="position: relative; width: 300px; height: 170px; background: #000;">
                                        <iframe src="${embedUrl}" 
                                                width="100%" 
                                                height="100%" 
                                                frameborder="0" 
                                                allow="autoplay; encrypted-media; fullscreen" 
                                                allowfullscreen
                                                style="border-radius: 12px; pointer-events: auto;">
                                        </iframe>
                                        </div>
                                `;
                            } else {
                                // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–µ —Å –ì—É–≥–ª–∞ –∏–ª–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥
                                contentHtml = `
                                    <div class="media-container">
                                        <video src="${m.txt}" controls playsinline class="chat-media-video"></video>
                                    </div>
                                `;
                            }
                        }
                        else if (msgType === 'file') {
                            // –§–ê–ô–õ
                            contentHtml = `
                                                                                                                                                                                                                                                                <a href="${m.txt}" target="_blank" class="chat-file-card">
                                                                                                                                                                                                                                                                    <div class="file-icon">üìÑ</div>
                                                                                                                                                                                                                                                                    <div class="file-info">
                                                                                                                                                                                                                                                                        <div class="file-name">–°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</div>
                                                                                                                                                                                                                                                                        <div class="file-action">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                </a>
                                                                                                                                                                                                                                                            `;
                        }
                        else {
                            // –¢–ï–ö–°–¢
                            const txtWithLinks = m.txt.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:#4a9eff;text-decoration:underline;">$1</a>');
                            contentHtml = `<span class="msg-text">${txtWithLinks}</span>`;
                        }

                        // –ú–µ—Ç–∞
                        if (!m.sys) {
                            let metaStyle = "";
                            // –î–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏ –≤–∏–¥–µ–æ –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ –∫—Ä–∞—Å–∏–≤–µ–µ —Å–º–æ—Ç—Ä—è—Ç—Å—è –ø–æ–≤–µ—Ä—Ö, –≤ —É–≥–ª—É (–∫–∞–∫ –≤ –¢–ì)
                            if (msgType === 'image' || msgType === 'video') {
                                metaStyle = "position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.4); padding: 2px 8px; border-radius: 12px; backdrop-filter: blur(2px); pointer-events: none;";
                                // –î–æ–±–∞–≤–ª—è–µ–º position: relative –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É, –µ—Å–ª–∏ —ç—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞
                                contentHtml = `<div style="position: relative; display: inline-block;">${contentHtml}`;
                            }

                            let metaHtml = `
                                                                                                                                                                                                                                                                <span class="msg-meta" style="${metaStyle}">
                                                                                                                                                                                                                                                                    <span class="msg-time" style="color: rgba(255,255,255,0.9);">${timeStr}</span>
                                                                                                                                                                                                                                                                    ${m.from === currentUser.uid ? `<span class="msg-ticks" style="color: white;">${ticksHtml}</span>` : ''}
                                                                                                                                                                                                                                                                </span>
                                                                                                                                                                                                                                                            `;

                            if (msgType === 'image' || msgType === 'video') contentHtml += metaHtml + `</div>`; // –ó–∞–∫—Ä—ã–≤–∞–µ–º wrapper
                            else div.innerHTML = contentHtml + metaHtml;

                            if (msgType === 'image' || msgType === 'video') div.innerHTML = contentHtml; // –î–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ HTML —É–∂–µ —Å–æ–±—Ä–∞–Ω —Å –º–µ—Ç–æ–π
                        } else {
                            div.innerHTML = contentHtml;
                        }

                        if (isNew) {
                            list.appendChild(div);
                            hasNewMessages = true;
                        }
                    });

                    if (needCommit) batch.commit();

                    if (hasNewMessages) {
                        setTimeout(() => {
                            list.scrollTop = list.scrollHeight;
                        }, 50);
                    }
                });

            setTimeout(() => document.getElementById('msgInput').focus(), 100);
        }






        function closeChat() {
            // === –ù–û–í–û–ï: –ü—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º —Ö–µ—à ===
            // –≠—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä–Ω–µ—Ç —Å–æ–±—ã—Ç–∏–µ hashchange, –∫–æ—Ç–æ—Ä–æ–µ —Å–∞–º–æ –∑–∞–∫—Ä–æ–µ—Ç –æ–∫–Ω–∞
            if (window.location.hash) {
                history.pushState("", document.title, window.location.pathname + window.location.search);
                // –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ä—É—á–Ω—É—é, —á—Ç–æ–±—ã UI –æ–±–Ω–æ–≤–∏–ª—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
                handleHashChange();
            } else {
                // –ï—Å–ª–∏ —Ö–µ—à–∞ –∏ —Ç–∞–∫ –Ω–µ –±—ã–ª–æ, –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º UI (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
                performCloseUI();
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –¥–µ–ª–∞–µ—Ç –≥—Ä—è–∑–Ω—É—é —Ä–∞–±–æ—Ç—É –ø–æ —Å–∫—Ä—ã—Ç–∏—é
        function performCloseUI() {
            document.getElementById('mainSidebar').classList.remove('hidden-mobile');
            document.getElementById('mainChatArea').classList.remove('active');
            document.getElementById('activeChat').classList.add('hidden');
            document.getElementById('noChat').classList.remove('hidden');

            currentFriendId = null;
            currentChatId = null;

            if (msgUnsub) {
                msgUnsub();
                msgUnsub = null;
            }
        }


        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–∏–ø: 'text', 'image', 'file')
        function sendMsg(txt, isSys = false, type = 'text') {
            // –ï—Å–ª–∏ txt –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω (–æ–±—ã—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞), –±–µ—Ä–µ–º –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞
            const t = txt || document.getElementById('msgInput').value.trim();

            if (!t) return;

            const msgData = {
                txt: t,
                from: currentUser.uid,
                to: currentFriendId,
                sys: isSys,
                type: type, // <--- –í–ê–ñ–ù–û: –ú—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
                read: false,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('chats').doc(currentChatId).collection('msgs').add(msgData);

            // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç (–∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞), –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ
            if (!txt) {
                document.getElementById('msgInput').value = '';
                document.getElementById('sendBtn').style.display = 'none';
                document.querySelector('.voice-btn').style.display = 'flex';
                document.getElementById('msgInput').focus();
            }

            // –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
            if (!isSys && currentFriendId) {
                db.collection('users').doc(currentFriendId).get().then(doc => {
                    if (doc.exists) {
                        const friendData = doc.data();

                        // –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                        let notifText = t;
                        if (type === 'image') notifText = 'üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è';
                        if (type === 'file') notifText = 'üìÅ –§–∞–π–ª';
                        if (type === 'video') notifText = 'üé• –í–∏–¥–µ–æ'; // –ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –≤–∏–¥–µ–æ

                        // Telegram
                        if (friendData.tgChatId) {
                            sendTelegramNotification(friendData.tgChatId, `üì© *–°–æ–æ–±—â–µ–Ω–∏–µ*\n–û—Ç: ${currentUser.email}\n${notifText}`);
                        }

                        // Push (OneSignal) - –µ—Å–ª–∏ –µ—Å—Ç—å
                        if (friendData.oneSignalId && typeof sendPush === 'function') {
                            sendPush(currentFriendId, notifText);
                        }
                    }
                });
            }
        }

        function openActionSheet(msgId, isMine) {
            selectedMsgId = msgId; selectedMsgIsMine = isMine;
            document.getElementById('overlaySheet').style.display = 'block';
            setTimeout(() => { document.getElementById('actionSheet').classList.add('open'); }, 10);
        }
        function openDeleteSheet() {
            document.getElementById('actionSheet').classList.remove('open');
            const btnAll = document.getElementById('btnDelAll');
            btnAll.style.display = 'block';
            setTimeout(() => {
                document.getElementById('deleteSheet').classList.add('open');
            }, 100);
        }

        function openProfileSheet() {
            document.getElementById('overlaySheet').style.display = 'block';
            setTimeout(() => { document.getElementById('profileSheet').classList.add('open'); }, 10);
        }

        function confirmDelete(mode) {
            if (!selectedMsgId) return;
            if (mode === 'all') { db.collection('chats').doc(currentChatId).collection('msgs').doc(selectedMsgId).delete(); }
            else if (mode === 'me') {
                const el = document.getElementById(`msg-${selectedMsgId}`);
                if (el) el.style.display = 'none';
                const deletedLocal = JSON.parse(localStorage.getItem('deletedMsgs') || '[]');
                deletedLocal.push(selectedMsgId);
                localStorage.setItem('deletedMsgs', JSON.stringify(deletedLocal));
            }
            closeAllSheets();
        }

        function closeAllSheets() {
            document.getElementById('actionSheet').classList.remove('open');
            document.getElementById('deleteSheet').classList.remove('open');
            document.getElementById('profileSheet').classList.remove('open');
            setTimeout(() => { document.getElementById('overlaySheet').style.display = 'none'; }, 300);
            selectedMsgId = null;
        }

        function updateCallStatus(text) { document.getElementById('callStatusText').innerText = text; }

        function startTimer() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –±—ã–ª
            if (callTimerInt) clearInterval(callTimerInt);

            // –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å—Ç–∞—Ä—Ç–∞ –µ—â–µ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω–æ ‚Äî –∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å–µ–π—á–∞—Å
            if (!callStartTime) callStartTime = Date.now();

            const el = document.getElementById('callTimer');

            const tick = () => {
                // –°—á–∏—Ç–∞–µ–º —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É "—Å–µ–π—á–∞—Å" –∏ "—Å—Ç–∞—Ä—Ç–æ–º"
                const diff = Math.max(0, Date.now() - callStartTime);
                const totalSeconds = Math.floor(diff / 1000);

                const mm = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
                const ss = String(totalSeconds % 60).padStart(2, '0');

                el.innerText = `${mm}:${ss}`;
            };

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∏–∫–∞–Ω—å–µ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            tick();
            callTimerInt = setInterval(tick, 1000);
        }


        function setupPeerConnection() {
            candidateQueue = [];
            pc = new RTCPeerConnection(iceServers);
            pc.oniceconnectionstatechange = () => {
                if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
                    pc.getStats().then(stats => {
                        stats.forEach(report => {
                            if (report.type === 'candidate-pair' && report.state === 'succeeded') {
                                const local = stats.get(report.localCandidateId);
                                console.log(`üöÄ Connection: ${local.candidateType}`);
                            }
                        });
                    });
                }
            };
            pc.onicecandidate = e => { };
            pc.ontrack = e => {
                const remoteVid = document.getElementById('remoteVideo');
                remoteVid.muted = false;
                if (remoteVid.srcObject !== e.streams[0]) {
                    remoteVid.srcObject = e.streams[0];
                    remoteVid.play().catch(console.error);
                }
            };
            pc.onconnectionstatechange = () => {
                if (pc.connectionState === 'connected') {
                    isConnected = true; wasCallConnected = true; updateCallStatus("–í —Ä–∞–∑–≥–æ–≤–æ—Ä–µ");
                    stopAllTones(); startTimer(); startPing();
                } else if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                    endCall(false);
                }
            };
        }

        function startPing() {
            const el = document.getElementById('callPing');
            if (pingInterval) clearInterval(pingInterval);
            pingInterval = setInterval(async () => {
                if (!pc) return;
                const stats = await pc.getStats();
                let rtt = null;
                stats.forEach(r => {
                    if (r.type === 'candidate-pair' && r.state === 'succeeded' && r.currentRoundTripTime) { rtt = r.currentRoundTripTime; }
                });
                if (rtt) el.innerText = `Ping: ${(rtt * 1000).toFixed(0)} ms`;
            }, 2000);
        }

        async function addCandidateSafely(candidate) {
            if (!pc) return;
            if (pc.remoteDescription && pc.remoteDescription.type) { try { await pc.addIceCandidate(new RTCIceCandidate(candidate)); } catch (e) { } }
            else { candidateQueue.push(candidate); }
        }
        async function flushCandidateQueue() {
            if (!pc) return;
            for (const cand of candidateQueue) { try { await pc.addIceCandidate(new RTCIceCandidate(cand)); } catch (e) { } }
            candidateQueue = [];
        }

        function setLocalMirror(facing) {
            const v = document.getElementById('localVideo');
            if (!v) return;
            if (facing === 'user') v.classList.add('mirror');
            else v.classList.remove('mirror');
        }

        async function getStreamForFacing(facing, withAudio) {
            const audio = !!withAudio;

            // 1) –ø—Ä–æ–±—É–µ–º —Å—Ç—Ä–æ–≥–æ –Ω—É–∂–Ω—É—é –∫–∞–º–µ—Ä—É
            try {
                return await navigator.mediaDevices.getUserMedia({
                    audio,
                    video: { facingMode: { exact: facing } }
                });
            } catch (e1) { }

            // 2) –ø—Ä–æ–±—É–µ–º "–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ"
            try {
                return await navigator.mediaDevices.getUserMedia({
                    audio,
                    video: { facingMode: { ideal: facing } }
                });
            } catch (e2) {
                // 3) fallback: —á–µ—Ä–µ–∑ enumerateDevices + deviceId
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cams = devices.filter(d => d.kind === 'videoinput');
                if (!cams.length) throw e2;

                const cam = (facing === 'environment') ? cams[cams.length - 1] : cams[0];

                return await navigator.mediaDevices.getUserMedia({
                    audio,
                    video: { deviceId: { exact: cam.deviceId } }
                });
            }
        }

        async function getMedia() {
            try {
                localStream = await getStreamForFacing(currentFacingMode, true);

                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('localVideo').muted = true;

                setLocalMirror(currentFacingMode);

                // –∫–∞–∫ –±—ã–ª–æ —É —Ç–µ–±—è: –≤–∏–¥–µ–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω–æ, –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω
                localStream.getVideoTracks()[0].enabled = false;
                updateCamBtnUI(false);

                localStream.getAudioTracks()[0].enabled = true;
                updateMicBtnUI(true);

                localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            } catch (e) {
                console.error(e);
                alert("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä/–∫–∞–º–µ—Ä–µ");
            }
        }

        async function switchCamera() {
            if (!pc || !localStream) return;

            const sender = pc.getSenders().find(s => s.track && s.track.kind === 'video');
            if (!sender) return;

            // –µ—Å–ª–∏ —Å–µ–π—á–∞—Å —à–∞—Ä–∏–Ω–≥ —ç–∫—Ä–∞–Ω–∞ ‚Äî –≤–µ—Ä–Ω—ë–º—Å—è –Ω–∞ –∫–∞–º–µ—Ä—É
            if (sender.track && sender.track.label && sender.track.label.toLowerCase().includes('screen')) {
                stopScreen(sender);
            }

            const oldVideoTrack = localStream.getVideoTracks()[0];
            const wasEnabled = oldVideoTrack ? oldVideoTrack.enabled : true;

            const nextFacing = (currentFacingMode === 'user') ? 'environment' : 'user';

            // –≤–∞–∂–Ω–æ –¥–ª—è Android: –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞–º–µ—Ä—É
            if (oldVideoTrack) oldVideoTrack.stop();

            let newStream;
            try {
                newStream = await getStreamForFacing(nextFacing, false); // —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ
            } catch (e) {
                console.error(e);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É");
                return;
            }

            const newVideoTrack = newStream.getVideoTracks()[0];
            newVideoTrack.enabled = wasEnabled;

            // –∫–ª—é—á–µ–≤–æ–µ: –º–µ–Ω—è–µ–º –≤–∏–¥–µ–æ—Ç—Ä–µ–∫ –±–µ–∑ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –∑–≤–æ–Ω–∫–∞ [web:16]
            await sender.replaceTrack(newVideoTrack);

            // –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º localStream: —Å—Ç–∞—Ä—ã–π –∞—É–¥–∏–æ + –Ω–æ–≤—ã–π –≤–∏–¥–µ–æ
            const audioTrack = localStream.getAudioTracks()[0] || null;
            localStream = new MediaStream();
            if (audioTrack) localStream.addTrack(audioTrack);
            localStream.addTrack(newVideoTrack);

            document.getElementById('localVideo').srcObject = localStream;

            currentFacingMode = nextFacing;
            setLocalMirror(currentFacingMode);

            // —á–∏—Å—Ç–∏–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç—Ä–∏–º
            newStream.getTracks().forEach(t => {
                if (t !== newVideoTrack) t.stop();
            });
        }


        async function startCall() {
            if (currentCallId) {
                try {
                    const snap = await db.collection('calls').doc(currentCallId).get();
                    if (snap.exists) { return alert("–í—ã —É–∂–µ –≤ –∑–≤–æ–Ω–∫–µ!"); }
                    else { currentCallId = null; isConnected = false; }
                } catch (e) { currentCallId = null; }
            }
            if (isConnected) return alert("–í—ã —É–∂–µ –≤ –∑–≤–æ–Ω–∫–µ!");

            amICaller = true; wasCallConnected = false;
            const newCallId = [currentUser.uid, currentFriendId].sort().join('_');
            const callDoc = db.collection('calls').doc(newCallId);

            const snap = await callDoc.get();
            if (snap.exists && snap.data().caller !== currentUser.uid) { return alert("–õ–∏–Ω–∏—è –∑–∞–Ω—è—Ç–∞!"); }

            currentCallId = newCallId;
            document.getElementById('callScreen').style.display = 'flex';
            updateCallControlsVisibility();
            document.getElementById('callScreen').style.pointerEvents = 'auto';
            updateCallStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...");
            playConnectingTone();

            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–≤–æ–Ω–∫–µ –≤ –¢–µ–ª–µ–≥—Ä–∞–º
            if (currentFriendId) {
                db.collection('users').doc(currentFriendId).get().then(doc => {
                    if (doc.exists && doc.data().tgChatId) {
                        sendTelegramNotification(doc.data().tgChatId, `üìû *–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫*\n–û—Ç: ${currentUser.email}\n–ó–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–∞–π—Ç, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å!`);
                    }
                });
            }

            setupPeerConnection();
            pc.onicecandidate = e => { if (e.candidate) callDoc.collection('offerCandidates').add(e.candidate.toJSON()); };
            await getMedia();
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await callDoc.set({ offer: { type: offer.type, sdp: offer.sdp }, caller: currentUser.uid, status: 'dialing' });

            callDoc.onSnapshot(async snap => {
                if (!snap.exists) { endCall(false, true); return; }
                const data = snap.data();
                if (data.status === 'ringing' && !isConnected) { updateCallStatus("–ó–≤–æ–Ω–æ–∫..."); playRingingTone(); }
                if (pc && !pc.currentRemoteDescription && data && data.answer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    flushCandidateQueue();
                }
            });
            callDoc.collection('answerCandidates').onSnapshot(snap => {
                snap.docChanges().forEach(change => { if (change.type === 'added') addCandidateSafely(change.doc.data()); });
            });
        }

        async function answerCall() {
            amICaller = false; wasCallConnected = false;
            document.getElementById('ringtone').pause();
            document.getElementById('incomingPopup').style.display = 'none';
            document.getElementById('callScreen').style.display = 'flex';
            updateCallControlsVisibility();
            document.getElementById('callScreen').style.pointerEvents = 'auto';
            updateCallStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...");
            const callDoc = db.collection('calls').doc(currentCallId);
            const data = (await callDoc.get()).data();
            setupPeerConnection();
            pc.onicecandidate = e => { if (e.candidate) callDoc.collection('answerCandidates').add(e.candidate.toJSON()); };
            await getMedia();
            await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
            flushCandidateQueue();
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await callDoc.update({ answer: { type: answer.type, sdp: answer.sdp }, status: 'connected' });
            callDoc.onSnapshot(snap => { if (!snap.exists) endCall(false, true); });
            callDoc.collection('offerCandidates').onSnapshot(snap => {
                snap.docChanges().forEach(change => { if (change.type === 'added') addCandidateSafely(change.doc.data()); });
            });
        }

        function toggleMic() {
            if (!localStream) return;
            const track = localStream.getAudioTracks()[0]; track.enabled = !track.enabled; updateMicBtnUI(track.enabled);
        }
        function updateMicBtnUI(enabled) {
            const btn = document.getElementById('btnMic'); const lbl = document.getElementById('lblMic');
            if (enabled) { btn.classList.remove('btn-active-white'); btn.innerHTML = 'üé§'; lbl.innerText = '–í—ã–∫–ª. –∑–≤—É–∫'; }
            else { btn.classList.add('btn-active-white'); btn.innerHTML = 'üîá'; lbl.innerText = '–í–∫–ª. –∑–≤—É–∫'; }
        }
        function toggleCamera() {
            if (!localStream) return;
            const sender = pc.getSenders().find(s => s.track.kind === 'video');
            if (sender && sender.track.label.includes('screen')) stopScreen(sender);
            const track = localStream.getVideoTracks()[0]; track.enabled = !track.enabled; updateCamBtnUI(track.enabled);
        }
        function updateCamBtnUI(enabled) {
            const btn = document.getElementById('btnCam'); const lbl = document.getElementById('lblCam');
            if (enabled) { btn.classList.add('btn-active-white'); btn.innerHTML = 'üì∑'; lbl.innerText = '–í—ã–∫–ª. –≤–∏–¥–µ–æ'; }
            else { btn.classList.remove('btn-active-white'); btn.innerHTML = 'üìµ'; lbl.innerText = '–í–∫–ª. –≤–∏–¥–µ–æ'; }
        }
        async function toggleScreen() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if (isIOS) { alert("–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞ iPhone."); return; }
            if (!localStream) return;
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const screenTrack = stream.getVideoTracks()[0];
                const sender = pc.getSenders().find(s => s.track.kind === 'video');
                if (sender) {
                    sender.replaceTrack(screenTrack);
                    document.getElementById('localVideo').srcObject = stream;
                    const btn = document.getElementById('btnScr'); const lbl = document.getElementById('lblScr');
                    btn.classList.add('btn-screen-on'); lbl.innerText = '–û—Å—Ç. —Å—Ç—Ä–∏–º';
                    screenTrack.onended = () => stopScreen(sender);
                }
            } catch (e) { console.log(e); }
        }
        function stopScreen(sender) {
            const camTrack = localStream.getVideoTracks()[0];
            sender.replaceTrack(camTrack);
            document.getElementById('localVideo').srcObject = localStream;
            const btn = document.getElementById('btnScr'); const lbl = document.getElementById('lblScr');
            btn.classList.remove('btn-screen-on'); lbl.innerText = '–≠–∫—Ä–∞–Ω';
        }

        function listenForIncomingCalls() {
            db.collection('calls').where('caller', '!=', currentUser.uid).onSnapshot(snap => {
                snap.docChanges().forEach(change => {
                    if (change.type === "added") {
                        if (change.doc.id.includes(currentUser.uid)) {
                            if (currentCallId) {
                                console.log("Ignored incoming call because busy");
                                return;
                            }
                            currentCallId = change.doc.id;

                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É
                            const popup = document.getElementById('incomingPopup');
                            popup.style.display = 'flex';
                            document.getElementById('ringtone').play().catch(() => { });

                            db.collection('calls').doc(currentCallId).update({ status: 'ringing' }).catch(() => { });

                            const data = change.doc.data();
                            const callerId = data.caller;

                            // –°—Å—ã–ª–∫–∞ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç –∏–º–µ–Ω–∏
                            const nameEl = document.getElementById('callerName');
                            nameEl.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞..."; // –°–±—Ä–æ—Å –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

                            // --- –ò–ó–ú–ï–ù–ï–ù–ò–Ø –ó–î–ï–°–¨: –ó–ê–ì–†–£–ó–ö–ê –ò–ú–ï–ù–ò, –§–ê–ú–ò–õ–ò–ò –ò –ê–í–ê–¢–ê–†–ö–ò ---
                            db.collection('users').doc(callerId).get().then(userDoc => {
                                if (userDoc.exists) {
                                    const u = userDoc.data();

                                    // 1. –§–æ—Ä–º–∏—Ä—É–µ–º –ò–º—è + –§–∞–º–∏–ª–∏—è
                                    // –ï—Å–ª–∏ —Ñ–∞–º–∏–ª–∏–∏ –Ω–µ—Ç, –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ –∏–º—è. trim() —É–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã.
                                    let fullName = `${u.name || ''} ${u.surname || ''}`.trim();

                                    // –ï—Å–ª–∏ –∏ –∏–º–µ–Ω–∏ –Ω–µ—Ç, –±–µ—Ä–µ–º –Ω–∏–∫–Ω–µ–π–º –∏–ª–∏ –∑–∞–≥–ª—É—à–∫—É
                                    if (!fullName) fullName = u.username ? `@${u.username}` : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";

                                    // 2. –õ–æ–≥–∏–∫–∞ –ê–≤–∞—Ç–∞—Ä–∫–∏
                                    let avatarHtml;
                                    if (u.avatar) {
                                        // –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ç–æ
                                        avatarHtml = `<img src="${u.avatar}" style="width:42px; height:42px; border-radius:50%; object-fit:cover; margin-right:12px;">`;
                                    } else {
                                        // –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ - –¥–µ–ª–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π –∫—Ä—É–∂–æ–∫ —Å –ø–µ—Ä–≤–æ–π –±—É–∫–≤–æ–π (–°—Ç–∏–ª—å Telegram)
                                        const firstLetter = fullName.charAt(0).toUpperCase();
                                        avatarHtml = `<div style="width:42px; height:42px; border-radius:50%; background: linear-gradient(135deg, #6a11cb, #2575fc); color:white; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px; margin-right:12px; border: 1px solid #444;">${firstLetter}</div>`;
                                    }

                                    // 3. –§–æ—Ä–º–∏—Ä—É–µ–º HTML "–∫–∞–∫ –≤ –¢–µ–ª–µ–≥—Ä–∞–º–µ"
                                    // –°–≤–µ—Ä—Ö—É –∏–º—è (–±–µ–ª–æ–µ, –∂–∏—Ä–Ω–æ–µ), —Å–Ω–∏–∑—É "Telegram Audio..." (–≥–æ–ª—É–±–æ–≤–∞—Ç–æ–µ/—Å–µ—Ä–æ–µ)
                                    nameEl.innerHTML = `
                                                                                                                                                                                                                                                                                    <div style="display:flex; align-items:center;">
                                                                                                                                                                                                                                                                                        ${avatarHtml}
                                                                                                                                                                                                                                                                                        <div style="display:flex; flex-direction:column; align-items:flex-start; justify-content:center;">
                                                                                                                                                                                                                                                                                            <span style="font-size: 15px; font-weight: 600; color: white; line-height: 1.2;">${fullName}</span>
                                                                                                                                                                                                                                                                                            <span style="font-size: 13px; color: #8faebf; font-weight: normal; margin-top: 2px;">Telegram Audio...</span>
                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                `;

                                } else {
                                    nameEl.innerText = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –Ω–æ–º–µ—Ä";
                                }
                            }).catch(err => {
                                console.error(err);
                                nameEl.innerText = "–û—à–∏–±–∫–∞ ID";
                            });
                            // -------------------------------------------------------------
                        }
                    }
                    if (change.type === "removed") {
                        if (currentCallId === change.doc.id) {
                            endCall(false, true);
                        }
                    }
                });
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –≤—Ö–æ–¥—è—â–µ–≥–æ –≤—ã–∑–æ–≤–∞
        function rejectCall() {
            // 1. –í—ã–∫–ª—é—á–∞–µ–º –∑–≤—É–∫
            document.getElementById('ringtone').pause();
            document.getElementById('ringtone').currentTime = 0;

            // 2. –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
            document.getElementById('incomingPopup').style.display = 'none';

            // 3. –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫ (ID –∑–≤–æ–Ω–∫–∞)
            if (currentCallId) {
                // –£–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –∑–≤–æ–Ω–∫–∞ –∏–∑ –±–∞–∑—ã (—ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç –∑–≤–æ–Ω–æ–∫ –∏ —É –∑–≤–æ–Ω—è—â–µ–≥–æ)
                db.collection('calls').doc(currentCallId).delete()
                    .then(() => {
                        console.log("–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω");
                    })
                    .catch(error => {
                        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏:", error);
                    });

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                currentCallId = null;
            }
        }



        function endCallUser() { endCall(true, false); }
        function endCall(isInitiator = true, isRemote = false) {
            document.getElementById('ringtone').pause();
            document.getElementById('ringtone').currentTime = 0;
            stopAllTones();

            if (amICaller) {
                if (wasCallConnected && isConnected) {
                    const time = document.getElementById('callTimer').innerText;
                    sendMsg(`üìû –ó–≤–æ–Ω–æ–∫: ${time}`, true);
                } else if (!wasCallConnected) {
                    if (isInitiator && !isRemote) { sendMsg(`üìû –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫`, true); }
                    else {
                        sendMsg(`üìû –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫`, true);
                        if (currentFriendId) {
                            db.collection('users').doc(currentFriendId).get().then(doc => {
                                if (doc.exists && doc.data().tgChatId) {
                                    sendTelegramNotification(doc.data().tgChatId, `‚ùå *–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫*\n–û—Ç: ${currentUser.email}`);
                                }
                            });
                        }
                    }
                }
            }
            if (pc) pc.close();
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            if (callTimerInt) clearInterval(callTimerInt);
            if (pingInterval) clearInterval(pingInterval);

            const statusText = document.getElementById('callStatusText');
            statusText.innerText = "–ó–í–û–ù–û–ö –ó–ê–í–ï –®–ï–ù"; statusText.style.color = "#ff4444"; statusText.style.fontWeight = "bold";
            playEndTone();
            const screen = document.getElementById('callScreen'); screen.style.pointerEvents = 'none';
            document.getElementById('incomingPopup').style.display = 'none';
            if (isInitiator && currentCallId) { db.collection('calls').doc(currentCallId).delete().catch(() => { }); }

            pc = null; localStream = null; candidateQueue = []; isConnected = false; currentCallId = null; wasCallConnected = false; amICaller = false;
            setTimeout(() => {
                screen.style.display = 'none';
                document.getElementById('callTimer').innerText = "00:00";
                document.getElementById('callPing').innerText = "Ping: -";
                statusText.style.color = "#ccc"; statusText.style.fontWeight = "normal";
            }, 1500);
        }

        function saveTgId() {
            const id = document.getElementById('tgChatId').value.trim();
            if (!id) return alert("–í–≤–µ–¥–∏—Ç–µ ID!");
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).set({ tgChatId: id }, { merge: true }).then(() => {
                    alert("ID —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
                    sendTelegramNotification(id, "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!");
                });
            }
        }
        function loadTgId() {
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).get().then(doc => {
                    if (doc.exists && doc.data().tgChatId) { document.getElementById('tgChatId').value = doc.data().tgChatId; }
                });
            }
        }
        function sendTelegramNotification(targetChatId, text) {
            if (!targetChatId) return;
            const token = getTgToken();
            const url = `https://api.telegram.org/bot${token}/sendMessage`;
            const params = { chat_id: targetChatId, text: text, parse_mode: 'Markdown' };
            fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(params) }).catch(err => console.error(err));
        }

        // --- –õ–û–ì–ò–ö–ê –ü–†–û–§–ò–õ–Ø ---

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∏–∫–Ω–µ–π–º–∞ (—Ç–æ–ª—å–∫–æ –∞–Ω–≥–ª, —Ü–∏—Ñ—Ä—ã, _ –∏ .)
        function validateUsername(input) {
            input.value = input.value.replace(/[^a-zA-Z0-9_.]/g, '');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∂–∞—Ç–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞
        let currentAvatarBase64 = null;

        function handleAvatarSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
                if (!file.type.match('image.*')) {
                    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.");
                    return;
                }

                const reader = new FileReader();

                reader.onload = function (e) {
                    const img = new Image();
                    img.src = e.target.result;

                    img.onload = function () {
                        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∂–∞—Ç–∏—è
                        const MAX_WIDTH = 300; // –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä –¥–æ 300px (–¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
                        const MAX_HEIGHT = 300;
                        let width = img.width;
                        let height = img.height;

                        // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        // –†–∏—Å—É–µ–º –Ω–∞ Canvas –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // –ü–æ–ª—É—á–∞–µ–º —Å–∂–∞—Ç—É—é Base64 —Å—Ç—Ä–æ–∫—É (JPEG —Å –∫–∞—á–µ—Å—Ç–≤–æ–º 0.7)
                        // –≠—Ç–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–º–µ–Ω—å—à–∏—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞!
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);

                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
                        currentAvatarBase64 = compressedDataUrl;

                        const preview = document.getElementById('profileAvatarPreview');
                        const placeholder = document.getElementById('profileAvatarPlaceholder');

                        preview.src = compressedDataUrl;
                        preview.style.display = 'block';
                        placeholder.style.display = 'none';
                    };
                };

                reader.readAsDataURL(file);
            }
        }


        // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        async function saveProfile() {
            const username = document.getElementById('profileUsername').value.trim();
            const name = document.getElementById('profileName').value.trim();
            const surname = document.getElementById('profileSurname').value.trim();
            const birthdate = document.getElementById('profileBirthdate').value;
            const tgId = document.getElementById('tgChatId').value.trim();

            if (!name) {
                alert("–ò–º—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è!");
                return;
            }

            if (!username) {
                alert("–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (@)!");
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–Ω–µ–π–º–∞
            // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ç–∞–∫–∏–º –∂–µ –Ω–∏–∫–Ω–µ–π–º–æ–º, –Ω–æ –ù–ï —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const snap = await db.collection('users')
                .where('username', '==', username)
                .get();

            let isTaken = false;
            snap.forEach(doc => {
                if (doc.id !== currentUser.uid) isTaken = true;
            });

            if (isTaken) {
                alert("–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!");
                return;
            }

            // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const updateData = {
                name: name,
                surname: surname,
                username: username,
                birthdate: birthdate,
                tgChatId: tgId
            };

            // –ï—Å–ª–∏ –º–µ–Ω—è–ª–∏ –∞–≤–∞—Ç–∞—Ä–∫—É, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë
            if (currentAvatarBase64) {
                updateData.avatar = currentAvatarBase64;
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore
            db.collection('users').doc(currentUser.uid).set(updateData, { merge: true })
                .then(() => {
                    alert("–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
                    closeAllSheets();
                })
                .catch(err => {
                    console.error(err);
                    alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + err.message);
                });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ–ª—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è
        function openProfileSheet() {
            document.getElementById('overlaySheet').style.display = 'block';
            setTimeout(() => document.getElementById('profileSheet').classList.add('open'), 10);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                if (doc.exists) {
                    const d = doc.data();
                    document.getElementById('profileEmail').innerText = d.email;
                    document.getElementById('profileUsername').value = d.username || '';
                    document.getElementById('profileName').value = d.name || '';
                    document.getElementById('profileSurname').value = d.surname || '';
                    document.getElementById('profileBirthdate').value = d.birthdate || '';
                    document.getElementById('tgChatId').value = d.tgChatId || '';

                    if (d.avatar) {
                        const img = document.getElementById('profileAvatarPreview');
                        const ph = document.getElementById('profileAvatarPlaceholder');
                        img.src = d.avatar;
                        img.style.display = 'block';
                        ph.style.display = 'none';
                    }
                }
            });
        }
        document.addEventListener('keydown', function (event) {
            if (event.key === "Escape" && currentChatId) {
                closeChat();
            }
        });

        const msgInput = document.getElementById('msgInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.querySelector('.voice-btn');

        msgInput.addEventListener('input', function () {
            if (this.value.trim().length > 0) {
                sendBtn.classList.remove('hidden'); // <-- –ò–°–ü–†–ê–í–õ–ï–ù–û (–±—ã–ª–æ hidden-btn)
                sendBtn.style.display = 'flex';      // –¢–µ–ø–µ—Ä—å —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
                voiceBtn.style.display = 'none';
            } else {
                sendBtn.classList.add('hidden');    // <-- –ò–°–ü–†–ê–í–õ–ï–ù–û
                sendBtn.style.display = 'none';
                voiceBtn.style.display = 'flex';
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –ø–æ Enter
        msgInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMsg();
            }
        });

        // --- –ê–í–¢–û–ü–û–í–û–†–û–¢ –û–ö–û–®–ö–ê –°–í–û–ï–ì–û –í–ò–î–ï–û ---
        // --- PIP: drag + resize (–∫—Ä–∞—Å–∏–≤–æ –∏ –±–µ–∑ –±–∞–≥–æ–≤) ---
        const localVidEl = document.getElementById('localVideo');
        const pipEl = document.getElementById('localPip');              // –Ω–æ–≤—ã–π id
        const gridEl = document.querySelector('.video-grid');
        const controlsEl = document.querySelector('.controls');
        const resizeHandleEl = pipEl.querySelector('.pip-resize-handle');

        const PIP_STORAGE_KEY = 'pipState_v3';

        let pipRatio = 2 / 3;      // width/height, –¥–µ—Ñ–æ–ª—Ç –∫–∞–∫ —É —Ç–µ–±—è 140x210
        let pipUserSized = false;  // —Å—Ç–∞–Ω–µ—Ç true –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ —Ä–µ—Å–∞–π–∑–∞

        function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

        function getBounds() {
            const gridRect = gridEl.getBoundingClientRect();
            const controlsRect = controlsEl.getBoundingClientRect();

            const margin = 12;

            // bottomLimit: –Ω–µ –¥–∞—ë–º –∑–∞–ª–µ–∑–∞—Ç—å –ø–æ–¥ controls (–æ–Ω–∏ absolute –∏ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—Ç –Ω–∏–∑)
            const bottomLimit = Math.min(gridRect.bottom, controlsRect.top) - gridRect.top - margin;

            return {
                minLeft: margin,
                minTop: margin,
                maxLeft: gridRect.width - margin,
                maxTop: bottomLimit
            };
        }

        function readPipRect() {
            return {
                left: parseFloat(pipEl.style.left || '0'),
                top: parseFloat(pipEl.style.top || '0'),
                width: parseFloat(pipEl.style.width || pipEl.offsetWidth),
                height: parseFloat(pipEl.style.height || pipEl.offsetHeight)
            };
        }

        function applyPipRect(rect, { save = true } = {}) {
            const b = getBounds();

            const minW = 110;
            const maxW = Math.max(minW, b.maxLeft - b.minLeft);
            const width = clamp(rect.width, minW, maxW);

            // –≤—ã—Å–æ—Ç—É –¥–µ—Ä–∂–∏–º –ø–æ ratio (—á—Ç–æ–±—ã –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–ª–æ—Å—å)
            const height = Math.max(90, Math.round(width / pipRatio));

            const maxLeft = Math.max(b.minLeft, b.maxLeft - width);
            const maxTop = Math.max(b.minTop, b.maxTop - height);

            const left = clamp(rect.left, b.minLeft, maxLeft);
            const top = clamp(rect.top, b.minTop, maxTop);

            // –≤–∞–∂–Ω–æ–µ: –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ left/top, —á—Ç–æ–±—ã drag/resize –±—ã–ª–∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º–∏
            pipEl.style.left = `${Math.round(left)}px`;
            pipEl.style.top = `${Math.round(top)}px`;
            pipEl.style.right = 'auto';
            pipEl.style.bottom = 'auto';
            pipEl.style.width = `${Math.round(width)}px`;
            pipEl.style.height = `${Math.round(height)}px`;

            if (save) {
                const state = { left: Math.round(left), top: Math.round(top), width: Math.round(width), ratio: pipRatio, userSized: pipUserSized };
                localStorage.setItem(PIP_STORAGE_KEY, JSON.stringify(state));
            }
        }

        function setDefaultPip() {
            const gridRect = gridEl.getBoundingClientRect();
            const controlsRect = controlsEl.getBoundingClientRect();
            const controlsH = Math.max(0, gridRect.bottom - controlsRect.top);

            const defW = (pipRatio >= 1) ? 210 : 140;   // –ø–æ—Ö–æ–∂–µ –Ω–∞ —Ç–≤–æ—é —Ç–µ–∫—É—â—É—é –ª–æ–≥–∏–∫—É landscape [–ø–æ —Å–º—ã—Å–ª—É]
            const left = gridRect.width - defW - 20;
            const top = gridRect.height - controlsH - Math.round(defW / pipRatio) - 160; // —Ç–≤–æ–π bottom:160 [–ø–æ —Å–º—ã—Å–ª—É]
            pipUserSized = false;
            applyPipRect({ left, top, width: defW, height: defW / pipRatio }, { save: true });
        }

        function loadPipState() {
            try {
                const raw = localStorage.getItem(PIP_STORAGE_KEY);
                if (!raw) return false;
                const s = JSON.parse(raw);

                if (typeof s.ratio === 'number' && isFinite(s.ratio) && s.ratio > 0.1) pipRatio = s.ratio;
                pipUserSized = !!s.userSized;

                applyPipRect({ left: s.left ?? 0, top: s.top ?? 0, width: s.width ?? 140, height: 0 }, { save: false });
                return true;
            } catch (_) {
                return false;
            }
        }

        function updateRatioFromVideo() {
            if (localVidEl.videoWidth && localVidEl.videoHeight) {

                const w = localVidEl.videoWidth;
                const h = localVidEl.videoHeight;

                // –õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ –≤–∏–¥–µ–æ —à–∏—Ä–æ–∫–æ–µ (–ü–ö) -> –¥–µ–ª–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (2:3)
                // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –≤—ã—Å–æ–∫–æ–µ (–¢–µ–ª–µ—Ñ–æ–Ω) -> –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
                if (w > h) {
                    pipRatio = 2 / 3;
                } else {
                    pipRatio = w / h;
                }

                // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã
                let currentWidth = parseFloat(pipEl.style.width) || 140;
                let newHeight = currentWidth / pipRatio;

                // –ó–∞—â–∏—Ç–∞ –æ—Ç –≥–ª—é–∫–æ–≤: –µ—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ –ø–æ–ª—É—á–∏–ª–∞—Å—å —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–π, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º
                if (newHeight < 100) newHeight = currentWidth * 1.5;

                applyPipRect({ width: currentWidth, height: newHeight }, true);
            }
        }



        // 1) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∑–∏—Ü–∏–∏/—Ä–∞–∑–º–µ—Ä–∞
        (function initPip() {
            // –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ bottom/right (–∏–∑ CSS) –≤ left/top, —á—Ç–æ–±—ã –¥–∞–ª—å—à–µ –±—ã–ª–æ —Å—Ç–∞–±–∏–ª—å–Ω–æ
            // –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ‚Äî –æ–Ω–æ –≥–ª–∞–≤–Ω–µ–µ
            const hasState = loadPipState();
            if (!hasState) setDefaultPip();

            // –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–≤—Ç–æ-–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ –±–µ–∑ –¥–µ—Ä–≥–∞–Ω–∏–π
            localVidEl.addEventListener('loadedmetadata', () => {
                updateRatioFromVideo();
                // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–µ–Ω—è–ª —Ä–∞–∑–º–µ—Ä ‚Äî –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç –ø–æ–¥ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—é
                if (!pipUserSized) setDefaultPip();
            });

            // –∫–æ–≥–¥–∞ –º–µ–Ω—è–µ—Ç—Å—è viewport (–ø–æ–≤–æ—Ä–æ—Ç/resize –æ–∫–Ω–∞) ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–∂–∏–º–∞–µ–º –≤ –≥—Ä–∞–Ω–∏—Ü—ã
            window.addEventListener('resize', () => applyPipRect(readPipRect(), { save: true }));
        })();

        // 2) Drag
        let drag = null;

        pipEl.addEventListener('pointerdown', (e) => {
            if (e.button !== 0) return;
            if (e.target === resizeHandleEl) return; // resize –æ—Ç–¥–µ–ª—å–Ω–æ

            e.preventDefault();
            pipEl.classList.add('dragging');
            pipEl.setPointerCapture(e.pointerId);

            const r = readPipRect();
            drag = {
                id: e.pointerId,
                startX: e.clientX,
                startY: e.clientY,
                startLeft: r.left,
                startTop: r.top,
                width: r.width,
                height: r.height
            };
        });

        pipEl.addEventListener('pointermove', (e) => {
            if (!drag || drag.id !== e.pointerId) return;

            const dx = e.clientX - drag.startX;
            const dy = e.clientY - drag.startY;

            applyPipRect({
                left: drag.startLeft + dx,
                top: drag.startTop + dy,
                width: drag.width,
                height: drag.height
            }, { save: false });
        });

        pipEl.addEventListener('pointerup', (e) => {
            if (!drag || drag.id !== e.pointerId) return;
            pipEl.classList.remove('dragging');
            drag = null;
            applyPipRect(readPipRect(), { save: true });
        });

        // 3) Resize (—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º aspect ratio)
        let resize = null;

        resizeHandleEl.addEventListener('pointerdown', (e) => {
            if (e.button !== 0) return;
            e.preventDefault();

            pipEl.classList.add('resizing');
            pipEl.setPointerCapture(e.pointerId);

            const r = readPipRect();
            resize = {
                id: e.pointerId,
                startX: e.clientX,
                startY: e.clientY,
                startW: r.width,
                startLeft: r.left,
                startTop: r.top
            };
        });

        pipEl.addEventListener('pointermove', (e) => {
            if (!resize || resize.id !== e.pointerId) return;

            const dx = e.clientX - resize.startX;
            const dy = e.clientY - resize.startY;

            // –±–µ—Ä—ë–º ‚Äú–Ω–∞–∏–±–æ–ª–µ–µ —Å–∏–ª—å–Ω–æ–µ‚Äù –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ
            const grow = Math.max(dx, dy * pipRatio);
            const newW = resize.startW + grow;

            pipUserSized = true;

            applyPipRect({
                left: resize.startLeft,
                top: resize.startTop,
                width: newW,
                height: 0
            }, { save: false });
        });

        pipEl.addEventListener('pointerup', (e) => {
            if (!resize || resize.id !== e.pointerId) return;
            pipEl.classList.remove('resizing');
            resize = null;
            applyPipRect(readPipRect(), { save: true });
        });

        // 4) –ë—ã—Å—Ç—Ä—ã–π —Å–±—Ä–æ—Å (–¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ / –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø)
        pipEl.addEventListener('dblclick', () => setDefaultPip());


        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–æ–≤ –≤–∏–¥–µ–æ
        localVidEl.addEventListener('loadedmetadata', checkLocalVideoOrientation);
        localVidEl.addEventListener('resize', checkLocalVideoOrientation);

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function checkLocalVideoOrientation() {
            if (!localStream) return;
            const videoTrack = localStream.getVideoTracks()[0];
            if (videoTrack) {
                const settings = videoTrack.getSettings();
                // –õ–æ–≥–∏–∫–∞ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥–ª—É—à–∫–∞, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞–ª–æ
                console.log("Orientation check:", settings.width, settings.height);
            }
        }



        function updateCallControlsVisibility() {
            const isMobile = isMobileDevice();

            // –ò—â–µ–º –∫–Ω–æ–ø–∫–∏
            const btnFlip = document.getElementById('btnFlip');
            const btnScr = document.getElementById('btnScr');

            // –ò—â–µ–º –∏—Ö —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ .control-item
            const flipItem = btnFlip ? btnFlip.closest('.control-item') : null;
            const scrItem = btnScr ? btnScr.closest('.control-item') : null;

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å —Å–∫—Ä—ã—Ç–∏—è:
            // - –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Ä–∞–Ω–∞ (btnScr) —Å–∫—Ä—ã—Ç–∞ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ
            // - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã (btnFlip) —Å–∫—Ä—ã—Ç–æ –Ω–∞ –ü–ö
            if (scrItem) {
                if (isMobile) {
                    scrItem.classList.add('control-item-hidden');
                } else {
                    scrItem.classList.remove('control-item-hidden');
                }
            }

            if (flipItem) {
                if (isMobile) {
                    flipItem.classList.remove('control-item-hidden');
                } else {
                    flipItem.classList.add('control-item-hidden');
                }
            }

            console.log('[updateCallControls] isMobile:', isMobile, '| scrItem —Å–∫—Ä—ã—Ç–∞:', scrItem?.classList.contains('control-item-hidden'), '| flipItem —Å–∫—Ä—ã—Ç–∞:', flipItem?.classList.contains('control-item-hidden'));
        }



    </script>

    <script>
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(function (OneSignal) {
            OneSignal.init({
                appId: "6af8818f-ba3a-40c4-b820-5235c1d73925", // –¢–≤–æ–π App ID
            });

            function savePlayerId() {
                if (OneSignal.User.PushSubscription.optedIn) {
                    const oneSignalId = OneSignal.User.PushSubscription.id;
                    const user = firebase.auth().currentUser;
                    if (user && oneSignalId) {
                        console.log("–°–æ—Ö—Ä–∞–Ω—è–µ–º OneSignal ID:", oneSignalId);
                        db.collection('users').doc(user.uid).update({ oneSignalId: oneSignalId }).catch(e => { });
                    }
                }
            }
            OneSignal.User.PushSubscription.addEventListener("change", savePlayerId);
            firebase.auth().onAuthStateChanged(u => { if (u) setTimeout(savePlayerId, 3000); });
        });

        // 2. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—É—à–∞ (–° –û–ë–•–û–î–û–ú –ë–õ–û–ö–ò–†–û–í–ö–ò)
        async function sendPush(friendUid, text) {
            if (!text || !friendUid) return;

            try {
                const doc = await db.collection('users').doc(friendUid).get();
                if (!doc.exists) {
                    console.warn("–î—Ä—É–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ");
                    return;
                }

                const friendData = doc.data();
                if (!friendData.oneSignalId) {
                    console.warn("–£ –¥—Ä—É–≥–∞ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –ø—É—à–∏ (–Ω–µ—Ç oneSignalId)");
                    return;
                }

                const APP_ID = "6af8818f-ba3a-40c4-b820-5235c1d73925";

                // === –í–°–¢–ê–í–¨ –°–í–û–ô –ù–û–í–´–ô –ö–õ–Æ–ß –ó–î–ï–°–¨ (–†–ê–ó–ë–ï–ô –ü–û–ü–û–õ–ê–ú) ===
                // –ü—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ –∫–ª—é—á "abcdef123456", —Ç–æ part1="abcdef", part2="123456"
                const part1 = "os_v2_app_nl4idd52hjamjobaki24dvzzevtckajbeoiez";
                const part2 = "o5skyl56k5y25jzh3fgf4b2yimz2osr5nvjkz3yx5fct6xpnv6qfl6fob6736ne3pi";
                const API_KEY = part1 + part2;
                // =======================================================

                console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—É—à –¥—Ä—É–≥—É:", friendUid);

                await fetch("https://onesignal.com/api/v1/notifications", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json; charset=utf-8",
                        "Authorization": "Basic " + API_KEY
                    },
                    body: JSON.stringify({
                        app_id: APP_ID,
                        include_player_ids: [friendData.oneSignalId],
                        headings: { en: "–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" }, // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                        contents: { en: text },
                        url: "https://novogram21.github.io"
                    })
                });
                console.log("–ü—É—à —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—É—à–∞:", e);
            }
        }

        // 3. –ü–ï–†–ï–•–í–ê–¢–ß–ò–ö –û–¢–ü–†–ê–í–ö–ò (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π)
        document.addEventListener("DOMContentLoaded", () => {
            const btn = document.getElementById('sendBtn');
            const input = document.getElementById('msgInput');

            if (btn && input) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'mousedown', —á—Ç–æ–±—ã —Å—Ä–∞–±–æ—Ç–∞—Ç—å –î–û —Ç–æ–≥–æ, –∫–∞–∫ –ø–æ–ª–µ –æ—á–∏—Å—Ç–∏—Ç—Å—è
                btn.addEventListener('mousedown', () => {
                    const text = input.value.trim();
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç –∏ –≤—ã–±—Ä–∞–Ω –¥—Ä—É–≥
                    if (text !== '' && typeof currentFriendId !== 'undefined') {
                        sendPush(currentFriendId, text);
                    }
                });

                // –î–ª—è Enter (keydown –Ω–∞–¥–µ–∂–Ω–µ–µ)
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && input.value.trim() !== '' && typeof currentFriendId !== 'undefined') {
                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞, –±–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ä–∞–∑—É
                        sendPush(currentFriendId, input.value.trim());
                    }
                });
            }
        });



        // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        async function logout() {
            if (!confirm("–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?")) return;

            const user = firebase.auth().currentUser;
            if (user) {
                try {
                    // –£–¥–∞–ª—è–µ–º ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ –±–∞–∑—ã, —á—Ç–æ–±—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å—é–¥–∞ –±–æ–ª—å—à–µ –Ω–µ —à–ª–∏
                    await db.collection('users').doc(user.uid).update({
                        oneSignalId: firebase.firestore.FieldValue.delete()
                    });
                    console.log("Push ID —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.");
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ Push ID (–≤–æ–∑–º–æ–∂–Ω–æ, –µ–≥–æ –∏ –Ω–µ –±—ã–ª–æ):", e);
                }
            }

            // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É –≤—Ö–æ–¥–∞ –∏ –≤—ã—Ö–æ–¥–∏–º
            localStorage.removeItem('isLoggedIn');
            auth.signOut().then(() => {
                window.location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            });
        }


        // === –†–û–£–¢–ï–† (–ù–ê–í–ò–ì–ê–¶–ò–Ø) ===

        // 1. –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–Ω–æ–ø–∫–∞ –ù–∞–∑–∞–¥)
        window.addEventListener('hashchange', handleHashChange);

        async function handleHashChange() {
            const hash = window.location.hash;

            // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –ø—É—Å—Ç–∞—è (–º—ã –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤)
            if (!hash || hash === '#') {
                performCloseUI();
                return;
            }

            // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –≤–∏–¥–∞ #chat/USER_ID
            if (hash.startsWith('#chat/')) {
                const userId = hash.replace('#chat/', '');

                // –ï—Å–ª–∏ –º—ã —É–∂–µ –≤ —ç—Ç–æ–º —á–∞—Ç–µ, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                if (currentFriendId === userId) return;

                // –ï—Å–ª–∏ –º—ã —Ç–æ–ª—å–∫–æ –∑–∞—à–ª–∏ –Ω–∞ —Å–∞–π—Ç, currentUser –º–æ–∂–µ—Ç –µ—â–µ –Ω–µ –ø—Ä–æ–≥—Ä—É–∑–∏—Ç—å—Å—è
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥–µ—Ç –≤–Ω—É—Ç—Ä–∏ auth listener, –Ω–æ –∑–¥–µ—Å—å –ø–æ–¥—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è
                if (!currentUser) return;

                // –ù–∞–º –Ω—É–∂–Ω–æ –∏–º—è –∏ –Ω–∏–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞.
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≤ –∫—ç—à–µ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –±–∞–∑—ã
                let userData = usersCache[userId];

                if (!userData) {
                    try {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–ª–æ–∞–¥–µ—Ä –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ, –ø–æ–∫–∞ –≥—Ä—É–∑–∏–º
                        document.getElementById('mainChatArea').classList.add('active'); // –¥–ª—è –º–æ–±–∏–ª–æ–∫
                        document.getElementById('noChat').classList.add('hidden');
                        document.getElementById('activeChat').classList.remove('hidden');
                        document.getElementById('chatTitle').innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

                        const doc = await db.collection('users').doc(userId).get();
                        if (doc.exists) {
                            userData = doc.data();
                            usersCache[userId] = userData; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
                        }
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ —Ä–æ—É—Ç–µ—Ä–∞", e);
                    }
                }

                if (userData) {
                    const name = userData.name || userData.username || 'User';
                    const nick = userData.username ? '@' + userData.username : '';

                    // –í—ã–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–∫—Ä—ã—Ç–∏—è, –Ω–æ –æ–Ω–∞ —Å–Ω–æ–≤–∞ –ø–æ—Å—Ç–∞–≤–∏—Ç —Ö–µ—à.
                    // –≠—Ç–æ –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ, –Ω–æ —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ü–∏–∫–ª–∏—Ç—å, –º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —Å–ª—É—à–∞—Ç–µ–ª—å,
                    // –Ω–æ –ø—Ä–æ—â–µ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å, –±—Ä–∞—É–∑–µ—Ä —É–º–Ω—ã–π.

                    // –í–ê–ñ–ù–û: –ú—ã –≤—ã–∑—ã–≤–∞–µ–º openChat, –Ω–æ –æ–Ω —Å–∞–º —Å—Ç–∞–≤–∏—Ç hash.
                    // –ß—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥–≤–æ–π–Ω–æ–π —Ä–∞–±–æ—Ç—ã, –∫–æ–¥ –≤–Ω—É—Ç—Ä–∏ openChat –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.

                    // –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ UI –ª–æ–≥–∏–∫–∏ (–¥—É–±–ª–∏—Ä—É–µ–º —á–∞—Å—Ç—å openChat —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–∏ —Ö–µ—à–∞)
                    currentFriendId = userId;
                    currentChatId = [currentUser.uid, userId].sort().join('_');

                    if (window.innerWidth <= 768) {
                        document.getElementById('mainSidebar').classList.add('hidden-mobile');
                        document.getElementById('mainChatArea').classList.add('active');
                    }
                    document.getElementById('noChat').classList.add('hidden');
                    document.getElementById('activeChat').classList.remove('hidden');

                    document.getElementById('chatTitle').innerHTML = `
                                                                                                                                                                                                                                                            <div>${name}</div>
                                                                                                                                                                                                                                                            <div style="font-size:11px; font-weight:normal; color:#888;">${nick}</div>
                                                                                                                                                                                                                                                        `;

                    loadMessages();
                } else {
                    // –Æ–∑–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞–∑–∞–¥
                    window.location.hash = '';
                }
            }
        }


        // --- –í—Å—Ç–∞–≤—å —ç—Ç–æ –≤ —Å–≤–æ–π —Å–∫—Ä–∏–ø—Ç ---

        // !!! –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò –°–°–´–õ–ö–£ –ù–ò–ñ–ï –ù–ê –°–í–û–Æ !!!
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby4AnViDZV8N6X-Tk9XFG2LQwTUVb2TWWR3RcoCNhkRmOM5XLug9UBi1Ky-_j2sQB5u/exec";



        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "—Ñ–µ–π–∫–æ–≤–æ–µ" —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–∫–∞ —Ñ–∞–π–ª –≥—Ä—É–∑–∏—Ç—Å—è
        function showTempMessage(file) {
            const list = document.getElementById('msgList');
            const tempId = 'temp-' + Date.now();
            const div = document.createElement('div');
            div.id = tempId;
            div.className = 'msg msg-me'; // –°—Ä–∞–∑—É –∫–∞–∫ "—Å–≤–æ—ë"

            let contentHtml = '';

            // –ï—Å–ª–∏ —ç—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—ë —Å—Ä–∞–∑—É
            if (file.type.startsWith('image/')) {
                const url = URL.createObjectURL(file);
                contentHtml = `
                                                                                                                                                                                                                                                                    <div class="media-container loading-overlay" style="position: relative; display: inline-block;">
                                                                                                                                                                                                                                                                        <img src="${url}" class="chat-media-img" style="opacity: 1;">
                                                                                                                                                                                                                                                                        <div class="upload-spinner"></div>
                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                `;
            }
            // –ï—Å–ª–∏ —ç—Ç–æ –≤–∏–¥–µ–æ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –≤–∏–¥–µ–æ (–º–æ–∂–Ω–æ —Ç–æ–∂–µ –ø—Ä–µ–≤—å—é, –µ—Å–ª–∏ —É–¥–∞—Å—Ç—Å—è)
            else if (file.type.startsWith('video/')) {
                // –î–ª—è –≤–∏–¥–µ–æ —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç URL, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä (–µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä —Å–º–æ–∂–µ—Ç)
                // –ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –∫—Ä–∞—Å–∏–≤—É—é –∑–∞–≥–ª—É—à–∫—É
                contentHtml = `
                                                <div class="chat-file-card" style="opacity: 0.7;">
                                                    <div class="file-icon">üé•</div>
                                                    <div class="file-info">
                                                        <div class="file-name">–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</div>
                                                        <div class="file-action">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</div>
                                                    </div>
                                                    <div class="upload-spinner" style="width: 20px; height: 20px; border-width: 2px; left: auto; right: 10px; transform: translateY(-50%);"></div>
                                                </div>
                                            `;
            }
            // –ï—Å–ª–∏ —ç—Ç–æ —Ñ–∞–π–ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
            else {
                contentHtml = `
                                                                                                                                                                                                                                                                    <div class="chat-file-card" style="opacity: 0.7;">
                                                                                                                                                                                                                                                                        <div class="file-icon">üìÑ</div>
                                                                                                                                                                                                                                                                        <div class="file-info">
                                                                                                                                                                                                                                                                            <div class="file-name">${file.name}</div>
                                                                                                                                                                                                                                                                            <div class="file-action">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                        <div class="upload-spinner" style="width: 20px; height: 20px; border-width: 2px; left: auto; right: 10px; transform: translateY(-50%);"></div>
                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                `;
            }

            div.innerHTML = contentHtml;
            list.appendChild(div);

            // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑
            setTimeout(() => { list.scrollTop = list.scrollHeight; }, 50);

            return tempId; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º ID, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
        }

        // --- 2. –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ ---
        // !!! –£–±–µ–¥–∏—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è GOOGLE_SCRIPT_URL –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤—ã—à–µ !!!
        async function uploadFile(input) {
            const file = input.files[0];
            if (!file) return;

            if (file.size > 20 * 1024 * 1024) {
                alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º—É–º 20 –ú–ë.");
                return;
            }

            // 1. –ü–û–ö–ê–ó–´–í–ê–ï–ú –ü–†–ï–í–¨–Æ –ú–ì–ù–û–í–ï–ù–ù–û
            const tempMsgId = showTempMessage(file);

            const originalPlaceholder = document.getElementById('msgInput').placeholder;
            // document.getElementById('msgInput').disabled = true; // –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–≤–æ–¥

            try {
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Base64 (–Ω—É–∂–Ω–æ –¥–ª—è Google Script)
                const toBase64 = f => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(f);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = error => reject(error);
                });

                const base64Data = await toBase64(file);

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ Google
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    body: JSON.stringify({
                        filename: file.name,
                        mimeType: file.type,
                        base64: base64Data
                    })
                });

                const data = await response.json();

                // 2. –ó–ê–ì–†–£–ó–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê -> –£–î–ê–õ–Ø–ï–ú –ü–†–ï–í–¨–Æ
                const tempEl = document.getElementById(tempMsgId);
                if (tempEl) tempEl.remove();

                if (data.result === "success") {
                    // 3. –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ù–ê–°–¢–û–Ø–©–ï–ï –°–û–û–ë–©–ï–ù–ò–ï
                    let type = 'file';
                    if (file.type.startsWith('image/')) type = 'image';
                    if (file.type.startsWith('video/')) type = 'video'; // <--- –î–æ–±–∞–≤–∏–ª–∏ —Ç–∏–ø –≤–∏–¥–µ–æ

                    sendMsg(data.url, false, type);
                } else {
                    throw new Error(data.message || "–û—à–∏–±–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞");
                }

            } catch (error) {
                console.error("–û—à–∏–±–∫–∞:", error);
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - —É–¥–∞–ª—è–µ–º –∫—Ä—É—Ç–∏–ª–∫—É –∏ –≥–æ–≤–æ—Ä–∏–º —é–∑–µ—Ä—É
                const tempEl = document.getElementById(tempMsgId);
                if (tempEl) tempEl.remove();
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
            } finally {
                document.getElementById('msgInput').placeholder = originalPlaceholder;
                document.getElementById('msgInput').disabled = false;
                input.value = ''; // –û—á–∏—â–∞–µ–º –∏–Ω–ø—É—Ç
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ
        function openImageViewer(src) {
            const viewer = document.getElementById('imageViewer');
            const img = document.getElementById('imageViewerImg');

            // –ú–µ–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –ø–æ–≤—ã—à–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (–µ—Å–ª–∏ —ç—Ç–æ –≥—É–≥–ª –¥–∏—Å–∫)
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä =w2000 (—à–∏—Ä–∏–Ω–∞ 2000px)
            let highResSrc = src;
            if (src.includes('lh3.googleusercontent.com')) {
                highResSrc = src.split('=')[0] + '=w2000';
            }

            img.src = highResSrc;
            viewer.classList.add('active');
        }

        function closeImageViewer() {
            const viewer = document.getElementById('imageViewer');
            viewer.classList.remove('active');
            setTimeout(() => {
                document.getElementById('imageViewerImg').src = ''; // –û—á–∏—Å—Ç–∫–∞
            }, 300);
        }



    </script>


    <div id="imageViewer" class="image-viewer" onclick="closeImageViewer()">
        <span class="close-viewer-btn">√ó</span>
        <img id="imageViewerImg" src="" onclick="event.stopPropagation()">
    </div>


</body>
</html>
