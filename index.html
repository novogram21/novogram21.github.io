#if ANDROID
using Android.App;
using Android.Content;
using Android.OS;
using AndroidX.Core.App;
using AndroidX.Core.Content.PM;
using AndroidX.Core.Graphics.Drawable;
using System;
using Application = Android.App.Application;

namespace MauiApp2.Platforms.Android
{
    public class AndroidBubbleService
    {
        public static void ShowBubble(string chatId, string senderName, string messageText)
        {
            // –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ Android 11 (API 30) –∏ –≤—ã—à–µ
            if (Build.VERSION.SdkInt < BuildVersionCodes.R)
                return;

            var context = Application.Context;
            var notificationManager = NotificationManagerCompat.From(context);

            // 1. –°–æ–∑–¥–∞–µ–º –Ω–∞–º–µ—Ä–µ–Ω–∏–µ (Intent), –∫–æ—Ç–æ—Ä–æ–µ –æ—Ç–∫—Ä–æ–µ—Ç –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ
            var intent = new Intent(context, typeof(MainActivity));
            intent.SetAction(Intent.ActionView);
            intent.PutExtra("OPEN_CHAT_ID", chatId); // –ü–µ—Ä–µ–¥–∞–µ–º ID —á–∞—Ç–∞

            var pendingIntent = PendingIntent.GetActivity(
                context,
                chatId.GetHashCode(),
                intent,
                PendingIntentFlags.Mutable | PendingIntentFlags.UpdateCurrent);

            // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –ò–∫–æ–Ω–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ MAUI –ª–µ–∂–∏—Ç –≤ Mipmap, –∞ –Ω–µ Drawable
            var icon = IconCompat.CreateWithResource(context, Resource.Mipmap.appicon);

            // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ –∫–ª–∞—Å—Å—É Person (AndroidX)
            var person = new AndroidX.Core.App.Person.Builder()
                .SetName(senderName)
                .SetIcon(icon)
                .SetImportant(true)
                .Build();

            // 4. –°–æ–∑–¥–∞–µ–º "–Ø—Ä–ª—ã–∫" (Shortcut)
            var shortcutId = "chat_" + chatId;
            var shortcut = new ShortcutInfoCompat.Builder(context, shortcutId)
                .SetShortLabel(senderName)
                .SetIcon(icon)
                .SetIntent(intent)
                .SetPerson(person)
                .SetLongLived(true)
                .Build();

            ShortcutManagerCompat.PushDynamicShortcut(context, shortcut);

            // 5. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–∞–º –ü–£–ó–´–†–¨ (BubbleMetadata)
            var bubbleData = new NotificationCompat.BubbleMetadata.Builder(pendingIntent, icon)
                .SetDesiredHeight(600) // –í—ã—Å–æ—Ç–∞ –æ–∫–Ω–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
                .SetAutoExpandBubble(true) // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–∫—Ä—ã—Ç—å
                .SetSuppressNotification(false)
                .Build();

            // 6. –°–æ–∑–¥–∞–µ–º –∫–∞–Ω–∞–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø—É–∑—ã—Ä–µ–π!)
            string channelId = "novogram_bubbles";
            if (Build.VERSION.SdkInt >= BuildVersionCodes.O)
            {
                var channel = new NotificationChannel(channelId, "–ß–∞—Ç—ã", NotificationImportance.High);
                channel.SetAllowBubbles(true); // –†–∞–∑—Ä–µ—à–∞–µ–º –ø—É–∑—ã—Ä–∏ –¥–ª—è –∫–∞–Ω–∞–ª–∞
                notificationManager.CreateNotificationChannel(channel);
            }

            // 7. –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∏–ª—å "–°–æ–æ–±—â–µ–Ω–∏–µ"
            var style = new NotificationCompat.MessagingStyle(person)
                .AddMessage(messageText, DateTimeOffset.UtcNow.ToUnixTimeMilliseconds(), person);

            // 8. –°–æ–±–∏—Ä–∞–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            var builder = new NotificationCompat.Builder(context, channelId)
                .SetContentTitle(senderName)
                .SetContentText(messageText)
                // üî• –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 3: –ó–¥–µ—Å—å —Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º Mipmap
                .SetSmallIcon(Resource.Mipmap.appicon)
                .SetStyle(style)
                .SetShortcutId(shortcutId)
                .SetBubbleMetadata(bubbleData)
                .AddPerson(person)
                .SetCategory(NotificationCompat.CategoryMessage);

            notificationManager.Notify(chatId.GetHashCode(), builder.Build());
        }
    }
}
#endif
